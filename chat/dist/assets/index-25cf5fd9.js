import{d as q,r as p,h as G,c as M,a as i,o as S,ag as J,w as H,e as $,t as b,k as D,l as R,q as B,I as k,m as z,s as O,H as P}from"./index-768c9aff.js";import{b as K}from"./mjDraw-55d0bf6c.js";const Q={class:"relative w-full h-full"},Z=["width","height"],A=["width","height"],ee=q({__name:"index",props:{src:String,width:Number,height:Number,max:{type:Number,default:500},exportMaskBackgroundColor:{type:String,default:"black"},exportMaskColor:{type:String,default:"white"},penColor:{type:String,default:"white"},penWidth:{type:Number,default:20},updateFileInfo:Function},setup(E,{expose:C}){const o=E,e=p(null),r=p(null),m=p([]);let g=!1,I=[];const f=new Image,x=p(!1),w=p(0),y=p(0),L=p(0);G(()=>{var n;e.value.getContext("2d");const a=(n=r.value)==null?void 0:n.getContext("2d");f.src=o.src,f.onload=()=>{var d;const c=Math.min(o.max/f.width,o.max/f.height);L.value=c,w.value=o.width||(c<1?f.width*c:f.width),y.value=o.height||(c<1?f.height*c:f.height),(d=o.updateFileInfo)==null||d.call(o,{width:f.width,height:f.height,scaleRatio:c.toFixed(3)}),e.value.width=w.value,r.value.width=w.value,e.value.height=y.value,r.value.height=y.value,a.drawImage(f,0,0,w.value,y.value)},e.value.addEventListener("mousedown",N),e.value.addEventListener("mousemove",T),e.value.addEventListener("mouseup",F)});const N=a=>{g=!0;const n=e.value.getContext("2d");n.beginPath(),n.moveTo(a.offsetX,a.offsetY),I=[{type:x.value?"erase":"draw",x:a.offsetX,y:a.offsetY}]},T=a=>{if(!g)return;const n=e.value.getContext("2d");n.lineTo(a.offsetX,a.offsetY),x.value?(n.globalCompositeOperation="destination-out",n.lineWidth=o.penWidth*2):(n.globalCompositeOperation="source-over",n.strokeStyle=o.penColor,n.lineWidth=o.penWidth),n.stroke(),I.push({type:x.value?"erase":"draw",x:a.offsetX,y:a.offsetY})},F=()=>{g=!1,m.value.push([...I,{type:"end"}]),I=[]},U=()=>new Promise((a,n)=>{const c=document.createElement("canvas"),d=f;c.width=d.width,c.height=d.height;const u=c.getContext("2d");if(u){u.fillStyle=o.exportMaskBackgroundColor,u.fillRect(0,0,c.width,c.height),u.beginPath();const v=d.width/w.value,X=d.height/y.value;u.beginPath(),m.value.forEach(W=>{W.forEach((_,j)=>{(_.type==="begin"||_.type==="draw")&&((j===0||W[j-1].type!==_.type)&&u.beginPath(),u.lineTo(_.x*v,_.y*X),u.strokeStyle=o.exportMaskColor,u.lineWidth=o.penWidth*v),_.type==="erase"&&((j===0||W[j-1].type!==_.type)&&u.beginPath(),u.lineTo(_.x*v,_.y*X),u.strokeStyle=o.exportMaskBackgroundColor),j<W.length-1&&W[j+1].type!==_.type&&u.stroke()}),W[W.length-1].type!=="begin"&&u.stroke()});const Y=c.toDataURL("image/png");a(Y)}else n(new Error("无法获取canvas的2D渲染上下文"))});function h(){m.value=[],e.value.getContext("2d").clearRect(0,0,e.value.width,e.value.height)}async function s(){return await U()}function V(){m.value.length>0&&(m.value.pop(),t())}function t(){const a=e.value.getContext("2d");a.clearRect(0,0,e.value.width,e.value.height),a.drawImage(f,0,0,w.value,y.value),m.value.forEach(n=>{n.forEach((c,d)=>{(d===0||n[d-1].type!==c.type)&&a.beginPath(),c.type==="erase"?(a.globalCompositeOperation="destination-out",a.strokeStyle="rgba(0,0,0,0)"):(a.globalCompositeOperation="source-over",a.strokeStyle="white"),a.lineWidth=c.type==="erase"?o.penWidth*2:o.penWidth,a.lineTo(c.x,c.y),a.stroke(),(d===n.length-1||n[d+1].type!==c.type)&&a.closePath()})}),a.globalCompositeOperation="source-over"}return C({getBase:s,undo:V,clear:h,toggleEraser:()=>{x.value=!x.value}}),(a,n)=>(S(),M("div",Q,[i("canvas",{ref_key:"backgroundCanvas",ref:r,class:"absolute left-0 top-0",width:E.width,height:E.height},null,8,Z),i("canvas",{ref_key:"canvas",ref:e,class:"absolute left-0 top-0",width:E.width,height:E.height},null,8,A)]))}});const te=J(ee,[["__scopeId","data-v-d6d70dde"]]),ae=q({__name:"index",props:{src:String,selectColor:String,maxSteps:Number,updateFileInfo:Function},setup(E,{expose:C}){const o=E,e=p(null),r=p(null);let m=new Set;const g=p([]),I=p(10);H(()=>o.maxSteps,t=>{t&&(I.value=t)},{immediate:!0}),G(()=>{e.value&&(r.value=e.value.getContext("2d",{willReadFrequently:!0}),f())}),H(()=>o.src,t=>{t&&f()});function f(){if(!r.value||!o.src)return;const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{var l;e.value.width=t.width,e.value.height=t.height,(l=o.updateFileInfo)==null||l.call(o,{width:t.width,height:t.height,scaleRatio:1}),r.value.drawImage(t,0,0,t.width,t.height)},t.src=o.src}function x(t,l){return(l*e.value.width+t)*4}function w(t,l,a){const n=x(t,l);return[a[n],a[n+1],a[n+2],a[n+3]]}function y(t,l){return t.reduce((n,c,d)=>n+Math.abs(c-l[d]),0)}function L(t,l,a,n,c){if(r.value&&e.value){const u=r.value.getImageData(0,0,e.value.width,e.value.height);V(u)}const d=[[t,l]];for(;d.length;){const[u,v]=d.shift();if(u<0||u>=e.value.width||v<0||v>=e.value.height)continue;const X=w(u,v,c);if(y(X,n)>50||y(X,a)===0)continue;const Y=x(u,v);c.set(a,Y),m.add(u+","+v),d.push([u+1,v]),d.push([u-1,v]),d.push([u,v+1]),d.push([u,v-1])}}function N(t){if(!r.value||!e.value)return;const l=t.offsetX,a=t.offsetY,n=r.value.getImageData(0,0,e.value.width,e.value.height),c=w(l,a,n.data),d=F(o.selectColor);L(l,a,d,c,n.data),r.value.putImageData(n,0,0)}function T(){if(!r.value||!e.value)return"";const t=r.value.getImageData(0,0,e.value.width,e.value.height),l=new Uint8ClampedArray(t.data);for(let d=0;d<e.value.height;d++)for(let u=0;u<e.value.width;u++){const v=x(u,d);m.has(u+","+d)?(l[v]=255,l[v+1]=255,l[v+2]=255):(l[v]=0,l[v+1]=0,l[v+2]=0),l[v+3]=255}const a=new ImageData(l,e.value.width,e.value.height),n=document.createElement("canvas");return n.width=e.value.width,n.height=e.value.height,n.getContext("2d").putImageData(a,0,0),n.toDataURL("image/png")}function F(t){if(t&&t.startsWith("#")){const l=t.length===4?"#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]:t,a=parseInt(l.slice(1,3),16),n=parseInt(l.slice(3,5),16),c=parseInt(l.slice(5,7),16);return[a,n,c,255]}else if(t&&t.startsWith("rgb")){const l=t.replace(/rgba?\(/,"").replace(/\)/,"").split(",").map(a=>parseInt(a));return l.length===3&&l.push(255),l}return[0,0,0,255]}async function U(){return await T()}function h(){if(g.value.length===0||!r.value||!e.value)return;const t=g.value.pop();r.value.putImageData(t.imageData,0,0),m=new Set(t.currentModifiedPixels)}function s(){!r.value||!e.value||(r.value.clearRect(0,0,e.value.width,e.value.height),m.clear(),g.value=[],f())}function V(t){const l=new Set(m);g.value.push({imageData:t,currentModifiedPixels:l}),g.value.length>I.value&&g.value.shift()}return C({getBase:U,undo:h,clear:s}),(t,l)=>(S(),M("div",null,[i("canvas",{ref_key:"canvas",ref:e,onClick:N,crossOrigin:"anonymous"},null,512)]))}});const ne={class:"w-full h-full bg-gray-100"},se={class:"h-[80px] w-full flex justify-center items-center space-x-5"},le={class:"text-2xl font-bold"},oe={key:0,class:"bg-gray-100 flex-1 h-full w-full flex"},ie={class:"w-[50%] flex flex-col border-r"},ue={class:"border-b border-t h-[50px] flex justify-center items-center space-x-5"},re={class:"mt-10 ml-10"},ce={class:"w-[50%] flex flex-col"},de={class:"border-b border-t h-[50px] flex justify-center items-center space-x-5"},ve={class:"border-b border-t h-[50px] flex justify-center items-center space-x-5"},fe=["src"],he={key:1,class:"bg-gray-100 flex-1 h-full w-full flex"},ge={class:"w-[50%] flex flex-col border-r"},pe={class:"border-b border-t h-[50px] flex justify-center items-center space-x-5"},me={class:"mt-10 ml-10"},xe={class:"w-[50%] flex flex-col"},ye={class:"border-b border-t h-[50px] flex justify-center items-center space-x-5"},we={class:"border-b border-t h-[50px] flex justify-center items-center space-x-5"},_e=["src"],be="",ke="",Se=q({__name:"index",setup(E){const C=p(""),o=p(null),e=p(""),r=p(1),m=p(!1),g=p({}),I=$(()=>r.value===1?"模块选区":"自由绘制"),f=$(()=>r.value===2?"模块选区模式":"自由绘制模式");async function x(){var s;const h=await((s=o.value)==null?void 0:s.getBase());C.value=h}async function w(){const h=r.value===1?be:ke,V="data:image/png;base64,"+(await K({url:h})).data;e.value=V}const y=$(()=>m.value?"橡皮擦模式":"画笔模式");function L(){e.value=null,r.value=r.value===1?2:1}H(r,()=>{w()},{immediate:!0});function N(){var h;(h=o.value)==null||h.undo()}function T(){var h;(h=o.value)==null||h.clear()}function F(h){g.value=h}function U(){var h;(h=o.value)==null||h.toggleEraser(),m.value=!m.value}return(h,s)=>(S(),M("div",ne,[i("div",se,[i("span",le," 当前测试模式："+b(f.value),1),D(B(P),{type:"primary",onClick:L},{default:R(()=>[k("切换至"+b(I.value)+"模式",1)]),_:1})]),r.value===1?(S(),M("div",oe,[i("div",ie,[s[3]||(s[3]=i("span",{class:"text-2xl w-full text-center"},"操作区域",-1)),i("div",ue,[D(B(P),{type:"primary",onClick:N},{default:R(()=>s[0]||(s[0]=[k("返回上一步")])),_:1}),D(B(P),{type:"primary",onClick:T},{default:R(()=>s[1]||(s[1]=[k("清空画布")])),_:1}),D(B(P),{type:"primary",onClick:U},{default:R(()=>s[2]||(s[2]=[k("切换橡皮擦模式")])),_:1}),k(" 当前模式: "+b(y.value),1)]),i("div",re,[i("div",null,[e.value&&r.value===1?(S(),z(te,{key:0,ref_key:"canvasRef",ref:o,updateFileInfo:F,max:700,src:e.value},null,8,["src"])):O("",!0)])])]),i("div",ce,[s[6]||(s[6]=i("span",{class:"text-2xl w-full text-center"},"预览区域",-1)),i("div",de,[D(B(P),{type:"primary",onClick:x},{default:R(()=>s[4]||(s[4]=[k("获取蒙层")])),_:1})]),i("div",ve,[s[5]||(s[5]=i("span",null,"图片原始信息：",-1)),i("span",null,"宽度： "+b(g.value.width),1),i("span",null,"高度： "+b(g.value.height),1),i("span",null,"缩放比： "+b(g.value.scaleRatio),1)]),i("div",null,[C.value?(S(),M("img",{key:0,src:C.value,alt:""},null,8,fe)):O("",!0)])])])):O("",!0),r.value===2?(S(),M("div",he,[i("div",ge,[s[9]||(s[9]=i("span",{class:"text-2xl w-full text-center"},"操作区域",-1)),i("div",pe,[D(B(P),{type:"primary",onClick:N},{default:R(()=>s[7]||(s[7]=[k("返回上一步")])),_:1}),D(B(P),{type:"primary",onClick:T},{default:R(()=>s[8]||(s[8]=[k("清空画布")])),_:1}),k(" 当前模式: "+b(y.value),1)]),i("div",me,[i("div",null,[e.value&&r.value===2?(S(),z(ae,{key:0,selectColor:"#fff",ref_key:"canvasRef",ref:o,updateFileInfo:F,max:500,src:e.value},null,8,["src"])):O("",!0)])])]),i("div",xe,[s[12]||(s[12]=i("span",{class:"text-2xl w-full text-center"},"预览区域",-1)),i("div",ye,[D(B(P),{type:"primary",onClick:x},{default:R(()=>s[10]||(s[10]=[k("获取蒙层")])),_:1})]),i("div",we,[s[11]||(s[11]=i("span",null,"图片原始信息：",-1)),i("span",null,"宽度： "+b(g.value.width),1),i("span",null,"高度： "+b(g.value.height),1),i("span",null,"缩放比： "+b(g.value.scaleRatio),1)]),i("div",null,[C.value?(S(),M("img",{key:0,src:C.value,alt:""},null,8,_e)):O("",!0)])])])):O("",!0)]))}});export{Se as default};
