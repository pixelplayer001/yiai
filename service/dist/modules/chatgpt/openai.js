'use strict';function _0x17ee(){const _0x890bf4=['delta','798690qbEDmb','6795QZYQqt','text','@nestjs/common','imageUrl','parse','length','------>\x20开始上传图片！！！','/v1/chat/completions','MidjourneyService','532zOPYvu','sendMessageFromOpenAi','end','content','6255065gOsLer','split','stringify','slice','@dqbd/tiktoken','Logger','filter','application/json','axios','default','response','max_tokens','Billing\x20hard\x20limit\x20has\x20been\x20reached','parse\x20Error','replace','dall','message','log','choices','stop','status','787016ytncLo','finish_reason','role','detail','5940466hWehsY','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','当前请求已过载、请稍等会儿再试试吧！','__esModule','uploadFile','getTokenCount','[DONE]\x20','Bearer\x20','error','81081RCUBiU','data','3418824SGkFWe','/v1/images/generations','usage','绘制图片失败，请稍后试试吧！','includes','forEach','encode','绘制图片失败，此次绘画被拒绝了！','POST','data:','base64','trim','defineProperty','绘制图片失败，请检查你的提示词是否有非法描述！','6HkLPCC'];_0x17ee=function(){return _0x890bf4;};return _0x17ee();}const _0x3c9fbf=_0x5c02;(function(_0x9f34ab,_0x318af5){const _0xd87c6d=_0x5c02,_0x4fd6f3=_0x9f34ab();while(!![]){try{const _0xe122ff=parseInt(_0xd87c6d(0x9b))/0x1+-parseInt(_0xd87c6d(0xba))/0x2+-parseInt(_0xd87c6d(0xbb))/0x3*(-parseInt(_0xd87c6d(0xc4))/0x4)+parseInt(_0xd87c6d(0xc8))/0x5+-parseInt(_0xd87c6d(0xb8))/0x6*(parseInt(_0xd87c6d(0x9f))/0x7)+-parseInt(_0xd87c6d(0xaa))/0x8+-parseInt(_0xd87c6d(0xa8))/0x9;if(_0xe122ff===_0x318af5)break;else _0x4fd6f3['push'](_0x4fd6f3['shift']());}catch(_0xff40ed){_0x4fd6f3['push'](_0x4fd6f3['shift']());}}}(_0x17ee,0x9fe51));Object[_0x3c9fbf(0xb6)](exports,_0x3c9fbf(0xa2),{'value':!![]}),exports[_0x3c9fbf(0xa4)]=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require(_0x3c9fbf(0xd0)),tiktoken_1=require(_0x3c9fbf(0xcc)),common_1=require(_0x3c9fbf(0xbd)),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1['get_encoding'])('cl100k_base');function getFullUrl(_0x53a3ea){const _0x147e15=_0x3c9fbf,_0x17bb2d=_0x53a3ea['endsWith']('/')?_0x53a3ea['slice'](0x0,-0x1):_0x53a3ea,_0x6b0f37=_0x17bb2d||'https://api.openai.com';return _0x6b0f37+_0x147e15(0xc2);}async function sendMessageFromOpenAi(_0x1f6cbc,_0x158092,_0x34974b){const _0x3f02f8=_0x3c9fbf;var _0x10f5d6,_0x2b2b14,_0x12a561,_0x3e32e6;const {onProgress:_0xace002,maxToken:_0x1f67bd,apiKey:_0x47aeb3,model:_0x483062,temperature:temperature=0.8,proxyUrl:_0x4c1e39,prompt:_0x35538c}=_0x158092;if(_0x483062[_0x3f02f8(0xae)](_0x3f02f8(0xd7))){let _0x2f1f2={'text':'','imageUrl':''};try{const _0xe1ca99={'method':_0x3f02f8(0xb2),'url':_0x4c1e39+_0x3f02f8(0xab),'headers':{'Content-Type':_0x3f02f8(0xcf),'Authorization':_0x3f02f8(0xa6)+_0x47aeb3},'data':{'prompt':_0x35538c,'model':_0x483062,'response_format':'b64_json'}},_0x4b300a=await(0x0,axios_1[_0x3f02f8(0xd1)])(_0xe1ca99),{b64_json:_0x1b91e6,revised_prompt:_0x335829}=_0x4b300a['data'][_0x3f02f8(0xa9)][0x0],_0x28f89a=Buffer['from'](_0x1b91e6,_0x3f02f8(0xb4));let _0x2eea91='';try{const _0x52656b=uuid['v4']()[_0x3f02f8(0xcb)](0x0,0xa)+'.png';common_1[_0x3f02f8(0xcd)]['debug'](_0x3f02f8(0xc1),_0x3f02f8(0xc3));const _0x28f039=Buffer['from'](_0x1b91e6,_0x3f02f8(0xb4));_0x2eea91=await _0x34974b[_0x3f02f8(0xa3)]({'filename':_0x52656b,'buffer':_0x28f039}),common_1[_0x3f02f8(0xcd)]['debug']('图片上传成功，URL:\x20'+_0x2eea91,_0x3f02f8(0xc3));}catch(_0x59c3d5){common_1[_0x3f02f8(0xcd)]['error']('上传图片过程中出现错误:\x20'+_0x59c3d5,_0x3f02f8(0xc3));}return _0x2f1f2[_0x3f02f8(0xbe)]=_0x2eea91,_0x2f1f2[_0x3f02f8(0xbc)]=_0x335829,_0xace002&&_0xace002({'text':_0x2f1f2[_0x3f02f8(0xbc)]}),_0x2f1f2;}catch(_0x241f52){const _0x758788=((_0x10f5d6=_0x241f52===null||_0x241f52===void 0x0?void 0x0:_0x241f52['response'])===null||_0x10f5d6===void 0x0?void 0x0:_0x10f5d6[_0x3f02f8(0x9a)])||0x1f4;console[_0x3f02f8(0xd9)]('openai-draw\x20error:\x20',JSON[_0x3f02f8(0xca)](_0x241f52),_0x758788);const _0xe48fd7=(_0x3e32e6=(_0x12a561=(_0x2b2b14=_0x241f52===null||_0x241f52===void 0x0?void 0x0:_0x241f52[_0x3f02f8(0xd2)])===null||_0x2b2b14===void 0x0?void 0x0:_0x2b2b14[_0x3f02f8(0xa9)])===null||_0x12a561===void 0x0?void 0x0:_0x12a561[_0x3f02f8(0xa7)])===null||_0x3e32e6===void 0x0?void 0x0:_0x3e32e6[_0x3f02f8(0xd8)];if(_0x758788===0x1ad)return _0x2f1f2[_0x3f02f8(0xbc)]=_0x3f02f8(0xa1),_0x2f1f2;if(_0x758788===0x190&&_0xe48fd7[_0x3f02f8(0xae)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0x2f1f2[_0x3f02f8(0xbc)]='您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',_0x2f1f2;if(_0x758788===0x190&&_0xe48fd7[_0x3f02f8(0xae)](_0x3f02f8(0xd4)))return _0x2f1f2[_0x3f02f8(0xbc)]=_0x3f02f8(0xa0),_0x2f1f2;if(_0x758788===0x1f4)return _0x2f1f2[_0x3f02f8(0xbc)]=_0x3f02f8(0xb7),_0x2f1f2;if(_0x758788===0x191)return _0x2f1f2[_0x3f02f8(0xbc)]=_0x3f02f8(0xb1),_0x2f1f2;return _0x2f1f2[_0x3f02f8(0xbc)]=_0x3f02f8(0xad),_0x2f1f2;}}else{let _0x270be7={'text':''};const _0x362da5={'method':'POST','url':getFullUrl(_0x4c1e39),'responseType':'stream','headers':{'Content-Type':_0x3f02f8(0xcf),'Accept':'application/json','Authorization':'Bearer\x20'+_0x47aeb3},'data':{'stream':!![],'temperature':temperature,'model':_0x483062,'messages':_0x1f6cbc}};return _0x483062==='gpt-4-vision-preview'&&(_0x362da5[_0x3f02f8(0xa9)][_0x3f02f8(0xd3)]=0x800),new Promise(async(_0x4fd326,_0x58429b)=>{const _0x23963a=_0x3f02f8;try{const _0xce6feb=await(0x0,axios_1[_0x23963a(0xd1)])(_0x362da5),_0x4e48de=_0xce6feb[_0x23963a(0xa9)];_0x4e48de['on'](_0x23963a(0xa9),_0x107a7f=>{const _0x5b9606=_0x23963a;var _0x3af99c;const _0x52fafc=_0x107a7f['toString']()[_0x5b9606(0xc9)]('\x0a\x0a')[_0x5b9606(0xce)](_0x1f8242=>_0x1f8242[_0x5b9606(0xb5)]()!=='');for(const _0x36ab3d of _0x52fafc){const _0x4fadc2=_0x36ab3d[_0x5b9606(0xd6)](_0x5b9606(0xb3),'');let _0x310244=![];try{_0x310244=JSON[_0x5b9606(0xbf)](_0x4fadc2)[_0x5b9606(0xda)][0x0][_0x5b9606(0x9c)]===_0x5b9606(0xdb);}catch(_0x51b327){_0x310244=![];}if(_0x310244)return _0x270be7[_0x5b9606(0xbc)]=_0x270be7['text'][_0x5b9606(0xb5)](),_0x270be7;try{if(_0x4fadc2!=='\x20[DONE]'&&_0x4fadc2!=='[DONE]'&&_0x4fadc2!=_0x5b9606(0xa5)){const _0x557a5d=JSON[_0x5b9606(0xbf)](_0x4fadc2);_0x557a5d['id']&&(_0x270be7['id']=_0x557a5d['id']);if((_0x3af99c=_0x557a5d[_0x5b9606(0xda)])===null||_0x3af99c===void 0x0?void 0x0:_0x3af99c[_0x5b9606(0xc0)]){const _0x290a35=_0x557a5d[_0x5b9606(0xda)][0x0][_0x5b9606(0xb9)];_0x270be7[_0x5b9606(0xb9)]=_0x290a35[_0x5b9606(0xc7)];if(_0x290a35===null||_0x290a35===void 0x0?void 0x0:_0x290a35[_0x5b9606(0xc7)])_0x270be7[_0x5b9606(0xbc)]+=_0x290a35[_0x5b9606(0xc7)];_0x290a35['role']&&(_0x270be7['role']=_0x290a35[_0x5b9606(0x9d)]),_0x270be7[_0x5b9606(0x9e)]=_0x557a5d;}_0xace002&&_0xace002({'text':_0x270be7[_0x5b9606(0xbc)]});}}catch(_0x40ca2d){console[_0x5b9606(0xd9)](_0x5b9606(0xd5),_0x4fadc2);}}});let _0x5c108e='';_0x1f6cbc[_0x23963a(0xaf)](_0x3300aa=>{const _0x1ee74e=_0x23963a;_0x5c108e+=_0x3300aa[_0x1ee74e(0xc7)]+'\x20';}),_0x4e48de['on'](_0x23963a(0xc6),()=>{const _0xcacfc4=_0x23963a;if(_0x270be7[_0xcacfc4(0x9e)]&&_0x270be7[_0xcacfc4(0xbc)]){const _0x37e150=getTokenCount(_0x5c108e),_0x4e0d1f=getTokenCount(_0x270be7['text']);_0x270be7['detail'][_0xcacfc4(0xac)]={'prompt_tokens':_0x37e150,'completion_tokens':_0x4e0d1f,'total_tokens':_0x37e150+_0x4e0d1f,'estimated':!![]};}return _0x4fd326(_0x270be7);});}catch(_0x291cd0){_0x58429b(_0x291cd0);}});}}exports[_0x3c9fbf(0xc5)]=sendMessageFromOpenAi;function getTokenCount(_0x15de17){const _0x3252dc=_0x3c9fbf;if(!_0x15de17)return 0x0;return typeof _0x15de17!=='string'&&(_0x15de17=String(_0x15de17)),_0x15de17=_0x15de17[_0x3252dc(0xd6)](/<\|endoftext\|>/g,''),tokenizer[_0x3252dc(0xb0)](_0x15de17)[_0x3252dc(0xc0)];}function _0x5c02(_0x585816,_0x1d6f0e){const _0x17ee96=_0x17ee();return _0x5c02=function(_0x5c0242,_0x13be9b){_0x5c0242=_0x5c0242-0x9a;let _0x3908d3=_0x17ee96[_0x5c0242];return _0x3908d3;},_0x5c02(_0x585816,_0x1d6f0e);}exports[_0x3c9fbf(0xa4)]=getTokenCount;