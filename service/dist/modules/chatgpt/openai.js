'use strict';const _0x15e9d5=_0x1c07;(function(_0xa84751,_0x57d43d){const _0xd8d1f5=_0x1c07,_0x4e25e5=_0xa84751();while(!![]){try{const _0x19175f=parseInt(_0xd8d1f5(0x1d8))/0x1+parseInt(_0xd8d1f5(0x1ef))/0x2*(-parseInt(_0xd8d1f5(0x1fc))/0x3)+-parseInt(_0xd8d1f5(0x1cd))/0x4+-parseInt(_0xd8d1f5(0x1e4))/0x5+parseInt(_0xd8d1f5(0x1bf))/0x6+-parseInt(_0xd8d1f5(0x1fb))/0x7*(-parseInt(_0xd8d1f5(0x1e8))/0x8)+parseInt(_0xd8d1f5(0x1c0))/0x9;if(_0x19175f===_0x57d43d)break;else _0x4e25e5['push'](_0x4e25e5['shift']());}catch(_0x17ac19){_0x4e25e5['push'](_0x4e25e5['shift']());}}}(_0xd6ff,0x6c8c5));Object['defineProperty'](exports,_0x15e9d5(0x1bd),{'value':!![]}),exports['getTokenCount']=exports[_0x15e9d5(0x1d2)]=void 0x0;const axios_1=require('axios'),tiktoken_1=require(_0x15e9d5(0x1fe)),common_1=require(_0x15e9d5(0x1d0)),uuid=require(_0x15e9d5(0x1e2)),tokenizer=(0x0,tiktoken_1[_0x15e9d5(0x1fd)])(_0x15e9d5(0x1cb));function getFullUrl(_0x2d148e){const _0x20493c=_0x15e9d5,_0x55790f=_0x2d148e[_0x20493c(0x1e3)]('/')?_0x2d148e[_0x20493c(0x1e0)](0x0,-0x1):_0x2d148e,_0xca4852=_0x55790f||_0x20493c(0x1f7);return _0xca4852+_0x20493c(0x1da);}function _0xd6ff(){const _0x2f61c9=['801523dBxzyG','图片上传成功，URL:\x20','/v1/chat/completions','绘制图片失败，此次绘画被拒绝了！','message','base64','openai-draw\x20error:\x20','content','slice','delta','uuid','endsWith','1057035MQcpyD','choices','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','split','5869448hzMweB','stream','from','Bearer\x20','Billing\x20hard\x20limit\x20has\x20been\x20reached','stop','上传图片过程中出现错误:\x20','2042jBOHDA','application/json','uploadFile','error','POST','绘制图片失败，请检查你的提示词是否有非法描述！','length','getTokenCount','https://api.openai.com','Logger','当前请求已过载、请稍等会儿再试试吧！','default','7sCcPhL','2412QcavSE','get_encoding','@dqbd/tiktoken','parse','encode','role','__esModule','detail','579024bHheqn','2565657dmajRn','[DONE]','debug','stringify','max_tokens','includes','trim','b64_json','replace','response','MidjourneyService','cl100k_base','parse\x20Error','1759508hXxfRW','text','gpt-4-vision-preview','@nestjs/common','data','sendMessageFromOpenAi','data:','.png','forEach','end','imageUrl'];_0xd6ff=function(){return _0x2f61c9;};return _0xd6ff();}function _0x1c07(_0x47c43a,_0x1dfa60){const _0xd6ff29=_0xd6ff();return _0x1c07=function(_0x1c07e6,_0x1e8109){_0x1c07e6=_0x1c07e6-0x1ba;let _0x563fca=_0xd6ff29[_0x1c07e6];return _0x563fca;},_0x1c07(_0x47c43a,_0x1dfa60);}async function sendMessageFromOpenAi(_0x348194,_0x3b7e0c,_0x571861){const _0x58f012=_0x15e9d5;var _0x1a5bc2,_0x547224,_0x22d2c8,_0x3742c5;const {onProgress:_0xe1921d,maxToken:_0x28bb47,apiKey:_0x2579a7,model:_0x387d5f,temperature:temperature=0.8,proxyUrl:_0x20bb1b,prompt:_0x131612}=_0x3b7e0c;if(_0x387d5f[_0x58f012(0x1c5)]('dall')){let _0xc9ee1c={'text':'','imageUrl':''};try{const _0x3485ef={'method':_0x58f012(0x1f3),'url':_0x20bb1b+'/v1/images/generations','headers':{'Content-Type':_0x58f012(0x1f0),'Authorization':_0x58f012(0x1eb)+_0x2579a7},'data':{'prompt':_0x131612,'model':_0x387d5f,'response_format':_0x58f012(0x1c7)}},_0x2f3fb3=await(0x0,axios_1[_0x58f012(0x1fa)])(_0x3485ef),{b64_json:_0x43fa34,revised_prompt:_0x4f76fb}=_0x2f3fb3[_0x58f012(0x1d1)][_0x58f012(0x1d1)][0x0],_0x49354e=Buffer[_0x58f012(0x1ea)](_0x43fa34,_0x58f012(0x1dd));let _0xe3a7f9='';try{const _0x1fe9b0=uuid['v4']()['slice'](0x0,0xa)+_0x58f012(0x1d4);common_1[_0x58f012(0x1f8)][_0x58f012(0x1c2)]('------>\x20开始上传图片！！！',_0x58f012(0x1ca));const _0x490b6f=Buffer[_0x58f012(0x1ea)](_0x43fa34,_0x58f012(0x1dd));_0xe3a7f9=await _0x571861[_0x58f012(0x1f1)]({'filename':_0x1fe9b0,'buffer':_0x490b6f}),common_1[_0x58f012(0x1f8)]['debug'](_0x58f012(0x1d9)+_0xe3a7f9,_0x58f012(0x1ca));}catch(_0x14af11){common_1[_0x58f012(0x1f8)][_0x58f012(0x1f2)](_0x58f012(0x1ee)+_0x14af11,'MidjourneyService');}return _0xc9ee1c[_0x58f012(0x1d7)]=_0xe3a7f9,_0xc9ee1c['text']=_0x4f76fb,_0xe1921d&&_0xe1921d({'text':_0xc9ee1c['text']}),_0xc9ee1c;}catch(_0x445fde){const _0x44f029=((_0x1a5bc2=_0x445fde===null||_0x445fde===void 0x0?void 0x0:_0x445fde[_0x58f012(0x1c9)])===null||_0x1a5bc2===void 0x0?void 0x0:_0x1a5bc2['status'])||0x1f4;console['log'](_0x58f012(0x1de),JSON[_0x58f012(0x1c3)](_0x445fde),_0x44f029);const _0x444954=(_0x3742c5=(_0x22d2c8=(_0x547224=_0x445fde===null||_0x445fde===void 0x0?void 0x0:_0x445fde[_0x58f012(0x1c9)])===null||_0x547224===void 0x0?void 0x0:_0x547224[_0x58f012(0x1d1)])===null||_0x22d2c8===void 0x0?void 0x0:_0x22d2c8[_0x58f012(0x1f2)])===null||_0x3742c5===void 0x0?void 0x0:_0x3742c5[_0x58f012(0x1dc)];if(_0x44f029===0x1ad)return _0xc9ee1c[_0x58f012(0x1ce)]=_0x58f012(0x1f9),_0xc9ee1c;if(_0x44f029===0x190&&_0x444954[_0x58f012(0x1c5)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0xc9ee1c[_0x58f012(0x1ce)]=_0x58f012(0x1e6),_0xc9ee1c;if(_0x44f029===0x190&&_0x444954[_0x58f012(0x1c5)](_0x58f012(0x1ec)))return _0xc9ee1c[_0x58f012(0x1ce)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0xc9ee1c;if(_0x44f029===0x1f4)return _0xc9ee1c['text']=_0x58f012(0x1f4),_0xc9ee1c;if(_0x44f029===0x191)return _0xc9ee1c['text']=_0x58f012(0x1db),_0xc9ee1c;return _0xc9ee1c[_0x58f012(0x1ce)]='绘制图片失败，请稍后试试吧！',_0xc9ee1c;}}else{let _0x4c4615={'text':''};const _0x4ad4f1={'method':_0x58f012(0x1f3),'url':getFullUrl(_0x20bb1b),'responseType':_0x58f012(0x1e9),'headers':{'Content-Type':_0x58f012(0x1f0),'Accept':_0x58f012(0x1f0),'Authorization':_0x58f012(0x1eb)+_0x2579a7},'data':{'stream':!![],'temperature':temperature,'model':_0x387d5f,'messages':_0x348194}};return _0x387d5f===_0x58f012(0x1cf)&&(_0x4ad4f1['data'][_0x58f012(0x1c4)]=0x800),new Promise(async(_0x2ce4d9,_0x583986)=>{const _0x434654=_0x58f012;try{const _0x53c4a4=await(0x0,axios_1[_0x434654(0x1fa)])(_0x4ad4f1),_0xe82909=_0x53c4a4['data'];_0xe82909['on']('data',_0x538815=>{const _0xa80556=_0x434654;var _0x253f27;const _0x7b41c9=_0x538815['toString']()[_0xa80556(0x1e7)]('\x0a\x0a')['filter'](_0x1d4f2f=>_0x1d4f2f[_0xa80556(0x1c6)]()!=='');for(const _0x2d7a2f of _0x7b41c9){const _0x1da04e=_0x2d7a2f[_0xa80556(0x1c8)](_0xa80556(0x1d3),'');let _0x2eda48=![];try{_0x2eda48=JSON[_0xa80556(0x1ba)](_0x1da04e)[_0xa80556(0x1e5)][0x0]['finish_reason']===_0xa80556(0x1ed);}catch(_0x1ed03b){_0x2eda48=![];}if(_0x2eda48)return _0x4c4615[_0xa80556(0x1ce)]=_0x4c4615[_0xa80556(0x1ce)][_0xa80556(0x1c6)](),_0x4c4615;try{if(_0x1da04e!=='\x20[DONE]'&&_0x1da04e!==_0xa80556(0x1c1)&&_0x1da04e!='[DONE]\x20'){const _0xa99ce1=JSON[_0xa80556(0x1ba)](_0x1da04e);_0xa99ce1['id']&&(_0x4c4615['id']=_0xa99ce1['id']);if((_0x253f27=_0xa99ce1[_0xa80556(0x1e5)])===null||_0x253f27===void 0x0?void 0x0:_0x253f27[_0xa80556(0x1f5)]){const _0x2d6cd0=_0xa99ce1[_0xa80556(0x1e5)][0x0][_0xa80556(0x1e1)];_0x4c4615[_0xa80556(0x1e1)]=_0x2d6cd0[_0xa80556(0x1df)];if(_0x2d6cd0===null||_0x2d6cd0===void 0x0?void 0x0:_0x2d6cd0[_0xa80556(0x1df)])_0x4c4615['text']+=_0x2d6cd0[_0xa80556(0x1df)];_0x2d6cd0[_0xa80556(0x1bc)]&&(_0x4c4615[_0xa80556(0x1bc)]=_0x2d6cd0[_0xa80556(0x1bc)]),_0x4c4615[_0xa80556(0x1be)]=_0xa99ce1;}_0xe1921d&&_0xe1921d({'text':_0x4c4615[_0xa80556(0x1ce)]});}}catch(_0x496cd2){console['log'](_0xa80556(0x1cc),_0x1da04e);}}});let _0x5d5599='';_0x348194[_0x434654(0x1d5)](_0x486cde=>{const _0xb76eba=_0x434654;_0x5d5599+=_0x486cde[_0xb76eba(0x1df)]+'\x20';}),_0xe82909['on'](_0x434654(0x1d6),()=>{const _0x550534=_0x434654;if(_0x4c4615[_0x550534(0x1be)]&&_0x4c4615[_0x550534(0x1ce)]){const _0x5adab2=getTokenCount(_0x5d5599),_0x1a3e03=getTokenCount(_0x4c4615[_0x550534(0x1ce)]);_0x4c4615['detail']['usage']={'prompt_tokens':_0x5adab2,'completion_tokens':_0x1a3e03,'total_tokens':_0x5adab2+_0x1a3e03,'estimated':!![]};}return _0x2ce4d9(_0x4c4615);});}catch(_0x532271){_0x583986(_0x532271);}});}}exports[_0x15e9d5(0x1d2)]=sendMessageFromOpenAi;function getTokenCount(_0xafa897){const _0x17fe2d=_0x15e9d5;if(!_0xafa897)return 0x0;return typeof _0xafa897!=='string'&&(_0xafa897=String(_0xafa897)),_0xafa897=_0xafa897[_0x17fe2d(0x1c8)](/<\|endoftext\|>/g,''),tokenizer[_0x17fe2d(0x1bb)](_0xafa897)['length'];}exports[_0x15e9d5(0x1f6)]=getTokenCount;