'use strict';const _0x4eeae9=_0x217a;(function(_0x590a25,_0x206c69){const _0x3d000f=_0x217a,_0x5cf1dc=_0x590a25();while(!![]){try{const _0xa9da73=-parseInt(_0x3d000f(0x1b9))/0x1*(-parseInt(_0x3d000f(0x1ce))/0x2)+parseInt(_0x3d000f(0x1a9))/0x3*(parseInt(_0x3d000f(0x1ae))/0x4)+parseInt(_0x3d000f(0x1a3))/0x5*(parseInt(_0x3d000f(0x1b8))/0x6)+parseInt(_0x3d000f(0x1b3))/0x7*(parseInt(_0x3d000f(0x1c6))/0x8)+parseInt(_0x3d000f(0x1ca))/0x9*(-parseInt(_0x3d000f(0x1be))/0xa)+parseInt(_0x3d000f(0x1b1))/0xb+parseInt(_0x3d000f(0x19d))/0xc*(-parseInt(_0x3d000f(0x1a1))/0xd);if(_0xa9da73===_0x206c69)break;else _0x5cf1dc['push'](_0x5cf1dc['shift']());}catch(_0x2b53b6){_0x5cf1dc['push'](_0x5cf1dc['shift']());}}}(_0x3417,0x4f55f));function _0x3417(){const _0x4224c1=['__esModule','splice','6mFntSX','getData','getUuid','gemini-pro','content','1214812twskjZ','encode','reduce','3235496WyLoso','gpt-4-vision-preview','308707pvrbtd','includes','NineStore','some','setData','558zrnmBb','9421erdJsT','claude-3-5-sonnet-20240620','generateKey','get','text','3310JBWUOY','replace','join','filter','hunyuan','buildMessageFromParentMessageId','_getTokenCount','length','88TZQPmd','map','expires','formatOptions','10386zNtAqA','uuid','user','parentMessageId','64ujnFRX','slice','@dqbd/tiktoken','get_encoding','concat','assistant','log','namespace','push','4317972nHoxXq','set','image_url','gpt-4o-all','39HuFEKr','cl100k_base','5285wAnxxT','type','_recursivePruning','store'];_0x3417=function(){return _0x4224c1;};return _0x3417();}Object['defineProperty'](exports,_0x4eeae9(0x1a7),{'value':!![]}),exports['NineStore']=void 0x0;const uuid_1=require(_0x4eeae9(0x1cb)),tiktoken_1=require(_0x4eeae9(0x196)),tokenizer=(0x0,tiktoken_1[_0x4eeae9(0x197)])(_0x4eeae9(0x1a2));class NineStore{constructor(_0x4e46e7){const _0x89d8f6=_0x4eeae9,{store:_0x4db872,namespace:_0x1ef7c3,expires:_0xee524c}=this[_0x89d8f6(0x1c9)](_0x4e46e7);this['store']=_0x4db872,this['namespace']=_0x1ef7c3,this[_0x89d8f6(0x1c8)]=_0xee524c;}[_0x4eeae9(0x1c9)](_0x2eceeb){const {store:_0xc2ed10,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x2eceeb;return{'store':_0xc2ed10,'namespace':namespace,'expires':expires};}[_0x4eeae9(0x1bb)](_0x55af69){const _0x417e97=_0x4eeae9;return this[_0x417e97(0x19b)]?this[_0x417e97(0x19b)]+'-'+_0x55af69:_0x55af69;}async['getData'](_0x24d602){const _0x5b605f=_0x4eeae9,_0x32729a=await this['store'][_0x5b605f(0x1bc)](_0x24d602);return _0x32729a;}async[_0x4eeae9(0x1b7)](_0x4c661a,_0x4ba63d=this['expires']){const _0xc03f9b=_0x4eeae9;await this[_0xc03f9b(0x1a6)][_0xc03f9b(0x19e)](_0x4c661a['id'],_0x4c661a,_0x4ba63d);}async[_0x4eeae9(0x1c3)](_0x529b3c,_0x58bc04){const _0x4fd2fd=_0x4eeae9;let {maxRounds:_0x508639,maxModelToken:_0x2b6693,maxResponseTokens:_0x3cabca,systemMessage:systemMessage='',name:_0x532e49,imageUrl:_0x1e80e5,model:_0x3c993b,activeModel:_0x54d00e}=_0x58bc04,{parentMessageId:_0x2e7b80}=_0x58bc04,_0x11360a=[],_0x20a01e=0x0;if(systemMessage){const _0x3c32d5=[_0x4fd2fd(0x1ac),'ERNIE',_0x4fd2fd(0x1c2)],_0x588b77=_0x54d00e&&_0x3c32d5[_0x4fd2fd(0x1b6)](_0x4ea9df=>_0x54d00e['includes'](_0x4ea9df));_0x588b77?(_0x11360a[_0x4fd2fd(0x19c)]({'role':_0x4fd2fd(0x1cc),'content':systemMessage,'name':_0x532e49}),_0x11360a[_0x4fd2fd(0x19c)]({'role':_0x4fd2fd(0x199),'content':'好的','name':_0x532e49})):_0x11360a[_0x4fd2fd(0x19c)]({'role':'system','content':systemMessage,'name':_0x532e49});}const _0x36d14d=_0x11360a[_0x4fd2fd(0x1c5)];let _0x77d4ad=0x0;const _0x1ab621=[_0x4fd2fd(0x1b2),'gpt-4o',_0x4fd2fd(0x1ba)];if(_0x1ab621['includes'](_0x54d00e)&&_0x1e80e5){const _0x24b6c7=[{'type':'text','text':_0x529b3c},{'type':_0x4fd2fd(0x19f),'image_url':{'url':_0x1e80e5}}];_0x11360a[_0x4fd2fd(0x19c)]({'role':_0x4fd2fd(0x1cc),'content':_0x24b6c7,'name':_0x532e49});}else{if(_0x1ab621[_0x4fd2fd(0x1b4)](_0x54d00e)&&!_0x1e80e5){const _0x45092c=[{'type':_0x4fd2fd(0x1bd),'text':_0x529b3c}];_0x11360a[_0x4fd2fd(0x19c)]({'role':'user','content':_0x45092c,'name':_0x532e49});}else(_0x3c993b==='gpt-4-all'||_0x3c993b===_0x4fd2fd(0x1a0))&&_0x1e80e5&&(_0x529b3c=_0x1e80e5+'\x0a'+_0x529b3c),_0x11360a[_0x4fd2fd(0x19c)]({'role':'user','content':_0x529b3c,'name':_0x532e49});}let _0x4fe638=_0x11360a;do{if(!_0x2e7b80)break;const _0x37cc5a=await this[_0x4fd2fd(0x1aa)](_0x2e7b80);if(!_0x37cc5a)break;const {text:_0xbdc992,name:_0x444bdc,role:_0x23df0b,imageUrl:_0x2edca5}=_0x37cc5a;let _0xa8c30=_0xbdc992;if(_0x2edca5)_0x1ab621[_0x4fd2fd(0x1b4)](_0x54d00e)&&(_0x23df0b==='assistant'?_0xa8c30=[{'type':'text','text':_0xbdc992}]:_0xa8c30=[{'type':'text','text':_0xbdc992},{'type':_0x4fd2fd(0x19f),'image_url':{'url':_0x2edca5}}]);else!_0x2edca5&&_0x1ab621['includes'](_0x54d00e)&&(_0xa8c30=[{'type':_0x4fd2fd(0x1bd),'text':_0xbdc992}]);_0x4fe638=_0x4fe638['slice'](0x0,_0x36d14d)[_0x4fd2fd(0x198)]([{'role':_0x23df0b,'content':_0xa8c30,'name':_0x444bdc},..._0x4fe638[_0x4fd2fd(0x195)](_0x36d14d)]),_0x77d4ad++;if(_0x508639&&_0x77d4ad>=_0x508639)break;if(_0x2b6693&&_0x3cabca){const _0x51e3d8=_0x2b6693-_0x3cabca;_0x20a01e=await this[_0x4fd2fd(0x1c4)](_0x4fe638);const _0x696c4c=_0x20a01e+0xc8<=_0x51e3d8;!_0x696c4c&&(_0x4fe638=this[_0x4fd2fd(0x1a5)](_0x4fe638,_0x51e3d8,systemMessage));}_0x2e7b80=_0x37cc5a[_0x4fd2fd(0x1cd)];}while(!![]);const _0x4b78f1=Math['max'](0x1,Math['min'](_0x2b6693-_0x20a01e,_0x3cabca));return console[_0x4fd2fd(0x19a)]('本次携带上下文的长度',_0x4fe638[_0x4fd2fd(0x1c5)],_0x20a01e),{'context':_0x4fe638,'round':_0x4fe638[_0x4fd2fd(0x1c5)],'historyToken':_0x20a01e};}[_0x4eeae9(0x1c4)](_0xe21a97){const _0x49c154=_0x4eeae9;let _0x14e0d4=_0xe21a97[_0x49c154(0x1b0)]((_0x360ad8,_0x290d93)=>{const _0x4ebf41=_0x49c154;if(Array['isArray'](_0x290d93[_0x4ebf41(0x1ad)])){const _0x45f5e0=_0x290d93[_0x4ebf41(0x1ad)][_0x4ebf41(0x1c1)](_0x10aa25=>_0x10aa25[_0x4ebf41(0x1a4)]==='text')[_0x4ebf41(0x1c7)](_0x22be08=>_0x22be08[_0x4ebf41(0x1bd)])[_0x4ebf41(0x1c0)]('\x20');return _0x360ad8+_0x45f5e0;}else return _0x360ad8+(_0x290d93['content']||'');},'');return _0x14e0d4=_0x14e0d4[_0x49c154(0x1bf)](/<\|endoftext\|>/g,''),tokenizer[_0x49c154(0x1af)](_0x14e0d4)['length'];}[_0x4eeae9(0x1a5)](_0x405a70,_0x3ff6dd,_0x560d3c){const _0x1ff7e2=_0x4eeae9,_0x5844f8=this[_0x1ff7e2(0x1c4)](_0x405a70);if(_0x5844f8<=_0x3ff6dd)return _0x405a70;return _0x405a70[_0x1ff7e2(0x1a8)](_0x560d3c?0x1:0x0,0x1),this[_0x1ff7e2(0x1a5)](_0x405a70,_0x3ff6dd,_0x560d3c);}[_0x4eeae9(0x1ab)](){return(0x0,uuid_1['v4'])();}}function _0x217a(_0x398124,_0x1d2bc8){const _0x34171c=_0x3417();return _0x217a=function(_0x217a59,_0x1aa7ef){_0x217a59=_0x217a59-0x195;let _0x1c4d92=_0x34171c[_0x217a59];return _0x1c4d92;},_0x217a(_0x398124,_0x1d2bc8);}exports[_0x4eeae9(0x1b5)]=NineStore;