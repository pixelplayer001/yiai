'use strict';const _0x4d3f18=_0x1303;(function(_0x578ff9,_0x122797){const _0x29b8c1=_0x1303,_0x49f34b=_0x578ff9();while(!![]){try{const _0x3f0a7e=parseInt(_0x29b8c1(0x276))/0x1*(-parseInt(_0x29b8c1(0x2a4))/0x2)+-parseInt(_0x29b8c1(0x23b))/0x3*(parseInt(_0x29b8c1(0x2c6))/0x4)+-parseInt(_0x29b8c1(0x2c7))/0x5*(parseInt(_0x29b8c1(0x1e6))/0x6)+parseInt(_0x29b8c1(0x269))/0x7+-parseInt(_0x29b8c1(0x27b))/0x8*(parseInt(_0x29b8c1(0x20e))/0x9)+-parseInt(_0x29b8c1(0x236))/0xa+parseInt(_0x29b8c1(0x23a))/0xb*(parseInt(_0x29b8c1(0x28a))/0xc);if(_0x3f0a7e===_0x122797)break;else _0x49f34b['push'](_0x49f34b['shift']());}catch(_0x2d6edb){_0x49f34b['push'](_0x49f34b['shift']());}}}(_0x2c53,0x32137));function _0x2c53(){const _0x2fc4d6=['nestjs-config','Logger','绘制图片失败，此次绘画被拒绝了！','当前分类下有未处理数据不可移除！','openaiModel3MaxTokensRes','toISOString','formatModelToken','nineai-chatlog','GptKeysEntity','is_end','chatProcess','data','ChatPreTypeEntity','assistant','uploadFile','1419068QQzBgc','update','model4','usage','metadata','default','user','../../common/constants/errorMessage.constant','./baidu','DeductionKey','./openai','gpt-4','status','10527mMqdtd','__param','defineProperty','buildMessageFromParentMessageId','ChatPreEntity','224152bVsrlC','split','chatBoxEntity','statusText:','queryChatPreList','getRequestParams','prompt','key','config','InjectRepository','../fanyi/fanyi.service','sendMessageFromZhipu','globalConfigService','当前请求已过载、请稍等会儿再试试吧！','Too\x20Many\x20Requests','24PdHSPw','close','weight','getClientIp','includes','childList','object','./chatBox.entity','delChatBox','post','fanyiService','configService','chatBoxTypeEntity','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','lockKey','appId','statusCode','preset','../app/app.entity','DrawService','UploadService','Bearer\x20','../../common/constants/balance.constant','32k','ChatgptService','dall-e\x20draw\x20params:\x20','20NMXOAP','appInfo','./../user/user.service','用户ID:\x20','gpt-4-1106','getBaseConfig','FanyiService','.png','ChatLogService','1106','text','__esModule','sendMessageFromOpenAi','model','badwordsService','keyv','userBanance','openaiProxyUrl','./chatPreType.entity','deductFromBalance','compileNetwork','error:\x20','draw\x20paompt\x20info\x20<==**==>\x20','setChatBox','nineStore','log','statusText','getUuid','gpt-3','getOwnPropertyDescriptor','setData','Billing\x20hard\x20limit\x20has\x20been\x20reached','onModuleInit','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','4IXeECq','250VsQCQN','HttpStatus','\x20模型名称:\x20','keyPool','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','userBalanceService',',\x20key\x20===>\x20','queryChatPre','BadwordsService','conversationId','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','map','save','ConfigService','configEntity','filter','Incorrect\x20API\x20key\x20provided','BAD_REQUEST','openai-draw\x20error:\x20','当前模型不是聊天模型','UserService','@keyv/redis','PAINT_TYPE','length','mjDraw','assign','push','forEach','DESC','getTokenCount','validateBalance','UserBalanceService','quality','提供了错误的模型秘钥','./store','response','chatGroupService','5418DObYEG','绘制图片失败，请检查你的提示词是否有非法描述！','getConfigs','./../upload/upload.service','proxyUrl','abortController','getCurrentModelKeyInfo','axios','typeInfo','ModelsService','chatPreEntity','./chatPre.entity','REDIS_USER','saveUseLog','openaiModel4MaxTokens','CHAT_TYPE','floor','importDynamic','whiteListUser','typeId','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','env','base64','stringify','缺失必要参数！','chatSyncFree','end','all','./chatBoxType.entity','size','服务异常、请重新试试吧！！！','Please\x20check\x20the\x20back-end\x20console','setHeader',',\x20消耗积分：\x20','userService','addOneIfOdd','chatPreTypeEntity','./helper','16k','当前模型key已被封禁','27DoPdrv','../autoreply/autoreply.service','../chatGroup/chatGroup.service','uploadService','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','openaiModel4MaxTokens32k','find','queryChatBoxFrontend','saveChatLog','delete','HttpException','dall-e-3','uuid','gptKeysEntity','imageUrl','getUploadType','../chatLog/chatLog.service','当前模型key余额已耗尽','\x0a\x20Current\x20date:\x20','message','/v1/images/generations','b64_json','code:\x20','findOne','../globalConfig/config.entity','modelsService','../userBalance/userBalance.service','openaiModel3MaxTokens16k','dall','modelInfo','openaiTimeoutMs','autoreplyService','checkBadWords','getRandomDrawKey','REDIS_HOST','setChatPre','当前模型调用过于频繁、请重新试试吧！','@nestjs/typeorm','write','sendMessageFromBaidu','2706470GYxLLU','chatLogService','../models/models.service','getMaxTokenFromModelWithOpenAi','3065150mezRbp','149367iNAtzn','openaiBaseUrl','toLowerCase','standard','./gptkeys.entity','chat-error\x20<----------------------------------------->','queryChatBoxType','delChatPreType','gpt-4-vision-preview','checkUserStatus','ceil','非法操作！','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','__decorate','detail','Repository','queryChatBox','绘制图片失败，请稍后试试吧！','systemPreMessage','setChatPreType','function','appEntity','ConfigEntity','REDIS_PORT','parse','count','OpenAiErrorCodeMessage','getModelProxyUrl','../../common/utils','decorate'];_0x2c53=function(){return _0x2fc4d6;};return _0x2c53();}var __decorate=this&&this[_0x4d3f18(0x249)]||function(_0x21828e,_0x102076,_0x42ea39,_0x168af0){const _0x58eb5b=_0x4d3f18;var _0x4f56fe=arguments[_0x58eb5b(0x2de)],_0x10365b=_0x4f56fe<0x3?_0x102076:_0x168af0===null?_0x168af0=Object[_0x58eb5b(0x2c1)](_0x102076,_0x42ea39):_0x168af0,_0x2f272a;if(typeof Reflect==='object'&&typeof Reflect[_0x58eb5b(0x259)]===_0x58eb5b(0x250))_0x10365b=Reflect[_0x58eb5b(0x259)](_0x21828e,_0x102076,_0x42ea39,_0x168af0);else{for(var _0x903247=_0x21828e[_0x58eb5b(0x2de)]-0x1;_0x903247>=0x0;_0x903247--)if(_0x2f272a=_0x21828e[_0x903247])_0x10365b=(_0x4f56fe<0x3?_0x2f272a(_0x10365b):_0x4f56fe>0x3?_0x2f272a(_0x102076,_0x42ea39,_0x10365b):_0x2f272a(_0x102076,_0x42ea39))||_0x10365b;}return _0x4f56fe>0x3&&_0x10365b&&Object[_0x58eb5b(0x278)](_0x102076,_0x42ea39,_0x10365b),_0x10365b;},__metadata=this&&this['__metadata']||function(_0xb163e6,_0x1e3678){const _0x4133e7=_0x4d3f18;if(typeof Reflect===_0x4133e7(0x290)&&typeof Reflect[_0x4133e7(0x26d)]===_0x4133e7(0x250))return Reflect[_0x4133e7(0x26d)](_0xb163e6,_0x1e3678);},__param=this&&this[_0x4d3f18(0x277)]||function(_0x29d095,_0x425804){return function(_0x3951c1,_0x5aa350){_0x425804(_0x3951c1,_0x5aa350,_0x29d095);};};Object[_0x4d3f18(0x278)](exports,_0x4d3f18(0x2af),{'value':!![]}),exports[_0x4d3f18(0x2a2)]=void 0x0;const upload_service_1=require(_0x4d3f18(0x1e9)),user_service_1=require(_0x4d3f18(0x2a6)),nestjs_config_1=require(_0x4d3f18(0x25a)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x4d3f18(0x270)),utils_1=require(_0x4d3f18(0x258)),axios_1=require(_0x4d3f18(0x1ed)),userBalance_service_1=require(_0x4d3f18(0x228)),balance_constant_1=require(_0x4d3f18(0x2a0)),chatLog_service_1=require(_0x4d3f18(0x21e)),uuid=require(_0x4d3f18(0x21a)),config_entity_1=require(_0x4d3f18(0x226)),typeorm_1=require('typeorm'),typeorm_2=require(_0x4d3f18(0x233)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x4d3f18(0x20f)),gptkeys_entity_1=require(_0x4d3f18(0x23f)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),fanyi_service_1=require(_0x4d3f18(0x285)),app_entity_1=require(_0x4d3f18(0x29c)),chatGroup_service_1=require(_0x4d3f18(0x210)),models_service_1=require(_0x4d3f18(0x238)),baidu_1=require(_0x4d3f18(0x271)),helper_1=require(_0x4d3f18(0x20b)),store_1=require(_0x4d3f18(0x1e3)),zhipu_1=require('./zhipu'),openai_1=require(_0x4d3f18(0x273)),chatBoxType_entity_1=require(_0x4d3f18(0x202)),chatBox_entity_1=require(_0x4d3f18(0x291)),chatPre_entity_1=require(_0x4d3f18(0x1f1)),chatPreType_entity_1=require(_0x4d3f18(0x2b6));function _0x1303(_0x3dce6f,_0x8c0921){const _0x2c538a=_0x2c53();return _0x1303=function(_0x130313,_0x456c7c){_0x130313=_0x130313-0x1e0;let _0x1bff35=_0x2c538a[_0x130313];return _0x1bff35;},_0x1303(_0x3dce6f,_0x8c0921);}let ChatgptService=class ChatgptService{constructor(_0x9ef9a8,_0x56de77,_0x6357d0,_0x515458,_0x4c5664,_0xaaef79,_0xd7a3cc,_0x5ab690,_0x478d5f,_0x19cbc3,_0x39c494,_0x2514a3,_0x5510e4,_0x502585,_0x540230,_0xcb3250,_0x2050c9,_0x94bca3){const _0x1140ab=_0x4d3f18;this[_0x1140ab(0x21b)]=_0x9ef9a8,this[_0x1140ab(0x2d5)]=_0x56de77,this[_0x1140ab(0x296)]=_0x6357d0,this['chatBoxEntity']=_0x515458,this['appEntity']=_0x4c5664,this[_0x1140ab(0x20a)]=_0xaaef79,this[_0x1140ab(0x1f0)]=_0xd7a3cc,this[_0x1140ab(0x295)]=_0x5ab690,this[_0x1140ab(0x2cc)]=_0x478d5f,this[_0x1140ab(0x237)]=_0x19cbc3,this[_0x1140ab(0x208)]=_0x39c494,this['uploadService']=_0x2514a3,this[_0x1140ab(0x2b2)]=_0x5510e4,this[_0x1140ab(0x22d)]=_0x502585,this['globalConfigService']=_0x540230,this[_0x1140ab(0x294)]=_0xcb3250,this['chatGroupService']=_0x2050c9,this[_0x1140ab(0x227)]=_0x94bca3,this[_0x1140ab(0x2bc)]=null,this[_0x1140ab(0x1f8)]=[],this['keyPool']={'list3':[],'list4':[]};}async[_0x4d3f18(0x2c4)](){const _0x54d55a=_0x4d3f18;let _0x1b19fe=await(0x0,utils_1[_0x54d55a(0x1f7)])('chatgpt-ai-web'),_0x323d78=await(0x0,utils_1[_0x54d55a(0x1f7)])(_0x54d55a(0x2dc)),_0x3fdce8=await(0x0,utils_1['importDynamic'])(_0x54d55a(0x2b3));_0x1b19fe=(_0x1b19fe===null||_0x1b19fe===void 0x0?void 0x0:_0x1b19fe['default'])?_0x1b19fe[_0x54d55a(0x26e)]:_0x1b19fe,_0x323d78=(_0x323d78===null||_0x323d78===void 0x0?void 0x0:_0x323d78[_0x54d55a(0x26e)])?_0x323d78[_0x54d55a(0x26e)]:_0x323d78,_0x3fdce8=(_0x3fdce8===null||_0x3fdce8===void 0x0?void 0x0:_0x3fdce8[_0x54d55a(0x26e)])?_0x3fdce8[_0x54d55a(0x26e)]:_0x3fdce8;const {ChatGPTAPI:_0x5d8b06,ChatGPTError:_0xde931c,ChatGPTUnofficialProxyAPI:_0x4e1791}=_0x1b19fe,_0x40d1a0=+process[_0x54d55a(0x1fb)][_0x54d55a(0x253)],_0x133535=process[_0x54d55a(0x1fb)][_0x54d55a(0x230)],_0x21c19b=process[_0x54d55a(0x1fb)]['REDIS_PASSWORD'],_0x321b4a=process[_0x54d55a(0x1fb)][_0x54d55a(0x1f2)],_0x1c9089='redis://'+(_0x321b4a||'')+':'+(_0x21c19b||'')+'@'+_0x133535+':'+_0x40d1a0,_0x406969=new _0x323d78(_0x1c9089),_0x4fbe7d=new _0x3fdce8({'store':_0x406969,'namespace':_0x54d55a(0x261)});this[_0x54d55a(0x2bc)]=new store_1['NineStore']({'store':_0x4fbe7d,'namespace':'chat'});}async[_0x4d3f18(0x280)](_0x492b36,_0x5894db,_0x3f6139,_0x5b95a9=null){const _0x12ebec=_0x4d3f18;var _0x59f9b2;!_0x5b95a9&&(_0x5b95a9=(_0x59f9b2=await this['modelsService'][_0x12ebec(0x2a9)]())===null||_0x59f9b2===void 0x0?void 0x0:_0x59f9b2[_0x12ebec(0x22b)]);const {timeout:timeout=0x3c}=_0x3f6139,{topN:_0x350880,model:_0x49e7ab}=_0x5b95a9,{parentMessageId:parentMessageId=0x0}=_0x492b36,_0x26d36b=await this[_0x12ebec(0x287)][_0x12ebec(0x1e8)]([_0x12ebec(0x22c)]),_0x11eb63=timeout*0x3e8||_0x26d36b||0x64*0x3e8,_0x8ee2a3={'parentMessageId':parentMessageId,'timeoutMs':+_0x11eb63,'completionParams':{'model':_0x49e7ab,'temperature':_0x350880}};return _0x5894db&&(_0x8ee2a3['systemMessage']=_0x5894db),_0x8ee2a3;}async[_0x4d3f18(0x1ff)](_0x37010c){const _0x407e41=_0x4d3f18,_0x1c7a0e=await this[_0x407e41(0x227)][_0x407e41(0x22f)](),_0x4095b1=await this[_0x407e41(0x287)][_0x407e41(0x1e8)]([_0x407e41(0x24e)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x2be021,model:_0x1ed0bb}=_0x1c7a0e,_0x15c5ac=await this[_0x407e41(0x257)](_0x1c7a0e),{context:_0x33cc86}=await this[_0x407e41(0x2bc)][_0x407e41(0x279)](_0x37010c,{'parentMessageId':'','systemMessage':_0x4095b1});try{const _0x134a80=await(0x0,openai_1[_0x407e41(0x2b0)])(_0x33cc86,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x2be021),'model':_0x1ed0bb,'proxyUrl':_0x15c5ac,'onProgress':null});return _0x134a80===null||_0x134a80===void 0x0?void 0x0:_0x134a80[_0x407e41(0x2ae)];}catch(_0xf16099){console[_0x407e41(0x2bd)](_0x407e41(0x2b9),_0xf16099);}}async[_0x4d3f18(0x264)](_0x43700f,_0x45e79b,_0x190501){const _0x51abc0=_0x4d3f18;var _0x1a7967,_0x56fb9e,_0x4e1350,_0xc9b5c9;const _0x46cd1d=_0x45e79b[_0x51abc0(0x1eb)],{options:options={},appId:_0x1e5a72,cusromPrompt:_0x169ccf,systemMessage:systemMessage=''}=_0x43700f;let _0x5e3f60=systemMessage;const {parentMessageId:_0x26b6c6}=options,{prompt:_0x99c75d,imageUrl:_0x3bf7b7,model:_0x6d895e}=_0x43700f,{groupId:_0xdd033a,usingNetwork:_0x427d38}=options,_0x52ad98=await this[_0x51abc0(0x1e5)]['getGroupInfoFromId'](_0xdd033a),_0x204b13=(_0x52ad98===null||_0x52ad98===void 0x0?void 0x0:_0x52ad98[_0x51abc0(0x283)])?JSON[_0x51abc0(0x254)](_0x52ad98[_0x51abc0(0x283)]):await this[_0x51abc0(0x227)][_0x51abc0(0x2a9)](),{keyType:_0x57faf9,model:_0x2eeb1c,topN:_0x581cbc,systemMessage:_0x387f6e,rounds:_0x5017b}=_0x204b13[_0x51abc0(0x22b)];let _0xce93c8=null;!_0x169ccf?_0xce93c8=await this[_0x51abc0(0x227)][_0x51abc0(0x1ec)](_0x2eeb1c):_0xce93c8=await this[_0x51abc0(0x227)][_0x51abc0(0x22f)]();if(!_0xce93c8)throw new common_1[(_0x51abc0(0x218))](_0x51abc0(0x1fa),common_1[_0x51abc0(0x2c8)][_0x51abc0(0x2d8)]);const {deduct:_0x19e847,isTokenBased:_0x2ab990,tokenFeeRatio:_0x56ebd9,deductType:_0x1b1484,key:_0x4fb0df,secret:_0x1a9ec7,modelName:_0x5c18b2,id:_0x531336,accessToken:_0x56a8a9}=_0xce93c8;await this[_0x51abc0(0x208)][_0x51abc0(0x244)](_0x45e79b[_0x51abc0(0x26f)]),await this['userBalanceService']['validateBalance'](_0x45e79b,_0x1b1484===0x1?'model3':_0x51abc0(0x26b),_0x19e847),_0x190501&&_0x190501[_0x51abc0(0x206)]('Content-type','application/octet-stream;\x20charset=utf-8'),await this[_0x51abc0(0x2b2)][_0x51abc0(0x22e)](_0x99c75d,_0x45e79b[_0x51abc0(0x26f)]['id']);const _0x131b8d=await this[_0x51abc0(0x22d)]['checkAutoReply'](_0x99c75d);if(_0x131b8d&&_0x190501){const _0x37ca1c={'message':_0x131b8d,'code':0x1f4};return _0x190501[_0x51abc0(0x234)](JSON[_0x51abc0(0x1fd)](_0x37ca1c)),_0x190501['end']();}if(_0x1e5a72){const _0x400360=await this[_0x51abc0(0x251)][_0x51abc0(0x225)]({'where':{'id':_0x1e5a72,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x400360)throw new common_1[(_0x51abc0(0x218))](_0x51abc0(0x2cb),common_1['HttpStatus'][_0x51abc0(0x2d8)]);_0x400360[_0x51abc0(0x29b)]&&(_0x5e3f60=_0x400360[_0x51abc0(0x29b)]);}else{if(_0x169ccf)_0x5e3f60=systemMessage;else{if(_0x387f6e)_0x5e3f60=_0x387f6e;else{const _0xbd9498=new Date()[_0x51abc0(0x25f)]()[_0x51abc0(0x27c)]('T')[0x0],_0x344b46=await this[_0x51abc0(0x287)]['getConfigs']([_0x51abc0(0x24e)]);_0x5e3f60=_0x344b46+('\x0a\x20Current\x20date:\x20'+_0xbd9498);}}}let _0x10d1b3='';if(_0x427d38){_0x10d1b3=await(0x0,utils_1[_0x51abc0(0x2b8)])(_0x99c75d);const _0x8abd10=new Date()[_0x51abc0(0x25f)]()[_0x51abc0(0x27c)]('T')[0x0],_0x152489=await this['globalConfigService'][_0x51abc0(0x1e8)]([_0x51abc0(0x24e)]);_0x5e3f60=_0x152489+(_0x51abc0(0x220)+_0x8abd10);}const _0x3ca62e=await this['getRequestParams'](options,_0x5e3f60,_0xce93c8,_0x204b13['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x3383ee}=_0xce93c8;_0x190501&&_0x190501[_0x51abc0(0x275)](0xc8);let _0x8a1f4a=null,_0x4a1a85=null;try{if(_0x190501){let _0x328a49=null,_0x5e209b=![];_0x190501['on'](_0x51abc0(0x28b),async()=>{const _0x29d314=_0x51abc0;if(_0x5e209b)return;_0x46cd1d['abort']();const _0x2e918a=await(0x0,openai_1[_0x29d314(0x2e4)])(_0x99c75d)||0x0,_0xc3b674=await(0x0,openai_1[_0x29d314(0x2e4)])(_0x328a49===null||_0x328a49===void 0x0?void 0x0:_0x328a49[_0x29d314(0x2ae)])||0x0,_0x2b8aaf=_0x2e918a+_0xc3b674,_0x1baf83=(0x0,utils_1[_0x29d314(0x28d)])(_0x45e79b);await this[_0x29d314(0x237)]['saveChatLog']({'appId':_0x1e5a72,'curIp':_0x1baf83,'userId':_0x45e79b[_0x29d314(0x26f)]['id'],'type':balance_constant_1[_0x29d314(0x272)]['CHAT_TYPE'],'prompt':_0x99c75d,'imageUrl':_0x3bf7b7,'activeModel':_0x6d895e,'answer':'','promptTokens':_0x2e918a,'completionTokens':0x0,'totalTokens':_0x2e918a,'model':_0x2eeb1c,'role':_0x29d314(0x26f),'groupId':_0xdd033a,'requestOptions':JSON[_0x29d314(0x1fd)]({'options':null,'prompt':_0x99c75d})}),await this[_0x29d314(0x237)][_0x29d314(0x216)]({'appId':_0x1e5a72,'curIp':_0x1baf83,'userId':_0x45e79b[_0x29d314(0x26f)]['id'],'type':balance_constant_1[_0x29d314(0x272)]['CHAT_TYPE'],'prompt':_0x99c75d,'answer':_0x328a49===null||_0x328a49===void 0x0?void 0x0:_0x328a49[_0x29d314(0x2ae)],'promptTokens':_0x2e918a,'completionTokens':_0xc3b674,'totalTokens':_0x2b8aaf,'model':_0x2eeb1c,'role':_0x29d314(0x267),'groupId':_0xdd033a,'requestOptions':JSON['stringify']({'options':{'model':_0x2eeb1c,'temperature':_0x581cbc},'prompt':_0x99c75d}),'conversationOptions':JSON['stringify']({'conversationId':_0x328a49===null||_0x328a49===void 0x0?void 0x0:_0x328a49[_0x29d314(0x2d0)],'model':_0x2eeb1c,'parentMessageId':_0x328a49===null||_0x328a49===void 0x0?void 0x0:_0x328a49['id'],'temperature':_0x581cbc})});let _0x53c581=_0x19e847;_0x2ab990===!![]&&(_0x53c581=Math['ceil'](_0x19e847*_0x2b8aaf/_0x56ebd9)),await this[_0x29d314(0x2cc)]['deductFromBalance'](_0x45e79b[_0x29d314(0x26f)]['id'],_0x29d314(0x2b1)+(_0x1b1484===0x1?0x3:0x4),_0x53c581,_0x2b8aaf);});if(Number(_0x57faf9)===0x1){const {key:_0x57e151,maxToken:_0x262a2b,maxTokenRes:_0x1a6b06,proxyResUrl:_0x325cb3}=await this[_0x51abc0(0x260)](_0xce93c8),{parentMessageId:_0x97328e,completionParams:_0x42e275,systemMessage:_0x2b7c30}=_0x3ca62e,{model:_0x1a7559,temperature:_0x527810}=_0x42e275,{context:_0x5cbfc1}=await this[_0x51abc0(0x2bc)][_0x51abc0(0x279)](_0x427d38?_0x10d1b3:_0x99c75d,{'parentMessageId':_0x97328e,'systemMessage':_0x2b7c30,'maxModelToken':_0x262a2b,'maxResponseTokens':_0x1a6b06,'maxRounds':(0x0,helper_1[_0x51abc0(0x209)])(_0x5017b),'imageUrl':_0x3bf7b7,'activeModel':_0x6d895e});let _0x93ed8b=!![];_0x8a1f4a=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x5cbfc1,{'maxToken':_0x262a2b,'maxTokenRes':_0x1a6b06,'apiKey':_0x4fb0df,'model':_0x1a7559,'prompt':_0x99c75d,'activeModel':_0x6d895e,'imageUrl':_0x3bf7b7,'temperature':_0x527810,'proxyUrl':_0x325cb3,'onProgress':_0x1401c0=>{const _0x341b7a=_0x51abc0;_0x190501['write'](_0x93ed8b?JSON[_0x341b7a(0x1fd)](_0x1401c0):'\x0a'+JSON[_0x341b7a(0x1fd)](_0x1401c0)),_0x328a49=_0x1401c0,_0x93ed8b=![];}},this[_0x51abc0(0x211)]),_0x5e209b=!![];}if(Number(_0x57faf9)===0x2){let _0x4b7509=!![];const {context:_0x32bec0}=await this[_0x51abc0(0x2bc)]['buildMessageFromParentMessageId'](_0x427d38?_0x10d1b3:_0x99c75d,{'parentMessageId':_0x26b6c6,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x5017b)});_0x8a1f4a=await(0x0,baidu_1[_0x51abc0(0x235)])(_0x427d38?_0x10d1b3:_0x32bec0,{'temperature':_0x581cbc,'accessToken':_0x56a8a9,'model':_0x2eeb1c,'onProgress':_0x59a052=>{const _0x474efe=_0x51abc0;_0x190501[_0x474efe(0x234)](_0x4b7509?JSON[_0x474efe(0x1fd)](_0x59a052):'\x0a'+JSON[_0x474efe(0x1fd)](_0x59a052)),_0x4b7509=![],_0x328a49=_0x59a052;}}),_0x5e209b=!![];}if(Number(_0x57faf9)===0x3){let _0x38b482=!![];const {context:_0x4cc2fc}=await this[_0x51abc0(0x2bc)][_0x51abc0(0x279)](_0x427d38?_0x10d1b3:_0x99c75d,{'parentMessageId':_0x26b6c6,'maxRounds':(0x0,helper_1[_0x51abc0(0x209)])(_0x5017b)});_0x8a1f4a=await(0x0,zhipu_1[_0x51abc0(0x286)])(_0x427d38?_0x10d1b3:_0x4cc2fc,{'temperature':_0x581cbc,'key':_0x3383ee,'model':_0x2eeb1c,'onProgress':_0x6a8d15=>{const _0x485a38=_0x51abc0;_0x190501[_0x485a38(0x234)](_0x38b482?JSON[_0x485a38(0x1fd)](_0x6a8d15):'\x0a'+JSON[_0x485a38(0x1fd)](_0x6a8d15)),_0x38b482=![],_0x328a49=_0x6a8d15;}}),_0x5e209b=!![];}const _0x59f51e={'id':this[_0x51abc0(0x2bc)][_0x51abc0(0x2bf)](),'text':_0x99c75d,'role':_0x51abc0(0x26f),'name':undefined,'usage':null,'imageUrl':_0x3bf7b7,'activeModel':_0x6d895e,'parentMessageId':_0x26b6c6,'conversationId':_0x8a1f4a===null||_0x8a1f4a===void 0x0?void 0x0:_0x8a1f4a[_0x51abc0(0x2d0)]};_0x4a1a85={'model':_0x2eeb1c,'parentMessageId':_0x26b6c6},await this['nineStore'][_0x51abc0(0x2c2)](_0x59f51e);const _0x131dc4={'id':_0x8a1f4a['id'],'text':_0x8a1f4a[_0x51abc0(0x2ae)],'role':_0x51abc0(0x267),'name':undefined,'usage':_0x8a1f4a===null||_0x8a1f4a===void 0x0?void 0x0:_0x8a1f4a[_0x51abc0(0x26c)],'imageUrl':_0x3bf7b7,'parentMessageId':_0x59f51e['id'],'conversationId':_0x8a1f4a===null||_0x8a1f4a===void 0x0?void 0x0:_0x8a1f4a[_0x51abc0(0x2d0)]};await this['nineStore'][_0x51abc0(0x2c2)](_0x131dc4),_0x4a1a85={'model':_0x2eeb1c,'parentMessageId':_0x59f51e['id']};}else{const {key:_0x2f7d12,maxToken:_0x5a3675,maxTokenRes:_0x10550d,proxyResUrl:_0x14115f}=await this[_0x51abc0(0x260)](_0xce93c8),{parentMessageId:_0x5d9215,completionParams:_0x16eb8b,systemMessage:_0x3fe5af}=_0x3ca62e,{model:_0x6c1b23,temperature:_0x3cad0b}=_0x16eb8b,{context:_0x3beb56}=await this[_0x51abc0(0x2bc)][_0x51abc0(0x279)](_0x427d38?_0x10d1b3:_0x99c75d,{'parentMessageId':_0x5d9215,'systemMessage':_0x3fe5af,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x5017b)});_0x8a1f4a=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x3beb56,{'apiKey':_0x4fb0df,'model':_0x6c1b23,'temperature':_0x3cad0b,'proxyUrl':_0x14115f,'onProgress':null,'prompt':_0x99c75d});}let _0xd21bd4=null,_0x546390=null;_0x2eeb1c['includes'](_0x51abc0(0x22a))?_0xd21bd4=((_0x1a7967=_0x8a1f4a[_0x51abc0(0x24a)])===null||_0x1a7967===void 0x0?void 0x0:_0x1a7967[_0x51abc0(0x26c)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x546390=await(0x0,helper_1['unifiedFormattingResponse'])(_0x57faf9,_0x8a1f4a,_0x4a1a85);const {prompt_tokens:_0x107b88,completion_tokens:_0x9c10b4,total_tokens:_0x30d392}=_0x2eeb1c[_0x51abc0(0x28e)]('dall')?_0xd21bd4:_0x546390['usage'];let _0x46415e=_0x19e847;_0x2ab990===!![]&&(_0x46415e=Math[_0x51abc0(0x245)](_0x19e847*_0x30d392/_0x56ebd9));await this[_0x51abc0(0x2cc)][_0x51abc0(0x2b7)](_0x45e79b[_0x51abc0(0x26f)]['id'],'model'+(_0x1b1484===0x1?0x3:0x4),_0x46415e,_0x30d392),await this[_0x51abc0(0x227)][_0x51abc0(0x1f3)](_0x531336,_0x30d392);const _0x2ab5ad=(0x0,utils_1[_0x51abc0(0x28d)])(_0x45e79b);await this['chatLogService'][_0x51abc0(0x216)]({'appId':_0x1e5a72,'curIp':_0x2ab5ad,'userId':_0x45e79b[_0x51abc0(0x26f)]['id'],'type':balance_constant_1[_0x51abc0(0x272)][_0x51abc0(0x1f5)],'prompt':_0x99c75d,'imageUrl':_0x3bf7b7,'activeModel':_0x6d895e,'answer':'','promptTokens':_0x107b88,'completionTokens':0x0,'totalTokens':_0x30d392,'model':_0x2eeb1c,'role':_0x51abc0(0x26f),'groupId':_0xdd033a,'requestOptions':JSON[_0x51abc0(0x1fd)]({'options':null,'prompt':_0x99c75d})}),await this[_0x51abc0(0x237)][_0x51abc0(0x216)]({'appId':_0x1e5a72,'curIp':_0x2ab5ad,'userId':_0x45e79b['user']['id'],'type':balance_constant_1['DeductionKey'][_0x51abc0(0x1f5)],'prompt':_0x99c75d,'imageUrl':_0x8a1f4a===null||_0x8a1f4a===void 0x0?void 0x0:_0x8a1f4a[_0x51abc0(0x21c)],'answer':_0x8a1f4a[_0x51abc0(0x2ae)],'promptTokens':_0x107b88,'completionTokens':_0x9c10b4,'totalTokens':_0x30d392,'model':_0x2eeb1c,'role':_0x51abc0(0x267),'groupId':_0xdd033a,'requestOptions':JSON['stringify']({'options':{'model':_0x2eeb1c,'temperature':_0x581cbc},'prompt':_0x99c75d}),'conversationOptions':JSON[_0x51abc0(0x1fd)]({'conversationId':_0x8a1f4a['conversationId'],'model':_0x2eeb1c,'parentMessageId':_0x8a1f4a['id'],'temperature':_0x581cbc})}),common_1[_0x51abc0(0x25b)]['debug'](_0x51abc0(0x2a7)+_0x45e79b[_0x51abc0(0x26f)]['id']+_0x51abc0(0x2c9)+_0x5c18b2+'-'+_0x6d895e+',\x20消耗token:\x20'+_0x30d392+_0x51abc0(0x207)+_0x46415e,_0x51abc0(0x2a2));const _0x3de941=await this[_0x51abc0(0x2cc)]['queryUserBalance'](_0x45e79b[_0x51abc0(0x26f)]['id']);return _0x8a1f4a[_0x51abc0(0x2b4)]=Object['assign']({},_0x3de941),_0x8a1f4a['result']&&(_0x8a1f4a['result']=''),_0x8a1f4a[_0x51abc0(0x263)]=!![],_0x190501?_0x190501['write']('\x0a'+JSON[_0x51abc0(0x1fd)](_0x8a1f4a)):_0x8a1f4a[_0x51abc0(0x2ae)];}catch(_0x6524f7){console[_0x51abc0(0x2bd)](_0x51abc0(0x240),_0x4fb0df,_0x6524f7);const _0x46c910=(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7['statusCode'])||0x190,_0x128b92=((_0x56fb9e=_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x1e4)])===null||_0x56fb9e===void 0x0?void 0x0:_0x56fb9e['status'])||(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x29a)])||0x190;console[_0x51abc0(0x2bd)]('chat-error-detail\x20\x20<----------------------------------------->',_0x51abc0(0x224),_0x46c910,_0x51abc0(0x221),_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x221)],_0x51abc0(0x27e),(_0x4e1350=_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7['response'])===null||_0x4e1350===void 0x0?void 0x0:_0x4e1350[_0x51abc0(0x2be)],'status',(_0xc9b5c9=_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x1e4)])===null||_0xc9b5c9===void 0x0?void 0x0:_0xc9b5c9['status']);if(_0x6524f7[_0x51abc0(0x275)]&&_0x6524f7['status']===0x192){const _0x53f5fd={'message':'Catch\x20Error\x20'+_0x6524f7['message'],'code':0x192};if(_0x190501)return _0x190501[_0x51abc0(0x234)](JSON[_0x51abc0(0x1fd)](_0x53f5fd));else throw new common_1[(_0x51abc0(0x218))](_0x6524f7[_0x51abc0(0x221)],common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x128b92){if(_0x190501)return _0x190501[_0x51abc0(0x234)](JSON[_0x51abc0(0x1fd)]({'message':_0x6524f7[_0x51abc0(0x221)],'code':0x1f4}));else throw new common_1['HttpException'](_0x6524f7[_0x51abc0(0x221)],common_1[_0x51abc0(0x2c8)][_0x51abc0(0x2d8)]);}let _0x407c88=errorMessage_constant_1[_0x51abc0(0x256)][_0x128b92]?errorMessage_constant_1[_0x51abc0(0x256)][_0x128b92]:_0x51abc0(0x204);(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7['message'][_0x51abc0(0x28e)](_0x51abc0(0x2c5)))&&Number(_0x57faf9)===0x1&&(await this[_0x51abc0(0x227)][_0x51abc0(0x298)](_0x531336,_0x51abc0(0x297),-0x1),_0x407c88=_0x51abc0(0x20d));(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x29a)])===0x1ad&&_0x6524f7['message'][_0x51abc0(0x28e)]('billing')&&Number(_0x57faf9)===0x1&&(await this[_0x51abc0(0x227)][_0x51abc0(0x298)](_0x531336,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x407c88=_0x51abc0(0x21f));(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7['statusCode'])===0x1ad&&(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x2be)])===_0x51abc0(0x289)&&(_0x407c88=_0x51abc0(0x232));(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7[_0x51abc0(0x29a)])===0x191&&_0x6524f7[_0x51abc0(0x221)]['includes'](_0x51abc0(0x2d7))&&Number(_0x57faf9)===0x1&&(await this['modelsService'][_0x51abc0(0x298)](_0x531336,_0x51abc0(0x1e2),-0x2),_0x407c88=_0x51abc0(0x2d1));(_0x6524f7===null||_0x6524f7===void 0x0?void 0x0:_0x6524f7['statusCode'])===0x194&&_0x6524f7[_0x51abc0(0x221)]['includes']('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x57faf9)===0x1&&(await this[_0x51abc0(0x227)][_0x51abc0(0x298)](_0x531336,_0x51abc0(0x2da),-0x4),_0x407c88=_0x51abc0(0x248));_0x46c910===0x190&&console[_0x51abc0(0x2bd)]('400\x20error',_0x6524f7,_0x6524f7['message']);const _0x53ffc0={'message':_0x407c88||_0x51abc0(0x205),'code':_0x46c910===0x191?0x190:_0x46c910||0x1f4};if(_0x190501)return _0x190501[_0x51abc0(0x234)](JSON['stringify'](_0x53ffc0));else throw new common_1[(_0x51abc0(0x218))](_0x53ffc0[_0x51abc0(0x221)],common_1[_0x51abc0(0x2c8)][_0x51abc0(0x2d8)]);}finally{_0x190501&&_0x190501[_0x51abc0(0x200)]();}}async['draw'](_0x51f2e8,_0x26003f){const _0x21004b=_0x4d3f18;var _0x45036f,_0x277e1c,_0x176352,_0x1a61b1;await this[_0x21004b(0x2b2)]['checkBadWords'](_0x51f2e8[_0x21004b(0x281)],_0x26003f['user']['id']),await this['userService'][_0x21004b(0x244)](_0x26003f[_0x21004b(0x26f)]);const _0x5c6d0c=(_0x51f2e8===null||_0x51f2e8===void 0x0?void 0x0:_0x51f2e8[_0x21004b(0x1e1)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x21004b(0x2e5)](_0x26003f,_0x21004b(0x2df),_0x5c6d0c);let _0x225503=[];const _0x4845d3=await this[_0x21004b(0x227)][_0x21004b(0x1ec)](_0x21004b(0x219)),_0x3b438c=_0x4845d3===null||_0x4845d3===void 0x0?void 0x0:_0x4845d3['id'],{key:_0x57532c,proxyResUrl:_0x307f77}=await this[_0x21004b(0x260)](_0x4845d3);common_1[_0x21004b(0x25b)][_0x21004b(0x2bd)](_0x21004b(0x2ba)+_0x51f2e8['prompt']+_0x21004b(0x2cd)+_0x57532c,_0x21004b(0x29d));try{const _0x2e9e49=_0x307f77+_0x21004b(0x222),_0x6b121d=Object[_0x21004b(0x2e0)](Object['assign']({},_0x51f2e8),{'model':'dall-e-3'});console[_0x21004b(0x2bd)](_0x21004b(0x2a3),_0x6b121d);const _0x5de74a=await axios_1[_0x21004b(0x26e)][_0x21004b(0x293)](_0x2e9e49,Object[_0x21004b(0x2e0)](Object[_0x21004b(0x2e0)]({},_0x6b121d),{'response_format':'b64_json'}),{'headers':{'Authorization':_0x21004b(0x29f)+_0x57532c}});_0x225503=_0x5de74a['data'][_0x21004b(0x265)];const _0x2015bb=[];for(const _0x59eb38 of _0x225503){const _0x1dd072=uuid['v4']()['slice'](0x0,0xa)+_0x21004b(0x2ab),_0x3f9b5b=Buffer['from'](_0x59eb38[_0x21004b(0x223)],_0x21004b(0x1fc));_0x2015bb[_0x21004b(0x2e1)](this['uploadService'][_0x21004b(0x268)]({'filename':_0x1dd072,'buffer':_0x3f9b5b}));}const _0x3bf3ef=await Promise['all'](_0x2015bb);await this[_0x21004b(0x2cc)][_0x21004b(0x2b7)](_0x26003f['user']['id'],'mjDraw',(_0x6b121d===null||_0x6b121d===void 0x0?void 0x0:_0x6b121d[_0x21004b(0x1e1)])===_0x21004b(0x23e)?0x2:0x4,_0x5c6d0c);const _0x2cc458=(0x0,utils_1['getClientIp'])(_0x26003f),_0x254df6=[],_0x1c4947=await this[_0x21004b(0x211)][_0x21004b(0x21d)](),[_0x55e1c,_0x4f8fcb]=_0x51f2e8[_0x21004b(0x203)][_0x21004b(0x27c)]('x');return _0x3bf3ef[_0x21004b(0x2e2)](_0x15acb6=>{const _0x5f47e2=_0x21004b;_0x254df6['push'](this[_0x5f47e2(0x237)][_0x5f47e2(0x216)]({'curIp':_0x2cc458,'userId':_0x26003f[_0x5f47e2(0x26f)]['id'],'type':balance_constant_1[_0x5f47e2(0x272)][_0x5f47e2(0x2dd)],'prompt':_0x51f2e8[_0x5f47e2(0x281)],'answer':_0x15acb6,'fileInfo':JSON[_0x5f47e2(0x1fd)]({'cosType':_0x1c4947,'width':_0x55e1c,'height':_0x4f8fcb,'cosUrl':_0x15acb6}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':'dall-e-3'}));}),await Promise[_0x21004b(0x201)](_0x254df6),_0x3bf3ef;}catch(_0x13ecb4){const _0x2259a2=((_0x45036f=_0x13ecb4===null||_0x13ecb4===void 0x0?void 0x0:_0x13ecb4['response'])===null||_0x45036f===void 0x0?void 0x0:_0x45036f[_0x21004b(0x275)])||0x1f4;console[_0x21004b(0x2bd)](_0x21004b(0x2d9),JSON[_0x21004b(0x1fd)](_0x13ecb4),_0x57532c,_0x2259a2);const _0x142dcc=(_0x1a61b1=(_0x176352=(_0x277e1c=_0x13ecb4===null||_0x13ecb4===void 0x0?void 0x0:_0x13ecb4[_0x21004b(0x1e4)])===null||_0x277e1c===void 0x0?void 0x0:_0x277e1c[_0x21004b(0x265)])===null||_0x176352===void 0x0?void 0x0:_0x176352['error'])===null||_0x1a61b1===void 0x0?void 0x0:_0x1a61b1[_0x21004b(0x221)];if(_0x2259a2===0x1ad)throw new common_1[(_0x21004b(0x218))](_0x21004b(0x288),common_1[_0x21004b(0x2c8)][_0x21004b(0x2d8)]);if(_0x2259a2===0x190&&_0x142dcc[_0x21004b(0x28e)](_0x21004b(0x247)))throw new common_1[(_0x21004b(0x218))](_0x21004b(0x212),common_1[_0x21004b(0x2c8)]['BAD_REQUEST']);if(_0x2259a2===0x190&&_0x142dcc[_0x21004b(0x28e)](_0x21004b(0x2c3))){await this['modelsService'][_0x21004b(0x298)](_0x3b438c,_0x21004b(0x297),-0x1);throw new common_1[(_0x21004b(0x218))]('当前Key余额已不足、请重新再试一次吧！',common_1['HttpStatus'][_0x21004b(0x2d8)]);}if(_0x2259a2===0x1f4)throw new common_1[(_0x21004b(0x218))](_0x21004b(0x1e7),common_1[_0x21004b(0x2c8)][_0x21004b(0x2d8)]);if(_0x2259a2===0x191)throw new common_1[(_0x21004b(0x218))](_0x21004b(0x25c),common_1[_0x21004b(0x2c8)]['BAD_REQUEST']);throw new common_1[(_0x21004b(0x218))](_0x21004b(0x24d),common_1[_0x21004b(0x2c8)][_0x21004b(0x2d8)]);}}async['getAllKeyList'](){const _0x20bf22=_0x4d3f18,_0x381b08=await this[_0x20bf22(0x21b)][_0x20bf22(0x214)]({'where':{'status':0x1},'select':['id',_0x20bf22(0x282),_0x20bf22(0x28c),_0x20bf22(0x2b1),'maxModelTokens','maxResponseTokens',_0x20bf22(0x2b5),_0x20bf22(0x22c)]}),_0xff44ec=_0x381b08[_0x20bf22(0x2d6)](_0x4f1ea9=>_0x4f1ea9[_0x20bf22(0x2b1)][_0x20bf22(0x28e)](_0x20bf22(0x2c0))),_0x1dbace=_0x381b08[_0x20bf22(0x2d6)](_0x44d9d4=>_0x44d9d4['model'][_0x20bf22(0x28e)](_0x20bf22(0x274)));this[_0x20bf22(0x2ca)]={'list3':_0xff44ec,'list4':_0x1dbace};}async[_0x4d3f18(0x257)](_0x220379){const _0x22ef6e=_0x4d3f18,_0x1c5eea=await this['globalConfigService'][_0x22ef6e(0x1e8)]([_0x22ef6e(0x23c)]);return(_0x220379===null||_0x220379===void 0x0?void 0x0:_0x220379[_0x22ef6e(0x1ea)])||_0x1c5eea||'https://api.openai.com';}async['formatModelToken'](_0x5158c2){const _0x23b6e3=_0x4d3f18,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x23b6e3(0x287)][_0x23b6e3(0x1e8)](['openaiModel3MaxTokens',_0x23b6e3(0x25e),_0x23b6e3(0x229),'openaiModel3MaxTokens16kRes',_0x23b6e3(0x1f4),'openaiModel4MaxTokensRes',_0x23b6e3(0x213),'openaiModel4MaxTokens32kRes',_0x23b6e3(0x23c)]);let _0xc7fcd1=null,_0x15eb04=null,_0x4f05ab=null,{model:_0x4ea0ae,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x406fd4}=_0x5158c2;return _0x4ea0ae[_0x23b6e3(0x23d)]()[_0x23b6e3(0x28e)](_0x23b6e3(0x274))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x15eb04>=0x1000&&(maxModelTokens=0x1000),_0xc7fcd1=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x15eb04=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x4ea0ae['toLowerCase']()[_0x23b6e3(0x28e)](_0x23b6e3(0x2a1))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x15eb04>=0x4000&&(maxModelTokens=0x4000),_0xc7fcd1=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x15eb04=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x4ea0ae[_0x23b6e3(0x23d)]()['includes']('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x15eb04>=0x1000&&(maxModelTokens=0x1000),_0xc7fcd1=maxModelTokens||0x3ffc,_0x15eb04=maxResponseTokens||0x1000)),_0x4ea0ae[_0x23b6e3(0x23d)]()[_0x23b6e3(0x28e)](_0x23b6e3(0x2c0))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x15eb04>=0x7d0&&(maxModelTokens=0x7d0),_0xc7fcd1=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x15eb04=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x4ea0ae[_0x23b6e3(0x23d)]()[_0x23b6e3(0x28e)](_0x23b6e3(0x20c))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x15eb04>=0x2000&&(maxModelTokens=0x2000),_0xc7fcd1=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x15eb04=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x4ea0ae[_0x23b6e3(0x23d)]()['includes'](_0x23b6e3(0x2ad))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x15eb04>=0x1000&&(maxModelTokens=0x1000),_0xc7fcd1=maxModelTokens||0x4000,_0x15eb04=maxResponseTokens||0x1000)),_0x4f05ab=proxyUrl||openaiBaseUrl||'https://api.openai.com',_0x15eb04>=_0xc7fcd1&&(_0x15eb04=Math[_0x23b6e3(0x1f6)](_0xc7fcd1/0x2)),{'key':_0x406fd4,'maxToken':_0xc7fcd1,'maxTokenRes':_0x15eb04,'proxyResUrl':_0x4f05ab};}async['setChatBoxType'](_0x1a2a36,_0x58f1db){const _0x80e350=_0x4d3f18;try{const {name:_0x1cea1d,icon:_0x551a8b,order:_0x3ffac9,id:_0xcdd744,status:_0xa8376a}=_0x58f1db;return _0xcdd744?await this[_0x80e350(0x296)][_0x80e350(0x26a)]({'id':_0xcdd744},{'name':_0x1cea1d,'icon':_0x551a8b,'order':_0x3ffac9,'status':_0xa8376a}):await this[_0x80e350(0x296)][_0x80e350(0x2d3)]({'name':_0x1cea1d,'icon':_0x551a8b,'order':_0x3ffac9,'status':_0xa8376a});}catch(_0x25b2cc){console[_0x80e350(0x2bd)]('error:\x20',_0x25b2cc);}}async['delChatBoxType'](_0x26923b,_0x10717c){const _0x2a9cf3=_0x4d3f18,{id:_0x460f83}=_0x10717c;if(!_0x460f83)throw new common_1['HttpException']('非法操作！',common_1[_0x2a9cf3(0x2c8)][_0x2a9cf3(0x2d8)]);const _0x4e6b07=await this[_0x2a9cf3(0x27d)][_0x2a9cf3(0x255)]({'where':{'typeId':_0x460f83}});if(_0x4e6b07)throw new common_1[(_0x2a9cf3(0x218))](_0x2a9cf3(0x25d),common_1[_0x2a9cf3(0x2c8)][_0x2a9cf3(0x2d8)]);return await this[_0x2a9cf3(0x296)][_0x2a9cf3(0x217)]({'id':_0x460f83});}async[_0x4d3f18(0x241)](){const _0x2bbbc7=_0x4d3f18;return await this['chatBoxTypeEntity'][_0x2bbbc7(0x214)]({'order':{'order':_0x2bbbc7(0x2e3)}});}async[_0x4d3f18(0x2bb)](_0x3edcab,_0x4887e2){const _0x551b35=_0x4d3f18,{title:_0x2e7bd9,prompt:_0x5c8108,appId:_0x2a0f41,order:_0x55b6f7,status:_0x4afe02,typeId:_0x20b7e6,id:_0x408599,url:_0x44899f}=_0x4887e2;if(!_0x20b7e6)throw new common_1['HttpException'](_0x551b35(0x1fe),common_1['HttpStatus'][_0x551b35(0x2d8)]);try{const _0x5e5510={'title':_0x2e7bd9,'order':_0x55b6f7,'status':_0x4afe02,'typeId':_0x20b7e6,'url':_0x44899f};return _0x5e5510[_0x551b35(0x299)]=_0x2a0f41||0x0,_0x5e5510['prompt']=_0x5c8108||'',_0x408599?await this[_0x551b35(0x27d)][_0x551b35(0x26a)]({'id':_0x408599},_0x5e5510):await this[_0x551b35(0x27d)][_0x551b35(0x2d3)](_0x5e5510);}catch(_0x239e08){console[_0x551b35(0x2bd)](_0x551b35(0x2b9),_0x239e08);}}async[_0x4d3f18(0x292)](_0x525662,_0x220d16){const _0x15d987=_0x4d3f18,{id:_0x5bed20}=_0x220d16;if(!_0x5bed20)throw new common_1[(_0x15d987(0x218))](_0x15d987(0x246),common_1[_0x15d987(0x2c8)][_0x15d987(0x2d8)]);return await this[_0x15d987(0x27d)][_0x15d987(0x217)]({'id':_0x5bed20});}async[_0x4d3f18(0x24c)](){const _0x3c311c=_0x4d3f18,_0x3c2ef2=await this['chatBoxEntity'][_0x3c311c(0x214)]({'order':{'order':_0x3c311c(0x2e3)}}),_0x4ce518=[...new Set(_0x3c2ef2[_0x3c311c(0x2d2)](_0x219d8a=>_0x219d8a[_0x3c311c(0x1f9)]))],_0x438c2e=[...new Set(_0x3c2ef2[_0x3c311c(0x2d2)](_0x3ae168=>_0x3ae168[_0x3c311c(0x299)]))],_0x895e62=await this[_0x3c311c(0x296)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x4ce518)}}),_0x362c56=await this[_0x3c311c(0x251)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x438c2e)}});return _0x3c2ef2[_0x3c311c(0x2d2)](_0x20a803=>{const _0x32bdee=_0x3c311c,{typeId:_0x31209a,appId:_0x2a6f5f}=_0x20a803;return _0x20a803[_0x32bdee(0x1ee)]=_0x895e62[_0x32bdee(0x214)](_0x5e0b50=>_0x5e0b50['id']===_0x31209a),_0x20a803[_0x32bdee(0x2a5)]=_0x362c56['find'](_0x24a145=>_0x24a145['id']===_0x2a6f5f),_0x20a803;});}async[_0x4d3f18(0x215)](){const _0x2b59c3=_0x4d3f18,_0x2cb034=await this['chatBoxTypeEntity'][_0x2b59c3(0x214)]({'order':{'order':_0x2b59c3(0x2e3)},'where':{'status':!![]}}),_0x473237=await this['chatBoxEntity']['find']({'where':{'status':!![]}}),_0xeeab58=[...new Set(_0x473237[_0x2b59c3(0x2d2)](_0x5d6823=>_0x5d6823[_0x2b59c3(0x299)]))],_0x3ccf72=await this[_0x2b59c3(0x251)][_0x2b59c3(0x214)]({'where':{'id':(0x0,typeorm_1['In'])(_0xeeab58)}});return _0x473237[_0x2b59c3(0x2e2)](_0x518ded=>{const _0x847465=_0x2b59c3,_0x467ab0=_0x3ccf72[_0x847465(0x214)](_0x1341b0=>_0x1341b0['id']===_0x518ded[_0x847465(0x299)]);return _0x518ded['coverImg']=_0x467ab0===null||_0x467ab0===void 0x0?void 0x0:_0x467ab0['coverImg'],_0x518ded;}),_0x2cb034[_0x2b59c3(0x2d2)](_0x44dead=>{const _0x3805e0=_0x2b59c3;return _0x44dead[_0x3805e0(0x28f)]=_0x473237[_0x3805e0(0x2d6)](_0x58ddb0=>_0x58ddb0['typeId']===_0x44dead['id']&&_0x58ddb0[_0x3805e0(0x275)]),_0x44dead;});}async[_0x4d3f18(0x24f)](_0x2deec6,_0x29f518){const _0x345276=_0x4d3f18;try{const {name:_0x17fbc5,icon:_0x1946d7,order:_0x4f10f9,id:_0x10df89,status:_0x2df1ea}=_0x29f518;return _0x10df89?await this['chatPreTypeEntity'][_0x345276(0x26a)]({'id':_0x10df89},{'name':_0x17fbc5,'icon':_0x1946d7,'order':_0x4f10f9,'status':_0x2df1ea}):await this[_0x345276(0x20a)][_0x345276(0x2d3)]({'name':_0x17fbc5,'icon':_0x1946d7,'order':_0x4f10f9,'status':_0x2df1ea});}catch(_0x16a188){console[_0x345276(0x2bd)]('error:\x20',_0x16a188);}}async[_0x4d3f18(0x242)](_0x46eda0,_0x4e35a3){const _0x146ed2=_0x4d3f18,{id:_0x3a100e}=_0x4e35a3;if(!_0x3a100e)throw new common_1[(_0x146ed2(0x218))](_0x146ed2(0x246),common_1[_0x146ed2(0x2c8)][_0x146ed2(0x2d8)]);const _0x3eb054=await this[_0x146ed2(0x27d)]['count']({'where':{'typeId':_0x3a100e}});if(_0x3eb054)throw new common_1['HttpException'](_0x146ed2(0x25d),common_1[_0x146ed2(0x2c8)][_0x146ed2(0x2d8)]);return await this[_0x146ed2(0x20a)]['delete']({'id':_0x3a100e});}async['queryChatPreType'](){const _0x1f56fd=_0x4d3f18;return await this[_0x1f56fd(0x20a)][_0x1f56fd(0x214)]({'order':{'order':_0x1f56fd(0x2e3)}});}async[_0x4d3f18(0x231)](_0x4be557,_0x5a30ab){const _0x314827=_0x4d3f18,{title:_0xad629c,prompt:_0x1d2ed2,appId:_0x5443f2,order:_0x1f1a52,status:_0xb52f0e,typeId:_0x2c7207,id:_0x891a37,url:_0x10a93a}=_0x5a30ab;if(!_0x2c7207)throw new common_1['HttpException'](_0x314827(0x1fe),common_1['HttpStatus'][_0x314827(0x2d8)]);try{const _0x487396={'title':_0xad629c,'prompt':_0x1d2ed2,'order':_0x1f1a52,'status':_0xb52f0e,'typeId':_0x2c7207,'url':_0x10a93a};return _0x891a37?await this[_0x314827(0x1f0)][_0x314827(0x26a)]({'id':_0x891a37},_0x487396):await this[_0x314827(0x1f0)][_0x314827(0x2d3)](_0x487396);}catch(_0x78add9){console['log']('error:\x20',_0x78add9);}}async['delChatPre'](_0x3d0227,_0x3594ff){const _0x295de0=_0x4d3f18,{id:_0xa16111}=_0x3594ff;if(!_0xa16111)throw new common_1[(_0x295de0(0x218))](_0x295de0(0x246),common_1[_0x295de0(0x2c8)][_0x295de0(0x2d8)]);return await this[_0x295de0(0x1f0)]['delete']({'id':_0xa16111});}async[_0x4d3f18(0x2ce)](){const _0x12d46b=_0x4d3f18,_0x4b5559=await this['chatPreEntity'][_0x12d46b(0x214)]({'order':{'order':'DESC'}}),_0x2b29b7=[...new Set(_0x4b5559['map'](_0x2d4f3e=>_0x2d4f3e[_0x12d46b(0x1f9)]))],_0x127df5=await this[_0x12d46b(0x20a)][_0x12d46b(0x214)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2b29b7)}});return _0x4b5559[_0x12d46b(0x2d2)](_0x506467=>{const _0x43b656=_0x12d46b,{typeId:_0x1b681e,appId:_0x3db5a4}=_0x506467;return _0x506467[_0x43b656(0x1ee)]=_0x127df5[_0x43b656(0x214)](_0x3dff4e=>_0x3dff4e['id']===_0x1b681e),_0x506467;});}async[_0x4d3f18(0x27f)](){const _0x52d62a=_0x4d3f18,_0x1c7f74=await this[_0x52d62a(0x20a)]['find']({'order':{'order':_0x52d62a(0x2e3)},'where':{'status':!![]}}),_0x106281=await this['chatPreEntity'][_0x52d62a(0x214)]({'where':{'status':!![]}});return _0x1c7f74['map'](_0x46e517=>{const _0x374234=_0x52d62a;return _0x46e517[_0x374234(0x28f)]=_0x106281[_0x374234(0x2d6)](_0x2e5762=>_0x2e5762[_0x374234(0x1f9)]===_0x46e517['id']&&_0x2e5762['status']),_0x46e517;});}async[_0x4d3f18(0x239)](_0x51f94c,_0x3d6107,_0x726aa){const _0x38639d=_0x4d3f18;let _0x1e441f=0x1000,_0x51a0a3=0x800;return _0x51f94c[_0x38639d(0x23d)]()[_0x38639d(0x28e)](_0x38639d(0x274))&&(_0x1e441f=_0x3d6107>=0x2004?0x2004:_0x3d6107,_0x51a0a3=_0x726aa>=0x1000?0x1000:_0x726aa,_0x51f94c[_0x38639d(0x23d)]()[_0x38639d(0x28e)](_0x38639d(0x2a1))&&(_0x1e441f=_0x3d6107>=0x8000?0x8000:_0x3d6107,_0x51a0a3=_0x726aa>=0x3e80?0x3e80:_0x726aa),(_0x51f94c['toLowerCase']()[_0x38639d(0x28e)](_0x38639d(0x2a8))||_0x51f94c[_0x38639d(0x23d)]()['includes'](_0x38639d(0x243)))&&(_0x1e441f=_0x3d6107>=0x1f400?0x1f400:_0x3d6107,_0x51a0a3=_0x726aa>=0x1000?0x1000:_0x726aa)),_0x51f94c[_0x38639d(0x23d)]()[_0x38639d(0x28e)](_0x38639d(0x2c0))&&(_0x1e441f=_0x3d6107>=0x1000?0x1000:_0x3d6107,_0x51a0a3=_0x726aa>=0x800?0x800:_0x726aa,_0x51f94c[_0x38639d(0x23d)]()[_0x38639d(0x28e)](_0x38639d(0x20c))&&(_0x1e441f=_0x3d6107>=0x4000?0x4000:_0x3d6107,_0x51a0a3=_0x726aa>=0x1f40?0x1f40:_0x726aa),_0x51f94c[_0x38639d(0x23d)]()[_0x38639d(0x28e)]('1106')&&(_0x1e441f=_0x3d6107>=0x4000?0x4000:_0x3d6107,_0x51a0a3=_0x726aa>=0x1f40?0x1f40:_0x726aa)),{'maxToken':_0x1e441f,'maxRes':_0x51a0a3};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x4d3f18(0x284)])(gptkeys_entity_1[_0x4d3f18(0x262)])),__param(0x1,(0x0,typeorm_2[_0x4d3f18(0x284)])(config_entity_1[_0x4d3f18(0x252)])),__param(0x2,(0x0,typeorm_2[_0x4d3f18(0x284)])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2[_0x4d3f18(0x284)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x4d3f18(0x284)])(chatPreType_entity_1[_0x4d3f18(0x266)])),__param(0x6,(0x0,typeorm_2[_0x4d3f18(0x284)])(chatPre_entity_1[_0x4d3f18(0x27a)])),__metadata('design:paramtypes',[typeorm_1[_0x4d3f18(0x24b)],typeorm_1[_0x4d3f18(0x24b)],typeorm_1[_0x4d3f18(0x24b)],typeorm_1[_0x4d3f18(0x24b)],typeorm_1['Repository'],typeorm_1[_0x4d3f18(0x24b)],typeorm_1[_0x4d3f18(0x24b)],nestjs_config_1[_0x4d3f18(0x2d4)],userBalance_service_1[_0x4d3f18(0x1e0)],chatLog_service_1[_0x4d3f18(0x2ac)],user_service_1[_0x4d3f18(0x2db)],upload_service_1[_0x4d3f18(0x29e)],badwords_service_1[_0x4d3f18(0x2cf)],autoreply_service_1['AutoreplyService'],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x4d3f18(0x2aa)],chatGroup_service_1['ChatGroupService'],models_service_1[_0x4d3f18(0x1ef)]])],ChatgptService),exports[_0x4d3f18(0x2a2)]=ChatgptService;