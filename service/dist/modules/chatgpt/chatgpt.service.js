'use strict';const _0x2fcd2f=_0x1747;(function(_0x1a10cd,_0x421c13){const _0x33df4e=_0x1747,_0x4eb535=_0x1a10cd();while(!![]){try{const _0x345156=parseInt(_0x33df4e(0x1c7))/0x1*(-parseInt(_0x33df4e(0x1d8))/0x2)+parseInt(_0x33df4e(0x18c))/0x3+-parseInt(_0x33df4e(0x14c))/0x4*(parseInt(_0x33df4e(0x11e))/0x5)+parseInt(_0x33df4e(0x107))/0x6*(-parseInt(_0x33df4e(0x14e))/0x7)+-parseInt(_0x33df4e(0xe3))/0x8+parseInt(_0x33df4e(0x16c))/0x9+parseInt(_0x33df4e(0x137))/0xa;if(_0x345156===_0x421c13)break;else _0x4eb535['push'](_0x4eb535['shift']());}catch(_0x48b9cb){_0x4eb535['push'](_0x4eb535['shift']());}}}(_0x3f6f,0xb7e53));function _0x1747(_0x9ff5f7,_0x55956b){const _0x3f6fc4=_0x3f6f();return _0x1747=function(_0x17476d,_0x52a7b9){_0x17476d=_0x17476d-0xd9;let _0x29b79e=_0x3f6fc4[_0x17476d];return _0x29b79e;},_0x1747(_0x9ff5f7,_0x55956b);}var __decorate=this&&this[_0x2fcd2f(0x15b)]||function(_0x2609db,_0x235652,_0x699b58,_0x291ab2){const _0x1d00a4=_0x2fcd2f;var _0x55aac0=arguments[_0x1d00a4(0x1b4)],_0x5223e4=_0x55aac0<0x3?_0x235652:_0x291ab2===null?_0x291ab2=Object[_0x1d00a4(0x12d)](_0x235652,_0x699b58):_0x291ab2,_0x3d3d23;if(typeof Reflect===_0x1d00a4(0x153)&&typeof Reflect[_0x1d00a4(0x131)]===_0x1d00a4(0x139))_0x5223e4=Reflect[_0x1d00a4(0x131)](_0x2609db,_0x235652,_0x699b58,_0x291ab2);else{for(var _0xf390a=_0x2609db[_0x1d00a4(0x1b4)]-0x1;_0xf390a>=0x0;_0xf390a--)if(_0x3d3d23=_0x2609db[_0xf390a])_0x5223e4=(_0x55aac0<0x3?_0x3d3d23(_0x5223e4):_0x55aac0>0x3?_0x3d3d23(_0x235652,_0x699b58,_0x5223e4):_0x3d3d23(_0x235652,_0x699b58))||_0x5223e4;}return _0x55aac0>0x3&&_0x5223e4&&Object['defineProperty'](_0x235652,_0x699b58,_0x5223e4),_0x5223e4;},__metadata=this&&this['__metadata']||function(_0x3af203,_0x192b9b){const _0x489ba8=_0x2fcd2f;if(typeof Reflect===_0x489ba8(0x153)&&typeof Reflect['metadata']===_0x489ba8(0x139))return Reflect[_0x489ba8(0xeb)](_0x3af203,_0x192b9b);},__param=this&&this[_0x2fcd2f(0x144)]||function(_0x4e4d11,_0x2f6045){return function(_0xbae53,_0x167763){_0x2f6045(_0xbae53,_0x167763,_0x4e4d11);};};Object[_0x2fcd2f(0x182)](exports,_0x2fcd2f(0x167),{'value':!![]}),exports['ChatgptService']=void 0x0;const upload_service_1=require(_0x2fcd2f(0x169)),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x2fcd2f(0xe9)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x2fcd2f(0x180)),utils_1=require(_0x2fcd2f(0x113)),axios_1=require('axios'),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x2fcd2f(0x13a)),chatLog_service_1=require(_0x2fcd2f(0x1d0)),uuid=require('uuid'),config_entity_1=require(_0x2fcd2f(0x11a)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x2fcd2f(0x10e)),autoreply_service_1=require(_0x2fcd2f(0x1d9)),gptkeys_entity_1=require('./gptkeys.entity'),globalConfig_service_1=require(_0x2fcd2f(0x17e)),fanyi_service_1=require(_0x2fcd2f(0x13e)),app_entity_1=require(_0x2fcd2f(0x1a6)),chatGroup_service_1=require(_0x2fcd2f(0x140)),models_service_1=require(_0x2fcd2f(0x12f)),baidu_1=require(_0x2fcd2f(0x154)),helper_1=require(_0x2fcd2f(0x1b3)),store_1=require(_0x2fcd2f(0x165)),zhipu_1=require(_0x2fcd2f(0xed)),openai_1=require(_0x2fcd2f(0x103)),chatBoxType_entity_1=require('./chatBoxType.entity'),chatBox_entity_1=require(_0x2fcd2f(0xdb)),chatPre_entity_1=require('./chatPre.entity'),chatPreType_entity_1=require(_0x2fcd2f(0x1ce));let ChatgptService=class ChatgptService{constructor(_0x305949,_0x16fbd0,_0x3d03d5,_0x70a6a3,_0x5b7574,_0x106929,_0x5c2d7f,_0x521c83,_0x38630f,_0x2994c9,_0x3c1935,_0x167fc0,_0x35d5fd,_0x5eaf76,_0x3596d1,_0x2bec2a,_0x5430c9,_0x113ed9){const _0x37fc39=_0x2fcd2f;this[_0x37fc39(0xf8)]=_0x305949,this['configEntity']=_0x16fbd0,this['chatBoxTypeEntity']=_0x3d03d5,this['chatBoxEntity']=_0x70a6a3,this[_0x37fc39(0x1cc)]=_0x5b7574,this['chatPreTypeEntity']=_0x106929,this[_0x37fc39(0x1c8)]=_0x5c2d7f,this[_0x37fc39(0x134)]=_0x521c83,this['userBalanceService']=_0x38630f,this[_0x37fc39(0x115)]=_0x2994c9,this[_0x37fc39(0x19c)]=_0x3c1935,this[_0x37fc39(0x1c5)]=_0x167fc0,this['badwordsService']=_0x35d5fd,this[_0x37fc39(0x121)]=_0x5eaf76,this[_0x37fc39(0x1b8)]=_0x3596d1,this['fanyiService']=_0x2bec2a,this['chatGroupService']=_0x5430c9,this['modelsService']=_0x113ed9,this[_0x37fc39(0x16b)]=null,this[_0x37fc39(0xfd)]=[],this[_0x37fc39(0xe2)]={'list3':[],'list4':[]};}async[_0x2fcd2f(0xdf)](){const _0x23f8d9=_0x2fcd2f;let _0x4848ea=await(0x0,utils_1[_0x23f8d9(0x194)])(_0x23f8d9(0x176)),_0x5428ea=await(0x0,utils_1['importDynamic'])(_0x23f8d9(0xf4)),_0x2dbfaf=await(0x0,utils_1[_0x23f8d9(0x194)])('keyv');_0x4848ea=(_0x4848ea===null||_0x4848ea===void 0x0?void 0x0:_0x4848ea[_0x23f8d9(0x17d)])?_0x4848ea[_0x23f8d9(0x17d)]:_0x4848ea,_0x5428ea=(_0x5428ea===null||_0x5428ea===void 0x0?void 0x0:_0x5428ea[_0x23f8d9(0x17d)])?_0x5428ea['default']:_0x5428ea,_0x2dbfaf=(_0x2dbfaf===null||_0x2dbfaf===void 0x0?void 0x0:_0x2dbfaf[_0x23f8d9(0x17d)])?_0x2dbfaf[_0x23f8d9(0x17d)]:_0x2dbfaf;const {ChatGPTAPI:_0x5aded9,ChatGPTError:_0x48e55c,ChatGPTUnofficialProxyAPI:_0x144f1c}=_0x4848ea,_0x311ed6=+process[_0x23f8d9(0x160)][_0x23f8d9(0x17f)],_0x5e8a4c=process[_0x23f8d9(0x160)][_0x23f8d9(0x108)],_0x56afc7=process['env'][_0x23f8d9(0x16d)],_0xacc27f=process['env'][_0x23f8d9(0x1b7)],_0xe0ad5d=_0x23f8d9(0x1b6)+(_0xacc27f||'')+':'+(_0x56afc7||'')+'@'+_0x5e8a4c+':'+_0x311ed6,_0x35653e=new _0x5428ea(_0xe0ad5d),_0x53c455=new _0x2dbfaf({'store':_0x35653e,'namespace':_0x23f8d9(0xde)});this[_0x23f8d9(0x16b)]=new store_1[(_0x23f8d9(0x1ab))]({'store':_0x53c455,'namespace':_0x23f8d9(0x152)});}async[_0x2fcd2f(0x12a)](_0x42fb40,_0x95180,_0x7c1fd6,_0x106450=null){const _0x2e9fb0=_0x2fcd2f;var _0x20f26a;!_0x106450&&(_0x106450=(_0x20f26a=await this[_0x2e9fb0(0x166)][_0x2e9fb0(0xf6)]())===null||_0x20f26a===void 0x0?void 0x0:_0x20f26a[_0x2e9fb0(0x179)]);const {timeout:timeout=0x3c}=_0x7c1fd6,{topN:_0x267b3f,model:_0x57321e}=_0x106450,{parentMessageId:parentMessageId=0x0}=_0x42fb40,_0x333881=await this[_0x2e9fb0(0x1b8)]['getConfigs']([_0x2e9fb0(0x17a)]),_0x5e43c6=timeout*0x3e8||_0x333881||0x64*0x3e8,_0x592b52={'parentMessageId':parentMessageId,'timeoutMs':+_0x5e43c6,'completionParams':{'model':_0x57321e,'temperature':_0x267b3f}};return _0x95180&&(_0x592b52[_0x2e9fb0(0x105)]=_0x95180),_0x592b52;}async[_0x2fcd2f(0xec)](_0x290068){const _0x212410=_0x2fcd2f,_0x10f6fb=await this[_0x212410(0x166)][_0x212410(0x120)](),_0x299088=await this[_0x212410(0x1b8)][_0x212410(0xdd)](['systemPreMessage']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x584dbf,model:_0x5aefc2}=_0x10f6fb,_0x5175c2=await this[_0x212410(0x1a7)](_0x10f6fb),{context:_0x3add5a}=await this['nineStore']['buildMessageFromParentMessageId'](_0x290068,{'parentMessageId':'','systemMessage':_0x299088});try{const _0x14d5cf=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x3add5a,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x584dbf),'model':_0x5aefc2,'proxyUrl':_0x5175c2,'onProgress':null});return _0x14d5cf===null||_0x14d5cf===void 0x0?void 0x0:_0x14d5cf['text'];}catch(_0x373277){console[_0x212410(0xe5)](_0x212410(0x163),_0x373277);}}async[_0x2fcd2f(0xe7)](_0x2e8b14,_0x5c4801,_0x143ab9){const _0x3ae9b7=_0x2fcd2f;var _0x17af7e,_0x381481,_0x31b727,_0x4233a4;const _0xca69f3=_0x5c4801[_0x3ae9b7(0x170)],{options:options={},appId:_0x58a8c8,cusromPrompt:_0x29d62a,systemMessage:systemMessage=''}=_0x2e8b14;let _0x37d8ea=systemMessage;const {parentMessageId:_0x1c0c18}=options,{prompt:_0x1ff09f,imageUrl:_0x3c127d,model:_0x1fb964}=_0x2e8b14,{groupId:_0x3fd034,usingNetwork:_0x380094}=options,_0x681858=await this[_0x3ae9b7(0x18e)]['getGroupInfoFromId'](_0x3fd034),_0x471592=(_0x681858===null||_0x681858===void 0x0?void 0x0:_0x681858[_0x3ae9b7(0x189)])?JSON[_0x3ae9b7(0x127)](_0x681858[_0x3ae9b7(0x189)]):await this[_0x3ae9b7(0x166)][_0x3ae9b7(0xf6)](),{keyType:_0x441ee6,model:_0x12b9ad,topN:_0x52a754,systemMessage:_0x2f63bb,rounds:_0x2c771b}=_0x471592['modelInfo'];let _0x553df6=null;!_0x29d62a?_0x553df6=await this[_0x3ae9b7(0x166)][_0x3ae9b7(0xd9)](_0x12b9ad):_0x553df6=await this['modelsService']['getRandomDrawKey']();if(!_0x553df6)throw new common_1[(_0x3ae9b7(0x16a))](_0x3ae9b7(0x101),common_1[_0x3ae9b7(0x185)][_0x3ae9b7(0x102)]);const {deduct:_0x1defb6,isTokenBased:_0x369082,tokenFeeRatio:_0x2ddbea,deductType:_0xfb2fb5,key:_0x3c7ac0,secret:_0x3cc92e,modelName:_0x814057,id:_0x377717,accessToken:_0x3b8405}=_0x553df6;await this['userService'][_0x3ae9b7(0x157)](_0x5c4801['user']),await this['userBalanceService'][_0x3ae9b7(0x195)](_0x5c4801,_0xfb2fb5===0x1?_0x3ae9b7(0xee):_0x3ae9b7(0x199),_0x1defb6),_0x143ab9&&_0x143ab9[_0x3ae9b7(0x149)](_0x3ae9b7(0x111),'application/octet-stream;\x20charset=utf-8'),await this[_0x3ae9b7(0x1ac)][_0x3ae9b7(0xfa)](_0x1ff09f,_0x5c4801[_0x3ae9b7(0xe0)]['id']);const _0xf8a7fe=await this[_0x3ae9b7(0x121)][_0x3ae9b7(0xfe)](_0x1ff09f);if(_0xf8a7fe&&_0x143ab9){const _0x772b5f={'message':_0xf8a7fe,'code':0x1f4};return _0x143ab9[_0x3ae9b7(0x1d7)](JSON[_0x3ae9b7(0xda)](_0x772b5f)),_0x143ab9[_0x3ae9b7(0x18f)]();}if(_0x58a8c8){const _0x3b6849=await this[_0x3ae9b7(0x1cc)]['findOne']({'where':{'id':_0x58a8c8,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x3b6849)throw new common_1[(_0x3ae9b7(0x16a))](_0x3ae9b7(0x12e),common_1['HttpStatus']['BAD_REQUEST']);_0x3b6849['preset']&&(_0x37d8ea=_0x3b6849['preset']);}else{if(_0x29d62a)_0x37d8ea=systemMessage;else{if(_0x2f63bb)_0x37d8ea=_0x2f63bb;else{const _0x49d756=new Date()[_0x3ae9b7(0x146)]()['split']('T')[0x0],_0x78a54f=await this[_0x3ae9b7(0x1b8)]['getConfigs'](['systemPreMessage']);_0x37d8ea=_0x78a54f+(_0x3ae9b7(0x1d1)+_0x49d756);}}}let _0x3f1b61='';if(_0x380094){_0x3f1b61=await(0x0,utils_1['compileNetwork'])(_0x1ff09f);const _0x5e6b58=new Date()[_0x3ae9b7(0x146)]()[_0x3ae9b7(0x181)]('T')[0x0],_0x56bed8=await this[_0x3ae9b7(0x1b8)][_0x3ae9b7(0xdd)]([_0x3ae9b7(0xe6)]);_0x37d8ea=_0x56bed8+(_0x3ae9b7(0x1d1)+_0x5e6b58);}const _0x38e6b8=await this['getRequestParams'](options,_0x37d8ea,_0x553df6,_0x471592[_0x3ae9b7(0x179)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x35073c}=_0x553df6;_0x143ab9&&_0x143ab9[_0x3ae9b7(0x1ae)](0xc8);let _0x1e0e76=null,_0x5e8366=null;try{if(_0x143ab9){let _0x33d3e2=null,_0x28ec9f=![];_0x143ab9['on']('close',async()=>{const _0x365cd1=_0x3ae9b7;if(_0x28ec9f)return;_0xca69f3[_0x365cd1(0x10d)]();const _0x2c4da5=await(0x0,openai_1[_0x365cd1(0x125)])(_0x1ff09f)||0x0,_0x4e20cf=await(0x0,openai_1['getTokenCount'])(_0x33d3e2===null||_0x33d3e2===void 0x0?void 0x0:_0x33d3e2[_0x365cd1(0x1c6)])||0x0,_0x4df844=_0x2c4da5+_0x4e20cf,_0x198c7b=(0x0,utils_1[_0x365cd1(0x183)])(_0x5c4801);await this['chatLogService'][_0x365cd1(0x1d2)]({'appId':_0x58a8c8,'curIp':_0x198c7b,'userId':_0x5c4801[_0x365cd1(0xe0)]['id'],'type':balance_constant_1[_0x365cd1(0x141)]['CHAT_TYPE'],'prompt':_0x1ff09f,'imageUrl':_0x3c127d,'activeModel':_0x1fb964,'answer':'','promptTokens':_0x2c4da5,'completionTokens':0x0,'totalTokens':_0x2c4da5,'model':_0x12b9ad,'role':_0x365cd1(0xe0),'groupId':_0x3fd034,'requestOptions':JSON[_0x365cd1(0xda)]({'options':null,'prompt':_0x1ff09f})}),await this[_0x365cd1(0x115)][_0x365cd1(0x1d2)]({'appId':_0x58a8c8,'curIp':_0x198c7b,'userId':_0x5c4801[_0x365cd1(0xe0)]['id'],'type':balance_constant_1[_0x365cd1(0x141)][_0x365cd1(0xf0)],'prompt':_0x1ff09f,'answer':_0x33d3e2===null||_0x33d3e2===void 0x0?void 0x0:_0x33d3e2['text'],'promptTokens':_0x2c4da5,'completionTokens':_0x4e20cf,'totalTokens':_0x4df844,'model':_0x12b9ad,'role':_0x365cd1(0x197),'groupId':_0x3fd034,'requestOptions':JSON[_0x365cd1(0xda)]({'options':{'model':_0x12b9ad,'temperature':_0x52a754},'prompt':_0x1ff09f}),'conversationOptions':JSON[_0x365cd1(0xda)]({'conversationId':_0x33d3e2===null||_0x33d3e2===void 0x0?void 0x0:_0x33d3e2[_0x365cd1(0x133)],'model':_0x12b9ad,'parentMessageId':_0x33d3e2===null||_0x33d3e2===void 0x0?void 0x0:_0x33d3e2['id'],'temperature':_0x52a754})});let _0x456007=_0x1defb6;_0x369082===!![]&&(_0x456007=Math[_0x365cd1(0x1a3)](_0x1defb6*_0x4df844/_0x2ddbea)),await this[_0x365cd1(0x1da)][_0x365cd1(0x19a)](_0x5c4801[_0x365cd1(0xe0)]['id'],_0x365cd1(0x14f)+(_0xfb2fb5===0x1?0x3:0x4),_0x456007,_0x4df844);});if(Number(_0x441ee6)===0x1){const {key:_0x59d66d,maxToken:_0x286a8d,maxTokenRes:_0x317c70,proxyResUrl:_0x1fccc7}=await this[_0x3ae9b7(0x192)](_0x553df6),{parentMessageId:_0x2663f3,completionParams:_0x401b6a,systemMessage:_0x3ced25}=_0x38e6b8,{model:_0x312243,temperature:_0x3d6a9d}=_0x401b6a,{context:_0x322c15}=await this[_0x3ae9b7(0x16b)][_0x3ae9b7(0x1ca)](_0x380094?_0x3f1b61:_0x1ff09f,{'parentMessageId':_0x2663f3,'systemMessage':_0x3ced25,'maxModelToken':_0x286a8d,'maxResponseTokens':_0x317c70,'maxRounds':(0x0,helper_1[_0x3ae9b7(0x17b)])(_0x2c771b),'imageUrl':_0x3c127d,'activeModel':_0x1fb964});let _0x45b53b=!![];_0x1e0e76=await(0x0,openai_1[_0x3ae9b7(0x118)])(_0x322c15,{'maxToken':_0x286a8d,'maxTokenRes':_0x317c70,'apiKey':_0x3c7ac0,'model':_0x312243,'prompt':_0x1ff09f,'activeModel':_0x1fb964,'imageUrl':_0x3c127d,'temperature':_0x3d6a9d,'proxyUrl':_0x1fccc7,'onProgress':_0x25642e=>{const _0x423b38=_0x3ae9b7;_0x143ab9[_0x423b38(0x1d7)](_0x45b53b?JSON['stringify'](_0x25642e):'\x0a'+JSON['stringify'](_0x25642e)),_0x33d3e2=_0x25642e,_0x45b53b=![];}},this[_0x3ae9b7(0x1c5)]),_0x28ec9f=!![];}if(Number(_0x441ee6)===0x2){let _0x290fe8=!![];const {context:_0xe87a9a}=await this[_0x3ae9b7(0x16b)]['buildMessageFromParentMessageId'](_0x380094?_0x3f1b61:_0x1ff09f,{'parentMessageId':_0x1c0c18,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x2c771b)});_0x1e0e76=await(0x0,baidu_1[_0x3ae9b7(0x155)])(_0x380094?_0x3f1b61:_0xe87a9a,{'temperature':_0x52a754,'accessToken':_0x3b8405,'model':_0x12b9ad,'onProgress':_0x215676=>{const _0x267b8f=_0x3ae9b7;_0x143ab9[_0x267b8f(0x1d7)](_0x290fe8?JSON['stringify'](_0x215676):'\x0a'+JSON['stringify'](_0x215676)),_0x290fe8=![],_0x33d3e2=_0x215676;}}),_0x28ec9f=!![];}if(Number(_0x441ee6)===0x3){let _0x2c8168=!![];const {context:_0x58dd1f}=await this[_0x3ae9b7(0x16b)][_0x3ae9b7(0x1ca)](_0x380094?_0x3f1b61:_0x1ff09f,{'parentMessageId':_0x1c0c18,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x2c771b)});_0x1e0e76=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x380094?_0x3f1b61:_0x58dd1f,{'temperature':_0x52a754,'key':_0x35073c,'model':_0x12b9ad,'onProgress':_0x18ca3b=>{const _0x59fe38=_0x3ae9b7;_0x143ab9[_0x59fe38(0x1d7)](_0x2c8168?JSON[_0x59fe38(0xda)](_0x18ca3b):'\x0a'+JSON[_0x59fe38(0xda)](_0x18ca3b)),_0x2c8168=![],_0x33d3e2=_0x18ca3b;}}),_0x28ec9f=!![];}const _0x487b11={'id':this['nineStore'][_0x3ae9b7(0x1be)](),'text':_0x1ff09f,'role':_0x3ae9b7(0xe0),'name':undefined,'usage':null,'imageUrl':_0x3c127d,'activeModel':_0x1fb964,'parentMessageId':_0x1c0c18,'conversationId':_0x1e0e76===null||_0x1e0e76===void 0x0?void 0x0:_0x1e0e76[_0x3ae9b7(0x133)]};_0x5e8366={'model':_0x12b9ad,'parentMessageId':_0x1c0c18},await this[_0x3ae9b7(0x16b)][_0x3ae9b7(0x156)](_0x487b11);const _0x53b587={'id':_0x1e0e76['id'],'text':_0x1e0e76[_0x3ae9b7(0x1c6)],'role':_0x3ae9b7(0x197),'name':undefined,'usage':_0x1e0e76===null||_0x1e0e76===void 0x0?void 0x0:_0x1e0e76[_0x3ae9b7(0x12c)],'imageUrl':_0x3c127d,'parentMessageId':_0x487b11['id'],'conversationId':_0x1e0e76===null||_0x1e0e76===void 0x0?void 0x0:_0x1e0e76['conversationId']};await this[_0x3ae9b7(0x16b)][_0x3ae9b7(0x156)](_0x53b587),_0x5e8366={'model':_0x12b9ad,'parentMessageId':_0x487b11['id']};}else{const {key:_0x4415ec,maxToken:_0x369515,maxTokenRes:_0x2e65df,proxyResUrl:_0x58242c}=await this[_0x3ae9b7(0x192)](_0x553df6),{parentMessageId:_0x405e1f,completionParams:_0x2ee29c,systemMessage:_0x1150eb}=_0x38e6b8,{model:_0x525dc4,temperature:_0x18b8c3}=_0x2ee29c,{context:_0x74190e}=await this[_0x3ae9b7(0x16b)][_0x3ae9b7(0x1ca)](_0x380094?_0x3f1b61:_0x1ff09f,{'parentMessageId':_0x405e1f,'systemMessage':_0x1150eb,'maxRounds':(0x0,helper_1[_0x3ae9b7(0x17b)])(_0x2c771b)});_0x1e0e76=await(0x0,openai_1[_0x3ae9b7(0x118)])(_0x74190e,{'apiKey':_0x3c7ac0,'model':_0x525dc4,'temperature':_0x18b8c3,'proxyUrl':_0x58242c,'onProgress':null,'prompt':_0x1ff09f});}let _0x4d796b=null,_0x1e0813=null;_0x12b9ad['includes'](_0x3ae9b7(0x150))?_0x4d796b=((_0x17af7e=_0x1e0e76[_0x3ae9b7(0x168)])===null||_0x17af7e===void 0x0?void 0x0:_0x17af7e['usage'])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x1e0813=await(0x0,helper_1[_0x3ae9b7(0x1d4)])(_0x441ee6,_0x1e0e76,_0x5e8366);const {prompt_tokens:_0x4688ef,completion_tokens:_0x471e34,total_tokens:_0x3483a1}=_0x12b9ad[_0x3ae9b7(0x18b)]('dall')?_0x4d796b:_0x1e0813[_0x3ae9b7(0x12c)];let _0x737505=_0x1defb6;_0x369082===!![]&&(_0x737505=Math['ceil'](_0x1defb6*_0x3483a1/_0x2ddbea));await this[_0x3ae9b7(0x1da)][_0x3ae9b7(0x19a)](_0x5c4801[_0x3ae9b7(0xe0)]['id'],_0x3ae9b7(0x14f)+(_0xfb2fb5===0x1?0x3:0x4),_0x737505,_0x3483a1),await this[_0x3ae9b7(0x166)]['saveUseLog'](_0x377717,_0x3483a1);const _0x48bd92=(0x0,utils_1['getClientIp'])(_0x5c4801);await this[_0x3ae9b7(0x115)][_0x3ae9b7(0x1d2)]({'appId':_0x58a8c8,'curIp':_0x48bd92,'userId':_0x5c4801[_0x3ae9b7(0xe0)]['id'],'type':balance_constant_1[_0x3ae9b7(0x141)][_0x3ae9b7(0xf0)],'prompt':_0x1ff09f,'imageUrl':_0x3c127d,'activeModel':_0x1fb964,'answer':'','promptTokens':_0x4688ef,'completionTokens':0x0,'totalTokens':_0x3483a1,'model':_0x12b9ad,'role':_0x3ae9b7(0xe0),'groupId':_0x3fd034,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x1ff09f})}),await this[_0x3ae9b7(0x115)][_0x3ae9b7(0x1d2)]({'appId':_0x58a8c8,'curIp':_0x48bd92,'userId':_0x5c4801['user']['id'],'type':balance_constant_1[_0x3ae9b7(0x141)][_0x3ae9b7(0xf0)],'prompt':_0x1ff09f,'imageUrl':_0x1e0e76===null||_0x1e0e76===void 0x0?void 0x0:_0x1e0e76[_0x3ae9b7(0x122)],'answer':_0x1e0e76[_0x3ae9b7(0x1c6)],'promptTokens':_0x4688ef,'completionTokens':_0x471e34,'totalTokens':_0x3483a1,'model':_0x12b9ad,'role':_0x3ae9b7(0x197),'groupId':_0x3fd034,'requestOptions':JSON[_0x3ae9b7(0xda)]({'options':{'model':_0x12b9ad,'temperature':_0x52a754},'prompt':_0x1ff09f}),'conversationOptions':JSON['stringify']({'conversationId':_0x1e0e76[_0x3ae9b7(0x133)],'model':_0x12b9ad,'parentMessageId':_0x1e0e76['id'],'temperature':_0x52a754})}),common_1[_0x3ae9b7(0xf3)]['debug'](_0x3ae9b7(0x191)+_0x5c4801[_0x3ae9b7(0xe0)]['id']+_0x3ae9b7(0x1c1)+_0x814057+'-'+_0x1fb964+_0x3ae9b7(0x177)+_0x3483a1+_0x3ae9b7(0x11d)+_0x737505,'ChatgptService');const _0x5f2b3f=await this[_0x3ae9b7(0x1da)][_0x3ae9b7(0x18d)](_0x5c4801[_0x3ae9b7(0xe0)]['id']);return _0x1e0e76['userBanance']=Object[_0x3ae9b7(0x10f)]({},_0x5f2b3f),_0x1e0e76[_0x3ae9b7(0x15d)]&&(_0x1e0e76[_0x3ae9b7(0x15d)]=''),_0x1e0e76[_0x3ae9b7(0x142)]=!![],_0x143ab9?_0x143ab9[_0x3ae9b7(0x1d7)]('\x0a'+JSON[_0x3ae9b7(0xda)](_0x1e0e76)):_0x1e0e76[_0x3ae9b7(0x1c6)];}catch(_0x38f606){console[_0x3ae9b7(0xe5)](_0x3ae9b7(0x10b),_0x3c7ac0,_0x38f606);const _0x1b75ec=(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606['statusCode'])||0x190,_0x1da1dc=((_0x381481=_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0x11b)])===null||_0x381481===void 0x0?void 0x0:_0x381481['status'])||(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0xf7)])||0x190;console[_0x3ae9b7(0xe5)](_0x3ae9b7(0x123),_0x3ae9b7(0x1c9),_0x1b75ec,_0x3ae9b7(0x15e),_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0x15e)],'statusText:',(_0x31b727=_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0x11b)])===null||_0x31b727===void 0x0?void 0x0:_0x31b727[_0x3ae9b7(0x161)],'status',(_0x4233a4=_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0x11b)])===null||_0x4233a4===void 0x0?void 0x0:_0x4233a4['status']);if(_0x38f606[_0x3ae9b7(0x1ae)]&&_0x38f606['status']===0x192){const _0x9db7b2={'message':_0x3ae9b7(0x11f)+_0x38f606['message'],'code':0x192};if(_0x143ab9)return _0x143ab9[_0x3ae9b7(0x1d7)](JSON['stringify'](_0x9db7b2));else throw new common_1[(_0x3ae9b7(0x16a))](_0x38f606['message'],common_1[_0x3ae9b7(0x185)][_0x3ae9b7(0x14d)]);}if(!_0x1da1dc){if(_0x143ab9)return _0x143ab9[_0x3ae9b7(0x1d7)](JSON[_0x3ae9b7(0xda)]({'message':_0x38f606[_0x3ae9b7(0x15e)],'code':0x1f4}));else throw new common_1[(_0x3ae9b7(0x16a))](_0x38f606[_0x3ae9b7(0x15e)],common_1[_0x3ae9b7(0x185)][_0x3ae9b7(0x102)]);}let _0x813a3b=errorMessage_constant_1[_0x3ae9b7(0x186)][_0x1da1dc]?errorMessage_constant_1[_0x3ae9b7(0x186)][_0x1da1dc]:_0x3ae9b7(0x1bd);(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0x15e)][_0x3ae9b7(0x18b)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.'))&&Number(_0x441ee6)===0x1&&(await this[_0x3ae9b7(0x166)][_0x3ae9b7(0x117)](_0x377717,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x813a3b=_0x3ae9b7(0xf1));(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0xf7)])===0x1ad&&_0x38f606['message'][_0x3ae9b7(0x18b)](_0x3ae9b7(0xf2))&&Number(_0x441ee6)===0x1&&(await this[_0x3ae9b7(0x166)][_0x3ae9b7(0x117)](_0x377717,_0x3ae9b7(0x147),-0x3),_0x813a3b='当前模型key余额已耗尽');(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0xf7)])===0x1ad&&(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0x161)])==='Too\x20Many\x20Requests'&&(_0x813a3b=_0x3ae9b7(0x190));(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0xf7)])===0x191&&_0x38f606[_0x3ae9b7(0x15e)]['includes'](_0x3ae9b7(0x1a2))&&Number(_0x441ee6)===0x1&&(await this[_0x3ae9b7(0x166)][_0x3ae9b7(0x117)](_0x377717,_0x3ae9b7(0x1a8),-0x2),_0x813a3b=_0x3ae9b7(0x145));(_0x38f606===null||_0x38f606===void 0x0?void 0x0:_0x38f606[_0x3ae9b7(0xf7)])===0x194&&_0x38f606[_0x3ae9b7(0x15e)][_0x3ae9b7(0x18b)](_0x3ae9b7(0x13d))&&Number(_0x441ee6)===0x1&&(await this['modelsService'][_0x3ae9b7(0x117)](_0x377717,_0x3ae9b7(0x1bc),-0x4),_0x813a3b=_0x3ae9b7(0x13c));_0x1b75ec===0x190&&console[_0x3ae9b7(0xe5)](_0x3ae9b7(0x130),_0x38f606,_0x38f606[_0x3ae9b7(0x15e)]);const _0x9a49f9={'message':_0x813a3b||_0x3ae9b7(0x162),'code':_0x1b75ec===0x191?0x190:_0x1b75ec||0x1f4};if(_0x143ab9)return _0x143ab9[_0x3ae9b7(0x1d7)](JSON[_0x3ae9b7(0xda)](_0x9a49f9));else throw new common_1['HttpException'](_0x9a49f9[_0x3ae9b7(0x15e)],common_1[_0x3ae9b7(0x185)][_0x3ae9b7(0x102)]);}finally{_0x143ab9&&_0x143ab9[_0x3ae9b7(0x18f)]();}}async[_0x2fcd2f(0x1b1)](_0x423c4e,_0xb51496){const _0x36b52d=_0x2fcd2f;var _0x29025b,_0x4c5484,_0x4401e7,_0x3f1a42;await this[_0x36b52d(0x1ac)][_0x36b52d(0xfa)](_0x423c4e[_0x36b52d(0xe4)],_0xb51496['user']['id']),await this[_0x36b52d(0x19c)]['checkUserStatus'](_0xb51496['user']);const _0x33ffa0=(_0x423c4e===null||_0x423c4e===void 0x0?void 0x0:_0x423c4e[_0x36b52d(0x1d6)])==='hd'?0x4:0x2;await this[_0x36b52d(0x1da)][_0x36b52d(0x195)](_0xb51496,'mjDraw',_0x33ffa0);let _0x475cd2=[];const _0x1c5492=await this[_0x36b52d(0x166)][_0x36b52d(0xd9)](_0x36b52d(0x1b9)),_0x53a64d=_0x1c5492===null||_0x1c5492===void 0x0?void 0x0:_0x1c5492['id'],{key:_0x3e4612,proxyResUrl:_0x46c028}=await this[_0x36b52d(0x192)](_0x1c5492);common_1[_0x36b52d(0xf3)]['log'](_0x36b52d(0x16e)+_0x423c4e[_0x36b52d(0xe4)]+_0x36b52d(0x178)+_0x3e4612,_0x36b52d(0x198));try{const _0x3f3998=_0x46c028+_0x36b52d(0xff),_0x75b551=Object[_0x36b52d(0x10f)](Object['assign']({},_0x423c4e),{'model':_0x36b52d(0x1b9)});console[_0x36b52d(0xe5)]('dall-e\x20draw\x20params:\x20',_0x75b551);const _0x708261=await axios_1['default'][_0x36b52d(0x135)](_0x3f3998,Object[_0x36b52d(0x10f)](Object['assign']({},_0x75b551),{'response_format':_0x36b52d(0xfc)}),{'headers':{'Authorization':'Bearer\x20'+_0x3e4612}});_0x475cd2=_0x708261[_0x36b52d(0x188)][_0x36b52d(0x188)];const _0x5e053f=[];for(const _0x4fac8d of _0x475cd2){const _0x5516da=uuid['v4']()[_0x36b52d(0xe8)](0x0,0xa)+_0x36b52d(0x151),_0x2b6232=Buffer[_0x36b52d(0x173)](_0x4fac8d['b64_json'],_0x36b52d(0x10c));_0x5e053f[_0x36b52d(0x1a4)](this[_0x36b52d(0x1c5)]['uploadFile']({'filename':_0x5516da,'buffer':_0x2b6232}));}const _0x25d402=await Promise[_0x36b52d(0x1aa)](_0x5e053f);await this[_0x36b52d(0x1da)][_0x36b52d(0x19a)](_0xb51496[_0x36b52d(0xe0)]['id'],'mjDraw',(_0x75b551===null||_0x75b551===void 0x0?void 0x0:_0x75b551[_0x36b52d(0x1d6)])===_0x36b52d(0x12b)?0x2:0x4,_0x33ffa0);const _0x173d3b=(0x0,utils_1[_0x36b52d(0x183)])(_0xb51496),_0x1191d4=[],_0x4594f8=await this['uploadService'][_0x36b52d(0x19f)](),[_0x363223,_0x439752]=_0x423c4e['size'][_0x36b52d(0x181)]('x');return _0x25d402[_0x36b52d(0x1c4)](_0x2e635b=>{const _0x2b60e6=_0x36b52d;_0x1191d4['push'](this[_0x2b60e6(0x115)]['saveChatLog']({'curIp':_0x173d3b,'userId':_0xb51496[_0x2b60e6(0xe0)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x423c4e[_0x2b60e6(0xe4)],'answer':_0x2e635b,'fileInfo':JSON[_0x2b60e6(0xda)]({'cosType':_0x4594f8,'width':_0x363223,'height':_0x439752,'cosUrl':_0x2e635b}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x2b60e6(0x1b9)}));}),await Promise[_0x36b52d(0x1aa)](_0x1191d4),_0x25d402;}catch(_0x4d3e72){const _0x5873cd=((_0x29025b=_0x4d3e72===null||_0x4d3e72===void 0x0?void 0x0:_0x4d3e72[_0x36b52d(0x11b)])===null||_0x29025b===void 0x0?void 0x0:_0x29025b[_0x36b52d(0x1ae)])||0x1f4;console[_0x36b52d(0xe5)]('openai-draw\x20error:\x20',JSON[_0x36b52d(0xda)](_0x4d3e72),_0x3e4612,_0x5873cd);const _0x619d2b=(_0x3f1a42=(_0x4401e7=(_0x4c5484=_0x4d3e72===null||_0x4d3e72===void 0x0?void 0x0:_0x4d3e72[_0x36b52d(0x11b)])===null||_0x4c5484===void 0x0?void 0x0:_0x4c5484[_0x36b52d(0x188)])===null||_0x4401e7===void 0x0?void 0x0:_0x4401e7[_0x36b52d(0x126)])===null||_0x3f1a42===void 0x0?void 0x0:_0x3f1a42['message'];if(_0x5873cd===0x1ad)throw new common_1[(_0x36b52d(0x16a))](_0x36b52d(0x19b),common_1[_0x36b52d(0x185)][_0x36b52d(0x102)]);if(_0x5873cd===0x190&&_0x619d2b['includes'](_0x36b52d(0x159)))throw new common_1['HttpException']('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1[_0x36b52d(0x185)][_0x36b52d(0x102)]);if(_0x5873cd===0x190&&_0x619d2b[_0x36b52d(0x18b)](_0x36b52d(0xdc))){await this[_0x36b52d(0x166)][_0x36b52d(0x117)](_0x53a64d,_0x36b52d(0x17c),-0x1);throw new common_1[(_0x36b52d(0x16a))](_0x36b52d(0x172),common_1['HttpStatus'][_0x36b52d(0x102)]);}if(_0x5873cd===0x1f4)throw new common_1[(_0x36b52d(0x16a))](_0x36b52d(0x132),common_1['HttpStatus'][_0x36b52d(0x102)]);if(_0x5873cd===0x191)throw new common_1[(_0x36b52d(0x16a))](_0x36b52d(0x1cd),common_1[_0x36b52d(0x185)][_0x36b52d(0x102)]);throw new common_1[(_0x36b52d(0x16a))]('绘制图片失败，请稍后试试吧！',common_1[_0x36b52d(0x185)]['BAD_REQUEST']);}}async[_0x2fcd2f(0x110)](){const _0x9bc450=_0x2fcd2f,_0x213d70=await this[_0x9bc450(0xf8)][_0x9bc450(0x1a5)]({'where':{'status':0x1},'select':['id','key',_0x9bc450(0x104),_0x9bc450(0x14f),'maxModelTokens','maxResponseTokens',_0x9bc450(0xfb),_0x9bc450(0x17a)]}),_0x1a125f=_0x213d70[_0x9bc450(0x1ba)](_0x381585=>_0x381585[_0x9bc450(0x14f)][_0x9bc450(0x18b)](_0x9bc450(0x175))),_0x1d09df=_0x213d70[_0x9bc450(0x1ba)](_0x6efc79=>_0x6efc79[_0x9bc450(0x14f)][_0x9bc450(0x18b)]('gpt-4'));this[_0x9bc450(0xe2)]={'list3':_0x1a125f,'list4':_0x1d09df};}async[_0x2fcd2f(0x1a7)](_0x5e2cf3){const _0x1a86ed=_0x2fcd2f,_0x56d9c0=await this[_0x1a86ed(0x1b8)]['getConfigs']([_0x1a86ed(0x112)]);return(_0x5e2cf3===null||_0x5e2cf3===void 0x0?void 0x0:_0x5e2cf3[_0x1a86ed(0x16f)])||_0x56d9c0||_0x1a86ed(0x114);}async['formatModelToken'](_0x29be75){const _0x5e5f76=_0x2fcd2f,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x5e5f76(0x1b8)][_0x5e5f76(0xdd)]([_0x5e5f76(0xef),'openaiModel3MaxTokensRes','openaiModel3MaxTokens16k','openaiModel3MaxTokens16kRes',_0x5e5f76(0x1ad),_0x5e5f76(0x1d3),_0x5e5f76(0x158),_0x5e5f76(0x129),_0x5e5f76(0x112)]);let _0x532905=null,_0x546ac4=null,_0x4b89e2=null,{model:_0x19e1af,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x3af5eb}=_0x29be75;return _0x19e1af[_0x5e5f76(0x18a)]()[_0x5e5f76(0x18b)](_0x5e5f76(0x13b))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x546ac4>=0x1000&&(maxModelTokens=0x1000),_0x532905=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x546ac4=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x19e1af[_0x5e5f76(0x18a)]()[_0x5e5f76(0x18b)](_0x5e5f76(0xea))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x546ac4>=0x4000&&(maxModelTokens=0x4000),_0x532905=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x546ac4=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x19e1af[_0x5e5f76(0x18a)]()[_0x5e5f76(0x18b)](_0x5e5f76(0x1b5))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x546ac4>=0x1000&&(maxModelTokens=0x1000),_0x532905=maxModelTokens||0x3ffc,_0x546ac4=maxResponseTokens||0x1000)),_0x19e1af[_0x5e5f76(0x18a)]()[_0x5e5f76(0x18b)](_0x5e5f76(0x175))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x546ac4>=0x7d0&&(maxModelTokens=0x7d0),_0x532905=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x546ac4=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x19e1af['toLowerCase']()[_0x5e5f76(0x18b)]('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x546ac4>=0x2000&&(maxModelTokens=0x2000),_0x532905=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x546ac4=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x19e1af[_0x5e5f76(0x18a)]()[_0x5e5f76(0x18b)]('1106')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x546ac4>=0x1000&&(maxModelTokens=0x1000),_0x532905=maxModelTokens||0x4000,_0x546ac4=maxResponseTokens||0x1000)),_0x4b89e2=proxyUrl||openaiBaseUrl||_0x5e5f76(0x114),_0x546ac4>=_0x532905&&(_0x546ac4=Math['floor'](_0x532905/0x2)),{'key':_0x3af5eb,'maxToken':_0x532905,'maxTokenRes':_0x546ac4,'proxyResUrl':_0x4b89e2};}async['setChatBoxType'](_0x458612,_0x22b206){const _0x565337=_0x2fcd2f;try{const {name:_0x346763,icon:_0x485a6,order:_0x1d7e75,id:_0x44c6ae,status:_0x196bf8}=_0x22b206;return _0x44c6ae?await this[_0x565337(0x1b0)]['update']({'id':_0x44c6ae},{'name':_0x346763,'icon':_0x485a6,'order':_0x1d7e75,'status':_0x196bf8}):await this[_0x565337(0x1b0)]['save']({'name':_0x346763,'icon':_0x485a6,'order':_0x1d7e75,'status':_0x196bf8});}catch(_0x261465){console['log'](_0x565337(0x163),_0x261465);}}async[_0x2fcd2f(0x1d5)](_0x2c5688,_0x5ec71a){const _0x2cd7b4=_0x2fcd2f,{id:_0x3a0fb9}=_0x5ec71a;if(!_0x3a0fb9)throw new common_1[(_0x2cd7b4(0x16a))](_0x2cd7b4(0x1a0),common_1[_0x2cd7b4(0x185)][_0x2cd7b4(0x102)]);const _0x4bfab7=await this[_0x2cd7b4(0x14a)][_0x2cd7b4(0x1b2)]({'where':{'typeId':_0x3a0fb9}});if(_0x4bfab7)throw new common_1['HttpException'](_0x2cd7b4(0xf5),common_1[_0x2cd7b4(0x185)][_0x2cd7b4(0x102)]);return await this[_0x2cd7b4(0x1b0)]['delete']({'id':_0x3a0fb9});}async[_0x2fcd2f(0x171)](){const _0x1b1ca7=_0x2fcd2f;return await this[_0x1b1ca7(0x1b0)][_0x1b1ca7(0x1a5)]({'order':{'order':_0x1b1ca7(0x196)}});}async['setChatBox'](_0x214ad3,_0x3de590){const _0x2ba682=_0x2fcd2f,{title:_0x154106,prompt:_0x144898,appId:_0x4c84be,order:_0x4eb868,status:_0x32a450,typeId:_0x5cb3cb,id:_0x41e9bc,url:_0x4b58e1}=_0x3de590;if(!_0x5cb3cb)throw new common_1[(_0x2ba682(0x16a))](_0x2ba682(0xe1),common_1[_0x2ba682(0x185)][_0x2ba682(0x102)]);try{const _0x6bd8c6={'title':_0x154106,'order':_0x4eb868,'status':_0x32a450,'typeId':_0x5cb3cb,'url':_0x4b58e1};return _0x6bd8c6[_0x2ba682(0x184)]=_0x4c84be||0x0,_0x6bd8c6['prompt']=_0x144898||'',_0x41e9bc?await this[_0x2ba682(0x14a)][_0x2ba682(0x106)]({'id':_0x41e9bc},_0x6bd8c6):await this[_0x2ba682(0x14a)][_0x2ba682(0x119)](_0x6bd8c6);}catch(_0x4c2e5b){console[_0x2ba682(0xe5)]('error:\x20',_0x4c2e5b);}}async[_0x2fcd2f(0x1c2)](_0x3d8b24,_0x433b5f){const _0x2de642=_0x2fcd2f,{id:_0x12b30a}=_0x433b5f;if(!_0x12b30a)throw new common_1['HttpException'](_0x2de642(0x1a0),common_1[_0x2de642(0x185)]['BAD_REQUEST']);return await this[_0x2de642(0x14a)][_0x2de642(0x1c3)]({'id':_0x12b30a});}async[_0x2fcd2f(0x148)](){const _0x5d15b3=_0x2fcd2f,_0x3486bb=await this[_0x5d15b3(0x14a)][_0x5d15b3(0x1a5)]({'order':{'order':_0x5d15b3(0x196)}}),_0x2380f7=[...new Set(_0x3486bb['map'](_0x125597=>_0x125597[_0x5d15b3(0x128)]))],_0x58635a=[...new Set(_0x3486bb['map'](_0xd769bc=>_0xd769bc[_0x5d15b3(0x184)]))],_0x4de65b=await this[_0x5d15b3(0x1b0)][_0x5d15b3(0x1a5)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2380f7)}}),_0x3881a6=await this['appEntity']['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x58635a)}});return _0x3486bb[_0x5d15b3(0x15f)](_0x216f7b=>{const _0x3bc633=_0x5d15b3,{typeId:_0x325e0e,appId:_0x43eb19}=_0x216f7b;return _0x216f7b[_0x3bc633(0x138)]=_0x4de65b[_0x3bc633(0x1a5)](_0x5244ec=>_0x5244ec['id']===_0x325e0e),_0x216f7b['appInfo']=_0x3881a6[_0x3bc633(0x1a5)](_0x3541d8=>_0x3541d8['id']===_0x43eb19),_0x216f7b;});}async[_0x2fcd2f(0x124)](){const _0x28adde=_0x2fcd2f,_0x312feb=await this[_0x28adde(0x1b0)][_0x28adde(0x1a5)]({'order':{'order':_0x28adde(0x196)},'where':{'status':!![]}}),_0x1c80a4=await this[_0x28adde(0x14a)][_0x28adde(0x1a5)]({'where':{'status':!![]}}),_0x4edfab=[...new Set(_0x1c80a4[_0x28adde(0x15f)](_0x41d743=>_0x41d743['appId']))],_0x1745c0=await this['appEntity'][_0x28adde(0x1a5)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4edfab)}});return _0x1c80a4[_0x28adde(0x1c4)](_0x2aee62=>{const _0x2e4c09=_0x28adde,_0x28e008=_0x1745c0[_0x2e4c09(0x1a5)](_0x484771=>_0x484771['id']===_0x2aee62['appId']);return _0x2aee62[_0x2e4c09(0x1a9)]=_0x28e008===null||_0x28e008===void 0x0?void 0x0:_0x28e008[_0x2e4c09(0x1a9)],_0x2aee62;}),_0x312feb['map'](_0x4c3a2d=>{const _0x59a633=_0x28adde;return _0x4c3a2d[_0x59a633(0x109)]=_0x1c80a4['filter'](_0x536321=>_0x536321[_0x59a633(0x128)]===_0x4c3a2d['id']&&_0x536321[_0x59a633(0x1ae)]),_0x4c3a2d;});}async[_0x2fcd2f(0x15a)](_0x30ea76,_0x34a102){const _0x26f8c3=_0x2fcd2f;try{const {name:_0x17945f,icon:_0x4c4bf2,order:_0x1bcd46,id:_0x5ef6d8,status:_0x4effe4}=_0x34a102;return _0x5ef6d8?await this['chatPreTypeEntity'][_0x26f8c3(0x106)]({'id':_0x5ef6d8},{'name':_0x17945f,'icon':_0x4c4bf2,'order':_0x1bcd46,'status':_0x4effe4}):await this[_0x26f8c3(0x15c)][_0x26f8c3(0x119)]({'name':_0x17945f,'icon':_0x4c4bf2,'order':_0x1bcd46,'status':_0x4effe4});}catch(_0x148317){console['log'](_0x26f8c3(0x163),_0x148317);}}async[_0x2fcd2f(0x116)](_0x240ff9,_0x358977){const _0x5a3c4e=_0x2fcd2f,{id:_0x1bc77a}=_0x358977;if(!_0x1bc77a)throw new common_1[(_0x5a3c4e(0x16a))](_0x5a3c4e(0x1a0),common_1[_0x5a3c4e(0x185)][_0x5a3c4e(0x102)]);const _0x1adfbf=await this[_0x5a3c4e(0x14a)][_0x5a3c4e(0x1b2)]({'where':{'typeId':_0x1bc77a}});if(_0x1adfbf)throw new common_1[(_0x5a3c4e(0x16a))](_0x5a3c4e(0xf5),common_1['HttpStatus'][_0x5a3c4e(0x102)]);return await this[_0x5a3c4e(0x15c)][_0x5a3c4e(0x1c3)]({'id':_0x1bc77a});}async['queryChatPreType'](){const _0x3d4dec=_0x2fcd2f;return await this['chatPreTypeEntity'][_0x3d4dec(0x1a5)]({'order':{'order':_0x3d4dec(0x196)}});}async['setChatPre'](_0x2593f3,_0x4dbe29){const _0x501366=_0x2fcd2f,{title:_0x5b2d3f,prompt:_0x14de48,appId:_0x5c73f9,order:_0x340a40,status:_0x21320b,typeId:_0x3b79c5,id:_0x551ba8,url:_0x476704}=_0x4dbe29;if(!_0x3b79c5)throw new common_1[(_0x501366(0x16a))](_0x501366(0xe1),common_1[_0x501366(0x185)]['BAD_REQUEST']);try{const _0x1032b3={'title':_0x5b2d3f,'prompt':_0x14de48,'order':_0x340a40,'status':_0x21320b,'typeId':_0x3b79c5,'url':_0x476704};return _0x551ba8?await this['chatPreEntity']['update']({'id':_0x551ba8},_0x1032b3):await this[_0x501366(0x1c8)][_0x501366(0x119)](_0x1032b3);}catch(_0x3e0bdb){console[_0x501366(0xe5)]('error:\x20',_0x3e0bdb);}}async[_0x2fcd2f(0x174)](_0x2a202d,_0x4b81db){const _0x237455=_0x2fcd2f,{id:_0x38837b}=_0x4b81db;if(!_0x38837b)throw new common_1[(_0x237455(0x16a))](_0x237455(0x1a0),common_1[_0x237455(0x185)][_0x237455(0x102)]);return await this['chatPreEntity'][_0x237455(0x1c3)]({'id':_0x38837b});}async[_0x2fcd2f(0x1cf)](){const _0x471c3c=_0x2fcd2f,_0x1481e6=await this[_0x471c3c(0x1c8)][_0x471c3c(0x1a5)]({'order':{'order':_0x471c3c(0x196)}}),_0x5dd38e=[...new Set(_0x1481e6[_0x471c3c(0x15f)](_0x13f101=>_0x13f101[_0x471c3c(0x128)]))],_0x321e0a=await this[_0x471c3c(0x15c)][_0x471c3c(0x1a5)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5dd38e)}});return _0x1481e6[_0x471c3c(0x15f)](_0x3752e6=>{const _0x3f1ccd=_0x471c3c,{typeId:_0x216833,appId:_0x3b3bde}=_0x3752e6;return _0x3752e6[_0x3f1ccd(0x138)]=_0x321e0a[_0x3f1ccd(0x1a5)](_0x4807b1=>_0x4807b1['id']===_0x216833),_0x3752e6;});}async[_0x2fcd2f(0x136)](){const _0x346a6d=_0x2fcd2f,_0x501d6c=await this[_0x346a6d(0x15c)][_0x346a6d(0x1a5)]({'order':{'order':_0x346a6d(0x196)},'where':{'status':!![]}}),_0x262682=await this[_0x346a6d(0x1c8)][_0x346a6d(0x1a5)]({'where':{'status':!![]}});return _0x501d6c['map'](_0x6a7d9=>{const _0x1c5f75=_0x346a6d;return _0x6a7d9[_0x1c5f75(0x109)]=_0x262682[_0x1c5f75(0x1ba)](_0x386f4a=>_0x386f4a['typeId']===_0x6a7d9['id']&&_0x386f4a[_0x1c5f75(0x1ae)]),_0x6a7d9;});}async[_0x2fcd2f(0x1af)](_0x54d938,_0x2edd93,_0x27380d){const _0x572c59=_0x2fcd2f;let _0x8597d3=0x1000,_0x4a2a1c=0x800;return _0x54d938[_0x572c59(0x18a)]()[_0x572c59(0x18b)]('gpt-4')&&(_0x8597d3=_0x2edd93>=0x2004?0x2004:_0x2edd93,_0x4a2a1c=_0x27380d>=0x1000?0x1000:_0x27380d,_0x54d938[_0x572c59(0x18a)]()[_0x572c59(0x18b)](_0x572c59(0xea))&&(_0x8597d3=_0x2edd93>=0x8000?0x8000:_0x2edd93,_0x4a2a1c=_0x27380d>=0x3e80?0x3e80:_0x27380d),(_0x54d938['toLowerCase']()[_0x572c59(0x18b)]('gpt-4-1106')||_0x54d938[_0x572c59(0x18a)]()[_0x572c59(0x18b)](_0x572c59(0x1a1)))&&(_0x8597d3=_0x2edd93>=0x1f400?0x1f400:_0x2edd93,_0x4a2a1c=_0x27380d>=0x1000?0x1000:_0x27380d)),_0x54d938[_0x572c59(0x18a)]()[_0x572c59(0x18b)](_0x572c59(0x175))&&(_0x8597d3=_0x2edd93>=0x1000?0x1000:_0x2edd93,_0x4a2a1c=_0x27380d>=0x800?0x800:_0x27380d,_0x54d938[_0x572c59(0x18a)]()['includes']('16k')&&(_0x8597d3=_0x2edd93>=0x4000?0x4000:_0x2edd93,_0x4a2a1c=_0x27380d>=0x1f40?0x1f40:_0x27380d),_0x54d938[_0x572c59(0x18a)]()[_0x572c59(0x18b)](_0x572c59(0x1b5))&&(_0x8597d3=_0x2edd93>=0x4000?0x4000:_0x2edd93,_0x4a2a1c=_0x27380d>=0x1f40?0x1f40:_0x27380d)),{'maxToken':_0x8597d3,'maxRes':_0x4a2a1c};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x2fcd2f(0x100)])(gptkeys_entity_1[_0x2fcd2f(0x143)])),__param(0x1,(0x0,typeorm_2[_0x2fcd2f(0x100)])(config_entity_1[_0x2fcd2f(0xf9)])),__param(0x2,(0x0,typeorm_2[_0x2fcd2f(0x100)])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2[_0x2fcd2f(0x100)])(chatBox_entity_1[_0x2fcd2f(0x1cb)])),__param(0x4,(0x0,typeorm_2[_0x2fcd2f(0x100)])(app_entity_1[_0x2fcd2f(0x19e)])),__param(0x5,(0x0,typeorm_2[_0x2fcd2f(0x100)])(chatPreType_entity_1[_0x2fcd2f(0x13f)])),__param(0x6,(0x0,typeorm_2[_0x2fcd2f(0x100)])(chatPre_entity_1[_0x2fcd2f(0x11c)])),__metadata('design:paramtypes',[typeorm_1[_0x2fcd2f(0x187)],typeorm_1[_0x2fcd2f(0x187)],typeorm_1['Repository'],typeorm_1[_0x2fcd2f(0x187)],typeorm_1[_0x2fcd2f(0x187)],typeorm_1[_0x2fcd2f(0x187)],typeorm_1[_0x2fcd2f(0x187)],nestjs_config_1[_0x2fcd2f(0x19d)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x2fcd2f(0x1bf)],user_service_1['UserService'],upload_service_1['UploadService'],badwords_service_1[_0x2fcd2f(0x193)],autoreply_service_1[_0x2fcd2f(0x1c0)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x2fcd2f(0x14b)],chatGroup_service_1[_0x2fcd2f(0x164)],models_service_1[_0x2fcd2f(0x1bb)]])],ChatgptService),exports[_0x2fcd2f(0x10a)]=ChatgptService;function _0x3f6f(){const _0x589083=['DrawService','model4','deductFromBalance','当前请求已过载、请稍等会儿再试试吧！','userService','ConfigService','AppEntity','getUploadType','非法操作！','gpt-4-vision-preview','Incorrect\x20API\x20key\x20provided','ceil','push','find','../app/app.entity','getModelProxyUrl','提供了错误的模型秘钥','coverImg','all','NineStore','badwordsService','openaiModel4MaxTokens','status','getMaxTokenFromModelWithOpenAi','chatBoxTypeEntity','draw','count','./helper','length','1106','redis://','REDIS_USER','globalConfigService','dall-e-3','filter','ModelsService','当前模型不是聊天模型','服务异常、请重新试试吧！！！','getUuid','ChatLogService','AutoreplyService','\x20模型名称:\x20','delChatBox','delete','forEach','uploadService','text','70125yqoxRd','chatPreEntity','code:\x20','buildMessageFromParentMessageId','ChatBoxEntity','appEntity','绘制图片失败，此次绘画被拒绝了！','./chatPreType.entity','queryChatPre','../chatLog/chatLog.service','\x0a\x20Current\x20date:\x20','saveChatLog','openaiModel4MaxTokensRes','unifiedFormattingResponse','delChatBoxType','quality','write','34XFANqh','../autoreply/autoreply.service','userBalanceService','getCurrentModelKeyInfo','stringify','./chatBox.entity','Billing\x20hard\x20limit\x20has\x20been\x20reached','getConfigs','nineai-chatlog','onModuleInit','user','缺失必要参数！','keyPool','8307088nLEABk','prompt','log','systemPreMessage','chatProcess','slice','nestjs-config','32k','metadata','chatSyncFree','./zhipu','model3','openaiModel3MaxTokens','CHAT_TYPE','当前模型key已被封禁','billing','Logger','@keyv/redis','当前分类下有未处理数据不可移除！','getBaseConfig','statusCode','gptKeysEntity','ConfigEntity','checkBadWords','openaiProxyUrl','b64_json','whiteListUser','checkAutoReply','/v1/images/generations','InjectRepository','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','BAD_REQUEST','./openai','weight','systemMessage','update','209052OcLiMW','REDIS_HOST','childList','ChatgptService','chat-error\x20<----------------------------------------->','base64','abort','../badwords/badwords.service','assign','getAllKeyList','Content-type','openaiBaseUrl','../../common/utils','https://api.openai.com','chatLogService','delChatPreType','lockKey','sendMessageFromOpenAi','save','../globalConfig/config.entity','response','ChatPreEntity',',\x20消耗积分：\x20','61705kPbciE','Catch\x20Error\x20','getRandomDrawKey','autoreplyService','imageUrl','chat-error-detail\x20\x20<----------------------------------------->','queryChatBoxFrontend','getTokenCount','error','parse','typeId','openaiModel4MaxTokens32kRes','getRequestParams','standard','usage','getOwnPropertyDescriptor','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','../models/models.service','400\x20error','decorate','绘制图片失败，请检查你的提示词是否有非法描述！','conversationId','configService','post','queryChatPreList','35932770yEJHDH','typeInfo','function','../../common/constants/balance.constant','gpt-4','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','../fanyi/fanyi.service','ChatPreTypeEntity','../chatGroup/chatGroup.service','DeductionKey','is_end','GptKeysEntity','__param','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','toISOString','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','queryChatBox','setHeader','chatBoxEntity','FanyiService','404vCrzEd','PAYMENT_REQUIRED','147xAIfJc','model','dall','.png','chat','object','./baidu','sendMessageFromBaidu','setData','checkUserStatus','openaiModel4MaxTokens32k','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','setChatPreType','__decorate','chatPreTypeEntity','result','message','map','env','statusText','Please\x20check\x20the\x20back-end\x20console','error:\x20','ChatGroupService','./store','modelsService','__esModule','detail','./../upload/upload.service','HttpException','nineStore','11370555sBWhgV','REDIS_PASSWORD','draw\x20paompt\x20info\x20<==**==>\x20','proxyUrl','abortController','queryChatBoxType','当前Key余额已不足、请重新再试一次吧！','from','delChatPre','gpt-3','chatgpt-ai-web',',\x20消耗token:\x20',',\x20key\x20===>\x20','modelInfo','openaiTimeoutMs','addOneIfOdd','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','default','../globalConfig/globalConfig.service','REDIS_PORT','../../common/constants/errorMessage.constant','split','defineProperty','getClientIp','appId','HttpStatus','OpenAiErrorCodeMessage','Repository','data','config','toLowerCase','includes','315591DWtcZz','queryUserBalance','chatGroupService','end','当前模型调用过于频繁、请重新试试吧！','用户ID:\x20','formatModelToken','BadwordsService','importDynamic','validateBalance','DESC','assistant'];_0x3f6f=function(){return _0x589083;};return _0x3f6f();}