'use strict';function _0x31ab(_0x902585,_0x585f85){const _0x1a4821=_0x1a48();return _0x31ab=function(_0x31ab8c,_0x30e84d){_0x31ab8c=_0x31ab8c-0x99;let _0x58fe34=_0x1a4821[_0x31ab8c];return _0x58fe34;},_0x31ab(_0x902585,_0x585f85);}function _0x1a48(){const _0x338e60=['872kSROaj','metadata','jobIds','function','1388135PcLygU','mjDrawQueue','InjectQueue','__param','../userBalance/userBalance.service','MJDRAW','@nestjs/bull','QueueService','@nestjs/common','3483918MLVAHX','push','add','getConfigs','createRandomUid','defineProperty','HttpException','design:paramtypes','validateBalance','1089itWeiC','userBalanceService','缺少必要参数！','addMjDrawQueue','getDrawActionDetail','__esModule','getOwnPropertyDescriptor','UPSCALE','getQueue','723625cQpzYO','checkLimit','cleanQueue','2357360bpdwBe','__metadata','113178rSnyqp','assign','BAD_REQUEST','__decorate','mjDraw','globalConfigService','237143KqPbRK','UserBalanceService','30fmxSSF','mjTimeoutMs','length','active','addDrawQueue','user','GlobalConfigService','36gWMpBr','midjourneyService','object'];_0x1a48=function(){return _0x338e60;};return _0x1a48();}const _0x471f4b=_0x31ab;(function(_0xd8e2fb,_0x5d1553){const _0x141205=_0x31ab,_0x38b30f=_0xd8e2fb();while(!![]){try{const _0x1cff2e=-parseInt(_0x141205(0xcc))/0x1+parseInt(_0x141205(0xc6))/0x2+-parseInt(_0x141205(0xb8))/0x3*(parseInt(_0x141205(0xa2))/0x4)+-parseInt(_0x141205(0xc1))/0x5*(parseInt(_0x141205(0x9f))/0x6)+parseInt(_0x141205(0xa6))/0x7+parseInt(_0x141205(0xc4))/0x8+-parseInt(_0x141205(0xaf))/0x9*(-parseInt(_0x141205(0xce))/0xa);if(_0x1cff2e===_0x5d1553)break;else _0x38b30f['push'](_0x38b30f['shift']());}catch(_0x3dd128){_0x38b30f['push'](_0x38b30f['shift']());}}}(_0x1a48,0x807a3));var __decorate=this&&this[_0x471f4b(0xc9)]||function(_0x772748,_0x73c787,_0x109b56,_0x19e092){const _0x2bf9e7=_0x471f4b;var _0x3381f5=arguments['length'],_0x3cedf5=_0x3381f5<0x3?_0x73c787:_0x19e092===null?_0x19e092=Object[_0x2bf9e7(0xbe)](_0x73c787,_0x109b56):_0x19e092,_0x1a3d1f;if(typeof Reflect===_0x2bf9e7(0xa1)&&typeof Reflect['decorate']===_0x2bf9e7(0xa5))_0x3cedf5=Reflect['decorate'](_0x772748,_0x73c787,_0x109b56,_0x19e092);else{for(var _0x53937e=_0x772748[_0x2bf9e7(0x9a)]-0x1;_0x53937e>=0x0;_0x53937e--)if(_0x1a3d1f=_0x772748[_0x53937e])_0x3cedf5=(_0x3381f5<0x3?_0x1a3d1f(_0x3cedf5):_0x3381f5>0x3?_0x1a3d1f(_0x73c787,_0x109b56,_0x3cedf5):_0x1a3d1f(_0x73c787,_0x109b56))||_0x3cedf5;}return _0x3381f5>0x3&&_0x3cedf5&&Object[_0x2bf9e7(0xb4)](_0x73c787,_0x109b56,_0x3cedf5),_0x3cedf5;},__metadata=this&&this[_0x471f4b(0xc5)]||function(_0x3f6e4c,_0x28e0ec){const _0x2c0f41=_0x471f4b;if(typeof Reflect===_0x2c0f41(0xa1)&&typeof Reflect[_0x2c0f41(0xa3)]===_0x2c0f41(0xa5))return Reflect['metadata'](_0x3f6e4c,_0x28e0ec);},__param=this&&this[_0x471f4b(0xa9)]||function(_0x3400fe,_0x2ae6e4){return function(_0x328c8e,_0x3a8196){_0x2ae6e4(_0x328c8e,_0x3a8196,_0x3400fe);};};Object['defineProperty'](exports,_0x471f4b(0xbd),{'value':!![]}),exports[_0x471f4b(0xad)]=void 0x0;const common_1=require(_0x471f4b(0xae)),bull_1=require(_0x471f4b(0xac)),utils_1=require('../../common/utils'),midjourney_service_1=require('../midjourney/midjourney.service'),userBalance_service_1=require(_0x471f4b(0xaa)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let QueueService=class QueueService{constructor(_0xe885e0,_0xa16b36,_0x3d65d2,_0xaa57e){const _0x13adf4=_0x471f4b;this[_0x13adf4(0xa7)]=_0xe885e0,this[_0x13adf4(0xa0)]=_0xa16b36,this[_0x13adf4(0xb9)]=_0x3d65d2,this['globalConfigService']=_0xaa57e,this[_0x13adf4(0xa4)]=[];}async['onApplicationBootstrap'](){const _0x576327=_0x471f4b;await this[_0x576327(0xa7)]['clean'](0x0,_0x576327(0x9b)),await this[_0x576327(0xa0)][_0x576327(0xc3)]();}async[_0x471f4b(0xbb)](_0x32dd08,_0x5e6b62){const _0x2be655=_0x471f4b,{imgUrl:_0x46fa47,orderId:_0x4b83ee,action:_0x3f27d1,drawId:_0x594766}=_0x32dd08;await this[_0x2be655(0xa0)][_0x2be655(0xc2)](_0x5e6b62),await this['userBalanceService'][_0x2be655(0xb7)](_0x5e6b62,_0x2be655(0xca),_0x3f27d1===_0x2be655(0xbf)?0x1:0x4);if(_0x3f27d1==='IMAGINE'){const _0xe9b171=''+(0x0,utils_1[_0x2be655(0xb3)])(),_0x3b4a70=Object[_0x2be655(0xc7)](Object[_0x2be655(0xc7)]({},_0x32dd08),{'userId':_0x5e6b62['user']['id'],'randomDrawId':_0xe9b171}),_0x121e89=await this['midjourneyService']['addDrawQueue'](_0x3b4a70),_0x4be288=await this[_0x2be655(0xcb)][_0x2be655(0xb2)](['mjTimeoutMs'])||0x30d40,_0x6e6dfc=await this['mjDrawQueue'][_0x2be655(0xb1)]('mjDraw',{'id':_0x121e89['id'],'action':_0x3f27d1,'userId':_0x5e6b62[_0x2be655(0x9d)]['id']},{'delay':0x3e8,'timeout':+_0x4be288});return this[_0x2be655(0xa4)][_0x2be655(0xb0)](_0x6e6dfc['id']),!![];}else{const {orderId:_0x5d97cd,action:_0x2d2f35,drawId:_0x4880fa}=_0x32dd08,_0x19f426=await this[_0x2be655(0xa0)][_0x2be655(0xbc)](_0x2d2f35,_0x4880fa,_0x5d97cd),_0x4a55c2=Object[_0x2be655(0xc7)](Object[_0x2be655(0xc7)](Object[_0x2be655(0xc7)]({},_0x32dd08),{'userId':_0x5e6b62[_0x2be655(0x9d)]['id']}),_0x19f426),_0x310dc7=await this['midjourneyService'][_0x2be655(0x9c)](_0x4a55c2),_0x18d98e=await this[_0x2be655(0xcb)][_0x2be655(0xb2)]([_0x2be655(0x99)])||0x30d40,_0x13c7c9=await this[_0x2be655(0xa7)]['add'](_0x2be655(0xca),{'id':_0x310dc7['id'],'action':_0x2d2f35,'userId':_0x5e6b62['user']['id']},{'delay':0x3e8,'timeout':+_0x18d98e});this[_0x2be655(0xa4)][_0x2be655(0xb0)](_0x13c7c9['id']);return;}if(!_0x594766||!_0x4b83ee)throw new common_1[(_0x2be655(0xb5))](_0x2be655(0xba),common_1['HttpStatus'][_0x2be655(0xc8)]);}async[_0x471f4b(0xc0)](){const _0x59e3f6=_0x471f4b;return{'jobIds':this[_0x59e3f6(0xa4)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x471f4b(0xa8)])(_0x471f4b(0xab))),__metadata(_0x471f4b(0xb6),[Object,midjourney_service_1['MidjourneyService'],userBalance_service_1[_0x471f4b(0xcd)],globalConfig_service_1[_0x471f4b(0x9e)]])],QueueService),exports[_0x471f4b(0xad)]=QueueService;