'use strict';const _0x7fbf0a=_0x42cc;(function(_0x3149f1,_0x146f18){const _0x3735ba=_0x42cc,_0x28f38d=_0x3149f1();while(!![]){try{const _0x1bf604=-parseInt(_0x3735ba(0x123))/0x1+-parseInt(_0x3735ba(0x115))/0x2+-parseInt(_0x3735ba(0x118))/0x3+-parseInt(_0x3735ba(0x11e))/0x4*(parseInt(_0x3735ba(0x13b))/0x5)+parseInt(_0x3735ba(0x161))/0x6+parseInt(_0x3735ba(0x17f))/0x7+parseInt(_0x3735ba(0x181))/0x8;if(_0x1bf604===_0x146f18)break;else _0x28f38d['push'](_0x28f38d['shift']());}catch(_0x1f875b){_0x28f38d['push'](_0x28f38d['shift']());}}}(_0xf587,0xd6d76));function _0xf587(){const _0x274b2d=['payEpayApiPayUrl','532715UkAsEl','query','payHupiAppId','payType:\x20','UserService','native','globalConfigService','default','notifyHupi','createHash','out_trade_no','BAD_REQUEST','function','order_no','keys','success','message','payEpayReturnUrl','version','mpay','wechatpay-node-v3','money','decipher_gcm','pid','85gPSbLS','支付请求失败:\x20','total','sign_type','微信H5支付失败！','payHupi','trade_status','@nestjs/common','https://api.xunhupay.com/payment/query.html','importDynamic','trade_order_id','payWeChatMchId','hupi','TRADE_SUCCESS','total_fee','failed','__param','Repository','attach','toFixed','订单不存在!','queryEpay','time','payWeChat','device','error:\x20','payMpayNotifyUrl','../userBalance/userBalance.service','微信支付通知params:\x20','metadata','h5_info','本次支付类型:\x20','payWeChatH5Name','HttpException','notify_url','length','getOpenIdByUserId','wx-native','9064980bliLrI','hex','wxpay','PayService','transactions_native','title','HttpStatus','payPlatform','sort','key','submit.php','payMpay','goodsId','digest','data','return_url','Injectable','@nestjs/typeorm','TRANSACTION.SUCCESS','getConfigs','status:\x20','192.168.1.100','payWeChatPublicKey','decorate','update','notifyWeChat','affected','userService','unsupported\x20pay\x20type','type','1653505RThhjf','wechat-pay:\x20','20558184OQFigH','SUCCESS','payWeChatSecret','epay','log','userBalanceService','payWeChatAppId','payWeChatPrivateKey','nonce_str','notifyEpay','transactions_jsapi','resource','../globalConfig/globalConfig.service','套餐不存在!','addBalanceToOrder','hash','map','InjectRepository','UserBalanceService','jsapi支付结果返回值:\x20','payEpay','jsapi','__decorate','sign','name','OrderEntity','1.1','text','param','createRandomNonceStr','trade_state','toString','object','notifyMpay','get','cramiPackageEntity','clientip','appid','out_trade_order','https://api.xunhupay.com/payment/do.html','__esModule','payHupiNotifyUrl','now','findOne','用户openId:\x20','payHupiSecret','payer','../../common/utils','act','typeorm','payHupiGatewayUrl','orderEntity','defineProperty','1341966UVIZyk','crypto','../crami/cramiPackage.entity','3088488dzjMnF','WxPay','pay','status','payMpaySecret','queryWeChat','283208FwaSMS','校验签名通过','payEpaySecret','transactions_h5'];_0xf587=function(){return _0x274b2d;};return _0xf587();}var __decorate=this&&this[_0x7fbf0a(0x197)]||function(_0x37c0c9,_0x250690,_0x3e8e09,_0x4da1d8){const _0x410b00=_0x7fbf0a;var _0x4f8fb5=arguments[_0x410b00(0x15e)],_0x30f22e=_0x4f8fb5<0x3?_0x250690:_0x4da1d8===null?_0x4da1d8=Object['getOwnPropertyDescriptor'](_0x250690,_0x3e8e09):_0x4da1d8,_0xdc2057;if(typeof Reflect===_0x410b00(0x100)&&typeof Reflect[_0x410b00(0x178)]===_0x410b00(0x12f))_0x30f22e=Reflect['decorate'](_0x37c0c9,_0x250690,_0x3e8e09,_0x4da1d8);else{for(var _0x55d9d3=_0x37c0c9[_0x410b00(0x15e)]-0x1;_0x55d9d3>=0x0;_0x55d9d3--)if(_0xdc2057=_0x37c0c9[_0x55d9d3])_0x30f22e=(_0x4f8fb5<0x3?_0xdc2057(_0x30f22e):_0x4f8fb5>0x3?_0xdc2057(_0x250690,_0x3e8e09,_0x30f22e):_0xdc2057(_0x250690,_0x3e8e09))||_0x30f22e;}return _0x4f8fb5>0x3&&_0x30f22e&&Object[_0x410b00(0x114)](_0x250690,_0x3e8e09,_0x30f22e),_0x30f22e;},__metadata=this&&this['__metadata']||function(_0x2c9ee4,_0x1ad4a7){const _0x31a6cd=_0x7fbf0a;if(typeof Reflect===_0x31a6cd(0x100)&&typeof Reflect[_0x31a6cd(0x158)]===_0x31a6cd(0x12f))return Reflect[_0x31a6cd(0x158)](_0x2c9ee4,_0x1ad4a7);},__param=this&&this[_0x7fbf0a(0x14b)]||function(_0x2aef27,_0x24785c){return function(_0x35e912,_0x4abbac){_0x24785c(_0x35e912,_0x4abbac,_0x2aef27);};};function _0x42cc(_0xc216ec,_0x395219){const _0xf58707=_0xf587();return _0x42cc=function(_0x42cc8b,_0x56e81f){_0x42cc8b=_0x42cc8b-0xf7;let _0x558551=_0xf58707[_0x42cc8b];return _0x558551;},_0x42cc(_0xc216ec,_0x395219);}Object[_0x7fbf0a(0x114)](exports,_0x7fbf0a(0x108),{'value':!![]}),exports[_0x7fbf0a(0x164)]=void 0x0;const typeorm_1=require(_0x7fbf0a(0x172)),typeorm_2=require(_0x7fbf0a(0x111)),common_1=require(_0x7fbf0a(0x142)),crypto=require(_0x7fbf0a(0x116)),axios_1=require('axios'),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x7fbf0a(0x117)),userBalance_service_1=require(_0x7fbf0a(0x156)),globalConfig_service_1=require(_0x7fbf0a(0x18d)),utils_1=require(_0x7fbf0a(0x10f)),user_service_1=require('../user/user.service');let PayService=class PayService{constructor(_0x1a168e,_0xac118a,_0x12ce66,_0x1cc745,_0x3adbd2){const _0x3f177c=_0x7fbf0a;this[_0x3f177c(0x103)]=_0x1a168e,this[_0x3f177c(0x113)]=_0xac118a,this[_0x3f177c(0x186)]=_0x12ce66,this[_0x3f177c(0x129)]=_0x1cc745,this[_0x3f177c(0x17c)]=_0x3adbd2;}async['onModuleInit'](){const _0x3d0abb=_0x7fbf0a,_0x2938c4=await(0x0,utils_1[_0x3d0abb(0x144)])(_0x3d0abb(0x137));this[_0x3d0abb(0x119)]=(_0x2938c4===null||_0x2938c4===void 0x0?void 0x0:_0x2938c4['default'])?_0x2938c4[_0x3d0abb(0x12a)]:_0x2938c4;}async['notify'](_0x1d900c){const _0x4c15b0=_0x7fbf0a;if(_0x1d900c[_0x4c15b0(0xfc)]==_0x4c15b0(0x184))return this[_0x4c15b0(0x18a)](_0x1d900c);if(_0x1d900c['attach']==_0x4c15b0(0x147))return this[_0x4c15b0(0x12b)](_0x1d900c);if(typeof _0x1d900c[_0x4c15b0(0x18c)]=='object')return this[_0x4c15b0(0x17a)](_0x1d900c);return this['notifyMpay'](_0x1d900c);}async[_0x7fbf0a(0x11a)](_0x2d7dcd,_0x2a0a66,_0x18cc65=_0x7fbf0a(0x163)){const _0x3dd8fd=_0x7fbf0a,_0x42c084=await this[_0x3dd8fd(0x113)][_0x3dd8fd(0x10b)]({'where':{'userId':_0x2d7dcd,'orderId':_0x2a0a66}});if(!_0x42c084)throw new common_1['HttpException'](_0x3dd8fd(0x14f),common_1[_0x3dd8fd(0x167)][_0x3dd8fd(0x12e)]);const _0x169f17=await this[_0x3dd8fd(0x103)][_0x3dd8fd(0x10b)]({'where':{'id':_0x42c084[_0x3dd8fd(0x16d)]}});if(!_0x169f17)throw new common_1[(_0x3dd8fd(0x15c))](_0x3dd8fd(0x18e),common_1['HttpStatus']['BAD_REQUEST']);console['log'](_0x3dd8fd(0x15a),_0x42c084[_0x3dd8fd(0x168)]);try{if(_0x42c084['payPlatform']=='wechat')return this[_0x3dd8fd(0x152)](_0x2d7dcd,_0x2a0a66,_0x18cc65);if(_0x42c084[_0x3dd8fd(0x168)]==_0x3dd8fd(0x184))return this['payEpay'](_0x2d7dcd,_0x2a0a66,_0x18cc65);if(_0x42c084[_0x3dd8fd(0x168)]==_0x3dd8fd(0x136))return this['payMpay'](_0x2d7dcd,_0x2a0a66,_0x18cc65);if(_0x42c084[_0x3dd8fd(0x168)]==_0x3dd8fd(0x147))return this[_0x3dd8fd(0x140)](_0x2d7dcd,_0x2a0a66,_0x18cc65);}catch(_0x196ad5){console[_0x3dd8fd(0x185)](_0x3dd8fd(0x13c),_0x196ad5);throw new common_1[(_0x3dd8fd(0x15c))]('支付请求失败!',common_1[_0x3dd8fd(0x167)][_0x3dd8fd(0x12e)]);}}async[_0x7fbf0a(0x124)](_0x2b6493){const _0x3067d4=_0x7fbf0a,_0x4537ad=await this[_0x3067d4(0x113)][_0x3067d4(0x10b)]({'where':{'orderId':_0x2b6493}});if(!_0x4537ad)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus'][_0x3067d4(0x12e)]);return _0x4537ad;}async[_0x7fbf0a(0x12b)](_0xb149ff){const _0x15a737=_0x7fbf0a,_0x193005=await this[_0x15a737(0x129)][_0x15a737(0x174)](['payHupiSecret']),_0x5b7b0e=_0xb149ff['hash'];delete _0xb149ff[_0x15a737(0x190)];if(this[_0x15a737(0xf7)](_0xb149ff,_0x193005)!=_0x5b7b0e)return'failed';const _0x28ecca=await this[_0x15a737(0x113)][_0x15a737(0x10b)]({'where':{'orderId':_0xb149ff[_0x15a737(0x145)],'status':0x0}});if(!_0x28ecca)return _0x15a737(0x14a);await this[_0x15a737(0x186)]['addBalanceToOrder'](_0x28ecca);const _0x3dd879=await this[_0x15a737(0x113)][_0x15a737(0x179)]({'orderId':_0xb149ff[_0x15a737(0x145)]},{'status':0x1,'paydAt':new Date()});if(_0x3dd879[_0x15a737(0x17b)]!=0x1)return _0x15a737(0x14a);return _0x15a737(0x132);}async[_0x7fbf0a(0x140)](_0x5e556b,_0x336d37,_0x3eead3='wxpay'){const _0x3f9d66=_0x7fbf0a,_0x3a5dd4=await this[_0x3f9d66(0x113)][_0x3f9d66(0x10b)]({'where':{'userId':_0x5e556b,'orderId':_0x336d37}});if(!_0x3a5dd4)throw new common_1['HttpException'](_0x3f9d66(0x14f),common_1[_0x3f9d66(0x167)]['BAD_REQUEST']);const _0x3d24d7=await this[_0x3f9d66(0x103)][_0x3f9d66(0x10b)]({'where':{'id':_0x3a5dd4[_0x3f9d66(0x16d)]}});if(!_0x3d24d7)throw new common_1[(_0x3f9d66(0x15c))](_0x3f9d66(0x18e),common_1[_0x3f9d66(0x167)]['BAD_REQUEST']);const {payHupiAppId:_0x216c41,payHupiSecret:_0x47428a,payHupiNotifyUrl:_0x47dfc5,payHupiReturnUrl:_0x1a114c,payHupiGatewayUrl:_0x460f92}=await this['globalConfigService'][_0x3f9d66(0x174)]([_0x3f9d66(0x125),'payHupiSecret',_0x3f9d66(0x109),'payHupiReturnUrl',_0x3f9d66(0x112)]),_0x36306b={};_0x36306b[_0x3f9d66(0x135)]=_0x3f9d66(0xfa),_0x36306b[_0x3f9d66(0x105)]=_0x216c41,_0x36306b[_0x3f9d66(0x151)]=(Date[_0x3f9d66(0x10a)]()/0x3e8)[_0x3f9d66(0x14e)](0x0),_0x36306b['nonce_str']=(0x0,utils_1[_0x3f9d66(0xfd)])(0x20),_0x36306b[_0x3f9d66(0x145)]=_0x336d37,_0x36306b[_0x3f9d66(0x166)]=_0x3d24d7[_0x3f9d66(0xf8)],_0x36306b[_0x3f9d66(0x149)]=_0x3a5dd4[_0x3f9d66(0x13d)],_0x36306b['notify_url']=_0x47dfc5,_0x36306b['return_url']=_0x1a114c,_0x36306b[_0x3f9d66(0x14d)]='hupi',_0x36306b[_0x3f9d66(0x190)]=this[_0x3f9d66(0xf7)](_0x36306b,_0x47428a);const {data:{errcode:_0x381cd3,errmsg:_0x435a42,url_qrcode:_0x91c7c4,url:_0x17c2ff}}=await axios_1[_0x3f9d66(0x12a)]['post'](_0x460f92||_0x3f9d66(0x107),_0x36306b);if(_0x381cd3!=0x0)throw new common_1[(_0x3f9d66(0x15c))](_0x435a42,common_1['HttpStatus'][_0x3f9d66(0x12e)]);return{'url_qrcode':_0x91c7c4,'url':_0x17c2ff};}async['queryHupi'](_0x1689e2){const _0x491e4e=_0x7fbf0a,{payHupiAppId:_0x4c5304,payHupiSecret:_0x2e2a9f}=await this[_0x491e4e(0x129)][_0x491e4e(0x174)]([_0x491e4e(0x125),_0x491e4e(0x10d)]),_0x22bb12={};_0x22bb12[_0x491e4e(0x135)]='1.1',_0x22bb12[_0x491e4e(0x105)]=_0x4c5304,_0x22bb12['time']=(Date['now']()/0x3e8)['toFixed'](0x0),_0x22bb12[_0x491e4e(0x189)]=(0x0,utils_1[_0x491e4e(0xfd)])(0x20),_0x22bb12[_0x491e4e(0x106)]=_0x1689e2,_0x22bb12[_0x491e4e(0x190)]=this[_0x491e4e(0xf7)](_0x22bb12,_0x2e2a9f);const {data:{errcode:_0x808ec7,errmsg:_0x11ae0c,data:_0x378574}}=await axios_1['default']['post'](_0x491e4e(0x143),_0x22bb12);if(_0x808ec7!=0x0)throw new common_1[(_0x491e4e(0x15c))](_0x11ae0c,common_1['HttpStatus']['BAD_REQUEST']);return _0x378574;}async['notifyEpay'](_0x184761){const _0x3e1707=_0x7fbf0a,_0x406a04=_0x184761['sign'];delete _0x184761[_0x3e1707(0xf7)],delete _0x184761['sign_type'];const _0x2efd30=await this['globalConfigService'][_0x3e1707(0x174)]([_0x3e1707(0x120)]);if(this[_0x3e1707(0xf7)](_0x184761,_0x2efd30)!=_0x406a04)return _0x3e1707(0x14a);console[_0x3e1707(0x185)](_0x3e1707(0x11f));const _0x204978=await this[_0x3e1707(0x113)][_0x3e1707(0x10b)]({'where':{'orderId':_0x184761[_0x3e1707(0x12d)],'status':0x0}});if(!_0x204978)return _0x3e1707(0x14a);const _0x5ea052=_0x184761[_0x3e1707(0x141)]==_0x3e1707(0x148)?0x1:0x2,_0x1f5ef8=await this[_0x3e1707(0x113)][_0x3e1707(0x179)]({'orderId':_0x184761[_0x3e1707(0x12d)]},{'status':_0x5ea052,'paydAt':new Date()});_0x5ea052===0x1&&await this[_0x3e1707(0x186)][_0x3e1707(0x18f)](_0x204978);if(_0x1f5ef8[_0x3e1707(0x17b)]!=0x1)return _0x3e1707(0x14a);return'success';}async[_0x7fbf0a(0x195)](_0x3001cd,_0x113aaf,_0x573085='alipay'){const _0x13a92d=_0x7fbf0a,_0x502b10=await this[_0x13a92d(0x113)][_0x13a92d(0x10b)]({'where':{'userId':_0x3001cd,'orderId':_0x113aaf}});if(!_0x502b10)throw new common_1[(_0x13a92d(0x15c))]('订单不存在!',common_1[_0x13a92d(0x167)]['BAD_REQUEST']);const _0x457eb9=await this[_0x13a92d(0x103)][_0x13a92d(0x10b)]({'where':{'id':_0x502b10[_0x13a92d(0x16d)]}});if(!_0x457eb9)throw new common_1[(_0x13a92d(0x15c))]('套餐不存在!',common_1[_0x13a92d(0x167)][_0x13a92d(0x12e)]);const {payEpayPid:_0x528a08,payEpaySecret:_0xb85395,payEpayNotifyUrl:_0x4260fc,payEpayReturnUrl:_0x194c5a,payEpayApiPayUrl:_0xa164d0}=await this['globalConfigService'][_0x13a92d(0x174)](['payEpayPid',_0x13a92d(0x120),'payEpayNotifyUrl',_0x13a92d(0x134),_0x13a92d(0x122)]);let _0x222227;_0x528a08['length']<=0x10?_0x222227=Number(_0x528a08):_0x222227=BigInt(_0x528a08);const _0x434520={};_0x434520[_0x13a92d(0x13a)]=_0x222227,_0x434520[_0x13a92d(0x17e)]=_0x573085,_0x434520[_0x13a92d(0x12d)]=_0x113aaf,_0x434520[_0x13a92d(0xf8)]=_0x457eb9[_0x13a92d(0xf8)],_0x434520['money']=_0x502b10[_0x13a92d(0x13d)],_0x434520[_0x13a92d(0x104)]=_0x13a92d(0x176),_0x434520[_0x13a92d(0x153)]='pc',_0x434520[_0x13a92d(0x15d)]=_0x4260fc,_0x434520['return_url']=_0x194c5a,_0x434520[_0x13a92d(0xfc)]=_0x13a92d(0x184),_0x434520[_0x13a92d(0xf7)]=this[_0x13a92d(0xf7)](_0x434520,_0xb85395),_0x434520[_0x13a92d(0x13e)]='MD5';const _0x12f507=new URLSearchParams(_0x434520)[_0x13a92d(0xff)](),_0x1a410e=_0xa164d0+'?'+_0x12f507;if(_0xa164d0['includes'](_0x13a92d(0x16b)))return{'url_qrcode':null,'redirectUrl':_0x1a410e,'channel':_0x573085,'isRedirect':!![]};else{const _0x1e863a=await axios_1[_0x13a92d(0x12a)][_0x13a92d(0x102)](_0xa164d0,{'params':_0x434520});console['log']('epay\x20--->\x20res:\x20',_0x1e863a[_0x13a92d(0x16f)]);const {data:{code:_0x1fbfb5,msg:_0x14d5ee,qrcode:_0x1c18f6}}=_0x1e863a;if(_0x1fbfb5!=0x1)throw new common_1[(_0x13a92d(0x15c))](_0x14d5ee,common_1[_0x13a92d(0x167)][_0x13a92d(0x12e)]);return{'url_qrcode':_0x1c18f6,'redirectUrl':null,'channel':_0x573085,'isRedirect':![]};}}async[_0x7fbf0a(0x150)](_0x57d138){const _0x29fc46=_0x7fbf0a,{payEpayPid:_0x49bda3,payEpaySecret:_0x4a0d27,payEpayApiQueryUrl:_0x1c1dac}=await this[_0x29fc46(0x129)][_0x29fc46(0x174)](['payEpayPid',_0x29fc46(0x120),'payEpayApiQueryUrl']),_0x38a39b={};_0x38a39b[_0x29fc46(0x110)]='order',_0x38a39b['out_trade_no']=_0x57d138,_0x38a39b['pid']=_0x49bda3,_0x38a39b[_0x29fc46(0x16a)]=_0x4a0d27;const {data:{code:_0x66cdfd,msg:_0x52a95d,data:_0x241dfb}}=await axios_1[_0x29fc46(0x12a)]['get'](_0x1c1dac,{'params':_0x38a39b});if(_0x66cdfd!=0x1)throw new common_1[(_0x29fc46(0x15c))](_0x52a95d,common_1[_0x29fc46(0x167)][_0x29fc46(0x12e)]);return _0x241dfb;}async[_0x7fbf0a(0x101)](_0x6b6a05){const _0x4e7047=_0x7fbf0a,_0x1c564c=_0x6b6a05[_0x4e7047(0xf7)];delete _0x6b6a05[_0x4e7047(0xf7)],delete _0x6b6a05[_0x4e7047(0x13e)];const _0x37ca60=await this['globalConfigService']['getConfigs']([_0x4e7047(0x11c)]);console['log']('校验签名');if(this['sign'](_0x6b6a05,_0x37ca60)!=_0x1c564c)return _0x4e7047(0x14a);console[_0x4e7047(0x185)]('校验签名通过');const _0x498054=await this['orderEntity'][_0x4e7047(0x10b)]({'where':{'orderId':_0x6b6a05[_0x4e7047(0x12d)],'status':0x0}});if(!_0x498054)return _0x4e7047(0x14a);const _0x2c3fb5=_0x6b6a05[_0x4e7047(0x141)]==_0x4e7047(0x148)?0x1:0x2;console[_0x4e7047(0x185)](_0x4e7047(0x175),_0x2c3fb5);const _0x22b62f=await this[_0x4e7047(0x113)][_0x4e7047(0x179)]({'orderId':_0x6b6a05['out_trade_no']},{'status':_0x2c3fb5,'paydAt':new Date()});_0x2c3fb5===0x1&&await this[_0x4e7047(0x186)]['addBalanceToOrder'](_0x498054);if(_0x22b62f['affected']!=0x1)return _0x4e7047(0x14a);return _0x4e7047(0x132);}async[_0x7fbf0a(0x16c)](_0xbdb1e6,_0x555eac,_0x2b87ac=_0x7fbf0a(0x163)){const _0x38ccab=_0x7fbf0a,_0x1eb208=await this[_0x38ccab(0x113)][_0x38ccab(0x10b)]({'where':{'userId':_0xbdb1e6,'orderId':_0x555eac}});if(!_0x1eb208)throw new common_1[(_0x38ccab(0x15c))]('订单不存在!',common_1[_0x38ccab(0x167)]['BAD_REQUEST']);const _0x50ff81=await this[_0x38ccab(0x103)][_0x38ccab(0x10b)]({'where':{'id':_0x1eb208[_0x38ccab(0x16d)]}});if(!_0x50ff81)throw new common_1[(_0x38ccab(0x15c))](_0x38ccab(0x18e),common_1[_0x38ccab(0x167)]['BAD_REQUEST']);const {payMpayPid:_0x19f022,payMpaySecret:_0x46fa1f,payMpayNotifyUrl:_0x268e4a,payMpayReturnUrl:_0x3d60d3,payMpayApiPayUrl:_0x10bb82}=await this['globalConfigService'][_0x38ccab(0x174)](['payMpayPid',_0x38ccab(0x11c),_0x38ccab(0x155),'payMpayReturnUrl','payMpayApiPayUrl']),_0x4ff7d5={};_0x4ff7d5[_0x38ccab(0x13a)]=Number(_0x19f022),_0x4ff7d5['type']=_0x2b87ac,_0x4ff7d5['out_trade_no']=_0x555eac,_0x4ff7d5[_0x38ccab(0xf8)]=_0x50ff81[_0x38ccab(0xf8)],_0x4ff7d5[_0x38ccab(0x138)]=_0x1eb208[_0x38ccab(0x13d)],_0x4ff7d5[_0x38ccab(0x15d)]=_0x268e4a,_0x4ff7d5[_0x38ccab(0x170)]=_0x3d60d3,_0x4ff7d5[_0x38ccab(0xf7)]=this['sign'](_0x4ff7d5,_0x46fa1f),_0x4ff7d5[_0x38ccab(0x13e)]='MD5';const _0xc13990=new URLSearchParams(_0x4ff7d5)['toString'](),_0xc0d2e5=_0x10bb82+'?'+_0xc13990;return{'url_qrcode':null,'redirectUrl':_0xc0d2e5,'channel':_0x2b87ac,'isRedirect':!![]};const _0x154acc=await axios_1[_0x38ccab(0x12a)]['get'](_0x10bb82,{'params':_0x4ff7d5});}async['queryMpay'](_0x5dcc3b){const _0x28d50b=_0x7fbf0a,{payMpayApiQueryUrl:_0xa03c2b}=await this[_0x28d50b(0x129)][_0x28d50b(0x174)](['payMpayPid',_0x28d50b(0x11c),'payMpayApiQueryUrl']),_0x50451b={};_0x50451b[_0x28d50b(0x17e)]=0x2,_0x50451b[_0x28d50b(0x130)]=_0x5dcc3b;const {data:{code:_0xa307b1,msg:_0x8351a1,data:_0x18351f}}=await axios_1[_0x28d50b(0x12a)][_0x28d50b(0x102)](_0xa03c2b,{'params':_0x50451b});if(_0xa307b1!=0x1)throw new common_1[(_0x28d50b(0x15c))](_0x8351a1,common_1['HttpStatus'][_0x28d50b(0x12e)]);return _0x18351f;}async[_0x7fbf0a(0x17a)](_0x3479a5){const _0x18f79c=_0x7fbf0a;console[_0x18f79c(0x185)](_0x18f79c(0x157),_0x3479a5);const {payWeChatAppId:_0xa1743a,payWeChatMchId:_0x381e09,payWeChatSecret:_0xbe9ecd,payWeChatPublicKey:_0x56382d,payWeChatPrivateKey:_0xbb1235}=await this[_0x18f79c(0x129)][_0x18f79c(0x174)]([_0x18f79c(0x187),'payWeChatMchId',_0x18f79c(0x183),_0x18f79c(0x177),_0x18f79c(0x188)]),_0x239924=new this[(_0x18f79c(0x119))]({'appid':_0xa1743a,'mchid':_0x381e09,'publicKey':_0x56382d,'privateKey':_0xbb1235});try{if(_0x3479a5['event_type']==_0x18f79c(0x173)){const {ciphertext:_0x173973,associated_data:_0x5ecf89,nonce:_0x5990f1}=_0x3479a5[_0x18f79c(0x18c)],_0x300f79=_0x239924[_0x18f79c(0x139)](_0x173973,_0x5ecf89,_0x5990f1,_0xbe9ecd),_0x1524aa=await this[_0x18f79c(0x113)][_0x18f79c(0x10b)]({'where':{'orderId':_0x300f79[_0x18f79c(0x12d)],'status':0x0}});if(!_0x1524aa)return'failed';const _0x4378f=_0x300f79[_0x18f79c(0xfe)]==_0x18f79c(0x182)?0x1:0x2,_0x2517c9=await this[_0x18f79c(0x113)]['update']({'orderId':_0x300f79['out_trade_no']},{'status':_0x4378f,'paydAt':new Date()});_0x4378f===0x1&&await this[_0x18f79c(0x186)][_0x18f79c(0x18f)](_0x1524aa);if(_0x2517c9[_0x18f79c(0x17b)]!=0x1)return _0x18f79c(0x14a);}return _0x18f79c(0x132);}catch(_0x2af482){return console[_0x18f79c(0x185)](_0x18f79c(0x154),_0x2af482),console[_0x18f79c(0x185)]('支付通知验证失败:\x20',_0x2af482),_0x18f79c(0x14a);}}async[_0x7fbf0a(0x152)](_0x23e4df,_0x89fa03,_0x3192f1='native'){const _0xfe00d=_0x7fbf0a;var _0xf97dc0,_0x3d90f2,_0x471b3e;console[_0xfe00d(0x185)](_0xfe00d(0x126),_0x3192f1);const _0x49f7fd=await this['orderEntity']['findOne']({'where':{'userId':_0x23e4df,'orderId':_0x89fa03}});if(!_0x49f7fd)throw new common_1[(_0xfe00d(0x15c))](_0xfe00d(0x14f),common_1[_0xfe00d(0x167)][_0xfe00d(0x12e)]);const _0x50ae48=await this[_0xfe00d(0x103)]['findOne']({'where':{'id':_0x49f7fd['goodsId']}});if(!_0x50ae48)throw new common_1['HttpException'](_0xfe00d(0x18e),common_1[_0xfe00d(0x167)][_0xfe00d(0x12e)]);const {payWeChatAppId:_0x1d84e9,payWeChatMchId:_0x28a1ab,payWeChatPublicKey:_0x4b95b7,payWeChatPrivateKey:_0x56e87c,payWeChatNotifyUrl:_0x1038a0,payWeChatH5Name:_0x15849c,payWeChatH5Url:_0x3dfd06}=await this[_0xfe00d(0x129)][_0xfe00d(0x174)](['payWeChatAppId',_0xfe00d(0x146),_0xfe00d(0x177),_0xfe00d(0x188),'payWeChatNotifyUrl',_0xfe00d(0x15b),'payWeChatH5Url']),_0x212800=new this['WxPay']({'appid':_0x1d84e9,'mchid':_0x28a1ab,'publicKey':_0x4b95b7,'privateKey':_0x56e87c}),_0x2960eb={'appid':_0x1d84e9,'mchid':_0x28a1ab,'description':_0x50ae48['name'],'out_trade_no':_0x89fa03,'notify_url':_0x1038a0,'amount':{'total':Number(_0x49f7fd['total']*0x64)},'scene_info':{'payer_client_ip':_0xfe00d(0x176)}};console[_0xfe00d(0x185)](_0xfe00d(0x180),_0x2960eb);if(_0x3192f1=='h5'){_0x2960eb['scene_info'][_0xfe00d(0x159)]={'type':'Wap','app_name':_0x15849c,'app_url':_0x3dfd06};const _0x14bd3a=await _0x212800[_0xfe00d(0x121)](_0x2960eb);if(_0x14bd3a[_0xfe00d(0x11b)]===0x193){const _0x51c483=(_0x471b3e=(_0x3d90f2=(_0xf97dc0=_0x14bd3a===null||_0x14bd3a===void 0x0?void 0x0:_0x14bd3a['errRaw'])===null||_0xf97dc0===void 0x0?void 0x0:_0xf97dc0['response'])===null||_0x3d90f2===void 0x0?void 0x0:_0x3d90f2[_0xfe00d(0xfb)])===null||_0x471b3e===void 0x0?void 0x0:_0x471b3e[_0xfe00d(0x133)];throw new common_1[(_0xfe00d(0x15c))]((_0x14bd3a===null||_0x14bd3a===void 0x0?void 0x0:_0x14bd3a['message'])||_0xfe00d(0x13f),common_1[_0xfe00d(0x167)][_0xfe00d(0x12e)]);}const {h5_url:_0x11f260}=_0x14bd3a;return{'url':_0x11f260};}if(_0x3192f1==_0xfe00d(0x196)){const _0x539a45=await this[_0xfe00d(0x17c)][_0xfe00d(0x15f)](_0x23e4df);console['log'](_0xfe00d(0x10c),_0x539a45),_0x2960eb[_0xfe00d(0x10e)]={'openid':_0x539a45};const _0x515a3e=await _0x212800[_0xfe00d(0x18b)](_0x2960eb);return console[_0xfe00d(0x185)](_0xfe00d(0x194),_0x515a3e),_0x515a3e;}if(_0x3192f1==_0xfe00d(0x128)){const _0x235d5f=await _0x212800[_0xfe00d(0x165)](_0x2960eb),{code_url:_0x5c4469}=_0x235d5f;return!_0x5c4469&&console[_0xfe00d(0x185)](_0xfe00d(0x160),_0x235d5f),{'url_qrcode':_0x5c4469,'isRedirect':![]};}throw new common_1['HttpException'](_0xfe00d(0x17d),common_1['HttpStatus'][_0xfe00d(0x12e)]);}async[_0x7fbf0a(0x11d)](_0xa4e6a4){const _0xd8f2e2=_0x7fbf0a,{payWeChatAppId:_0x169aca,payWeChatMchId:_0x2595ca,payWeChatPublicKey:_0xac1828,payWeChatPrivateKey:_0x4168a9,payWeChatNotifyUrl:_0x5707c6,payWeChatH5Name:_0xcc4f6c,payWeChatH5Url:_0xfb1be4}=await this[_0xd8f2e2(0x129)][_0xd8f2e2(0x174)]([_0xd8f2e2(0x187),_0xd8f2e2(0x146),'payWeChatPublicKey',_0xd8f2e2(0x188)]),_0xcd6297=new this[(_0xd8f2e2(0x119))]({'appid':_0x169aca,'mchid':_0x2595ca,'publicKey':_0xac1828,'privateKey':_0x4168a9}),_0x23fb15=await _0xcd6297['query']({'out_trade_no':_0xa4e6a4});return _0x23fb15;}['sign'](_0x42a280,_0x5d7a3b){const _0x54ba38=_0x7fbf0a,_0x3fbc08=Object[_0x54ba38(0x131)](_0x42a280)[_0x54ba38(0x169)]()[_0x54ba38(0x191)](_0x27e538=>_0x27e538+'='+_0x42a280[_0x27e538])['join']('&')+_0x5d7a3b;return crypto[_0x54ba38(0x12c)]('md5')[_0x54ba38(0x179)](_0x3fbc08)[_0x54ba38(0x16e)](_0x54ba38(0x162));}};PayService=__decorate([(0x0,common_1[_0x7fbf0a(0x171)])(),__param(0x0,(0x0,typeorm_1[_0x7fbf0a(0x192)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x7fbf0a(0xf9)])),__metadata('design:paramtypes',[typeorm_2[_0x7fbf0a(0x14c)],typeorm_2[_0x7fbf0a(0x14c)],userBalance_service_1[_0x7fbf0a(0x193)],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x7fbf0a(0x127)]])],PayService),exports[_0x7fbf0a(0x164)]=PayService;