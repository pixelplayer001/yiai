'use strict';function _0x2ebf(){const _0x192fa0=['chatlog.createdAt\x20>=\x20:startDate','M.DD','chatLog.createdAt\x20>=\x20:today','orderEntity','countNewUsersToday','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','../../common/constants/balance.constant','andWhere','73izxrdX','../user/user.entity','order','&metrics=','请先配置百度统计accessToken','1786860GofQGO','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','midjourney','StatisticService','metadata','order.createdAt\x20<\x20:tomorrow','DRAWED','ConfigEntity','function','__esModule','midjourney.createdAt\x20<\x20:tomorrow','getChatStatistic','Repository','user.createdAt\x20>=\x20:today','user.createdAt\x20<\x20:tomorrow','chatLog','countDrawsByTimeRange','CHAT_TYPE','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','userEntity','获取百度统计数据失败','configEntity','Injectable','countNewMidhourneysToday','ChatLogEntity','setDate','countDraws','user','&site_id=','map','midjourney.createdAt\x20>=\x20:startDate','data','getOwnPropertyDescriptor','../globalConfig/config.entity','date','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','1609188HyHcES','33386OQbFoZ','formatDate','setHours','countUsers','DeductionKey','chatLog.createdAt\x20<\x20:tomorrow','2465355zDdWMH','groupBy','countChatsByTimeRange','../../common/constants/midjourney.constant','&method=','../midjourney/midjourney.entity','countOrders','baiduSiteId','PAINT_TYPE','YYYYMMDD','161hcWFkN','getTime','orderBy','midjourney.status\x20=\x20:status','HttpStatus','请先配置百度统计siteId','34528ijweqw','__decorate','createQueryBuilder','getRawMany','getBaiduVisit','getCount','百度授权码过期','81460dFenyT','330keUBuJ','chatLogEntity','select','6726900nVzvse','&start_date=','HttpException','countNewChatsToday','__param','configVal','default','getBaiduStatistics','result','count','defineProperty','value','countNewDrawsToday','BAD_REQUEST','../chatLog/chatLog.entity','push','countMjDrawsByTimeRange','midjourney.createdAt\x20>=\x20:today','midjourneyEntity','baiduToken','getDate','InjectRepository','overview/getTimeTrendRpt','../order/order.entity','chatLog.type\x20=\x20:type','../../common/utils/date','chatlog','now','@nestjs/common','axios','__metadata','OrderEntity','where','configKey','find','UserEntity'];_0x2ebf=function(){return _0x192fa0;};return _0x2ebf();}const _0x274f36=_0xfe18;(function(_0x4e667e,_0x6ef3e6){const _0x571be7=_0xfe18,_0x3b2492=_0x4e667e();while(!![]){try{const _0x44ede5=-parseInt(_0x571be7(0x15d))/0x1*(-parseInt(_0x571be7(0x187))/0x2)+-parseInt(_0x571be7(0x18d))/0x3+parseInt(_0x571be7(0x1a4))/0x4*(parseInt(_0x571be7(0x1a5))/0x5)+-parseInt(_0x571be7(0x186))/0x6+parseInt(_0x571be7(0x197))/0x7*(parseInt(_0x571be7(0x19d))/0x8)+-parseInt(_0x571be7(0x162))/0x9+-parseInt(_0x571be7(0x1a8))/0xa;if(_0x44ede5===_0x6ef3e6)break;else _0x3b2492['push'](_0x3b2492['shift']());}catch(_0x323437){_0x3b2492['push'](_0x3b2492['shift']());}}}(_0x2ebf,0xab13e));var __decorate=this&&this[_0x274f36(0x19e)]||function(_0x699b2d,_0x273eab,_0x5b1b34,_0x4cbf73){const _0x2d72dd=_0x274f36;var _0x39fa41=arguments['length'],_0x9709b7=_0x39fa41<0x3?_0x273eab:_0x4cbf73===null?_0x4cbf73=Object[_0x2d72dd(0x182)](_0x273eab,_0x5b1b34):_0x4cbf73,_0x22275f;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x2d72dd(0x16a))_0x9709b7=Reflect['decorate'](_0x699b2d,_0x273eab,_0x5b1b34,_0x4cbf73);else{for(var _0x4a8ce1=_0x699b2d['length']-0x1;_0x4a8ce1>=0x0;_0x4a8ce1--)if(_0x22275f=_0x699b2d[_0x4a8ce1])_0x9709b7=(_0x39fa41<0x3?_0x22275f(_0x9709b7):_0x39fa41>0x3?_0x22275f(_0x273eab,_0x5b1b34,_0x9709b7):_0x22275f(_0x273eab,_0x5b1b34))||_0x9709b7;}return _0x39fa41>0x3&&_0x9709b7&&Object[_0x2d72dd(0x1b2)](_0x273eab,_0x5b1b34,_0x9709b7),_0x9709b7;},__metadata=this&&this[_0x274f36(0x14f)]||function(_0x38ccc6,_0x2024e5){const _0x109cb3=_0x274f36;if(typeof Reflect==='object'&&typeof Reflect[_0x109cb3(0x166)]===_0x109cb3(0x16a))return Reflect['metadata'](_0x38ccc6,_0x2024e5);},__param=this&&this[_0x274f36(0x1ac)]||function(_0x48310d,_0x7ea217){return function(_0x39078b,_0x3e9ca2){_0x7ea217(_0x39078b,_0x3e9ca2,_0x48310d);};};Object[_0x274f36(0x1b2)](exports,_0x274f36(0x16b),{'value':!![]}),exports[_0x274f36(0x165)]=void 0x0;const common_1=require(_0x274f36(0x1c4)),typeorm_1=require('@nestjs/typeorm'),user_entity_1=require(_0x274f36(0x15e)),typeorm_2=require('typeorm'),chatLog_entity_1=require(_0x274f36(0x1b6)),balance_constant_1=require(_0x274f36(0x15b)),date_1=require(_0x274f36(0x1c1)),axios_1=require(_0x274f36(0x1c5)),config_entity_1=require(_0x274f36(0x183)),order_entity_1=require(_0x274f36(0x1bf)),midjourney_entity_1=require(_0x274f36(0x192)),midjourney_constant_1=require(_0x274f36(0x190));let StatisticService=class StatisticService{constructor(_0x1c316b,_0x56b1c6,_0x4f450f,_0x2e1255,_0x3ca1c){const _0x3fbafe=_0x274f36;this['userEntity']=_0x1c316b,this[_0x3fbafe(0x1a6)]=_0x56b1c6,this['configEntity']=_0x4f450f,this['orderEntity']=_0x2e1255,this[_0x3fbafe(0x1ba)]=_0x3ca1c;}async['getBaseStatistic'](){const _0x1093e6=_0x274f36,_0x385201=await this[_0x1093e6(0x18a)](),_0x6118a8=await this[_0x1093e6(0x159)](),_0x357b20=await this['countChats'](),_0x1e2aef=await this[_0x1093e6(0x1ab)](),_0x1c92e3=await this[_0x1093e6(0x17c)](),_0x1c1674=await this[_0x1093e6(0x1b4)](),_0x117a23=await this[_0x1093e6(0x179)](),_0x4f3367=await this[_0x1093e6(0x193)](),_0x2b3193=await this['countNewOrdersToday']();return{'userCount':_0x385201,'newUserCount':_0x6118a8,'chatCount':_0x357b20,'newChatCount':_0x1e2aef,'drawCount':_0x1c92e3,'newDrawCount':_0x117a23+_0x1c1674,'orderCount':_0x4f3367,'newOrderCount':_0x2b3193};}async[_0x274f36(0x16d)]({days:days=0x7}){const _0x10a0ca=_0x274f36,_0x1d062a=await this[_0x10a0ca(0x18f)](days),_0xaed15a=await this[_0x10a0ca(0x172)](days),_0x102bff=await this[_0x10a0ca(0x1b8)](days);return{'date':_0x1d062a[_0x10a0ca(0x17f)](_0x20c8d4=>_0x20c8d4['date']),'chat':_0x1d062a['map'](_0x79f408=>_0x79f408[_0x10a0ca(0x1b3)]),'draw':_0xaed15a[_0x10a0ca(0x17f)]((_0x550448,_0x37e587)=>{const _0x229701=_0x10a0ca;return _0x550448[_0x229701(0x1b3)]+_0x102bff[_0x37e587][_0x229701(0x1b3)];})};}async[_0x274f36(0x1a1)]({days:days=0x7}){const _0x4367d8=_0x274f36,_0x3875cc=await this[_0x4367d8(0x1af)](days);return _0x3875cc;}async[_0x274f36(0x18a)](){const _0x35829f=_0x274f36,_0x2f1de3=await this['userEntity'][_0x35829f(0x1b1)]();return _0x2f1de3;}async[_0x274f36(0x159)](){const _0x14a7be=_0x274f36,_0x2ba30b=new Date();_0x2ba30b['setHours'](0x0,0x0,0x0,0x0);const _0x429b38=new Date(_0x2ba30b[_0x14a7be(0x198)]()+0x18*0x3c*0x3c*0x3e8),_0x1e0e86=this[_0x14a7be(0x175)][_0x14a7be(0x19f)](_0x14a7be(0x17d)),_0x5ddc23=await _0x1e0e86[_0x14a7be(0x151)](_0x14a7be(0x16f),{'today':_0x2ba30b})['andWhere'](_0x14a7be(0x170),{'tomorrow':_0x429b38})[_0x14a7be(0x1a2)]();return _0x5ddc23;}async['countChats'](){const _0x49b03d=_0x274f36,_0x4ff64e=await this[_0x49b03d(0x1a6)][_0x49b03d(0x1b1)]({'where':{'type':balance_constant_1[_0x49b03d(0x18b)][_0x49b03d(0x173)]}});return _0x4ff64e;}async['countNewChatsToday'](){const _0x5b0fb5=_0x274f36,_0x4d8395=new Date();_0x4d8395[_0x5b0fb5(0x189)](0x0,0x0,0x0,0x0);const _0x50b808=new Date(_0x4d8395[_0x5b0fb5(0x198)]()+0x18*0x3c*0x3c*0x3e8),_0x1bca88=this[_0x5b0fb5(0x1a6)]['createQueryBuilder'](_0x5b0fb5(0x171)),_0x4938dd=await _0x1bca88['where'](_0x5b0fb5(0x1c0),{'type':balance_constant_1[_0x5b0fb5(0x18b)][_0x5b0fb5(0x173)]})[_0x5b0fb5(0x15c)](_0x5b0fb5(0x157),{'today':_0x4d8395})[_0x5b0fb5(0x15c)](_0x5b0fb5(0x18c),{'tomorrow':_0x50b808})[_0x5b0fb5(0x1a2)]();return _0x4938dd;}async[_0x274f36(0x17c)](){const _0x499f11=_0x274f36,_0x3d0c41=await this[_0x499f11(0x1a6)][_0x499f11(0x1b1)]({'where':{'type':balance_constant_1[_0x499f11(0x18b)][_0x499f11(0x195)]}});return _0x3d0c41;}async[_0x274f36(0x1b4)](){const _0x4ba252=_0x274f36,_0x1b7979=new Date();_0x1b7979[_0x4ba252(0x189)](0x0,0x0,0x0,0x0);const _0x4a438c=new Date(_0x1b7979[_0x4ba252(0x198)]()+0x18*0x3c*0x3c*0x3e8),_0x36ca27=this[_0x4ba252(0x1a6)]['createQueryBuilder'](_0x4ba252(0x171)),_0x492bc6=await _0x36ca27['where']('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x4ba252(0x18b)]['PAINT_TYPE']})[_0x4ba252(0x15c)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x1b7979})[_0x4ba252(0x15c)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x4a438c})[_0x4ba252(0x1a2)]();return _0x492bc6;}async['countNewMidhourneysToday'](){const _0x5e55f5=_0x274f36,_0xe92f5c=new Date();_0xe92f5c['setHours'](0x0,0x0,0x0,0x0);const _0x2ac38b=new Date(_0xe92f5c[_0x5e55f5(0x198)]()+0x18*0x3c*0x3c*0x3e8),_0x3c2809=this['midjourneyEntity'][_0x5e55f5(0x19f)](_0x5e55f5(0x164)),_0x52b1fc=await _0x3c2809[_0x5e55f5(0x151)](_0x5e55f5(0x1b9),{'today':_0xe92f5c})[_0x5e55f5(0x15c)](_0x5e55f5(0x16c),{'tomorrow':_0x2ac38b})[_0x5e55f5(0x1a2)]();return _0x52b1fc;}async[_0x274f36(0x18f)](_0x499dde){const _0x381959=_0x274f36;var _0x26e91d,_0x249ff;const _0x45b87f=new Date();_0x45b87f[_0x381959(0x189)](0x0,0x0,0x0,0x0);const _0x253a3a=new Date(_0x45b87f[_0x381959(0x198)]()-(_0x499dde-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5da3c5=this[_0x381959(0x1a6)][_0x381959(0x19f)](_0x381959(0x1c2)),_0x45eaf1=await _0x5da3c5[_0x381959(0x1a7)](_0x381959(0x15a))[_0x381959(0x151)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x381959(0x18b)][_0x381959(0x173)]})[_0x381959(0x15c)](_0x381959(0x155),{'startDate':_0x253a3a})['groupBy'](_0x381959(0x184))['orderBy']('date')[_0x381959(0x1a0)](),_0x1e3399=[],_0xcb2fe3=_0x253a3a;for(let _0x273737=0x0;_0x273737<_0x499dde;_0x273737++){const _0xc9edf5=(0x0,date_1[_0x381959(0x188)])(new Date(_0xcb2fe3),_0x381959(0x156)),_0x5e8301=(_0x249ff=(_0x26e91d=_0x45eaf1[_0x381959(0x153)](_0x465d3b=>(0x0,date_1['formatDate'])(new Date(_0x465d3b['date']),_0x381959(0x156))===_0xc9edf5))===null||_0x26e91d===void 0x0?void 0x0:_0x26e91d[_0x381959(0x1b1)])!==null&&_0x249ff!==void 0x0?_0x249ff:0x0;_0x5e8301>0x0?_0x1e3399[_0x381959(0x1b7)]({'date':_0xc9edf5,'value':Number(_0x5e8301)}):_0x1e3399['push']({'date':_0xc9edf5,'value':0x0}),_0xcb2fe3[_0x381959(0x17b)](_0xcb2fe3[_0x381959(0x1bc)]()+0x1);}return _0x1e3399;}async[_0x274f36(0x172)](_0xf269a8){const _0x16d136=_0x274f36;var _0x2337eb,_0x18b6f3;const _0x41dbba=new Date();_0x41dbba[_0x16d136(0x189)](0x0,0x0,0x0,0x0);const _0x304a37=new Date(_0x41dbba[_0x16d136(0x198)]()-(_0xf269a8-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4a4f4c=this[_0x16d136(0x1a6)][_0x16d136(0x19f)](_0x16d136(0x1c2)),_0x38c666=await _0x4a4f4c['select']('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')['where']('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x16d136(0x18b)][_0x16d136(0x195)]})[_0x16d136(0x15c)](_0x16d136(0x155),{'startDate':_0x304a37})[_0x16d136(0x18e)](_0x16d136(0x184))[_0x16d136(0x199)]('date')[_0x16d136(0x1a0)](),_0x53976c=[],_0x225d78=_0x304a37;for(let _0x5abbb2=0x0;_0x5abbb2<_0xf269a8;_0x5abbb2++){const _0x5ca044=(0x0,date_1[_0x16d136(0x188)])(new Date(_0x225d78),_0x16d136(0x156)),_0x1c72cc=(_0x18b6f3=(_0x2337eb=_0x38c666[_0x16d136(0x153)](_0x1310f1=>(0x0,date_1[_0x16d136(0x188)])(new Date(_0x1310f1['date']),_0x16d136(0x156))===_0x5ca044))===null||_0x2337eb===void 0x0?void 0x0:_0x2337eb[_0x16d136(0x1b1)])!==null&&_0x18b6f3!==void 0x0?_0x18b6f3:0x0;_0x1c72cc>0x0?_0x53976c['push']({'date':_0x5ca044,'value':Number(_0x1c72cc)}):_0x53976c[_0x16d136(0x1b7)]({'date':_0x5ca044,'value':0x0}),_0x225d78['setDate'](_0x225d78['getDate']()+0x1);}return _0x53976c;}async[_0x274f36(0x1b8)](_0x171364){const _0x1d3390=_0x274f36;var _0xcc2ff2,_0x1180c2;const _0x4300f7=new Date();_0x4300f7[_0x1d3390(0x189)](0x0,0x0,0x0,0x0);const _0x334bc8=new Date(_0x4300f7['getTime']()-(_0x171364-0x1)*0x18*0x3c*0x3c*0x3e8),_0x47be69=this[_0x1d3390(0x1ba)][_0x1d3390(0x19f)](_0x1d3390(0x164)),_0x23fa73=await _0x47be69[_0x1d3390(0x1a7)](_0x1d3390(0x174))[_0x1d3390(0x151)](_0x1d3390(0x19a),{'status':midjourney_constant_1['MidjourneyStatusEnum'][_0x1d3390(0x168)]})['andWhere'](_0x1d3390(0x180),{'startDate':_0x334bc8})['groupBy'](_0x1d3390(0x184))[_0x1d3390(0x199)](_0x1d3390(0x184))['getRawMany'](),_0x5cd4e4=[],_0x37f02f=_0x334bc8;for(let _0xe21b57=0x0;_0xe21b57<_0x171364;_0xe21b57++){const _0x4bac0a=(0x0,date_1[_0x1d3390(0x188)])(new Date(_0x37f02f),_0x1d3390(0x156)),_0x28b3d8=(_0x1180c2=(_0xcc2ff2=_0x23fa73[_0x1d3390(0x153)](_0x3dbf10=>(0x0,date_1[_0x1d3390(0x188)])(new Date(_0x3dbf10[_0x1d3390(0x184)]),'M.DD')===_0x4bac0a))===null||_0xcc2ff2===void 0x0?void 0x0:_0xcc2ff2[_0x1d3390(0x1b1)])!==null&&_0x1180c2!==void 0x0?_0x1180c2:0x0;_0x28b3d8>0x0?_0x5cd4e4[_0x1d3390(0x1b7)]({'date':_0x4bac0a,'value':Number(_0x28b3d8)}):_0x5cd4e4[_0x1d3390(0x1b7)]({'date':_0x4bac0a,'value':0x0}),_0x37f02f[_0x1d3390(0x17b)](_0x37f02f['getDate']()+0x1);}return _0x5cd4e4;}async[_0x274f36(0x1af)](_0x5348b2){const _0x335d3a=_0x274f36;var _0x45134b,_0x5206a0;const _0x596bf4=(0x0,date_1[_0x335d3a(0x188)])(new Date(),_0x335d3a(0x196)),_0x45060f=(0x0,date_1[_0x335d3a(0x188)])(new Date(Date[_0x335d3a(0x1c3)]()-Number(_0x5348b2-0x1)*0x18*0x3c*0x3c*0x3e8),_0x335d3a(0x196)),_0x3faba6=_0x335d3a(0x185),_0x6e6e52=_0x335d3a(0x1be),_0x4f1806=await this[_0x335d3a(0x177)][_0x335d3a(0x153)]({'where':{'configKey':(0x0,typeorm_2['In'])(['baiduToken','baiduSiteId'])}}),_0x1ef1f4=(_0x45134b=_0x4f1806[_0x335d3a(0x153)](_0x3a813e=>_0x3a813e[_0x335d3a(0x152)]===_0x335d3a(0x194)))===null||_0x45134b===void 0x0?void 0x0:_0x45134b[_0x335d3a(0x1ad)],_0x1a3780=(_0x5206a0=_0x4f1806['find'](_0x230160=>_0x230160[_0x335d3a(0x152)]===_0x335d3a(0x1bb)))===null||_0x5206a0===void 0x0?void 0x0:_0x5206a0[_0x335d3a(0x1ad)];if(!_0x1ef1f4||!_0x1a3780)return[];if(!_0x1ef1f4)throw new common_1[(_0x335d3a(0x1aa))](_0x335d3a(0x19c),common_1['HttpStatus']['BAD_REQUEST']);if(!_0x1a3780)throw new common_1[(_0x335d3a(0x1aa))](_0x335d3a(0x161),common_1['HttpStatus']['BAD_REQUEST']);const _0x35b8f1=_0x335d3a(0x163)+_0x1a3780+_0x335d3a(0x17e)+_0x1ef1f4+_0x335d3a(0x191)+_0x6e6e52+_0x335d3a(0x1a9)+_0x45060f+'&end_date='+_0x596bf4+_0x335d3a(0x160)+_0x3faba6,_0x4a5965=await axios_1[_0x335d3a(0x1ae)]['get'](_0x35b8f1),{error_code:_0x494713,message:_0x28276e}=_0x4a5965['data'];if(_0x494713===0x6f)throw new common_1[(_0x335d3a(0x1aa))](_0x28276e||_0x335d3a(0x1a3),common_1[_0x335d3a(0x19b)][_0x335d3a(0x1b5)]);if(_0x494713&&_0x494713!==0xc8)throw new common_1[(_0x335d3a(0x1aa))](_0x28276e||_0x335d3a(0x176),common_1[_0x335d3a(0x19b)][_0x335d3a(0x1b5)]);return _0x4a5965[_0x335d3a(0x181)][_0x335d3a(0x1b0)];}async[_0x274f36(0x193)](){const _0x936f0c=_0x274f36,_0x3fe619=await this[_0x936f0c(0x158)][_0x936f0c(0x1b1)]();return _0x3fe619;}async['countNewOrdersToday'](){const _0x4c4416=_0x274f36,_0x2fc784=new Date();_0x2fc784[_0x4c4416(0x189)](0x0,0x0,0x0,0x0);const _0x17fd26=new Date(_0x2fc784[_0x4c4416(0x198)]()+0x18*0x3c*0x3c*0x3e8),_0x3b91ec=this['orderEntity'][_0x4c4416(0x19f)](_0x4c4416(0x15f)),_0x506516=await _0x3b91ec[_0x4c4416(0x151)]('order.createdAt\x20>=\x20:today',{'today':_0x2fc784})[_0x4c4416(0x15c)](_0x4c4416(0x167),{'tomorrow':_0x17fd26})[_0x4c4416(0x1a2)]();return _0x506516;}};function _0xfe18(_0x37a90e,_0x85d263){const _0x2ebffd=_0x2ebf();return _0xfe18=function(_0xfe18eb,_0x11c8b3){_0xfe18eb=_0xfe18eb-0x14f;let _0x1dceee=_0x2ebffd[_0xfe18eb];return _0x1dceee;},_0xfe18(_0x37a90e,_0x85d263);}StatisticService=__decorate([(0x0,common_1[_0x274f36(0x178)])(),__param(0x0,(0x0,typeorm_1[_0x274f36(0x1bd)])(user_entity_1[_0x274f36(0x154)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x274f36(0x17a)])),__param(0x2,(0x0,typeorm_1[_0x274f36(0x1bd)])(config_entity_1[_0x274f36(0x169)])),__param(0x3,(0x0,typeorm_1[_0x274f36(0x1bd)])(order_entity_1[_0x274f36(0x150)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1['MidjourneyEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x274f36(0x16e)],typeorm_2[_0x274f36(0x16e)],typeorm_2[_0x274f36(0x16e)],typeorm_2[_0x274f36(0x16e)],typeorm_2[_0x274f36(0x16e)]])],StatisticService),exports['StatisticService']=StatisticService;