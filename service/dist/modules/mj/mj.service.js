'use strict';const _0x6ba634=_0x416c;(function(_0x2ef563,_0x4363e2){const _0x103fee=_0x416c,_0x3bc12f=_0x2ef563();while(!![]){try{const _0x1f6cf8=-parseInt(_0x103fee(0x201))/0x1*(-parseInt(_0x103fee(0x203))/0x2)+parseInt(_0x103fee(0x1dc))/0x3+-parseInt(_0x103fee(0x256))/0x4+parseInt(_0x103fee(0x206))/0x5+-parseInt(_0x103fee(0x222))/0x6+-parseInt(_0x103fee(0x267))/0x7*(parseInt(_0x103fee(0x236))/0x8)+parseInt(_0x103fee(0x26a))/0x9*(parseInt(_0x103fee(0x25b))/0xa);if(_0x1f6cf8===_0x4363e2)break;else _0x3bc12f['push'](_0x3bc12f['shift']());}catch(_0x274cab){_0x3bc12f['push'](_0x3bc12f['shift']());}}}(_0x54ed,0xd74fe));var __decorate=this&&this[_0x6ba634(0x22a)]||function(_0x129cc6,_0x3d0128,_0x508e8e,_0x54f777){const _0x37bb7c=_0x6ba634;var _0x4ededc=arguments['length'],_0x332467=_0x4ededc<0x3?_0x3d0128:_0x54f777===null?_0x54f777=Object['getOwnPropertyDescriptor'](_0x3d0128,_0x508e8e):_0x54f777,_0x380164;if(typeof Reflect===_0x37bb7c(0x1e2)&&typeof Reflect['decorate']==='function')_0x332467=Reflect['decorate'](_0x129cc6,_0x3d0128,_0x508e8e,_0x54f777);else{for(var _0x1d4408=_0x129cc6[_0x37bb7c(0x258)]-0x1;_0x1d4408>=0x0;_0x1d4408--)if(_0x380164=_0x129cc6[_0x1d4408])_0x332467=(_0x4ededc<0x3?_0x380164(_0x332467):_0x4ededc>0x3?_0x380164(_0x3d0128,_0x508e8e,_0x332467):_0x380164(_0x3d0128,_0x508e8e))||_0x332467;}return _0x4ededc>0x3&&_0x332467&&Object[_0x37bb7c(0x24c)](_0x3d0128,_0x508e8e,_0x332467),_0x332467;},__metadata=this&&this[_0x6ba634(0x247)]||function(_0x3cdd14,_0xfcaeb){const _0xf12e2e=_0x6ba634;if(typeof Reflect==='object'&&typeof Reflect[_0xf12e2e(0x243)]==='function')return Reflect[_0xf12e2e(0x243)](_0x3cdd14,_0xfcaeb);},__param=this&&this[_0x6ba634(0x248)]||function(_0x237a85,_0x57b8c4){return function(_0x548ed5,_0x36f2b1){_0x57b8c4(_0x548ed5,_0x36f2b1,_0x237a85);};};Object[_0x6ba634(0x24c)](exports,_0x6ba634(0x223),{'value':!![]}),exports[_0x6ba634(0x24a)]=void 0x0;function _0x54ed(){const _0x4fe95e=['当前用户\x20','绘画任务开始','variationId','PAINT_TYPE','https://discord.com/api/v9/interactions','HttpException','http://172.247.48.137:8000/mj/draw','本次放大图片的id:\x20','http://172.247.48.137:8000/mj/list?channel_id=','uploadFileFromUrl','DeductionKey','baiduFanyiAppId','UploadService','match','../fanyi/fanyi.service','拿到了远程地址:\x20','replace','Like','9eoGLRf','components','96130BlxpjO','开始查询绘画结果轮询','fanyiService','5512955lOqlqo','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','mjProxy','user','floor','查询绘制结果失败...','mjChannelId','mjAuthorization','freeQueueUsers','data','prompt\x20-------->\x20\x20','开始请求用户','includes','response','variationSingleImg','error:\x20','GlobalConfigService','mjservice','变换当前图片失败','sleep','../chatLog/chatLog.entity','\x20次开始查询[变换图片]','InjectRepository','查询期间出现错误：','\x20队列+1:\x20','mjId','checkFree','\x20请求过于频繁！','7920972qrJkJx','__esModule','绘制图片任务结束\x20队列-1:\x20','秒请求一次、请合理使用！','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','历史这些id已经被获取过了\x20不能拿了:\x20','放大图片任务结束\x20队列-1:\x20','axios','__decorate','getClientIp','ChatLogEntity','ChatLogService','getConfigs','本次比对的随机ID:\x20','../globalConfig/globalConfig.service','rateLimits','test','../upload/upload.service','pollForUpscaleResult','baiduFanyiSecret','44872MctSGB','绘制图片任务异常中断\x20队列-1:\x20','queueCount','orderId','substring','由于速率限制、当前普通用户限制为','extractContent','stringify','parse','绘画失败','prompt','HttpStatus','../../common/constants/balance.constant','metadata','变换图片任务结束\x20队列-1:\x20','checkBadWords','createRandomUid','__metadata','__param','pollForVariationResult','MjService','checkRateLimit','defineProperty','message','default','removeEmoji','IsNull','queryMessageList','Not','BalanceEntity','开始请求放大图片\x20队列+1:\x20','findCurrentPromptResult','6642064USgHIc','message_id','length','admin','saveChatLog','20530FHIHGw','当前提示词已经在任务队列中了、请勿重复提交。。。','变换当前图片超时！','error','当前图片没有绘画信息、无法变体!','mjNotSaveImg','存入图片完成:\x20','drawWorking','sendSmInteractions','upscaleSingleImg','log','get','1904oggzGj','axios:\x20','BAD_REQUEST','10935fEBgDb','\x20次开始查询\x20=>\x20当前查询结果：','design:paramtypes','typeorm','where','mjDraw','checkAuth','mjGuildId','deductBalance','filter','globalConfigService','INTERNAL_SERVER_ERROR','findCurrentVariationImgResult','enlarge','now','chatLogService','历史记录中不存在当前图片、请确认您放大的图片是否存在','当前用户','pollForResult','mjRateLimit','您当前暂无MJ绘画余额！！！','map','badwordsService','BadwordsService','开始轮询单张变换图片结果','balance\x20-\x201','url','find','sendDrawInteractions','放大custom_id:\x20','randomId:\x20','发送绘画指令结果:\x20','https://discord.com/api/v9/channels/','mjApplicationId','绘图指令完成','balanceEntity','历史中存在当前图片、直接获取！','4076019oeqbQK','FanyiService','chatLogEntity','/messages?limit=50','放大图片任务异常中断\x20队列-1:\x20','axios\x20get:\x20','object','findOne','放大当前图片失败','balance','当前图片已经放大过了、请勿重复放大!','getMjDefaultParams','userId\x20=\x20:userId','max','uploadService','convertToEnglish','mjSessionId','Repository','mjVersion'];_0x54ed=function(){return _0x4fe95e;};return _0x54ed();}const globalConfig_service_1=require(_0x6ba634(0x230)),upload_service_1=require(_0x6ba634(0x233)),common_1=require('@nestjs/common'),axios_1=require(_0x6ba634(0x229)),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x6ba634(0x242)),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x6ba634(0x21a)),typeorm_1=require(_0x6ba634(0x26d)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x6ba634(0x1fd)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x1b1c25,_0xd6b0f6,_0x71d008,_0x5680c0,_0x2dc052,_0x5b0f02,_0x3099ab){const _0x34a055=_0x6ba634;this[_0x34a055(0x1de)]=_0x1b1c25,this[_0x34a055(0x1da)]=_0xd6b0f6,this[_0x34a055(0x1ea)]=_0x71d008,this[_0x34a055(0x279)]=_0x5680c0,this[_0x34a055(0x274)]=_0x2dc052,this[_0x34a055(0x205)]=_0x5b0f02,this[_0x34a055(0x280)]=_0x3099ab,this[_0x34a055(0x231)]={},this['drawWorking']=[],this['enlargeWorking']=[],this[_0x34a055(0x238)]=0x0,this[_0x34a055(0x20e)]={};}async[_0x6ba634(0x26f)](_0xe9fc62){const _0x4177a5=_0x6ba634,{jobId:_0x3e9d14,prompt:_0x43ca1d,startTime:_0x264521,userId:_0x3413c3}=_0xe9fc62;return console['log'](_0x4177a5(0x1f0),_0x4177a5(0x217)),await new Promise(_0x5e301e=>setTimeout(_0x5e301e,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x21895e,_0x40ff4e){const _0x347600=_0x6ba634;await this[_0x347600(0x270)](_0x40ff4e),await this[_0x347600(0x280)][_0x347600(0x245)](_0x21895e[_0x347600(0x240)],_0x40ff4e[_0x347600(0x209)]['id']);const _0x58e496=_0x21895e[_0x347600(0x240)];let _0x316f4f=_0x21895e[_0x347600(0x240)];const {baiduFanyiAppId:_0x59b02d,baiduFanyiSecret:_0x3999b6}=await this[_0x347600(0x274)][_0x347600(0x22e)]([_0x347600(0x1fa),_0x347600(0x235)]);_0x59b02d&&_0x3999b6&&(_0x316f4f=await this[_0x347600(0x205)][_0x347600(0x1eb)](_0x58e496));const _0x2d18c2='['+(0x0,utils_1[_0x347600(0x246)])()+']',_0x32d931=_0x2d18c2+'\x20'+_0x316f4f;console['log'](_0x347600(0x1d5),_0x2d18c2),console[_0x347600(0x265)](_0x347600(0x210),_0x32d931);const _0x391cf5=this[_0x347600(0x262)]['find'](_0x2e05fe=>_0x2e05fe[_0x347600(0x212)](_0x21895e[_0x347600(0x240)]));if(_0x391cf5)throw new common_1[(_0x347600(0x1f4))](_0x347600(0x25c),common_1[_0x347600(0x241)][_0x347600(0x269)]);if(this[_0x347600(0x238)]>=0x3)throw new common_1[(_0x347600(0x1f4))](_0x347600(0x207),common_1[_0x347600(0x241)]['BAD_REQUEST']);await this[_0x347600(0x24b)](_0x40ff4e),this['queueCount']++,console[_0x347600(0x265)](_0x347600(0x211)+_0x40ff4e[_0x347600(0x209)]['id']+_0x347600(0x21e),this['queueCount']);try{const _0x4b2ef5=await this['chatLogEntity'][_0x347600(0x285)]({'where':{'prompt':(0x0,typeorm_1[_0x347600(0x200)])('%'+_0x32d931+'%')}}),_0x466062=_0x4b2ef5['map'](_0x33a779=>_0x33a779['message_id']);this[_0x347600(0x262)]['push'](_0x32d931);let _0x3c6acf;const _0x1f264d=await this[_0x347600(0x1d3)](_0x32d931,_0x466062,_0x2d18c2);_0x1f264d?(console[_0x347600(0x265)](_0x347600(0x1db)),_0x3c6acf=_0x1f264d):_0x3c6acf=await this[_0x347600(0x27c)](_0x32d931,_0x466062,_0x2d18c2);this[_0x347600(0x238)]--,this[_0x347600(0x238)]<0x0&&(this[_0x347600(0x238)]=0x0),console['log'](_0x347600(0x224),this[_0x347600(0x238)]);const {id:_0x2448ef,content:_0x16eb7d,channel_id:_0x2ea035,attachments:attachments=[],timestamp:_0x47622c}=_0x3c6acf;if(!attachments[_0x347600(0x258)]||!attachments[0x0]['url'])throw new common_1['HttpException'](_0x347600(0x23f),common_1[_0x347600(0x241)][_0x347600(0x269)]);const {filename:_0x1562a0,url:_0x2e4dc8,width:_0x277a4d,height:_0x46070b,size:_0x4a6090}=attachments[0x0];console['log'](_0x347600(0x1fe),_0x2e4dc8);const _0x4f3b21=this[_0x347600(0x274)][_0x347600(0x22e)]([_0x347600(0x260)]);let _0x1e8435='';(!Number(_0x4f3b21)||Number(_0x4f3b21)===0x0)&&(_0x1e8435=await this[_0x347600(0x1ea)][_0x347600(0x1f8)]({'filename':_0x1562a0,'url':_0x2e4dc8}),console[_0x347600(0x265)](_0x347600(0x261),_0x1e8435));const _0x1ae577={'curIp':(0x0,utils_1['getClientIp'])(_0x40ff4e),'userId':_0x40ff4e[_0x347600(0x209)]['id'],'type':balance_constant_1[_0x347600(0x1f9)][_0x347600(0x1f2)],'prompt':_0x32d931,'answer':_0x1e8435,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x3c6acf)),'message_id':_0x2448ef,'variationId':_0x2448ef,'upscaleId':_0x2448ef,'group':0x1,'isSaveImg':!Number(_0x4f3b21)||Number(_0x4f3b21)===0x0,'fileInfo':JSON[_0x347600(0x23d)]({'width':_0x277a4d,'height':_0x46070b,'size':_0x4a6090,'filename':_0x1562a0,'cosUrl':_0x1e8435})};return await this[_0x347600(0x279)]['saveChatLog'](_0x1ae577),await this[_0x347600(0x272)](_0x40ff4e),this[_0x347600(0x262)]=this[_0x347600(0x262)][_0x347600(0x273)](_0x31699e=>_0x31699e!==_0x21895e['prompt']),_0x1e8435;}catch(_0x55f061){this[_0x347600(0x238)]--,this[_0x347600(0x238)]<0x0&&(this[_0x347600(0x238)]=0x0),console[_0x347600(0x265)](_0x347600(0x237),this[_0x347600(0x238)]),this['drawWorking']=this[_0x347600(0x262)][_0x347600(0x273)](_0x523148=>_0x523148!==_0x21895e[_0x347600(0x240)]);throw new common_1[(_0x347600(0x1f4))](_0x55f061[_0x347600(0x213)],common_1[_0x347600(0x241)][_0x347600(0x269)]);}}async[_0x6ba634(0x264)](_0x141b24,_0x302f99){const _0x3779fc=_0x6ba634;if(this[_0x3779fc(0x238)]>=0x3)throw new common_1[(_0x3779fc(0x1f4))](_0x3779fc(0x207),common_1['HttpStatus'][_0x3779fc(0x269)]);this['queueCount']++,console['log']('用户'+_0x302f99[_0x3779fc(0x209)]['id']+_0x3779fc(0x254),this['queueCount']);const {message_id:_0x589b2b,orderId:_0x39bd21}=_0x141b24;try{const _0x58ef46=await this[_0x3779fc(0x1de)][_0x3779fc(0x1e3)]({'where':{'message_id':_0x589b2b}});if(!_0x58ef46)throw new common_1['HttpException'](_0x3779fc(0x27a),common_1[_0x3779fc(0x241)]['BAD_REQUEST']);const _0x27a2ce=await this[_0x3779fc(0x1de)][_0x3779fc(0x1e3)]({'where':{'upscaleId':_0x589b2b,'action':'enlarge','orderId':_0x39bd21}});if(_0x27a2ce)throw new common_1['HttpException'](_0x3779fc(0x1e6),common_1[_0x3779fc(0x241)]['BAD_REQUEST']);const {prompt:_0x35c441,extend:_0x4c9b82}=_0x58ef46;let _0x3f8b50=null;try{_0x3f8b50=JSON[_0x3779fc(0x23e)](_0x4c9b82);}catch(_0x4835ed){_0x3f8b50=[];}const {components:components=[]}=_0x3f8b50;if(!components[_0x3779fc(0x258)])throw new common_1['HttpException']('当前图片没有绘画信息、无法放大!',common_1['HttpStatus']['BAD_REQUEST']);const _0x774dea=components[0x0][_0x3779fc(0x202)][_0x39bd21-0x1],{custom_id:_0x4062fc}=_0x774dea;console[_0x3779fc(0x265)](_0x3779fc(0x1d4),_0x4062fc);const _0x2c8980={'message_id':_0x589b2b,'custom_id':_0x4062fc,'prompt':_0x35c441,'orderId':_0x39bd21};await this[_0x3779fc(0x263)](_0x2c8980),console[_0x3779fc(0x265)]('发送放大指令成功');const _0x302a53=await this[_0x3779fc(0x1de)][_0x3779fc(0x285)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x35c441+'%')}}),_0x23ed85=_0x302a53['map'](_0xd24abd=>_0xd24abd[_0x3779fc(0x257)]);console[_0x3779fc(0x265)](_0x3779fc(0x227),_0x23ed85);const _0x565e9f=await this[_0x3779fc(0x234)](_0x2c8980,_0x23ed85);this[_0x3779fc(0x238)]--,this[_0x3779fc(0x238)]<0x0&&(this['queueCount']=0x0),console['log'](_0x3779fc(0x228),this[_0x3779fc(0x238)]);const {id:_0x3f7f05,content:_0xeeac6f,channel_id:_0x53bdf9,attachments:attachments=[],timestamp:_0x1f38ea}=_0x565e9f;if(!attachments[_0x3779fc(0x258)]||!attachments[0x0][_0x3779fc(0x284)])throw new common_1[(_0x3779fc(0x1f4))](_0x3779fc(0x1e4),common_1[_0x3779fc(0x241)][_0x3779fc(0x269)]);const {filename:_0x2a4d15,url:_0x1e0a0b,width:_0x3080bc,height:_0x5ade31,size:_0x4e43b3}=attachments[0x0],_0x541bb8=this[_0x3779fc(0x274)][_0x3779fc(0x22e)](['mjNotSaveImg']);let _0x5cc881='';(!Number(_0x541bb8)||Number(_0x541bb8)===0x0)&&(_0x5cc881=await this['uploadService'][_0x3779fc(0x1f8)]({'filename':_0x2a4d15,'url':_0x1e0a0b}),console[_0x3779fc(0x265)](_0x3779fc(0x261),_0x5cc881));const _0x587c02={'curIp':(0x0,utils_1[_0x3779fc(0x22b)])(_0x302f99),'userId':_0x302f99['user']['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x35c441,'answer':_0x5cc881,'model':'mj','extend':this['removeEmoji'](JSON[_0x3779fc(0x23d)](_0x565e9f)),'message_id':_0x589b2b,'upscaleId':_0x3f7f05,'variationId':_0x3f7f05,'action':_0x3779fc(0x277),'orderId':_0x2c8980[_0x3779fc(0x239)],'isSaveImg':!Number(_0x541bb8)||Number(_0x541bb8)===0x0,'fileInfo':JSON[_0x3779fc(0x23d)]({'width':_0x3080bc,'height':_0x5ade31,'size':_0x4e43b3,'filename':_0x2a4d15,'cosUrl':_0x5cc881})};return await this['chatLogService'][_0x3779fc(0x25a)](_0x587c02),_0x5cc881;}catch(_0x3bc9bd){console[_0x3779fc(0x265)](_0x3779fc(0x215),_0x3bc9bd),this[_0x3779fc(0x238)]--,this[_0x3779fc(0x238)]<0x0&&(this[_0x3779fc(0x238)]=0x0),console[_0x3779fc(0x265)](_0x3779fc(0x1e0),this[_0x3779fc(0x238)]);throw new common_1[(_0x3779fc(0x1f4))](_0x3bc9bd[_0x3779fc(0x213)],common_1['HttpStatus'][_0x3779fc(0x269)]);}}async[_0x6ba634(0x214)](_0x49c0bf,_0x2644fe){const _0x115f5f=_0x6ba634;if(this[_0x115f5f(0x238)]>=0x3)throw new common_1[(_0x115f5f(0x1f4))](_0x115f5f(0x207),common_1[_0x115f5f(0x241)]['BAD_REQUEST']);await this[_0x115f5f(0x270)](_0x2644fe),await this[_0x115f5f(0x24b)](_0x2644fe),this[_0x115f5f(0x238)]++,console[_0x115f5f(0x265)]('用户'+_0x2644fe['user']['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x115f5f(0x238)]);const {message_id:_0x4931ee,orderId:_0x4cd716}=_0x49c0bf;try{const _0x7abbb7=await this[_0x115f5f(0x1de)]['findOne']({'where':{'message_id':_0x4931ee}});if(!_0x7abbb7)throw new common_1[(_0x115f5f(0x1f4))](_0x115f5f(0x226),common_1[_0x115f5f(0x241)][_0x115f5f(0x269)]);const {prompt:_0x19d982,extend:_0x45cadf}=_0x7abbb7;let _0x7b4dd7=null;try{_0x7b4dd7=JSON[_0x115f5f(0x23e)](_0x45cadf);}catch(_0x13809c){_0x7b4dd7=[];}const {components:components=[]}=_0x7b4dd7;if(!components[_0x115f5f(0x258)])throw new common_1[(_0x115f5f(0x1f4))](_0x115f5f(0x25f),common_1[_0x115f5f(0x241)][_0x115f5f(0x269)]);const _0x23ca11=components[0x1][_0x115f5f(0x202)][_0x4cd716-0x1],{custom_id:_0x475dc9}=_0x23ca11,_0x2f628c=await this[_0x115f5f(0x1de)][_0x115f5f(0x285)]({'where':{'variationId':(0x0,typeorm_1[_0x115f5f(0x252)])((0x0,typeorm_1[_0x115f5f(0x250)])()),'prompt':(0x0,typeorm_1[_0x115f5f(0x200)])('%'+_0x19d982+'%')}}),_0x3cffc7=_0x2f628c[_0x115f5f(0x27f)](_0x5bdcdd=>_0x5bdcdd[_0x115f5f(0x1f1)]),_0x14f3c6={'message_id':_0x4931ee,'custom_id':_0x475dc9,'prompt':_0x19d982,'orderId':_0x4cd716};await this[_0x115f5f(0x263)](_0x14f3c6);const _0x267615=await this[_0x115f5f(0x249)](_0x14f3c6,_0x3cffc7);this[_0x115f5f(0x238)]--,this[_0x115f5f(0x238)]<0x0&&(this['queueCount']=0x0),console[_0x115f5f(0x265)](_0x115f5f(0x244),this[_0x115f5f(0x238)]);const {id:_0x4ad7de,content:_0x33b0f8,channel_id:_0x35c8de,attachments:attachments=[],timestamp:_0x242751}=_0x267615;if(!attachments[_0x115f5f(0x258)]||!attachments[0x0][_0x115f5f(0x284)])throw new common_1[(_0x115f5f(0x1f4))](_0x115f5f(0x218),common_1[_0x115f5f(0x241)][_0x115f5f(0x269)]);const {filename:_0x402653,url:_0x3253b1,width:_0xb3b267,height:_0x100c77,size:_0x4b3382}=attachments[0x0],_0x10066a=this[_0x115f5f(0x274)][_0x115f5f(0x22e)]([_0x115f5f(0x260)]);let _0x5187fc='';(!Number(_0x10066a)||Number(_0x10066a)===0x0)&&(_0x5187fc=await this[_0x115f5f(0x1ea)][_0x115f5f(0x1f8)]({'filename':_0x402653,'url':_0x3253b1}),console[_0x115f5f(0x265)](_0x115f5f(0x261),_0x5187fc));const _0x3e45fb={'curIp':(0x0,utils_1[_0x115f5f(0x22b)])(_0x2644fe),'userId':_0x2644fe['user']['id'],'type':balance_constant_1[_0x115f5f(0x1f9)][_0x115f5f(0x1f2)],'prompt':_0x19d982,'answer':_0x5187fc,'model':'mj','group':0x1,'extend':this[_0x115f5f(0x24f)](JSON['stringify'](_0x267615)),'message_id':_0x4ad7de,'upscaleId':_0x4ad7de,'variationId':_0x4ad7de,'action':_0x115f5f(0x277),'orderId':_0x14f3c6['orderId'],'isSaveImg':!Number(_0x10066a)||Number(_0x10066a)===0x0,'fileInfo':JSON[_0x115f5f(0x23d)]({'width':_0xb3b267,'height':_0x100c77,'size':_0x4b3382,'filename':_0x402653,'cosUrl':_0x5187fc})};return await this[_0x115f5f(0x279)]['saveChatLog'](_0x3e45fb),_0x5187fc;}catch(_0x2d7672){console[_0x115f5f(0x265)](_0x115f5f(0x215),_0x2d7672),this[_0x115f5f(0x238)]--,this[_0x115f5f(0x238)]<0x0&&(this[_0x115f5f(0x238)]=0x0),console[_0x115f5f(0x265)]('变化图片任务异常中断\x20队列-1:\x20',this[_0x115f5f(0x238)]);throw new common_1['HttpException'](_0x2d7672[_0x115f5f(0x213)],common_1[_0x115f5f(0x241)][_0x115f5f(0x269)]);}}async[_0x6ba634(0x263)](_0x5e7498){const _0x4c9de8=_0x6ba634,{message_id:_0x4603a9,custom_id:_0x68587f}=_0x5e7498,{application_id:_0x397ba4,guild_id:_0x1c5c6a,channel_id:_0x6cc825,session_id:_0x2423c7,version:_0x2f2934,id:_0x451f98,authorization:_0x272a25,mjProxy:_0x5676ac}=await this['getMjDefaultParams'](),_0x229451=_0x5676ac==0x1?_0x4c9de8(0x1f5):_0x4c9de8(0x1f3),_0x5da8cf={'authorization':_0x272a25},_0x3f84d0={'type':0x3,'guild_id':_0x1c5c6a,'channel_id':_0x6cc825,'message_flags':0x0,'message_id':_0x4603a9,'application_id':_0x397ba4,'session_id':_0x2423c7,'data':{'component_type':0x2,'custom_id':_0x68587f}};try{await axios_1[_0x4c9de8(0x24e)]['post'](_0x229451,_0x3f84d0,{'headers':_0x5da8cf}),console['log'](_0x4c9de8(0x1d9));}catch(_0x1494bc){console[_0x4c9de8(0x265)]('error:\x20',_0x1494bc);throw new common_1['HttpException']('放大单张图片请求失败...',common_1[_0x4c9de8(0x241)]['BAD_REQUEST']);}}async[_0x6ba634(0x234)](_0x433b90,_0x4b2c43){const _0x310860=_0x6ba634,{message_id:_0x28a9a0,custom_id:_0x7f1eed,prompt:_0x214119,orderId:_0x42820b}=_0x433b90;let _0xfec61f=null,_0x48c928=0x0;while(!_0xfec61f&&_0x48c928<0xa){try{const _0xc76dbd=Date['now'](),_0x1f1409=await this[_0x310860(0x251)]();console[_0x310860(0x265)]('第\x20'+(_0x48c928+0x1)+_0x310860(0x26b)+_0x1f1409['length']);_0x1f1409&&_0x1f1409[_0x310860(0x258)]&&(_0xfec61f=await this['findCurrentEnlargeImgResult'](_0x1f1409,_0x433b90,_0x4b2c43));const _0x277190=Date[_0x310860(0x278)]()-_0xc76dbd,_0x29f696=0xbb8;await this[_0x310860(0x219)](Math[_0x310860(0x1e9)](_0x29f696-_0x277190,0x0)),_0x48c928++;}catch(_0x4c6670){console[_0x310860(0x25e)](_0x310860(0x21d)+_0x4c6670[_0x310860(0x24d)]);}}return _0xfec61f;}async[_0x6ba634(0x249)](_0x33db01,_0x5101e3){const _0x5170a4=_0x6ba634,{message_id:_0x3da90d,custom_id:_0x13c9d2,prompt:_0x46d358,orderId:_0x16ea73}=_0x33db01;console[_0x5170a4(0x265)](_0x5170a4(0x282));let _0x1d303a=null,_0x148748=0x0;while(!_0x1d303a&&_0x148748<0xa){try{console['log']('第\x20'+(_0x148748+0x1)+_0x5170a4(0x21b));const _0x80febb=Date[_0x5170a4(0x278)](),_0x5c2049=await this[_0x5170a4(0x251)]();_0x5c2049&&_0x5c2049[_0x5170a4(0x258)]&&(_0x1d303a=await this[_0x5170a4(0x276)](_0x5c2049,_0x33db01,_0x5101e3));const _0x24547a=Date[_0x5170a4(0x278)]()-_0x80febb,_0x4998c1=0x1f40;await this['sleep'](Math[_0x5170a4(0x1e9)](_0x4998c1-_0x24547a,0x0)),_0x148748++;}catch(_0x5e0932){console[_0x5170a4(0x25e)](_0x5170a4(0x21d)+_0x5e0932[_0x5170a4(0x24d)]);}}if(!_0x1d303a)throw new common_1['HttpException'](_0x5170a4(0x25d),common_1[_0x5170a4(0x241)]['BAD_REQUEST']);return _0x1d303a;}async['findCurrentEnlargeImgResult'](_0x252d6f,_0x35ce93,_0x197d78){const _0x422b5b=_0x6ba634,{message_id:_0x5e9144,custom_id:_0x5d2b2a,prompt:_0x291435,orderId:_0x524095}=_0x35ce93,_0x1e83f6=_0x291435[_0x422b5b(0x23a)](0x0,0xc);console[_0x422b5b(0x265)](_0x422b5b(0x1f6),_0x1e83f6);const _0x4e6644=_0x252d6f['find'](_0x2f3d85=>{const _0x454060=_0x422b5b,{content:_0x1c1c84}=_0x2f3d85;if(!this['extractContent'](_0x1c1c84))return![];const {prompt:_0xc211c1,order:_0x5aaf26}=this[_0x454060(0x23c)](_0x1c1c84);return _0xc211c1[_0x454060(0x212)](_0x1e83f6)&&_0x35ce93[_0x454060(0x239)]===_0x5aaf26&&!_0x197d78['includes'](_0x2f3d85['id']);});return _0x4e6644;}async[_0x6ba634(0x276)](_0x2513cd,_0x7ac2c5,_0x5b4c70){const _0x7f5c5f=_0x6ba634,{message_id:_0x54465b,custom_id:_0x272dd7,prompt:_0x2b9edf,orderId:_0x383134}=_0x7ac2c5,_0x176af4=_0x2b9edf[_0x7f5c5f(0x23a)](0x0,0xc),_0x225c5e=_0x2513cd['find'](_0x5c34a1=>{const _0x42b680=_0x7f5c5f,{content:_0x11c33d}=_0x5c34a1,_0xce84d=_0x11c33d['match'](/\*\*(.+?)\*\*/),_0xc95c2d=_0xce84d?_0xce84d[0x1]:'';if(!_0xc95c2d)return![];return _0xc95c2d[_0x42b680(0x212)](_0x176af4)&&!_0x5b4c70['includes'](_0x5c34a1['id']);});return _0x225c5e;}async[_0x6ba634(0x1d3)](_0xcce260,_0x4c99e2,_0x12e92e){const _0x45fcf2=_0x6ba634,_0x2f37d0=await this[_0x45fcf2(0x251)](),_0x169725=await this['findCurrentPromptResult'](_0x2f37d0,_0x12e92e,_0x4c99e2);if(_0x169725)return console['log']('有历史信息之间返回:\x20',_0x169725),_0x169725;const {application_id:_0x408dc2,guild_id:_0x538f95,channel_id:_0x3e53d2,session_id:_0xbb3106,version:_0x25c564,id:_0xb72156,authorization:_0x296d4a,mjProxy:_0x1d4c61}=await this[_0x45fcf2(0x1e7)](),_0x29cb5d={'type':0x2,'application_id':_0x408dc2,'guild_id':_0x538f95,'channel_id':_0x3e53d2,'session_id':_0xbb3106,'data':{'version':_0x25c564,'id':_0xb72156,'name':'imagine','type':0x1,'options':[{'type':0x3,'name':_0x45fcf2(0x240),'value':_0xcce260}],'attachments':[]}};try{const _0x493065=_0x1d4c61==0x1?_0x45fcf2(0x1f5):_0x45fcf2(0x1f3),_0x201408={'authorization':_0x296d4a},_0x18a00f=await axios_1[_0x45fcf2(0x24e)]['post'](_0x493065,_0x29cb5d,{'headers':_0x201408});return console[_0x45fcf2(0x265)](_0x45fcf2(0x1d6),_0x18a00f[_0x45fcf2(0x20f)]),![];}catch(_0x3ddc46){console['log'](_0x45fcf2(0x268),_0x3ddc46);throw new common_1[(_0x45fcf2(0x1f4))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0x45fcf2(0x241)]['BAD_REQUEST']);}}async[_0x6ba634(0x27c)](_0x3148f2,_0x4bfe26,_0xbaac67){const _0x37f3d4=_0x6ba634;console['log'](_0x37f3d4(0x204));const _0x2a6cb4=Date[_0x37f3d4(0x278)]();try{const _0x173e2e=0xd,_0x37aa94=0x2ee0,_0xa91b19=0x1388,_0x268d31=0x3c*0x3e8;let _0x36b133=0x0,_0xed3a68=![],_0x100aaa=null;while(!_0x100aaa&&_0x36b133<_0x173e2e){console[_0x37f3d4(0x265)]('第\x20'+(_0x36b133+0x1)+'\x20次开始查询');Date[_0x37f3d4(0x278)]()-_0x2a6cb4>=_0x268d31&&(_0xed3a68=!![]);await this['sleep'](_0xed3a68?_0xa91b19:_0x37aa94);const _0x3107a1=await this[_0x37f3d4(0x251)]();_0x100aaa=await this[_0x37f3d4(0x255)](_0x3107a1,_0xbaac67,_0x4bfe26),_0x36b133++;}if(!_0x100aaa)throw new common_1[(_0x37f3d4(0x1f4))]('绘画超时，请稍后再试！',common_1['HttpStatus'][_0x37f3d4(0x269)]);const _0x5a7a67=Date['now']();return console[_0x37f3d4(0x265)]('本次绘图耗时:\x20'+Math[_0x37f3d4(0x20a)]((_0x5a7a67-_0x2a6cb4)/0x3e8)+'\x20S'),_0x100aaa;}catch(_0x1875ba){console[_0x37f3d4(0x25e)](_0x1875ba['message']);throw new common_1[(_0x37f3d4(0x1f4))]('网络连接失败，请稍后再试！',common_1[_0x37f3d4(0x241)][_0x37f3d4(0x275)]);}}async[_0x6ba634(0x255)](_0x6b33a3,_0x3b0338,_0x52bcd4){const _0x228676=_0x6ba634;if(!_0x6b33a3||!_0x6b33a3[_0x228676(0x258)])return;console['log'](_0x228676(0x22f),_0x3b0338);const _0x50b885=_0x6b33a3[_0x228676(0x285)](_0x138e0a=>{const _0x40119e=_0x228676,{attachments:attachments=[],content:_0x189cf2,edited_timestamp:_0x58d5fd}=_0x138e0a;return _0x189cf2[_0x40119e(0x212)](_0x3b0338)&&attachments[_0x40119e(0x258)]>0x0&&!_0x58d5fd&&!_0x52bcd4[_0x40119e(0x212)](_0x138e0a['id']);});return _0x50b885||null;}async[_0x6ba634(0x251)](){const _0x1f2d54=_0x6ba634;try{const {application_id:_0x5bcc19,guild_id:_0x2d5296,channel_id:_0xb9176f,session_id:_0x5bdfb0,version:_0x737648,id:_0x1d5b2b,authorization:_0x5da821,mjProxy:_0xc8bf21}=await this[_0x1f2d54(0x1e7)](),_0x3f0295=_0xc8bf21==0x1?_0x1f2d54(0x1f7)+_0xb9176f:_0x1f2d54(0x1d7)+_0xb9176f+_0x1f2d54(0x1df),_0x5c5c65={'authorization':_0x5da821},_0x1eb121=await axios_1['default'][_0x1f2d54(0x266)](_0x3f0295,{'headers':_0x5c5c65});return _0x1eb121[_0x1f2d54(0x20f)];}catch(_0x41e3e3){console[_0x1f2d54(0x265)](_0x1f2d54(0x1e1),_0x41e3e3);throw new common_1[(_0x1f2d54(0x1f4))](_0x1f2d54(0x20b),common_1[_0x1f2d54(0x241)][_0x1f2d54(0x269)]);}}async['sleep'](_0x42889e){return new Promise(_0xd57b2a=>setTimeout(_0xd57b2a,_0x42889e));}['extractContent'](_0x5763d1){const _0x3ced0a=_0x6ba634,_0x8c9b8f=_0x5763d1['match'](/\*\*(.+?)\*\*/),_0x4345bb=_0x5763d1[_0x3ced0a(0x1fc)](/- Image #(\d+)/);if(!_0x8c9b8f||!_0x4345bb)return null;const _0xb1f885=_0x8c9b8f[0x1],_0x159af8=parseInt(_0x4345bb[0x1]);return{'prompt':_0xb1f885,'order':_0x159af8};}async[_0x6ba634(0x1e7)](){const _0x5723a8=_0x6ba634,_0x4e3b01=await this[_0x5723a8(0x274)]['getConfigs']([_0x5723a8(0x21f),_0x5723a8(0x1d8),_0x5723a8(0x271),_0x5723a8(0x20c),_0x5723a8(0x1ec),'mjVersion',_0x5723a8(0x20d),'mjRateLimit',_0x5723a8(0x208)]),_0x185322={'application_id':_0x4e3b01[_0x5723a8(0x1d8)],'guild_id':_0x4e3b01[_0x5723a8(0x271)],'channel_id':_0x4e3b01[_0x5723a8(0x20c)],'session_id':_0x4e3b01[_0x5723a8(0x1ec)],'version':_0x4e3b01[_0x5723a8(0x1ee)],'id':_0x4e3b01[_0x5723a8(0x21f)],'authorization':_0x4e3b01[_0x5723a8(0x20d)],'mjRateLimit':_0x4e3b01[_0x5723a8(0x27d)],'mjProxy':_0x4e3b01[_0x5723a8(0x208)]||0x0};return _0x185322;}[_0x6ba634(0x24f)](_0x41258e){const _0x3b9fc2=_0x6ba634,_0x5b9880=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x41258e[_0x3b9fc2(0x1ff)](_0x5b9880,'');}async[_0x6ba634(0x270)](_0x2386eb){const _0xd97c73=_0x6ba634,_0x4bd405=await this[_0xd97c73(0x1da)][_0xd97c73(0x1e3)]({'where':{'userId':_0x2386eb[_0xd97c73(0x209)]['id']}}),{id:_0x224ff7,balance:_0x49f502}=_0x4bd405;if(!_0x49f502||(_0x4bd405===null||_0x4bd405===void 0x0?void 0x0:_0x4bd405[_0xd97c73(0x1e5)])<0x1)throw new common_1[(_0xd97c73(0x1f4))](_0xd97c73(0x27e),common_1[_0xd97c73(0x241)]['BAD_REQUEST']);}async[_0x6ba634(0x220)](_0x32f0cb){const _0x3b53ef=_0x6ba634,{id:_0x520684,role:_0x2e0f44}=_0x32f0cb[_0x3b53ef(0x209)];!this[_0x3b53ef(0x20e)][_0x520684]?this[_0x3b53ef(0x20e)][_0x520684]=0x1:this[_0x3b53ef(0x20e)][_0x520684]=this[_0x3b53ef(0x20e)][_0x520684]+0x1,console['log'](_0x3b53ef(0x27b)+_0x520684+'使用的次数：',this[_0x3b53ef(0x20e)][_0x520684]);}async['checkRateLimit'](_0x596e5b){const _0x362f22=_0x6ba634,{id:_0x36aa4d,role:_0x27c089}=_0x596e5b[_0x362f22(0x209)];if([_0x362f22(0x259),'super'][_0x362f22(0x212)](_0x27c089))return!![];const {mjRateLimit:_0x32eb4a}=await this['getMjDefaultParams']();if(this[_0x362f22(0x231)][_0x36aa4d]){const _0x53c8a0=this[_0x362f22(0x231)][_0x36aa4d];if(_0x53c8a0>Date[_0x362f22(0x278)]()){console[_0x362f22(0x265)](_0x362f22(0x1ef)+_0x36aa4d+_0x362f22(0x221));throw new common_1[(_0x362f22(0x1f4))](_0x362f22(0x23b)+_0x32eb4a+_0x362f22(0x225),common_1[_0x362f22(0x241)][_0x362f22(0x269)]);}else this['rateLimits'][_0x36aa4d]=Date[_0x362f22(0x278)]()+Number(_0x32eb4a)*0x3e8;}else{const _0x37ca22=Date[_0x362f22(0x278)]();this[_0x362f22(0x231)][_0x36aa4d]=_0x37ca22+0x3e8*Number(_0x32eb4a);}}async[_0x6ba634(0x272)](_0x594cdb){const _0x102816=_0x6ba634;await this[_0x102816(0x1da)]['createQueryBuilder']()['update'](balance_entity_1['BalanceEntity'])['set']({'balance':()=>_0x102816(0x283)})[_0x102816(0x26e)](_0x102816(0x1e8),{'userId':_0x594cdb['user']['id']})['execute']();}async[_0x6ba634(0x232)](){return 0x1;}};function _0x416c(_0x5646e5,_0x2914fc){const _0x54ed44=_0x54ed();return _0x416c=function(_0x416cd4,_0x2cf0b9){_0x416cd4=_0x416cd4-0x1d3;let _0x1c4dec=_0x54ed44[_0x416cd4];return _0x1c4dec;},_0x416c(_0x5646e5,_0x2914fc);}MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x6ba634(0x21c)])(chatLog_entity_1[_0x6ba634(0x22c)])),__param(0x1,(0x0,typeorm_2[_0x6ba634(0x21c)])(balance_entity_1[_0x6ba634(0x253)])),__metadata(_0x6ba634(0x26c),[typeorm_1['Repository'],typeorm_1[_0x6ba634(0x1ed)],upload_service_1[_0x6ba634(0x1fb)],chatLog_service_1[_0x6ba634(0x22d)],globalConfig_service_1[_0x6ba634(0x216)],fanyi_service_1[_0x6ba634(0x1dd)],badwords_service_1[_0x6ba634(0x281)]])],MjService),exports['MjService']=MjService;