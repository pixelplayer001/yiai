'use strict';const _0x535aad=_0xdca8;(function(_0x1fe1fe,_0x4b989c){const _0x5700b7=_0xdca8,_0x343320=_0x1fe1fe();while(!![]){try{const _0x31989a=-parseInt(_0x5700b7(0x1a0))/0x1+parseInt(_0x5700b7(0x112))/0x2+-parseInt(_0x5700b7(0x190))/0x3*(parseInt(_0x5700b7(0x131))/0x4)+-parseInt(_0x5700b7(0x166))/0x5*(parseInt(_0x5700b7(0x17b))/0x6)+-parseInt(_0x5700b7(0x1a3))/0x7*(parseInt(_0x5700b7(0x10f))/0x8)+parseInt(_0x5700b7(0x17c))/0x9*(parseInt(_0x5700b7(0x122))/0xa)+-parseInt(_0x5700b7(0x184))/0xb*(-parseInt(_0x5700b7(0x1a1))/0xc);if(_0x31989a===_0x4b989c)break;else _0x343320['push'](_0x343320['shift']());}catch(_0x2a41da){_0x343320['push'](_0x343320['shift']());}}}(_0x2c4c,0x54e04));function _0x2c4c(){const _0x24057b=['使用的次数：','freeQueueUsers','绘制图片任务异常中断\x20队列-1:\x20','Like','http://172.247.48.137:8000/mj/list?channel_id=','upscaleSingleImg','https://discord.com/api/v9/channels/','放大当前图片失败','defineProperty','由于速率限制、当前普通用户限制为','变换图片任务结束\x20队列-1:\x20','查询绘制结果失败...','http://172.247.48.137:8000/mj/draw','mjRateLimit','mjNotSaveImg','网络连接失败，请稍后再试！','queueCount','findCurrentPromptResult','放大custom_id:\x20','当前用户\x20','checkBadWords','放大单张图片请求失败...','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','orderId','parse','变换当前图片失败','checkRateLimit','1312SslWMa','fanyiService','post','1189114cnQvHB','mjProxy','sendDrawInteractions','baiduFanyiSecret','BalanceEntity','绘画超时，请稍后再试！','findCurrentVariationImgResult','__esModule','ChatLogService','balanceEntity','存入图片完成:\x20','baiduFanyiAppId','response','开始请求用户','badwordsService','error:\x20','76810BvcRLG','mjGuildId','findOne','Injectable','mjApplicationId','mjChannelId','drawWorking','getConfigs','getOwnPropertyDescriptor','chatLogService','../upload/upload.service','https://discord.com/api/v9/interactions','pollForVariationResult','replace','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','18148ulJVLw','substring','UploadService','FanyiService','data','get','GlobalConfigService','imagine','本次放大图片的id:\x20','发送放大指令成功','default','createRandomUid','push','removeEmoji','绘画任务开始','mjSessionId','IsNull','saveChatLog','历史这些id已经被获取过了\x20不能拿了:\x20','match','当前图片没有绘画信息、无法放大!','object','metadata','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','stringify','getMjDefaultParams','axios:\x20','您当前暂无MJ绘画余额！！！','变换当前图片超时！','uploadFileFromUrl','sendSmInteractions','balance','/messages?limit=50','__param','../globalConfig/globalConfig.service','rateLimits','\x20请求过于频繁！','绘图指令完成','convertToEnglish','user','HttpStatus','max','sleep','function','uploadService','balance\x20-\x201','error','axios','checkFree','checkAuth','DeductionKey','components','ChatLogEntity','215VPWRoZ','includes','开始请求放大图片\x20队列+1:\x20','拿到了远程地址:\x20','本次绘图耗时:\x20','当前图片没有绘画信息、无法变体!','message_id','历史记录中不存在当前图片、请确认您放大的图片是否存在','../userBalance/balance.entity','filter','getClientIp','开始轮询单张变换图片结果','length','test','mjVersion','randomId:\x20','发送绘画指令结果:\x20','now','pollForUpscaleResult','decorate','mjDraw','71046vAFvEh','279wkwNdX','\x20次开始查询[变换图片]','chatLogEntity','HttpException','update','@nestjs/common','MjService','set','143BxpXPa','__metadata','mjAuthorization','BAD_REQUEST','find','log','enlargeWorking','PAINT_TYPE','当前用户','globalConfigService','admin','queryMessageList','186LDycxB','pollForResult','findCurrentEnlargeImgResult','url','map','message','开始请求变换图片\x20队列+1:\x20','Repository','enlarge','variationId','extractContent','绘画失败','当前图片已经放大过了、请勿重复放大!','deductBalance','prompt','../../common/constants/balance.constant','480904CaUZfW','1248588iRWSfC','mjId','24171cPGjKY','历史中存在当前图片、直接获取！','axios\x20get:\x20','design:paramtypes'];_0x2c4c=function(){return _0x24057b;};return _0x2c4c();}var __decorate=this&&this['__decorate']||function(_0x4a1e36,_0x3a5515,_0xc4ac4d,_0x901fd5){const _0x1f8ecf=_0xdca8;var _0x281160=arguments['length'],_0x3e10d0=_0x281160<0x3?_0x3a5515:_0x901fd5===null?_0x901fd5=Object[_0x1f8ecf(0x12a)](_0x3a5515,_0xc4ac4d):_0x901fd5,_0x16e5ed;if(typeof Reflect===_0x1f8ecf(0x146)&&typeof Reflect[_0x1f8ecf(0x179)]===_0x1f8ecf(0x15c))_0x3e10d0=Reflect[_0x1f8ecf(0x179)](_0x4a1e36,_0x3a5515,_0xc4ac4d,_0x901fd5);else{for(var _0x16ac64=_0x4a1e36[_0x1f8ecf(0x172)]-0x1;_0x16ac64>=0x0;_0x16ac64--)if(_0x16e5ed=_0x4a1e36[_0x16ac64])_0x3e10d0=(_0x281160<0x3?_0x16e5ed(_0x3e10d0):_0x281160>0x3?_0x16e5ed(_0x3a5515,_0xc4ac4d,_0x3e10d0):_0x16e5ed(_0x3a5515,_0xc4ac4d))||_0x3e10d0;}return _0x281160>0x3&&_0x3e10d0&&Object[_0x1f8ecf(0x1af)](_0x3a5515,_0xc4ac4d,_0x3e10d0),_0x3e10d0;},__metadata=this&&this[_0x535aad(0x185)]||function(_0x4903b0,_0x2ac951){const _0x49074e=_0x535aad;if(typeof Reflect===_0x49074e(0x146)&&typeof Reflect['metadata']===_0x49074e(0x15c))return Reflect[_0x49074e(0x147)](_0x4903b0,_0x2ac951);},__param=this&&this[_0x535aad(0x152)]||function(_0x4f3538,_0x240a95){return function(_0x94cb8c,_0xe0b69e){_0x240a95(_0x94cb8c,_0xe0b69e,_0x4f3538);};};function _0xdca8(_0x1d540a,_0x4a35d6){const _0x2c4c6d=_0x2c4c();return _0xdca8=function(_0xdca818,_0x5d95a1){_0xdca818=_0xdca818-0x109;let _0x59cc56=_0x2c4c6d[_0xdca818];return _0x59cc56;},_0xdca8(_0x1d540a,_0x4a35d6);}Object['defineProperty'](exports,_0x535aad(0x119),{'value':!![]}),exports[_0x535aad(0x182)]=void 0x0;const globalConfig_service_1=require(_0x535aad(0x153)),upload_service_1=require(_0x535aad(0x12c)),common_1=require(_0x535aad(0x181)),axios_1=require(_0x535aad(0x160)),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x535aad(0x19f)),utils_1=require('../../common/utils'),chatLog_entity_1=require('../chatLog/chatLog.entity'),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x535aad(0x16e)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x437393,_0x203367,_0x476b1d,_0x260b5f,_0x3495ad,_0xdee03c,_0x1ef6b0){const _0x2325df=_0x535aad;this['chatLogEntity']=_0x437393,this[_0x2325df(0x11b)]=_0x203367,this['uploadService']=_0x476b1d,this['chatLogService']=_0x260b5f,this[_0x2325df(0x18d)]=_0x3495ad,this[_0x2325df(0x110)]=_0xdee03c,this[_0x2325df(0x120)]=_0x1ef6b0,this[_0x2325df(0x154)]={},this[_0x2325df(0x128)]=[],this[_0x2325df(0x18a)]=[],this[_0x2325df(0x1b7)]=0x0,this[_0x2325df(0x1a8)]={};}async[_0x535aad(0x17a)](_0x432807){const _0x9390e9=_0x535aad,{jobId:_0x14bf3a,prompt:_0x329986,startTime:_0x30c078,userId:_0x5deca7}=_0x432807;return console[_0x9390e9(0x189)](_0x9390e9(0x13f),'mjservice'),await new Promise(_0x46e428=>setTimeout(_0x46e428,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x375ad8,_0x2d9ad3){const _0x3bbb31=_0x535aad;await this[_0x3bbb31(0x162)](_0x2d9ad3),await this[_0x3bbb31(0x120)][_0x3bbb31(0x1bb)](_0x375ad8[_0x3bbb31(0x19e)],_0x2d9ad3[_0x3bbb31(0x158)]['id']);const _0x37d967=_0x375ad8['prompt'];let _0x5c893e=_0x375ad8[_0x3bbb31(0x19e)];const {baiduFanyiAppId:_0x38fd6f,baiduFanyiSecret:_0x1ed813}=await this['globalConfigService'][_0x3bbb31(0x129)]([_0x3bbb31(0x11d),_0x3bbb31(0x115)]);_0x38fd6f&&_0x1ed813&&(_0x5c893e=await this[_0x3bbb31(0x110)][_0x3bbb31(0x157)](_0x37d967));const _0xf3c08a='['+(0x0,utils_1[_0x3bbb31(0x13c)])()+']',_0xa48dc9=_0xf3c08a+'\x20'+_0x5c893e;console['log'](_0x3bbb31(0x175),_0xf3c08a),console[_0x3bbb31(0x189)]('prompt\x20-------->\x20\x20',_0xa48dc9);const _0x8dec33=this['drawWorking'][_0x3bbb31(0x188)](_0x181fdb=>_0x181fdb[_0x3bbb31(0x167)](_0x375ad8[_0x3bbb31(0x19e)]));if(_0x8dec33)throw new common_1['HttpException']('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1[_0x3bbb31(0x159)][_0x3bbb31(0x187)]);if(this['queueCount']>=0x3)throw new common_1[(_0x3bbb31(0x17f))](_0x3bbb31(0x10a),common_1[_0x3bbb31(0x159)]['BAD_REQUEST']);await this[_0x3bbb31(0x10e)](_0x2d9ad3),this['queueCount']++,console[_0x3bbb31(0x189)](_0x3bbb31(0x11f)+_0x2d9ad3[_0x3bbb31(0x158)]['id']+'\x20队列+1:\x20',this[_0x3bbb31(0x1b7)]);try{const _0x566d2d=await this[_0x3bbb31(0x17e)][_0x3bbb31(0x188)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0xa48dc9+'%')}}),_0x5ed99f=_0x566d2d['map'](_0x370420=>_0x370420[_0x3bbb31(0x16c)]);this[_0x3bbb31(0x128)][_0x3bbb31(0x13d)](_0xa48dc9);let _0x56d5a3;const _0x3654be=await this[_0x3bbb31(0x114)](_0xa48dc9,_0x5ed99f,_0xf3c08a);_0x3654be?(console['log'](_0x3bbb31(0x1a4)),_0x56d5a3=_0x3654be):_0x56d5a3=await this[_0x3bbb31(0x191)](_0xa48dc9,_0x5ed99f,_0xf3c08a);this[_0x3bbb31(0x1b7)]--,this[_0x3bbb31(0x1b7)]<0x0&&(this['queueCount']=0x0),console[_0x3bbb31(0x189)]('绘制图片任务结束\x20队列-1:\x20',this[_0x3bbb31(0x1b7)]);const {id:_0x410346,content:_0x37908e,channel_id:_0x528d01,attachments:attachments=[],timestamp:_0x36fa97}=_0x56d5a3;if(!attachments[_0x3bbb31(0x172)]||!attachments[0x0][_0x3bbb31(0x193)])throw new common_1[(_0x3bbb31(0x17f))](_0x3bbb31(0x19b),common_1['HttpStatus'][_0x3bbb31(0x187)]);const {filename:_0x46095f,url:_0x40b5d0,width:_0x213823,height:_0x393941,size:_0x33da62}=attachments[0x0];console['log'](_0x3bbb31(0x169),_0x40b5d0);const _0x1a32f3=this[_0x3bbb31(0x18d)][_0x3bbb31(0x129)]([_0x3bbb31(0x1b5)]);let _0x392a3c='';(!Number(_0x1a32f3)||Number(_0x1a32f3)===0x0)&&(_0x392a3c=await this['uploadService'][_0x3bbb31(0x14e)]({'filename':_0x46095f,'url':_0x40b5d0}),console[_0x3bbb31(0x189)](_0x3bbb31(0x11c),_0x392a3c));const _0x40a463={'curIp':(0x0,utils_1['getClientIp'])(_0x2d9ad3),'userId':_0x2d9ad3[_0x3bbb31(0x158)]['id'],'type':balance_constant_1[_0x3bbb31(0x163)][_0x3bbb31(0x18b)],'prompt':_0xa48dc9,'answer':_0x392a3c,'model':'mj','extend':this['removeEmoji'](JSON[_0x3bbb31(0x149)](_0x56d5a3)),'message_id':_0x410346,'variationId':_0x410346,'upscaleId':_0x410346,'group':0x1,'isSaveImg':!Number(_0x1a32f3)||Number(_0x1a32f3)===0x0,'fileInfo':JSON[_0x3bbb31(0x149)]({'width':_0x213823,'height':_0x393941,'size':_0x33da62,'filename':_0x46095f,'cosUrl':_0x392a3c})};return await this[_0x3bbb31(0x12b)][_0x3bbb31(0x142)](_0x40a463),await this[_0x3bbb31(0x19d)](_0x2d9ad3),this[_0x3bbb31(0x128)]=this[_0x3bbb31(0x128)]['filter'](_0xefe3e6=>_0xefe3e6!==_0x375ad8['prompt']),_0x392a3c;}catch(_0x108f5){this[_0x3bbb31(0x1b7)]--,this['queueCount']<0x0&&(this[_0x3bbb31(0x1b7)]=0x0),console[_0x3bbb31(0x189)](_0x3bbb31(0x1a9),this[_0x3bbb31(0x1b7)]),this[_0x3bbb31(0x128)]=this[_0x3bbb31(0x128)][_0x3bbb31(0x16f)](_0x372615=>_0x372615!==_0x375ad8[_0x3bbb31(0x19e)]);throw new common_1[(_0x3bbb31(0x17f))](_0x108f5['response'],common_1[_0x3bbb31(0x159)][_0x3bbb31(0x187)]);}}async[_0x535aad(0x1ac)](_0x1fd5ff,_0x1bef37){const _0x1f7182=_0x535aad;if(this[_0x1f7182(0x1b7)]>=0x3)throw new common_1['HttpException'](_0x1f7182(0x10a),common_1[_0x1f7182(0x159)][_0x1f7182(0x187)]);this[_0x1f7182(0x1b7)]++,console[_0x1f7182(0x189)]('用户'+_0x1bef37[_0x1f7182(0x158)]['id']+_0x1f7182(0x168),this[_0x1f7182(0x1b7)]);const {message_id:_0x13a6d4,orderId:_0x2beb53}=_0x1fd5ff;try{const _0x105ab0=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x13a6d4}});if(!_0x105ab0)throw new common_1[(_0x1f7182(0x17f))](_0x1f7182(0x16d),common_1[_0x1f7182(0x159)]['BAD_REQUEST']);const _0xe22ed2=await this[_0x1f7182(0x17e)][_0x1f7182(0x124)]({'where':{'upscaleId':_0x13a6d4,'action':_0x1f7182(0x198),'orderId':_0x2beb53}});if(_0xe22ed2)throw new common_1['HttpException'](_0x1f7182(0x19c),common_1[_0x1f7182(0x159)]['BAD_REQUEST']);const {prompt:_0x860933,extend:_0x33efdd}=_0x105ab0;let _0x2bbb50=null;try{_0x2bbb50=JSON[_0x1f7182(0x10c)](_0x33efdd);}catch(_0x474190){_0x2bbb50=[];}const {components:components=[]}=_0x2bbb50;if(!components[_0x1f7182(0x172)])throw new common_1[(_0x1f7182(0x17f))](_0x1f7182(0x145),common_1['HttpStatus'][_0x1f7182(0x187)]);const _0x882f04=components[0x0][_0x1f7182(0x164)][_0x2beb53-0x1],{custom_id:_0x1584a3}=_0x882f04;console[_0x1f7182(0x189)](_0x1f7182(0x1b9),_0x1584a3);const _0x2a1b1e={'message_id':_0x13a6d4,'custom_id':_0x1584a3,'prompt':_0x860933,'orderId':_0x2beb53};await this[_0x1f7182(0x14f)](_0x2a1b1e),console[_0x1f7182(0x189)](_0x1f7182(0x13a));const _0x596b84=await this[_0x1f7182(0x17e)][_0x1f7182(0x188)]({'where':{'prompt':(0x0,typeorm_1[_0x1f7182(0x1aa)])('%'+_0x860933+'%')}}),_0xf7c7df=_0x596b84['map'](_0x2809c9=>_0x2809c9[_0x1f7182(0x16c)]);console[_0x1f7182(0x189)](_0x1f7182(0x143),_0xf7c7df);const _0x49f195=await this[_0x1f7182(0x178)](_0x2a1b1e,_0xf7c7df);this[_0x1f7182(0x1b7)]--,this['queueCount']<0x0&&(this[_0x1f7182(0x1b7)]=0x0),console[_0x1f7182(0x189)]('放大图片任务结束\x20队列-1:\x20',this[_0x1f7182(0x1b7)]);const {id:_0x59c245,content:_0x1b0c32,channel_id:_0x3850e5,attachments:attachments=[],timestamp:_0x4e4e78}=_0x49f195;if(!attachments['length']||!attachments[0x0][_0x1f7182(0x193)])throw new common_1['HttpException'](_0x1f7182(0x1ae),common_1[_0x1f7182(0x159)][_0x1f7182(0x187)]);const {filename:_0x31936b,url:_0xf377e3,width:_0x421ece,height:_0x25f593,size:_0x2c8d64}=attachments[0x0],_0x3ca9b6=this[_0x1f7182(0x18d)]['getConfigs']([_0x1f7182(0x1b5)]);let _0x9aae90='';(!Number(_0x3ca9b6)||Number(_0x3ca9b6)===0x0)&&(_0x9aae90=await this[_0x1f7182(0x15d)][_0x1f7182(0x14e)]({'filename':_0x31936b,'url':_0xf377e3}),console[_0x1f7182(0x189)]('存入图片完成:\x20',_0x9aae90));const _0x868826={'curIp':(0x0,utils_1[_0x1f7182(0x170)])(_0x1bef37),'userId':_0x1bef37['user']['id'],'type':balance_constant_1[_0x1f7182(0x163)][_0x1f7182(0x18b)],'prompt':_0x860933,'answer':_0x9aae90,'model':'mj','extend':this[_0x1f7182(0x13e)](JSON[_0x1f7182(0x149)](_0x49f195)),'message_id':_0x13a6d4,'upscaleId':_0x59c245,'variationId':_0x59c245,'action':_0x1f7182(0x198),'orderId':_0x2a1b1e[_0x1f7182(0x10b)],'isSaveImg':!Number(_0x3ca9b6)||Number(_0x3ca9b6)===0x0,'fileInfo':JSON[_0x1f7182(0x149)]({'width':_0x421ece,'height':_0x25f593,'size':_0x2c8d64,'filename':_0x31936b,'cosUrl':_0x9aae90})};return await this[_0x1f7182(0x12b)][_0x1f7182(0x142)](_0x868826),_0x9aae90;}catch(_0x31060a){console[_0x1f7182(0x189)](_0x1f7182(0x121),_0x31060a),this[_0x1f7182(0x1b7)]--,this[_0x1f7182(0x1b7)]<0x0&&(this['queueCount']=0x0),console[_0x1f7182(0x189)]('放大图片任务异常中断\x20队列-1:\x20',this[_0x1f7182(0x1b7)]);throw new common_1[(_0x1f7182(0x17f))](_0x31060a[_0x1f7182(0x11e)],common_1[_0x1f7182(0x159)]['BAD_REQUEST']);}}async['variationSingleImg'](_0x374780,_0x2d4a73){const _0x583915=_0x535aad;if(this['queueCount']>=0x3)throw new common_1['HttpException'](_0x583915(0x10a),common_1[_0x583915(0x159)]['BAD_REQUEST']);await this['checkAuth'](_0x2d4a73),await this['checkRateLimit'](_0x2d4a73),this[_0x583915(0x1b7)]++,console['log']('用户'+_0x2d4a73[_0x583915(0x158)]['id']+_0x583915(0x196),this[_0x583915(0x1b7)]);const {message_id:_0x51e8b6,orderId:_0x88b0ea}=_0x374780;try{const _0x421e35=await this[_0x583915(0x17e)][_0x583915(0x124)]({'where':{'message_id':_0x51e8b6}});if(!_0x421e35)throw new common_1['HttpException'](_0x583915(0x148),common_1['HttpStatus'][_0x583915(0x187)]);const {prompt:_0x500ac2,extend:_0x23e1de}=_0x421e35;let _0x21154e=null;try{_0x21154e=JSON[_0x583915(0x10c)](_0x23e1de);}catch(_0x380948){_0x21154e=[];}const {components:components=[]}=_0x21154e;if(!components['length'])throw new common_1[(_0x583915(0x17f))](_0x583915(0x16b),common_1['HttpStatus']['BAD_REQUEST']);const _0xe60ee9=components[0x1]['components'][_0x88b0ea-0x1],{custom_id:_0xd77a07}=_0xe60ee9,_0x189964=await this[_0x583915(0x17e)][_0x583915(0x188)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x583915(0x141)])()),'prompt':(0x0,typeorm_1[_0x583915(0x1aa)])('%'+_0x500ac2+'%')}}),_0x197c9c=_0x189964[_0x583915(0x194)](_0x1859d8=>_0x1859d8[_0x583915(0x199)]),_0x150a77={'message_id':_0x51e8b6,'custom_id':_0xd77a07,'prompt':_0x500ac2,'orderId':_0x88b0ea};await this[_0x583915(0x14f)](_0x150a77);const _0x2228e1=await this[_0x583915(0x12e)](_0x150a77,_0x197c9c);this[_0x583915(0x1b7)]--,this[_0x583915(0x1b7)]<0x0&&(this['queueCount']=0x0),console[_0x583915(0x189)](_0x583915(0x1b1),this['queueCount']);const {id:_0x48e78c,content:_0x2f4a86,channel_id:_0x4ee2dc,attachments:attachments=[],timestamp:_0x8bf1b0}=_0x2228e1;if(!attachments['length']||!attachments[0x0][_0x583915(0x193)])throw new common_1[(_0x583915(0x17f))](_0x583915(0x10d),common_1[_0x583915(0x159)]['BAD_REQUEST']);const {filename:_0x3da7fc,url:_0xc25a27,width:_0x3e66ea,height:_0x168961,size:_0x14c848}=attachments[0x0],_0xbba3c5=this['globalConfigService'][_0x583915(0x129)]([_0x583915(0x1b5)]);let _0x3019de='';(!Number(_0xbba3c5)||Number(_0xbba3c5)===0x0)&&(_0x3019de=await this[_0x583915(0x15d)][_0x583915(0x14e)]({'filename':_0x3da7fc,'url':_0xc25a27}),console[_0x583915(0x189)]('存入图片完成:\x20',_0x3019de));const _0x3dfa94={'curIp':(0x0,utils_1[_0x583915(0x170)])(_0x2d4a73),'userId':_0x2d4a73['user']['id'],'type':balance_constant_1[_0x583915(0x163)]['PAINT_TYPE'],'prompt':_0x500ac2,'answer':_0x3019de,'model':'mj','group':0x1,'extend':this[_0x583915(0x13e)](JSON[_0x583915(0x149)](_0x2228e1)),'message_id':_0x48e78c,'upscaleId':_0x48e78c,'variationId':_0x48e78c,'action':_0x583915(0x198),'orderId':_0x150a77[_0x583915(0x10b)],'isSaveImg':!Number(_0xbba3c5)||Number(_0xbba3c5)===0x0,'fileInfo':JSON[_0x583915(0x149)]({'width':_0x3e66ea,'height':_0x168961,'size':_0x14c848,'filename':_0x3da7fc,'cosUrl':_0x3019de})};return await this[_0x583915(0x12b)][_0x583915(0x142)](_0x3dfa94),_0x3019de;}catch(_0x3d59e3){console['log'](_0x583915(0x121),_0x3d59e3),this[_0x583915(0x1b7)]--,this['queueCount']<0x0&&(this['queueCount']=0x0),console['log']('变化图片任务异常中断\x20队列-1:\x20',this[_0x583915(0x1b7)]);throw new common_1[(_0x583915(0x17f))](_0x3d59e3['response'],common_1['HttpStatus']['BAD_REQUEST']);}}async['sendSmInteractions'](_0x4bef9f){const _0x2bb012=_0x535aad,{message_id:_0x2f76ac,custom_id:_0x425209}=_0x4bef9f,{application_id:_0xae6efd,guild_id:_0x3463b0,channel_id:_0x164fe7,session_id:_0x3ab79e,version:_0x237823,id:_0x560fb8,authorization:_0x149146,mjProxy:_0xedb474}=await this['getMjDefaultParams'](),_0x2c99b0=_0xedb474==0x1?_0x2bb012(0x1b3):_0x2bb012(0x12d),_0x2263d9={'authorization':_0x149146},_0x1a71ad={'type':0x3,'guild_id':_0x3463b0,'channel_id':_0x164fe7,'message_flags':0x0,'message_id':_0x2f76ac,'application_id':_0xae6efd,'session_id':_0x3ab79e,'data':{'component_type':0x2,'custom_id':_0x425209}};try{await axios_1[_0x2bb012(0x13b)][_0x2bb012(0x111)](_0x2c99b0,_0x1a71ad,{'headers':_0x2263d9}),console[_0x2bb012(0x189)](_0x2bb012(0x156));}catch(_0x3f7255){console[_0x2bb012(0x189)]('error:\x20',_0x3f7255);throw new common_1[(_0x2bb012(0x17f))](_0x2bb012(0x109),common_1[_0x2bb012(0x159)]['BAD_REQUEST']);}}async[_0x535aad(0x178)](_0x3d273e,_0x28ccf7){const _0x1d4442=_0x535aad,{message_id:_0x160748,custom_id:_0xd37a86,prompt:_0x5b07f1,orderId:_0x15306f}=_0x3d273e;let _0x3d095b=null,_0x23ac30=0x0;while(!_0x3d095b&&_0x23ac30<0xa){try{const _0x332e35=Date[_0x1d4442(0x177)](),_0x476f88=await this[_0x1d4442(0x18f)]();console[_0x1d4442(0x189)]('第\x20'+(_0x23ac30+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x476f88[_0x1d4442(0x172)]);_0x476f88&&_0x476f88[_0x1d4442(0x172)]&&(_0x3d095b=await this[_0x1d4442(0x192)](_0x476f88,_0x3d273e,_0x28ccf7));const _0x21aec1=Date[_0x1d4442(0x177)]()-_0x332e35,_0x5c776f=0xbb8;await this[_0x1d4442(0x15b)](Math[_0x1d4442(0x15a)](_0x5c776f-_0x21aec1,0x0)),_0x23ac30++;}catch(_0x1ebe2){console[_0x1d4442(0x15f)]('查询期间出现错误：'+_0x1ebe2[_0x1d4442(0x195)]);}}return _0x3d095b;}async[_0x535aad(0x12e)](_0x4f166c,_0x5b6cc7){const _0x3e580a=_0x535aad,{message_id:_0x4671ca,custom_id:_0x14c8fa,prompt:_0x4fcee3,orderId:_0x3a18f6}=_0x4f166c;console['log'](_0x3e580a(0x171));let _0x236976=null,_0x67a290=0x0;while(!_0x236976&&_0x67a290<0xa){try{console['log']('第\x20'+(_0x67a290+0x1)+_0x3e580a(0x17d));const _0xa74736=Date[_0x3e580a(0x177)](),_0x5a075d=await this[_0x3e580a(0x18f)]();_0x5a075d&&_0x5a075d[_0x3e580a(0x172)]&&(_0x236976=await this['findCurrentVariationImgResult'](_0x5a075d,_0x4f166c,_0x5b6cc7));const _0x2b1ea3=Date['now']()-_0xa74736,_0x17f867=0x1f40;await this[_0x3e580a(0x15b)](Math[_0x3e580a(0x15a)](_0x17f867-_0x2b1ea3,0x0)),_0x67a290++;}catch(_0x2f5ad1){console['error']('查询期间出现错误：'+_0x2f5ad1['message']);}}if(!_0x236976)throw new common_1['HttpException'](_0x3e580a(0x14d),common_1[_0x3e580a(0x159)][_0x3e580a(0x187)]);return _0x236976;}async[_0x535aad(0x192)](_0xe3431b,_0x24fdfa,_0x2f3d1b){const _0x9aafc9=_0x535aad,{message_id:_0x3cacea,custom_id:_0x572f48,prompt:_0x247da6,orderId:_0x375299}=_0x24fdfa,_0x57f99c=_0x247da6[_0x9aafc9(0x132)](0x0,0xc);console['log'](_0x9aafc9(0x139),_0x57f99c);const _0x1ab5b2=_0xe3431b[_0x9aafc9(0x188)](_0x3fe18c=>{const _0x59b531=_0x9aafc9,{content:_0x570e35}=_0x3fe18c;if(!this['extractContent'](_0x570e35))return![];const {prompt:_0x4e8b62,order:_0x1945b8}=this[_0x59b531(0x19a)](_0x570e35);return _0x4e8b62[_0x59b531(0x167)](_0x57f99c)&&_0x24fdfa[_0x59b531(0x10b)]===_0x1945b8&&!_0x2f3d1b['includes'](_0x3fe18c['id']);});return _0x1ab5b2;}async[_0x535aad(0x118)](_0x137fa3,_0x1df1fb,_0x3edf6e){const _0x990cca=_0x535aad,{message_id:_0x53678a,custom_id:_0x95dade,prompt:_0x58904c,orderId:_0x1f0f5a}=_0x1df1fb,_0xcbe456=_0x58904c['substring'](0x0,0xc),_0xa8af51=_0x137fa3[_0x990cca(0x188)](_0x10a257=>{const _0x100866=_0x990cca,{content:_0x151cad}=_0x10a257,_0x3cd15f=_0x151cad[_0x100866(0x144)](/\*\*(.+?)\*\*/),_0x165058=_0x3cd15f?_0x3cd15f[0x1]:'';if(!_0x165058)return![];return _0x165058[_0x100866(0x167)](_0xcbe456)&&!_0x3edf6e[_0x100866(0x167)](_0x10a257['id']);});return _0xa8af51;}async[_0x535aad(0x114)](_0x4a35bb,_0x41ef8e,_0x599cd7){const _0x1c9f50=_0x535aad,_0x2c5169=await this[_0x1c9f50(0x18f)](),_0x745506=await this[_0x1c9f50(0x1b8)](_0x2c5169,_0x599cd7,_0x41ef8e);if(_0x745506)return console[_0x1c9f50(0x189)]('有历史信息之间返回:\x20',_0x745506),_0x745506;const {application_id:_0x381820,guild_id:_0x2e2d0d,channel_id:_0x52aad6,session_id:_0x477bd0,version:_0x3e26eb,id:_0x445657,authorization:_0x13c50a,mjProxy:_0x462e60}=await this['getMjDefaultParams'](),_0x31e8ef={'type':0x2,'application_id':_0x381820,'guild_id':_0x2e2d0d,'channel_id':_0x52aad6,'session_id':_0x477bd0,'data':{'version':_0x3e26eb,'id':_0x445657,'name':_0x1c9f50(0x138),'type':0x1,'options':[{'type':0x3,'name':_0x1c9f50(0x19e),'value':_0x4a35bb}],'attachments':[]}};try{const _0x1b4d61=_0x462e60==0x1?_0x1c9f50(0x1b3):_0x1c9f50(0x12d),_0x41a04f={'authorization':_0x13c50a},_0x56e8a1=await axios_1['default'][_0x1c9f50(0x111)](_0x1b4d61,_0x31e8ef,{'headers':_0x41a04f});return console['log'](_0x1c9f50(0x176),_0x56e8a1['data']),![];}catch(_0x83d579){console[_0x1c9f50(0x189)](_0x1c9f50(0x14b),_0x83d579);throw new common_1[(_0x1c9f50(0x17f))](_0x1c9f50(0x130),common_1[_0x1c9f50(0x159)][_0x1c9f50(0x187)]);}}async[_0x535aad(0x191)](_0x2e3fce,_0x2273ab,_0x479fe9){const _0x496931=_0x535aad;console[_0x496931(0x189)]('开始查询绘画结果轮询');const _0xf0a1f2=Date['now']();try{const _0x3e33e9=0xd,_0x12690f=0x2ee0,_0x2663f6=0x1388,_0x2e59bb=0x3c*0x3e8;let _0x4f6dfe=0x0,_0x37ebcd=![],_0x56915a=null;while(!_0x56915a&&_0x4f6dfe<_0x3e33e9){console[_0x496931(0x189)]('第\x20'+(_0x4f6dfe+0x1)+'\x20次开始查询');Date[_0x496931(0x177)]()-_0xf0a1f2>=_0x2e59bb&&(_0x37ebcd=!![]);await this[_0x496931(0x15b)](_0x37ebcd?_0x2663f6:_0x12690f);const _0x1dc727=await this['queryMessageList']();_0x56915a=await this[_0x496931(0x1b8)](_0x1dc727,_0x479fe9,_0x2273ab),_0x4f6dfe++;}if(!_0x56915a)throw new common_1['HttpException'](_0x496931(0x117),common_1['HttpStatus'][_0x496931(0x187)]);const _0x4d8092=Date['now']();return console[_0x496931(0x189)](_0x496931(0x16a)+Math['floor']((_0x4d8092-_0xf0a1f2)/0x3e8)+'\x20S'),_0x56915a;}catch(_0x25a8bd){console[_0x496931(0x15f)](_0x25a8bd[_0x496931(0x195)]);throw new common_1['HttpException'](_0x496931(0x1b6),common_1[_0x496931(0x159)]['INTERNAL_SERVER_ERROR']);}}async[_0x535aad(0x1b8)](_0x5dc978,_0x13f830,_0x2e790c){const _0x40661f=_0x535aad;if(!_0x5dc978||!_0x5dc978[_0x40661f(0x172)])return;console[_0x40661f(0x189)]('本次比对的随机ID:\x20',_0x13f830);const _0x16b319=_0x5dc978[_0x40661f(0x188)](_0xca8669=>{const _0x4661e2=_0x40661f,{attachments:attachments=[],content:_0x16e261,edited_timestamp:_0x95e415}=_0xca8669;return _0x16e261[_0x4661e2(0x167)](_0x13f830)&&attachments[_0x4661e2(0x172)]>0x0&&!_0x95e415&&!_0x2e790c[_0x4661e2(0x167)](_0xca8669['id']);});return _0x16b319||null;}async[_0x535aad(0x18f)](){const _0x441af3=_0x535aad;try{const {application_id:_0x32dba7,guild_id:_0x420bc6,channel_id:_0x2fbbd3,session_id:_0xa2bb90,version:_0x2fd001,id:_0x2517df,authorization:_0x342dc4,mjProxy:_0x10660e}=await this['getMjDefaultParams'](),_0x3ca1f6=_0x10660e==0x1?_0x441af3(0x1ab)+_0x2fbbd3:_0x441af3(0x1ad)+_0x2fbbd3+_0x441af3(0x151),_0x3b212c={'authorization':_0x342dc4},_0x4dbbe3=await axios_1[_0x441af3(0x13b)][_0x441af3(0x136)](_0x3ca1f6,{'headers':_0x3b212c});return _0x4dbbe3[_0x441af3(0x135)];}catch(_0x1941e5){console[_0x441af3(0x189)](_0x441af3(0x1a5),_0x1941e5);throw new common_1[(_0x441af3(0x17f))](_0x441af3(0x1b2),common_1[_0x441af3(0x159)][_0x441af3(0x187)]);}}async[_0x535aad(0x15b)](_0x24b7bd){return new Promise(_0x477f8b=>setTimeout(_0x477f8b,_0x24b7bd));}[_0x535aad(0x19a)](_0x3d5bd3){const _0x50fad8=_0x535aad,_0x4650ec=_0x3d5bd3[_0x50fad8(0x144)](/\*\*(.+?)\*\*/),_0x27bbb7=_0x3d5bd3[_0x50fad8(0x144)](/- Image #(\d+)/);if(!_0x4650ec||!_0x27bbb7)return null;const _0x57f37b=_0x4650ec[0x1],_0x174194=parseInt(_0x27bbb7[0x1]);return{'prompt':_0x57f37b,'order':_0x174194};}async[_0x535aad(0x14a)](){const _0x113cd3=_0x535aad,_0x388980=await this['globalConfigService'][_0x113cd3(0x129)](['mjId',_0x113cd3(0x126),_0x113cd3(0x123),'mjChannelId',_0x113cd3(0x140),'mjVersion',_0x113cd3(0x186),_0x113cd3(0x1b4),_0x113cd3(0x113)]),_0x544cec={'application_id':_0x388980['mjApplicationId'],'guild_id':_0x388980[_0x113cd3(0x123)],'channel_id':_0x388980[_0x113cd3(0x127)],'session_id':_0x388980[_0x113cd3(0x140)],'version':_0x388980[_0x113cd3(0x174)],'id':_0x388980[_0x113cd3(0x1a2)],'authorization':_0x388980['mjAuthorization'],'mjRateLimit':_0x388980['mjRateLimit'],'mjProxy':_0x388980[_0x113cd3(0x113)]||0x0};return _0x544cec;}[_0x535aad(0x13e)](_0x1efc95){const _0x547964=_0x535aad,_0x55a065=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x1efc95[_0x547964(0x12f)](_0x55a065,'');}async[_0x535aad(0x162)](_0x3e01f1){const _0x1f50db=_0x535aad,_0x503d05=await this[_0x1f50db(0x11b)][_0x1f50db(0x124)]({'where':{'userId':_0x3e01f1[_0x1f50db(0x158)]['id']}}),{id:_0x17d166,balance:_0x3a4962}=_0x503d05;if(!_0x3a4962||(_0x503d05===null||_0x503d05===void 0x0?void 0x0:_0x503d05[_0x1f50db(0x150)])<0x1)throw new common_1[(_0x1f50db(0x17f))](_0x1f50db(0x14c),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x535aad(0x161)](_0x2f38d4){const _0x596856=_0x535aad,{id:_0x24a2e9,role:_0x66d6fe}=_0x2f38d4[_0x596856(0x158)];!this[_0x596856(0x1a8)][_0x24a2e9]?this[_0x596856(0x1a8)][_0x24a2e9]=0x1:this[_0x596856(0x1a8)][_0x24a2e9]=this[_0x596856(0x1a8)][_0x24a2e9]+0x1,console[_0x596856(0x189)](_0x596856(0x18c)+_0x24a2e9+_0x596856(0x1a7),this['freeQueueUsers'][_0x24a2e9]);}async[_0x535aad(0x10e)](_0x1a7d88){const _0x25739a=_0x535aad,{id:_0x388c71,role:_0x20d5b1}=_0x1a7d88[_0x25739a(0x158)];if([_0x25739a(0x18e),'super']['includes'](_0x20d5b1))return!![];const {mjRateLimit:_0x5e79e9}=await this[_0x25739a(0x14a)]();if(this['rateLimits'][_0x388c71]){const _0x78f4fb=this[_0x25739a(0x154)][_0x388c71];if(_0x78f4fb>Date[_0x25739a(0x177)]()){console[_0x25739a(0x189)](_0x25739a(0x1ba)+_0x388c71+_0x25739a(0x155));throw new common_1['HttpException'](_0x25739a(0x1b0)+_0x5e79e9+'秒请求一次、请合理使用！',common_1[_0x25739a(0x159)][_0x25739a(0x187)]);}else this[_0x25739a(0x154)][_0x388c71]=Date[_0x25739a(0x177)]()+Number(_0x5e79e9)*0x3e8;}else{const _0x193345=Date[_0x25739a(0x177)]();this['rateLimits'][_0x388c71]=_0x193345+0x3e8*Number(_0x5e79e9);}}async[_0x535aad(0x19d)](_0x2b84e7){const _0x564957=_0x535aad;await this[_0x564957(0x11b)]['createQueryBuilder']()[_0x564957(0x180)](balance_entity_1[_0x564957(0x116)])[_0x564957(0x183)]({'balance':()=>_0x564957(0x15e)})['where']('userId\x20=\x20:userId',{'userId':_0x2b84e7[_0x564957(0x158)]['id']})['execute']();}async[_0x535aad(0x173)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x535aad(0x125)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x535aad(0x165)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0x535aad(0x116)])),__metadata(_0x535aad(0x1a6),[typeorm_1[_0x535aad(0x197)],typeorm_1[_0x535aad(0x197)],upload_service_1[_0x535aad(0x133)],chatLog_service_1[_0x535aad(0x11a)],globalConfig_service_1[_0x535aad(0x137)],fanyi_service_1[_0x535aad(0x134)],badwords_service_1['BadwordsService']])],MjService),exports[_0x535aad(0x182)]=MjService;