'use strict';function _0x2d98(){const _0x214a7b=['\x20欠费或被官方封禁导致不可用，已被系统自动锁定','modelName','secret','length','36967570ZdVlje','40OxsWKL','log','push','useToken\x20+\x20','findAndCount','__decorate','keyType','find','keyList','keys','6189820biSiyy','modelsList','hideString','Repository','lockKey','super','design:paramtypes','where','defineProperty','affected','execute','user','11YllXdv','val','modelMaps','object','values','modelsTypeEntity','status','282759yeURUp','modelTypes','492314COfMzc','createQueryBuilder','InjectRepository','decorate','error','__param','ModelsTypeEntity','Injectable','keyPoolIndexMap','ModelsEntity','typeorm','__esModule','delModel','setModelType','getRandomDrawKey','parse','HttpException','model','parse\x20error:\x20','../../common/constants/status.constant','236JVzBXI','129745VoTUFL','Like','HttpStatus','../../common/utils','id\x20=\x20:id','useCount\x20+\x201','Logger','key','reduce','sort','__metadata','BAD_REQUEST','keyStatus','keyPoolMap','2894103uRtoIl','map','saveUseLog','forEach','getOwnPropertyDescriptor','@nestjs/common','queryModelType','findOne','当前未指定特殊模型KEY、前往后台模型池设置吧！','@nestjs/typeorm','缺失必要参数！','update','error:\x20','755694oMGIlY','9NEnByU','save','initCalcKey','getBaseConfig','metadata','function','setModel','ASC','modelOrder','ModelsMapCn','delModelType','delete','ModelsService','modelsEntity','key:\x20','./modelType.entity'];_0x2d98=function(){return _0x214a7b;};return _0x2d98();}const _0x4233ce=_0x1e27;(function(_0x1eadbf,_0x48dc8b){const _0x4023fc=_0x1e27,_0x55a8d0=_0x1eadbf();while(!![]){try{const _0x94135c=-parseInt(_0x4023fc(0x8e))/0x1+parseInt(_0x4023fc(0x90))/0x2*(parseInt(_0x4023fc(0xc1))/0x3)+parseInt(_0x4023fc(0xa4))/0x4*(parseInt(_0x4023fc(0xa5))/0x5)+parseInt(_0x4023fc(0xc0))/0x6+parseInt(_0x4023fc(0x7b))/0x7+parseInt(_0x4023fc(0x71))/0x8*(parseInt(_0x4023fc(0xb3))/0x9)+-parseInt(_0x4023fc(0x70))/0xa*(parseInt(_0x4023fc(0x87))/0xb);if(_0x94135c===_0x48dc8b)break;else _0x55a8d0['push'](_0x55a8d0['shift']());}catch(_0x7bf77d){_0x55a8d0['push'](_0x55a8d0['shift']());}}}(_0x2d98,0xddad6));var __decorate=this&&this[_0x4233ce(0x76)]||function(_0x530501,_0x183124,_0x386199,_0x5c2e1d){const _0x3e8c8a=_0x4233ce;var _0x14587d=arguments[_0x3e8c8a(0xd4)],_0x840c2c=_0x14587d<0x3?_0x183124:_0x5c2e1d===null?_0x5c2e1d=Object[_0x3e8c8a(0xb7)](_0x183124,_0x386199):_0x5c2e1d,_0x4f3daa;if(typeof Reflect==='object'&&typeof Reflect[_0x3e8c8a(0x93)]===_0x3e8c8a(0xc6))_0x840c2c=Reflect[_0x3e8c8a(0x93)](_0x530501,_0x183124,_0x386199,_0x5c2e1d);else{for(var _0x3e12f1=_0x530501[_0x3e8c8a(0xd4)]-0x1;_0x3e12f1>=0x0;_0x3e12f1--)if(_0x4f3daa=_0x530501[_0x3e12f1])_0x840c2c=(_0x14587d<0x3?_0x4f3daa(_0x840c2c):_0x14587d>0x3?_0x4f3daa(_0x183124,_0x386199,_0x840c2c):_0x4f3daa(_0x183124,_0x386199))||_0x840c2c;}return _0x14587d>0x3&&_0x840c2c&&Object[_0x3e8c8a(0x83)](_0x183124,_0x386199,_0x840c2c),_0x840c2c;},__metadata=this&&this[_0x4233ce(0xaf)]||function(_0x31795d,_0x642c40){const _0x63def4=_0x4233ce;if(typeof Reflect===_0x63def4(0x8a)&&typeof Reflect[_0x63def4(0xc5)]===_0x63def4(0xc6))return Reflect[_0x63def4(0xc5)](_0x31795d,_0x642c40);},__param=this&&this[_0x4233ce(0x95)]||function(_0x5b54cc,_0x5d20b1){return function(_0x25ff21,_0x42bf3d){_0x5d20b1(_0x25ff21,_0x42bf3d,_0x5b54cc);};};Object[_0x4233ce(0x83)](exports,_0x4233ce(0x9b),{'value':!![]}),exports[_0x4233ce(0xcd)]=void 0x0;function _0x1e27(_0x4baa3f,_0xca3eea){const _0x2d98b2=_0x2d98();return _0x1e27=function(_0x1e2782,_0x48daf4){_0x1e2782=_0x1e2782-0x70;let _0x3844b1=_0x2d98b2[_0x1e2782];return _0x3844b1;},_0x1e27(_0x4baa3f,_0xca3eea);}const common_1=require(_0x4233ce(0xb8)),typeorm_1=require(_0x4233ce(0xbc)),typeorm_2=require(_0x4233ce(0x9a)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x4233ce(0xa3)),utils_1=require(_0x4233ce(0xa8)),modelType_entity_1=require(_0x4233ce(0xd0));let ModelsService=class ModelsService{constructor(_0x3e4f3d,_0x31742a){const _0x2be3cb=_0x4233ce;this[_0x2be3cb(0xce)]=_0x3e4f3d,this[_0x2be3cb(0x8c)]=_0x31742a,this[_0x2be3cb(0x8f)]=[],this['modelMaps']={},this['keyList']={},this[_0x2be3cb(0xb2)]={},this[_0x2be3cb(0x98)]={};}async['onModuleInit'](){const _0xc3b166=_0x4233ce;await this[_0xc3b166(0xc3)]();}async['initCalcKey'](){const _0x310783=_0x4233ce;this['keyPoolMap']={},this[_0x310783(0x98)]={},this[_0x310783(0x79)]={},this[_0x310783(0x89)]={},this['modelTypes']=[];const _0xe22d8=await this[_0x310783(0xce)]['find']({'where':{'status':!![]}}),_0x127213=_0xe22d8[_0x310783(0xad)]((_0x4d451,_0x25e3e4)=>{const _0x4f4fd9=_0x310783;return!_0x4d451[_0x25e3e4[_0x4f4fd9(0x77)]]?_0x4d451[_0x25e3e4[_0x4f4fd9(0x77)]]=[_0x25e3e4]:_0x4d451[_0x25e3e4[_0x4f4fd9(0x77)]][_0x4f4fd9(0x73)](_0x25e3e4),_0x4d451;},{});this[_0x310783(0x8f)]=Object[_0x310783(0x7a)](_0x127213)[_0x310783(0xb4)](_0x5e8fba=>{const _0xc7739d=_0x310783;return{'label':status_constant_1[_0xc7739d(0xca)][_0x5e8fba],'val':_0x5e8fba};}),this['modelMaps']=_0x127213,this[_0x310783(0x79)]={},_0xe22d8[_0x310783(0xb6)](_0x1e0a32=>{const _0x6fad04=_0x310783,{keyType:_0x360cf7,model:_0xba1a49,keyWeight:_0x580249}=_0x1e0a32;if(!this[_0x6fad04(0xb2)][_0xba1a49])this['keyPoolMap'][_0xba1a49]=[];for(let _0x1b9666=0x0;_0x1b9666<_0x580249;_0x1b9666++){this['keyPoolMap'][_0xba1a49][_0x6fad04(0x73)](_0x1e0a32);}if(!this[_0x6fad04(0x98)][_0xba1a49])this[_0x6fad04(0x98)][_0xba1a49]=0x0;if(!this[_0x6fad04(0x79)][_0x360cf7])this[_0x6fad04(0x79)][_0x360cf7]={};if(!this[_0x6fad04(0x79)][_0x360cf7][_0xba1a49])this['keyList'][_0x360cf7][_0xba1a49]=[];this[_0x6fad04(0x79)][_0x360cf7][_0xba1a49][_0x6fad04(0x73)](_0x1e0a32);});}async[_0x4233ce(0x7f)](_0xcda244,_0x5d30f3,_0x17719d=-0x1){const _0x55e3d8=_0x4233ce,_0x15bd16=await this[_0x55e3d8(0xce)][_0x55e3d8(0xbe)]({'id':_0xcda244},{'status':![],'keyStatus':_0x17719d,'remark':_0x5d30f3});common_1[_0x55e3d8(0xab)][_0x55e3d8(0x94)](_0x55e3d8(0xcf)+_0xcda244+_0x55e3d8(0xd1)),this[_0x55e3d8(0xc3)]();}async['getCurrentModelKeyInfo'](_0xe3b657){const _0x5d39b4=_0x4233ce;if(!this[_0x5d39b4(0xb2)][_0xe3b657])throw new common_1[(_0x5d39b4(0xa0))]('当前调用模型已经被移除、请重新选择模型！',common_1[_0x5d39b4(0xa7)][_0x5d39b4(0xb0)]);this[_0x5d39b4(0x98)][_0xe3b657]++;const _0x1289c6=this[_0x5d39b4(0x98)][_0xe3b657];if(_0x1289c6>=this[_0x5d39b4(0xb2)][_0xe3b657][_0x5d39b4(0xd4)])this['keyPoolIndexMap'][_0xe3b657]=0x0;const _0x1760d8=this[_0x5d39b4(0xb2)][_0xe3b657][this[_0x5d39b4(0x98)][_0xe3b657]];return _0x1760d8;}async[_0x4233ce(0xc4)](_0x4b79e9){const _0x4cdd20=_0x4233ce;if(!this[_0x4cdd20(0x8f)][_0x4cdd20(0xd4)]||!Object[_0x4cdd20(0x7a)](this[_0x4cdd20(0x89)])['length'])return;const _0x5162ac=_0x4b79e9?this[_0x4cdd20(0x8f)]['find'](_0x282d97=>Number(_0x282d97[_0x4cdd20(0x88)])===0x1):this['modelTypes'][0x0];if(!_0x5162ac)return;const {keyType:_0x1dc4de,modelName:_0x2c1aea,model:_0x3b54e6,maxModelTokens:_0x2f8048,maxResponseTokens:_0x5bd48b,deductType:_0x104d6d,deduct:_0x3e9885,maxRounds:_0x21ccd3}=this[_0x4cdd20(0x89)][_0x5162ac['val']][0x0];return{'modelTypeInfo':_0x5162ac,'modelInfo':{'keyType':_0x1dc4de,'modelName':_0x2c1aea,'model':_0x3b54e6,'maxModelTokens':_0x2f8048,'maxResponseTokens':_0x5bd48b,'topN':0.8,'systemMessage':'','deductType':_0x104d6d,'deduct':_0x3e9885,'maxRounds':_0x21ccd3,'rounds':0x8}};}async[_0x4233ce(0xc7)](_0x4952eb){const _0x4c290c=_0x4233ce;try{const {id:_0x1bfd44}=_0x4952eb;_0x4952eb['status']&&(_0x4952eb[_0x4c290c(0xb1)]=0x1);if(_0x1bfd44){const _0x453e35=await this[_0x4c290c(0xce)][_0x4c290c(0xbe)]({'id':_0x1bfd44},_0x4952eb);return await this[_0x4c290c(0xc3)](),_0x453e35[_0x4c290c(0x84)]>0x0;}else{const {keyType:_0x2a55f5,key:_0x118ca2}=_0x4952eb;if(Number(_0x2a55f5!==0x1)){const _0x15d4e3=await this[_0x4c290c(0xce)][_0x4c290c(0xc2)](_0x4952eb);return await this[_0x4c290c(0xc3)](),_0x15d4e3;}else{const _0x2a09ff=_0x118ca2[_0x4c290c(0xb4)](_0x86482e=>{const _0x435896=_0x4c290c;try{const _0x6b1886=JSON[_0x435896(0x9f)](JSON['stringify'](_0x4952eb));return _0x6b1886[_0x435896(0xac)]=_0x86482e,_0x6b1886;}catch(_0x5d98a2){console['log'](_0x435896(0xa2),_0x5d98a2);}}),_0xc48f67=await this[_0x4c290c(0xce)][_0x4c290c(0xc2)](_0x2a09ff);return await this[_0x4c290c(0xc3)](),_0xc48f67;}}}catch(_0x5a9f5a){console[_0x4c290c(0x72)](_0x4c290c(0xbf),_0x5a9f5a);}}async[_0x4233ce(0x9c)]({id:_0x5b18b7}){const _0xd2828a=_0x4233ce;if(!_0x5b18b7)throw new common_1['HttpException'](_0xd2828a(0xbd),common_1['HttpStatus'][_0xd2828a(0xb0)]);const _0x4d1221=await this[_0xd2828a(0xce)][_0xd2828a(0xba)]({'where':{'id':_0x5b18b7}});if(!_0x4d1221)throw new common_1[(_0xd2828a(0xa0))]('当前账号不存在！',common_1[_0xd2828a(0xa7)][_0xd2828a(0xb0)]);const _0x54df7c=await this[_0xd2828a(0xce)][_0xd2828a(0xcc)]({'id':_0x5b18b7});return await this[_0xd2828a(0xc3)](),_0x54df7c;}async['queryModels'](_0x45b662,_0x2e7c05){const _0xf322c8=_0x4233ce,{role:_0x1f437e}=_0x45b662[_0xf322c8(0x86)],{keyType:_0x309c6a,key:_0x386bee,status:_0x2a8692,model:_0x35746b,page:page=0x1,size:size=0xa}=_0x2e7c05;let _0x390b68={};_0x309c6a&&(_0x390b68[_0xf322c8(0x77)]=_0x309c6a),_0x35746b&&(_0x390b68[_0xf322c8(0xa1)]=_0x35746b),_0x2a8692&&(_0x390b68[_0xf322c8(0x8d)]=Number(_0x2a8692)===0x1?!![]:![]),_0x386bee&&(_0x390b68[_0xf322c8(0xac)]=(0x0,typeorm_2[_0xf322c8(0xa6)])('%'+_0x386bee+'%'));const [_0x271368,_0x4667ba]=await this[_0xf322c8(0xce)][_0xf322c8(0x75)]({'where':_0x390b68,'order':{'modelOrder':_0xf322c8(0xc8)},'skip':(page-0x1)*size,'take':size});return _0x1f437e!==_0xf322c8(0x80)&&_0x271368[_0xf322c8(0xb6)](_0x1d022f=>{const _0x2a97a7=_0xf322c8;_0x1d022f[_0x2a97a7(0xac)]&&(_0x1d022f[_0x2a97a7(0xac)]=(0x0,utils_1['hideString'])(_0x1d022f[_0x2a97a7(0xac)])),_0x1d022f[_0x2a97a7(0xd3)]&&(_0x1d022f[_0x2a97a7(0xd3)]=(0x0,utils_1[_0x2a97a7(0x7d)])(_0x1d022f[_0x2a97a7(0xd3)]));}),{'rows':_0x271368,'count':_0x4667ba};}async[_0x4233ce(0x7c)](){const _0x525804=_0x4233ce,_0x436e25=JSON['parse'](JSON['stringify'](this[_0x525804(0x89)]));return Object[_0x525804(0x7a)](_0x436e25)[_0x525804(0xb6)](_0x1736b4=>{const _0x381b30=_0x525804;_0x436e25[_0x1736b4]=_0x436e25[_0x1736b4][_0x381b30(0xae)]((_0xd18820,_0x5eaecb)=>_0xd18820['modelOrder']-_0x5eaecb[_0x381b30(0xc9)]),_0x436e25[_0x1736b4]=Array['from'](_0x436e25[_0x1736b4][_0x381b30(0xb4)](_0x278c0e=>{const {modelName:_0x5a565a,model:_0x36675a,deduct:_0x335687,deductType:_0xb7ab25,maxRounds:_0x5d6b58}=_0x278c0e;return{'modelName':_0x5a565a,'model':_0x36675a,'deduct':_0x335687,'deductType':_0xb7ab25,'maxRounds':_0x5d6b58};})[_0x381b30(0xad)]((_0x392100,_0x535f4a)=>_0x392100['set'](_0x535f4a[_0x381b30(0xd2)],_0x535f4a),new Map())[_0x381b30(0x8b)]());}),{'modelTypeList':this['modelTypes'],'modelMaps':_0x436e25};}async[_0x4233ce(0xb5)](_0xe03956,_0x438027){const _0x4322b1=_0x4233ce;await this[_0x4322b1(0xce)][_0x4322b1(0x91)]()[_0x4322b1(0xbe)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>_0x4322b1(0xaa),'useToken':()=>_0x4322b1(0x74)+_0x438027})[_0x4322b1(0x82)](_0x4322b1(0xa9),{'id':_0xe03956})[_0x4322b1(0x85)]();}async[_0x4233ce(0x9e)](){const _0x3750cc=_0x4233ce,_0x3d6a06=await this[_0x3750cc(0xce)][_0x3750cc(0x78)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x3d6a06[_0x3750cc(0xd4)])throw new common_1[(_0x3750cc(0xa0))](_0x3750cc(0xbb),common_1[_0x3750cc(0xa7)][_0x3750cc(0xb0)]);return(0x0,utils_1['getRandomItemFromArray'])(_0x3d6a06);}async['getAllKey'](){const _0x4397cb=_0x4233ce;return await this[_0x4397cb(0xce)][_0x4397cb(0x78)]();}async[_0x4233ce(0xb9)](_0xcd3285){return 0x1;}async[_0x4233ce(0x9d)](_0x5bae59){return 0x1;}async[_0x4233ce(0xcb)](_0x157021){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x4233ce(0x97)])(),__param(0x0,(0x0,typeorm_1[_0x4233ce(0x92)])(models_entity_1[_0x4233ce(0x99)])),__param(0x1,(0x0,typeorm_1[_0x4233ce(0x92)])(modelType_entity_1[_0x4233ce(0x96)])),__metadata(_0x4233ce(0x81),[typeorm_2[_0x4233ce(0x7e)],typeorm_2[_0x4233ce(0x7e)]])],ModelsService),exports[_0x4233ce(0xcd)]=ModelsService;