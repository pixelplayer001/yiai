'use strict';const _0x43d465=_0x2013;(function(_0x1f1c72,_0x34dd01){const _0x54ec94=_0x2013,_0x26236f=_0x1f1c72();while(!![]){try{const _0x19db7b=-parseInt(_0x54ec94(0x126))/0x1+-parseInt(_0x54ec94(0x15c))/0x2+-parseInt(_0x54ec94(0x143))/0x3+-parseInt(_0x54ec94(0x125))/0x4*(parseInt(_0x54ec94(0x128))/0x5)+-parseInt(_0x54ec94(0x101))/0x6*(parseInt(_0x54ec94(0x104))/0x7)+-parseInt(_0x54ec94(0x149))/0x8+parseInt(_0x54ec94(0x159))/0x9*(parseInt(_0x54ec94(0x158))/0xa);if(_0x19db7b===_0x34dd01)break;else _0x26236f['push'](_0x26236f['shift']());}catch(_0x31df9c){_0x26236f['push'](_0x26236f['shift']());}}}(_0x3b97,0x3d118));function _0x2013(_0x52cb9d,_0x1b8ad8){const _0x3b9749=_0x3b97();return _0x2013=function(_0x2013a9,_0x14ed80){_0x2013a9=_0x2013a9-0x100;let _0x3c3422=_0x3b9749[_0x2013a9];return _0x3c3422;},_0x2013(_0x52cb9d,_0x1b8ad8);}var __decorate=this&&this[_0x43d465(0x142)]||function(_0x383bac,_0x4295ee,_0x32ed86,_0x20b440){const _0x1a9dbe=_0x43d465;var _0x37f8bc=arguments[_0x1a9dbe(0x12d)],_0x436d2f=_0x37f8bc<0x3?_0x4295ee:_0x20b440===null?_0x20b440=Object[_0x1a9dbe(0x14b)](_0x4295ee,_0x32ed86):_0x20b440,_0x2d1854;if(typeof Reflect==='object'&&typeof Reflect[_0x1a9dbe(0x137)]===_0x1a9dbe(0x108))_0x436d2f=Reflect[_0x1a9dbe(0x137)](_0x383bac,_0x4295ee,_0x32ed86,_0x20b440);else{for(var _0x560e0a=_0x383bac[_0x1a9dbe(0x12d)]-0x1;_0x560e0a>=0x0;_0x560e0a--)if(_0x2d1854=_0x383bac[_0x560e0a])_0x436d2f=(_0x37f8bc<0x3?_0x2d1854(_0x436d2f):_0x37f8bc>0x3?_0x2d1854(_0x4295ee,_0x32ed86,_0x436d2f):_0x2d1854(_0x4295ee,_0x32ed86))||_0x436d2f;}return _0x37f8bc>0x3&&_0x436d2f&&Object['defineProperty'](_0x4295ee,_0x32ed86,_0x436d2f),_0x436d2f;},__metadata=this&&this[_0x43d465(0x14d)]||function(_0xf3f47c,_0x506995){const _0x19abcb=_0x43d465;if(typeof Reflect===_0x19abcb(0x140)&&typeof Reflect[_0x19abcb(0x132)]==='function')return Reflect['metadata'](_0xf3f47c,_0x506995);},__param=this&&this[_0x43d465(0x105)]||function(_0xaa1a3e,_0x35d3be){return function(_0x1cefc8,_0x2faad2){_0x35d3be(_0x1cefc8,_0x2faad2,_0xaa1a3e);};};function _0x3b97(){const _0x19b9ee=['generateCrami','@nestjs/common','metadata','queryAllCrami','套餐名称或套餐等级重复、请检查！','name','defineProperty','decorate','当前卡密已被使用、已使用的卡密禁止删除！','Not','batchDelCrami','Like','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','../user/user.entity','maskCrami','maskEmail','object','当前卡密不存在、请确认您输入的卡密是否正确！','__decorate','1263450KoefqF','generateCramiCode','update','delPackage','addBalanceToUser','CramiService','87752gKpcLq','findAndCount','getOwnPropertyDescriptor','CramiPackageEntity','__metadata','../../common/constants/balance.constant','super','error:\x20','RechargeType','Injectable','InjectRepository','createCrami','BAD_REQUEST','./crami.entity','MoreThan','15820mbGHKX','9423AEOLHw','map','createPackage','590006fLAqsX','design:paramtypes','queryAllPackage','affected','useId','userEntity','10830JiMOsJ','email','user','161bAuaDB','__param','__esModule','CramiEntity','function','save','delete','../userBalance/userBalance.service','updatePackage','assign','当前卡密不存在、请确认您要删除的卡密是否存在！','@nestjs/typeorm','自定义卡密必须至少一项余额不为0️零！','count','delCrami','useCrami','findOne','UserEntity','username','./cramiPackage.entity','HttpException','code','当前套餐不存在、请确认您选择的套餐是否存在！','every','packageId','role','cramiEntity','删除卡密失败、请重试！','../../common/utils','HttpStatus','create','PACKAGE_GIFT','DESC','1002320SCWaVT','387001QlXHLF','userBalanceService','5UNuUSO','当前卡密已被使用、请确认您输入的卡密是否正确！','forEach','使用卡密成功','cramiPackageEntity','length','find','Repository'];_0x3b97=function(){return _0x19b9ee;};return _0x3b97();}Object[_0x43d465(0x136)](exports,_0x43d465(0x106),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require(_0x43d465(0x131)),crami_entity_1=require(_0x43d465(0x156)),typeorm_1=require(_0x43d465(0x10f)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x43d465(0x117)),utils_1=require(_0x43d465(0x120)),user_entity_1=require(_0x43d465(0x13d)),userBalance_service_1=require(_0x43d465(0x10b)),balance_constant_1=require(_0x43d465(0x14e));let CramiService=class CramiService{constructor(_0x3f25d3,_0x561fbd,_0x5c1ff6,_0x10c2b8){const _0x3301af=_0x43d465;this['cramiEntity']=_0x3f25d3,this['cramiPackageEntity']=_0x561fbd,this[_0x3301af(0x100)]=_0x5c1ff6,this[_0x3301af(0x127)]=_0x10c2b8;}async['queryOnePackage'](_0x25dfec){const _0x33b486=_0x43d465;return await this[_0x33b486(0x12c)]['findOne']({'where':{'id':_0x25dfec}});}async[_0x43d465(0x15e)](_0x3b3abf){const _0x54bc30=_0x43d465;try{const {page:page=0x1,size:size=0xa,name:_0x628999,status:_0x540e58,type:_0x424974}=_0x3b3abf,_0x3864cc={};_0x628999&&Object[_0x54bc30(0x10d)](_0x3864cc,{'name':(0x0,typeorm_2[_0x54bc30(0x13b)])('%'+_0x628999+'%')}),_0x540e58&&Object[_0x54bc30(0x10d)](_0x3864cc,{'status':_0x540e58});_0x424974&&(_0x424974>0x0?Object[_0x54bc30(0x10d)](_0x3864cc,{'days':(0x0,typeorm_2[_0x54bc30(0x157)])(0x0)}):Object[_0x54bc30(0x10d)](_0x3864cc,{'days':(0x0,typeorm_2['LessThanOrEqual'])(0x0)}));const [_0x2dc3b4,_0x4a6986]=await this['cramiPackageEntity'][_0x54bc30(0x14a)]({'skip':(page-0x1)*size,'take':size,'where':_0x3864cc,'order':{'order':_0x54bc30(0x124)}});return{'rows':_0x2dc3b4,'count':_0x4a6986};}catch(_0x41a27d){console['log'](_0x54bc30(0x150),_0x41a27d);}}async[_0x43d465(0x15b)](_0x284b37){const _0x2ce48d=_0x43d465,{name:_0x5f1755,weight:_0x161906}=_0x284b37,_0x37e972=await this[_0x2ce48d(0x12c)]['findOne']({'where':[{'name':_0x5f1755},{'weight':_0x161906}]});if(_0x37e972)throw new common_1[(_0x2ce48d(0x118))]('套餐名称或套餐等级重复、请检查！',common_1['HttpStatus'][_0x2ce48d(0x155)]);try{return await this[_0x2ce48d(0x12c)][_0x2ce48d(0x109)](_0x284b37);}catch(_0x6978e1){console['log'](_0x2ce48d(0x150),_0x6978e1);throw new common_1[(_0x2ce48d(0x118))](_0x6978e1,common_1[_0x2ce48d(0x121)][_0x2ce48d(0x155)]);}}async[_0x43d465(0x10c)](_0x512e85){const _0x5632b8=_0x43d465,{id:_0x24c4a5,name:_0x212553,weight:_0x21f18d}=_0x512e85,_0x56ce36=await this[_0x5632b8(0x12c)][_0x5632b8(0x114)]({'where':{'id':_0x24c4a5}});if(!_0x56ce36)throw new common_1['HttpException']('当前套餐不存在、请检查你的输入参数！',common_1[_0x5632b8(0x121)][_0x5632b8(0x155)]);const _0xe01dbe=await this[_0x5632b8(0x12c)][_0x5632b8(0x111)]({'where':[{'name':_0x212553,'id':(0x0,typeorm_2[_0x5632b8(0x139)])(_0x24c4a5)},{'weight':_0x21f18d,'id':(0x0,typeorm_2[_0x5632b8(0x139)])(_0x24c4a5)}]});if(_0xe01dbe)throw new common_1['HttpException'](_0x5632b8(0x134),common_1['HttpStatus'][_0x5632b8(0x155)]);const _0x99f073=await this[_0x5632b8(0x12c)]['update']({'id':_0x24c4a5},_0x512e85);if(_0x99f073[_0x5632b8(0x15f)]>0x0)return'更新套餐成功！';else throw new common_1[(_0x5632b8(0x118))]('更新套餐失败、请重试！',common_1[_0x5632b8(0x121)][_0x5632b8(0x155)]);}async[_0x43d465(0x146)](_0x4c698e){const _0x1eb01f=_0x43d465,{id:_0xe21712}=_0x4c698e,_0x57869b=await this[_0x1eb01f(0x11e)]['count']({'where':{'packageId':_0xe21712}});if(_0x57869b)throw new common_1[(_0x1eb01f(0x118))](_0x1eb01f(0x13c),common_1[_0x1eb01f(0x121)][_0x1eb01f(0x155)]);return await this[_0x1eb01f(0x12c)][_0x1eb01f(0x10a)]({'id':_0xe21712});}async[_0x43d465(0x154)](_0x2deeb8){const _0x9c9344=_0x43d465,{packageId:_0x841fa6,count:count=0x1}=_0x2deeb8;if(_0x841fa6){const _0x50e52b=await this[_0x9c9344(0x12c)]['findOne']({'where':{'id':_0x841fa6}});if(!_0x50e52b)throw new common_1[(_0x9c9344(0x118))](_0x9c9344(0x11a),common_1['HttpStatus']['BAD_REQUEST']);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x50e52b,_0x206cf8={'packageId':_0x841fa6,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x9c9344(0x130)](_0x206cf8,count);}if(!_0x841fa6){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2deeb8;if([model3Count,model4Count,drawMjCount][_0x9c9344(0x11b)](_0x1690ae=>!_0x1690ae))throw new common_1[(_0x9c9344(0x118))](_0x9c9344(0x110),common_1[_0x9c9344(0x121)][_0x9c9344(0x155)]);const _0x2f4bab={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x9c9344(0x130)](_0x2f4bab,count);}}async[_0x43d465(0x130)](_0x5d55ee,_0x3ee1dc){const _0x1a67a0=_0x43d465,_0x5d3bc9=[];for(let _0x267c15=0x0;_0x267c15<_0x3ee1dc;_0x267c15++){const _0x550e99=(0x0,utils_1[_0x1a67a0(0x144)])(),_0x1a1c48=this[_0x1a67a0(0x11e)][_0x1a67a0(0x122)](Object['assign'](Object[_0x1a67a0(0x10d)]({},_0x5d55ee),{'code':_0x550e99}));_0x5d3bc9['push'](_0x1a1c48);}return await this[_0x1a67a0(0x11e)][_0x1a67a0(0x109)](_0x5d3bc9);}async[_0x43d465(0x113)](_0x3b31be,_0x3749b9){const _0x4eefe4=_0x43d465,{id:_0x2e3706}=_0x3b31be[_0x4eefe4(0x103)],_0x77dac0=await this['cramiEntity'][_0x4eefe4(0x114)]({'where':{'code':_0x3749b9[_0x4eefe4(0x119)]}});if(!_0x77dac0)throw new common_1[(_0x4eefe4(0x118))](_0x4eefe4(0x141),common_1['HttpStatus']['BAD_REQUEST']);const {status:_0x59923c,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x1b2fe9}=_0x77dac0;if(_0x59923c===0x1)throw new common_1['HttpException'](_0x4eefe4(0x129),common_1[_0x4eefe4(0x121)][_0x4eefe4(0x155)]);const _0x248253={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x1b2fe9};return await this[_0x4eefe4(0x127)][_0x4eefe4(0x147)](_0x2e3706,Object[_0x4eefe4(0x10d)]({},_0x248253),days),await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x2e3706,'rechargeType':balance_constant_1[_0x4eefe4(0x151)][_0x4eefe4(0x123)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x4eefe4(0x11e)][_0x4eefe4(0x145)]({'code':_0x3749b9[_0x4eefe4(0x119)]},{'useId':_0x2e3706,'status':0x1}),_0x4eefe4(0x12b);}async[_0x43d465(0x133)](_0x5ae973,_0x104f86){const _0x5817bf=_0x43d465,{page:page=0x1,size:size=0xa,status:_0x27ab58,useId:_0x5776ca}=_0x5ae973,_0xdeb809={};_0x27ab58&&Object[_0x5817bf(0x10d)](_0xdeb809,{'status':_0x27ab58}),_0x5776ca&&Object[_0x5817bf(0x10d)](_0xdeb809,{'useId':_0x5776ca});const [_0x5cf826,_0xb786af]=await this[_0x5817bf(0x11e)][_0x5817bf(0x14a)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0xdeb809}),_0x77fe1f=_0x5cf826[_0x5817bf(0x15a)](_0xcf5963=>_0xcf5963['useId']),_0x269868=_0x5cf826[_0x5817bf(0x15a)](_0x45301f=>_0x45301f[_0x5817bf(0x11c)]),_0x391cf4=await this[_0x5817bf(0x100)][_0x5817bf(0x12e)]({'where':{'id':(0x0,typeorm_2['In'])(_0x77fe1f)}}),_0xe13d06=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x269868)}});return _0x5cf826[_0x5817bf(0x12a)](_0x2b1e2b=>{const _0x16493b=_0x5817bf;var _0x35b4f9,_0x1385e2,_0x44afb1;_0x2b1e2b[_0x16493b(0x116)]=(_0x35b4f9=_0x391cf4['find'](_0x289869=>_0x289869['id']===_0x2b1e2b[_0x16493b(0x160)]))===null||_0x35b4f9===void 0x0?void 0x0:_0x35b4f9[_0x16493b(0x116)],_0x2b1e2b[_0x16493b(0x102)]=(_0x1385e2=_0x391cf4[_0x16493b(0x12e)](_0x414909=>_0x414909['id']===_0x2b1e2b[_0x16493b(0x160)]))===null||_0x1385e2===void 0x0?void 0x0:_0x1385e2[_0x16493b(0x102)],_0x2b1e2b['packageName']=(_0x44afb1=_0xe13d06[_0x16493b(0x12e)](_0x25d8f7=>_0x25d8f7['id']===_0x2b1e2b[_0x16493b(0x11c)]))===null||_0x44afb1===void 0x0?void 0x0:_0x44afb1[_0x16493b(0x135)];}),_0x104f86[_0x5817bf(0x103)]['role']!==_0x5817bf(0x14f)&&_0x5cf826['forEach'](_0xa4da8d=>_0xa4da8d[_0x5817bf(0x102)]=(0x0,utils_1[_0x5817bf(0x13f)])(_0xa4da8d['email'])),_0x104f86[_0x5817bf(0x103)][_0x5817bf(0x11d)]!=='super'&&_0x5cf826[_0x5817bf(0x12a)](_0x38f9c0=>_0x38f9c0['code']=(0x0,utils_1[_0x5817bf(0x13e)])(_0x38f9c0[_0x5817bf(0x119)])),{'rows':_0x5cf826,'count':_0xb786af};}async[_0x43d465(0x112)](_0x4fb0b6){const _0x1271a6=_0x43d465,_0x5274a7=await this[_0x1271a6(0x11e)][_0x1271a6(0x114)]({'where':{'id':_0x4fb0b6}});if(!_0x5274a7)throw new common_1['HttpException'](_0x1271a6(0x10e),common_1[_0x1271a6(0x121)][_0x1271a6(0x155)]);if(_0x5274a7['status']===0x1)throw new common_1[(_0x1271a6(0x118))](_0x1271a6(0x138),common_1[_0x1271a6(0x121)]['BAD_REQUEST']);return await this['cramiEntity'][_0x1271a6(0x10a)]({'id':_0x4fb0b6});}async[_0x43d465(0x13a)](_0x47b53e){const _0x40d52d=_0x43d465,{ids:_0x3e9f51}=_0x47b53e,_0xf7fd7f=await this['cramiEntity'][_0x40d52d(0x10a)](_0x3e9f51);if(_0xf7fd7f[_0x40d52d(0x15f)]>0x0)return'删除卡密成功！';else throw new common_1['HttpException'](_0x40d52d(0x11f),common_1['HttpStatus'][_0x40d52d(0x155)]);}};CramiService=__decorate([(0x0,common_1[_0x43d465(0x152)])(),__param(0x0,(0x0,typeorm_1[_0x43d465(0x153)])(crami_entity_1[_0x43d465(0x107)])),__param(0x1,(0x0,typeorm_1[_0x43d465(0x153)])(cramiPackage_entity_1[_0x43d465(0x14c)])),__param(0x2,(0x0,typeorm_1[_0x43d465(0x153)])(user_entity_1[_0x43d465(0x115)])),__metadata(_0x43d465(0x15d),[typeorm_2[_0x43d465(0x12f)],typeorm_2[_0x43d465(0x12f)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService']])],CramiService),exports[_0x43d465(0x148)]=CramiService;