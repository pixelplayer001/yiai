'use strict';const _0x56ea6a=_0x1872;function _0x50c4(){const _0x496227=['createQueryBuilder','payPlatform','deleteOrder','1133445rJHiDC','DESC','37684rWxNax','des','length','user','username','@nestjs/common','userInfo','HttpException','query','findAndCount','cramiPackageEntity','total','OrderEntity','../../common/utils','email','__param','299576nzuTvJ','UNAUTHORIZED','channel','select','createOrderId','购买失败!','518104qVKvyk','BAD_REQUEST','7036750qkIgVH','order:\x20','../pay/pay.service','HttpStatus','deleteNotPay','pay','typeorm','save','defineProperty','where','235974dgxcmX','OrderService','findOne','__decorate','create','56bqHRDL','map','object','name','__metadata','status','function','@nestjs/typeorm','queryPayType','orderId','../globalConfig/globalConfig.service','套餐不存在!','message','Injectable','price','goodsInfo','orderEntity','UserEntity','1579401BUobvI','userEntity','goodsId','globalConfigService','count','InjectRepository','assign','metadata','buy','order.status\x20=\x20:status','find','getRawOne','decorate','coverImg','userId','265QhNOKM','Repository','forEach','queryByOrderId','total_price','订单不存在!'];_0x50c4=function(){return _0x496227;};return _0x50c4();}(function(_0x150d20,_0x29364c){const _0x1b501f=_0x1872,_0x816e0c=_0x150d20();while(!![]){try{const _0x33f3a2=parseInt(_0x1b501f(0x179))/0x1+parseInt(_0x1b501f(0x173))/0x2+-parseInt(_0x1b501f(0x161))/0x3+parseInt(_0x1b501f(0x163))/0x4*(parseInt(_0x1b501f(0x158))/0x5)+parseInt(_0x1b501f(0x185))/0x6+parseInt(_0x1b501f(0x17b))/0x7+parseInt(_0x1b501f(0x137))/0x8*(-parseInt(_0x1b501f(0x149))/0x9);if(_0x33f3a2===_0x29364c)break;else _0x816e0c['push'](_0x816e0c['shift']());}catch(_0x3c37ae){_0x816e0c['push'](_0x816e0c['shift']());}}}(_0x50c4,0x93d6a));var __decorate=this&&this[_0x56ea6a(0x188)]||function(_0xebdf2f,_0x3cb016,_0x2e0b16,_0x50ed7e){const _0x365610=_0x56ea6a;var _0x3cf600=arguments[_0x365610(0x165)],_0x2abf4c=_0x3cf600<0x3?_0x3cb016:_0x50ed7e===null?_0x50ed7e=Object['getOwnPropertyDescriptor'](_0x3cb016,_0x2e0b16):_0x50ed7e,_0x4021bc;if(typeof Reflect==='object'&&typeof Reflect[_0x365610(0x155)]===_0x365610(0x13d))_0x2abf4c=Reflect[_0x365610(0x155)](_0xebdf2f,_0x3cb016,_0x2e0b16,_0x50ed7e);else{for(var _0x5ad205=_0xebdf2f[_0x365610(0x165)]-0x1;_0x5ad205>=0x0;_0x5ad205--)if(_0x4021bc=_0xebdf2f[_0x5ad205])_0x2abf4c=(_0x3cf600<0x3?_0x4021bc(_0x2abf4c):_0x3cf600>0x3?_0x4021bc(_0x3cb016,_0x2e0b16,_0x2abf4c):_0x4021bc(_0x3cb016,_0x2e0b16))||_0x2abf4c;}return _0x3cf600>0x3&&_0x2abf4c&&Object[_0x365610(0x183)](_0x3cb016,_0x2e0b16,_0x2abf4c),_0x2abf4c;},__metadata=this&&this[_0x56ea6a(0x13b)]||function(_0x248fb9,_0x409139){const _0x5dee2b=_0x56ea6a;if(typeof Reflect===_0x5dee2b(0x139)&&typeof Reflect[_0x5dee2b(0x150)]===_0x5dee2b(0x13d))return Reflect[_0x5dee2b(0x150)](_0x248fb9,_0x409139);},__param=this&&this[_0x56ea6a(0x172)]||function(_0x14af99,_0x2988a1){return function(_0x167c27,_0x3526ae){_0x2988a1(_0x167c27,_0x3526ae,_0x14af99);};};function _0x1872(_0xf90d33,_0xdca2dd){const _0x50c4b0=_0x50c4();return _0x1872=function(_0x1872ad,_0x440401){_0x1872ad=_0x1872ad-0x137;let _0x2a3061=_0x50c4b0[_0x1872ad];return _0x2a3061;},_0x1872(_0xf90d33,_0xdca2dd);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x56ea6a(0x186)]=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require(_0x56ea6a(0x13e)),common_1=require(_0x56ea6a(0x168)),typeorm_2=require(_0x56ea6a(0x181)),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require(_0x56ea6a(0x170)),pay_service_1=require(_0x56ea6a(0x17d)),globalConfig_service_1=require(_0x56ea6a(0x141));let OrderService=class OrderService{constructor(_0x2be2ae,_0x54f0fc,_0x48f0f0,_0x1e4323,_0x11d0f5){const _0x424eb5=_0x56ea6a;this['orderEntity']=_0x2be2ae,this[_0x424eb5(0x16d)]=_0x54f0fc,this[_0x424eb5(0x14a)]=_0x48f0f0,this['payService']=_0x1e4323,this[_0x424eb5(0x14c)]=_0x11d0f5;}async[_0x56ea6a(0x151)](_0x10879f,_0x5d3a1d){const _0x478d11=_0x56ea6a;try{const {goodsId:_0x2be759,count:count=0x1,payType:_0x5791e4}=_0x10879f,{id:_0x5422a1}=_0x5d3a1d['user'];if(_0x5422a1>0xf4240)throw new common_1[(_0x478d11(0x16a))]('请先注册账号后购买商品！',common_1[_0x478d11(0x17e)]['UNAUTHORIZED']);const _0x3403a6=await this[_0x478d11(0x189)](_0x5422a1,_0x2be759,count,_0x5791e4),_0x2ffb55=await this['payService'][_0x478d11(0x180)](_0x5422a1,_0x3403a6[_0x478d11(0x140)],_0x5791e4);return Object[_0x478d11(0x14f)](Object[_0x478d11(0x14f)]({},_0x2ffb55),{'orderId':_0x3403a6[_0x478d11(0x140)],'platform':_0x3403a6['payPlatform'],'total':_0x3403a6[_0x478d11(0x16e)]});}catch(_0x3c927d){if(_0x3c927d[_0x478d11(0x13c)]===0x191)throw new common_1[(_0x478d11(0x16a))](_0x3c927d['message'],common_1['HttpStatus'][_0x478d11(0x174)]);throw new common_1['HttpException'](_0x3c927d[_0x478d11(0x143)]||_0x478d11(0x178),common_1[_0x478d11(0x17e)][_0x478d11(0x17a)]);}}async[_0x56ea6a(0x15b)](_0x5cbb5e,_0x43876f){const _0x4800b1=_0x56ea6a,{id:_0x1d6d19}=_0x5cbb5e[_0x4800b1(0x166)],{orderId:_0x26db07}=_0x43876f,_0x4d3fc3=await this[_0x4800b1(0x147)]['findOne']({'where':{'userId':_0x1d6d19,'orderId':_0x26db07}});if(!_0x4d3fc3)throw new common_1[(_0x4800b1(0x16a))](_0x4800b1(0x15d),common_1[_0x4800b1(0x17e)][_0x4800b1(0x17a)]);return _0x4d3fc3;}async[_0x56ea6a(0x189)](_0x4b2e3d,_0x4a6075,_0x56775e,_0x32807a){const _0x2bded6=_0x56ea6a,_0x15afb4=await this[_0x2bded6(0x14c)][_0x2bded6(0x13f)](),_0x3afe8b=await this[_0x2bded6(0x16d)]['findOne']({'where':{'id':_0x4a6075}});if(!_0x3afe8b)throw new common_1[(_0x2bded6(0x16a))](_0x2bded6(0x142),common_1[_0x2bded6(0x17e)][_0x2bded6(0x17a)]);const _0x57ebcf={};_0x57ebcf[_0x2bded6(0x140)]=(0x0,utils_1[_0x2bded6(0x177)])(),_0x57ebcf[_0x2bded6(0x157)]=_0x4b2e3d,_0x57ebcf[_0x2bded6(0x14b)]=_0x4a6075,_0x57ebcf['price']=Number(_0x3afe8b[_0x2bded6(0x145)]),_0x57ebcf[_0x2bded6(0x14d)]=_0x56775e,_0x57ebcf[_0x2bded6(0x16e)]=Number(_0x3afe8b[_0x2bded6(0x145)])*_0x56775e,_0x57ebcf['payPlatform']=_0x15afb4,_0x57ebcf[_0x2bded6(0x175)]=_0x32807a;const _0x1c3a53=await this['orderEntity'][_0x2bded6(0x182)](_0x57ebcf);return console['log'](_0x2bded6(0x17c),_0x1c3a53),_0x1c3a53;}async[_0x56ea6a(0x16b)](_0x4feb32,_0x46f188,_0x410b08){const _0x4d1875=_0x56ea6a;return await this[_0x4d1875(0x147)][_0x4d1875(0x16c)]({'where':{'userId':_0x4feb32},'order':{'id':_0x4d1875(0x162)},'skip':(_0x46f188-0x1)*_0x410b08,'take':_0x410b08});}async['queryAllOrder'](_0x2f7b4c){const _0x4eecb1=_0x56ea6a,{page:_0x552c52,size:_0x1c6428,userId:_0x477369,platform:_0x47fab4,status:_0x1d8353}=_0x2f7b4c,_0x1049a8={};if(_0x477369)_0x1049a8['userId']=_0x477369;if(_0x47fab4)_0x1049a8[_0x4eecb1(0x15f)]=_0x47fab4;if(_0x1d8353)_0x1049a8[_0x4eecb1(0x13c)]=_0x1d8353;const [_0x207e95,_0x32d5e4]=await this[_0x4eecb1(0x147)][_0x4eecb1(0x16c)]({'order':{'id':_0x4eecb1(0x162)},'where':_0x1049a8,'skip':(_0x552c52-0x1)*_0x1c6428,'take':_0x1c6428}),_0x2d4ba6=_0x207e95['map'](_0x1a88cf=>_0x1a88cf[_0x4eecb1(0x157)]),_0x52db5e=_0x207e95[_0x4eecb1(0x138)](_0x38bca1=>_0x38bca1[_0x4eecb1(0x14b)]),_0x38422e=await this[_0x4eecb1(0x14a)][_0x4eecb1(0x153)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2d4ba6)},'select':['id',_0x4eecb1(0x167),_0x4eecb1(0x171)]}),_0x201ad9=await this[_0x4eecb1(0x16d)][_0x4eecb1(0x153)]({'where':{'id':(0x0,typeorm_2['In'])(_0x52db5e)},'select':['id',_0x4eecb1(0x13a),_0x4eecb1(0x156),_0x4eecb1(0x164)]});_0x207e95[_0x4eecb1(0x15a)](_0x14efc2=>{const _0x45e52e=_0x4eecb1;_0x14efc2[_0x45e52e(0x169)]=_0x38422e['find'](_0x5ea9ba=>_0x5ea9ba['id']===_0x14efc2[_0x45e52e(0x157)]),_0x14efc2[_0x45e52e(0x146)]=_0x201ad9['find'](_0x23e3c4=>_0x23e3c4['id']===_0x14efc2['goodsId']);});const _0x2db8e8=await this[_0x4eecb1(0x147)][_0x4eecb1(0x15e)]('order')[_0x4eecb1(0x184)](_0x4eecb1(0x152),{'status':0x1})[_0x4eecb1(0x176)]('SUM(order.price)',_0x4eecb1(0x15c))[_0x4eecb1(0x154)]();return Object[_0x4eecb1(0x14f)]({'rows':_0x207e95,'count':_0x32d5e4},_0x2db8e8);}async[_0x56ea6a(0x160)](_0x264e96){const _0x51ef70=_0x56ea6a,{orderId:_0x482e90}=_0x264e96,_0x1dbe5f=await this[_0x51ef70(0x147)][_0x51ef70(0x187)]({'where':{'orderId':_0x482e90}});if(!_0x1dbe5f)throw new common_1[(_0x51ef70(0x16a))]('订单不存在!',common_1[_0x51ef70(0x17e)]['BAD_REQUEST']);return await this[_0x51ef70(0x147)]['delete']({'orderId':_0x482e90});}async[_0x56ea6a(0x17f)](){const _0x2119c4=_0x56ea6a;return await this[_0x2119c4(0x147)]['delete']({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x56ea6a(0x144)])(),__param(0x0,(0x0,typeorm_1[_0x56ea6a(0x14e)])(order_entity_1[_0x56ea6a(0x16f)])),__param(0x1,(0x0,typeorm_1[_0x56ea6a(0x14e)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x56ea6a(0x148)])),__metadata('design:paramtypes',[typeorm_2[_0x56ea6a(0x159)],typeorm_2[_0x56ea6a(0x159)],typeorm_2['Repository'],pay_service_1['PayService'],globalConfig_service_1['GlobalConfigService']])],OrderService),exports['OrderService']=OrderService;