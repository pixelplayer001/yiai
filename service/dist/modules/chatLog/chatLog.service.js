'use strict';const _0x18eea4=_0xc09e;(function(_0x5c500d,_0x26acc1){const _0x29d0bd=_0xc09e,_0x4f9262=_0x5c500d();while(!![]){try{const _0x3385da=-parseInt(_0x29d0bd(0x191))/0x1*(parseInt(_0x29d0bd(0x1f1))/0x2)+parseInt(_0x29d0bd(0x18d))/0x3*(parseInt(_0x29d0bd(0x1c2))/0x4)+-parseInt(_0x29d0bd(0x1ba))/0x5*(parseInt(_0x29d0bd(0x18b))/0x6)+parseInt(_0x29d0bd(0x1b4))/0x7+parseInt(_0x29d0bd(0x1c7))/0x8*(-parseInt(_0x29d0bd(0x185))/0x9)+parseInt(_0x29d0bd(0x186))/0xa+-parseInt(_0x29d0bd(0x1a4))/0xb*(-parseInt(_0x29d0bd(0x1cb))/0xc);if(_0x3385da===_0x26acc1)break;else _0x4f9262['push'](_0x4f9262['shift']());}catch(_0x382f49){_0x4f9262['push'](_0x4f9262['shift']());}}}(_0x13f0,0x453c6));function _0xc09e(_0x332bf0,_0x26cf54){const _0x13f029=_0x13f0();return _0xc09e=function(_0xc09e20,_0xd333ad){_0xc09e20=_0xc09e20-0x17c;let _0x53f925=_0x13f029[_0xc09e20];return _0x53f925;},_0xc09e(_0x332bf0,_0x26cf54);}function _0x13f0(){const _0x44c8b3=['cos','findOne','chatLogEntity','components','../../common/constants/balance.constant','2120459SjErMd','attachment;\x20filename=','affected','model','recDrawImg','function','UserEntity','chat.xlsx','HttpStatus','chatGroupEntity','isGroup','length','paintCount','find','metadata','default','847266OFjMYo','rec','/q/55','DESC','Content-Disposition','userEntity','81290QsRROl','../chatGroup/chatGroup.entity','chatlog','__param','email','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','ali','@nestjs/common','220rmbLOz','Repository','answer','user','__metadata','32lOyyDy','message_id','Injectable','ChatLogService','12WySwYh','querAllChatLog','删除对话记录成功！','fileInfo','getOwnPropertyDescriptor','__decorate','thumbImg','../../common/utils','addWorksheet','decorate','forEach','@nine.com','end','super','DALL-E2','?imageView2/1/w/','assistant','extend','username','formatDate','findAndCount','用户邮箱','Content-Type','你删除的对话记录不存在、请检查！','createdAt','DeductionKey','PAINT_TYPE','querAllDrawLog','BAD_REQUEST','group','write','map','Workbook','querDrawLog','__esModule','xlsx','InjectRepository','tencent','1938UCrunS','log','includes','delByGroupId','CHAT_TYPE','@nestjs/typeorm','userId','addRow','role','querAllDrawLog\x20Json\x20parse\x20error','./chatLog.entity','919413tUnKUO','5587250ferTUi','object','HttpException','提问时间','图片成功！','186UGHUBX','prompt','24738sbMZha','取消推荐','update','ChatGroupEntity','134zyOKyv','design:paramtypes','Not','byAppId','当前页面已经没有东西可以删除了！','chatList','parse','assign','dall-e-3','setHeader','maskEmail','columns','Like','saveChatLog'];_0x13f0=function(){return _0x44c8b3;};return _0x13f0();}var __decorate=this&&this[_0x18eea4(0x1d0)]||function(_0x485ee2,_0x5f4bf9,_0x4a003c,_0x26e8f9){const _0x19926e=_0x18eea4;var _0x51bd02=arguments['length'],_0x45b07a=_0x51bd02<0x3?_0x5f4bf9:_0x26e8f9===null?_0x26e8f9=Object[_0x19926e(0x1cf)](_0x5f4bf9,_0x4a003c):_0x26e8f9,_0x3c9fa1;if(typeof Reflect===_0x19926e(0x187)&&typeof Reflect[_0x19926e(0x1d4)]==='function')_0x45b07a=Reflect[_0x19926e(0x1d4)](_0x485ee2,_0x5f4bf9,_0x4a003c,_0x26e8f9);else{for(var _0x3c961a=_0x485ee2[_0x19926e(0x1af)]-0x1;_0x3c961a>=0x0;_0x3c961a--)if(_0x3c9fa1=_0x485ee2[_0x3c961a])_0x45b07a=(_0x51bd02<0x3?_0x3c9fa1(_0x45b07a):_0x51bd02>0x3?_0x3c9fa1(_0x5f4bf9,_0x4a003c,_0x45b07a):_0x3c9fa1(_0x5f4bf9,_0x4a003c))||_0x45b07a;}return _0x51bd02>0x3&&_0x45b07a&&Object['defineProperty'](_0x5f4bf9,_0x4a003c,_0x45b07a),_0x45b07a;},__metadata=this&&this[_0x18eea4(0x1c6)]||function(_0x4825e1,_0x232f42){const _0x3fb81d=_0x18eea4;if(typeof Reflect===_0x3fb81d(0x187)&&typeof Reflect[_0x3fb81d(0x1b2)]===_0x3fb81d(0x1a9))return Reflect[_0x3fb81d(0x1b2)](_0x4825e1,_0x232f42);},__param=this&&this[_0x18eea4(0x1bd)]||function(_0x106694,_0x341053){return function(_0x2befa1,_0x2bb9a9){_0x341053(_0x2befa1,_0x2bb9a9,_0x106694);};};Object['defineProperty'](exports,_0x18eea4(0x1ed),{'value':!![]}),exports[_0x18eea4(0x1ca)]=void 0x0;const common_1=require(_0x18eea4(0x1c1)),typeorm_1=require(_0x18eea4(0x17f)),chatLog_entity_1=require(_0x18eea4(0x184)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x18eea4(0x1a3)),user_entity_1=require('../user/user.entity'),utils_1=require(_0x18eea4(0x1d2)),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x18eea4(0x1bb));let ChatLogService=class ChatLogService{constructor(_0x2cb4dc,_0x498d61,_0x20f13e){const _0x591708=_0x18eea4;this[_0x591708(0x1a1)]=_0x2cb4dc,this[_0x591708(0x1b9)]=_0x498d61,this[_0x591708(0x1ad)]=_0x20f13e;}async[_0x18eea4(0x19e)](_0x5b8e6c){const _0x3c97f7=_0x18eea4;return await this[_0x3c97f7(0x1a1)]['save'](_0x5b8e6c);}async[_0x18eea4(0x1ec)](_0x3bc06b,_0x21d298){const _0x2ed712=_0x18eea4,{id:_0x173adc}=_0x3bc06b[_0x2ed712(0x1c5)],{model:_0x881aca}=_0x21d298,_0x1c3dd0={'userId':_0x173adc,'type':balance_constant_1[_0x2ed712(0x1e4)]['PAINT_TYPE']};_0x881aca&&(_0x1c3dd0[_0x2ed712(0x1a7)]=_0x881aca,_0x881aca===_0x2ed712(0x1d9)&&(_0x1c3dd0[_0x2ed712(0x1a7)]=(0x0,typeorm_2['In'])([_0x2ed712(0x1d9),'dall-e-3'])));const _0x11975c=await this[_0x2ed712(0x1a1)][_0x2ed712(0x1b1)]({'where':_0x1c3dd0,'order':{'id':_0x2ed712(0x1b7)},'select':['id',_0x2ed712(0x1c4),_0x2ed712(0x18c),_0x2ed712(0x1c8),_0x2ed712(0x1e8),_0x2ed712(0x1a7),_0x2ed712(0x1dc),'type','fileInfo']});return _0x11975c[_0x2ed712(0x1d5)](_0x25807c=>{const _0x28d22c=_0x2ed712;if(_0x25807c['type']==='paintCount'){const _0x508da5=_0x25807c[_0x28d22c(0x1a7)]==='mj'?0x136:0xa0,_0x1daac8=_0x25807c['answer'][_0x28d22c(0x17c)](_0x28d22c(0x19f))?_0x28d22c(0x1f0):_0x28d22c(0x1c0),_0x12c7f4=_0x1daac8===_0x28d22c(0x1f0)?_0x28d22c(0x1da)+_0x508da5+_0x28d22c(0x1b6):'?x-oss-process=image/resize,w_'+_0x508da5;_0x25807c[_0x28d22c(0x1d1)]=_0x25807c[_0x28d22c(0x1c4)]+_0x12c7f4;try{_0x25807c[_0x28d22c(0x1ce)]=_0x25807c[_0x28d22c(0x1ce)]?JSON['parse'](_0x25807c[_0x28d22c(0x1ce)]):null;}catch(_0x55d630){_0x25807c['fileInfo']={};}}}),_0x11975c;}async[_0x18eea4(0x1e6)](_0x5741e8){const _0x43646e=_0x18eea4,{page:page=0x1,size:size=0x14,rec:_0x338670,userId:_0x14ae24,model:_0x4dccf0}=_0x5741e8,_0x4e5e3c={'type':balance_constant_1[_0x43646e(0x1e4)]['PAINT_TYPE'],'prompt':(0x0,typeorm_2[_0x43646e(0x193)])(''),'answer':(0x0,typeorm_2[_0x43646e(0x193)])('')};_0x338670&&Object['assign'](_0x4e5e3c,{'rec':_0x338670}),_0x14ae24&&Object[_0x43646e(0x198)](_0x4e5e3c,{'userId':_0x14ae24});_0x4dccf0&&(_0x4e5e3c[_0x43646e(0x1a7)]=_0x4dccf0,_0x4dccf0==='DALL-E2'&&(_0x4e5e3c[_0x43646e(0x1a7)]=(0x0,typeorm_2['In'])([_0x43646e(0x1d9),_0x43646e(0x199)])));const [_0x4be299,_0x53d343]=await this[_0x43646e(0x1a1)][_0x43646e(0x1df)]({'order':{'id':_0x43646e(0x1b7)},'skip':(page-0x1)*size,'take':size,'where':_0x4e5e3c});return _0x4be299[_0x43646e(0x1d5)](_0x12d7db=>{const _0x2ab215=_0x43646e;var _0x4d193a;if(_0x12d7db['type']===_0x2ab215(0x1b0)){const _0x16bf3c=_0x12d7db[_0x2ab215(0x1a7)]==='mj'?0x136:0xa0,_0x560a5f=_0x12d7db[_0x2ab215(0x1c4)]['includes'](_0x2ab215(0x19f))?_0x2ab215(0x1f0):_0x2ab215(0x1c0),_0x4d8795=_0x560a5f===_0x2ab215(0x1f0)?_0x2ab215(0x1da)+_0x16bf3c+_0x2ab215(0x1b6):'?x-oss-process=image/resize,w_'+_0x16bf3c;_0x12d7db[_0x2ab215(0x1d1)]=_0x12d7db['answer']+_0x4d8795;try{const _0x368560=_0x12d7db[_0x2ab215(0x1dc)]?JSON[_0x2ab215(0x197)](_0x12d7db[_0x2ab215(0x1dc)]):null;_0x368560&&(_0x368560?_0x12d7db[_0x2ab215(0x1ae)]=((_0x4d193a=_0x368560===null||_0x368560===void 0x0?void 0x0:_0x368560[_0x2ab215(0x1a2)][0x0])===null||_0x4d193a===void 0x0?void 0x0:_0x4d193a[_0x2ab215(0x1a2)]['length'])===0x5:_0x12d7db[_0x2ab215(0x1ae)]=![]);}catch(_0x133638){console[_0x2ab215(0x1f2)](_0x2ab215(0x183),_0x133638);}}}),{'rows':_0x4be299,'count':_0x53d343};}async[_0x18eea4(0x1a8)](_0x1739d6){const _0x26d2bf=_0x18eea4,{id:_0x28edfc}=_0x1739d6,_0x283944=await this[_0x26d2bf(0x1a1)]['findOne']({'where':{'id':_0x28edfc,'type':balance_constant_1[_0x26d2bf(0x1e4)][_0x26d2bf(0x1e5)]}});if(!_0x283944)throw new common_1[(_0x26d2bf(0x188))]('你推荐的图片不存在、请检查！',common_1[_0x26d2bf(0x1ac)][_0x26d2bf(0x1e7)]);const _0x385681=_0x283944[_0x26d2bf(0x1b5)]===0x1?0x0:0x1,_0x2351f8=await this[_0x26d2bf(0x1a1)][_0x26d2bf(0x18f)]({'id':_0x28edfc},{'rec':_0x385681});if(_0x2351f8[_0x26d2bf(0x1a6)]>0x0)return(_0x385681?'推荐':_0x26d2bf(0x18e))+_0x26d2bf(0x18a);throw new common_1[(_0x26d2bf(0x188))]('你操作的图片不存在、请检查！',common_1[_0x26d2bf(0x1ac)][_0x26d2bf(0x1e7)]);}async['exportExcel'](_0x35eacc,_0x5f20c7){const _0x25da60=_0x18eea4,_0xa23173={'type':balance_constant_1['DeductionKey'][_0x25da60(0x17e)]},{page:page=0x1,size:size=0x1e,prompt:_0x39e51e,email:_0x361c45}=_0x35eacc;_0x39e51e&&Object[_0x25da60(0x198)](_0xa23173,{'prompt':(0x0,typeorm_2[_0x25da60(0x19d)])('%'+_0x39e51e+'%')});if(_0x361c45){const _0x3c5efd=await this[_0x25da60(0x1b9)]['findOne']({'where':{'email':_0x361c45}});(_0x3c5efd===null||_0x3c5efd===void 0x0?void 0x0:_0x3c5efd['id'])&&Object[_0x25da60(0x198)](_0xa23173,{'userId':_0x3c5efd['id']});}const [_0x452b8e,_0x4475d5]=await this[_0x25da60(0x1a1)][_0x25da60(0x1df)]({'order':{'id':_0x25da60(0x1b7)},'skip':(page-0x1)*size,'take':size,'where':_0xa23173}),_0x2f677c=_0x452b8e['map'](_0x24a149=>_0x24a149['userId']),_0x4a7195=await this[_0x25da60(0x1b9)][_0x25da60(0x1b1)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2f677c)}}),_0x44b0f2=_0x452b8e[_0x25da60(0x1ea)](_0x5e5315=>{const _0x4d847a=_0x25da60,_0x5f4cf2=_0x4a7195[_0x4d847a(0x1b1)](_0x349a0f=>_0x349a0f['id']===_0x5e5315[_0x4d847a(0x180)]);return{'username':_0x5f4cf2?_0x5f4cf2[_0x4d847a(0x1dd)]:'','email':_0x5f4cf2?_0x5f4cf2['email']:'','prompt':_0x5e5315['prompt'],'answer':_0x5e5315[_0x4d847a(0x1c4)],'createdAt':(0x0,utils_1[_0x4d847a(0x1de)])(_0x5e5315['createdAt'])};}),_0x379ec6=new exceljs_1[(_0x25da60(0x1b3))][(_0x25da60(0x1eb))](),_0x43e9c9=_0x379ec6[_0x25da60(0x1d3)](_0x25da60(0x1bc));_0x43e9c9[_0x25da60(0x19c)]=[{'header':'用户名','key':_0x25da60(0x1dd),'width':0x14},{'header':_0x25da60(0x1e0),'key':_0x25da60(0x1be),'width':0x14},{'header':_0x25da60(0x189),'key':_0x25da60(0x1e3),'width':0x14},{'header':'提问问题','key':_0x25da60(0x18c),'width':0x50},{'header':'回答答案','key':'answer','width':0x96}],_0x44b0f2[_0x25da60(0x1d5)](_0x13a68b=>_0x43e9c9[_0x25da60(0x181)](_0x13a68b)),_0x5f20c7['setHeader'](_0x25da60(0x1e1),_0x25da60(0x1bf)),_0x5f20c7[_0x25da60(0x19a)](_0x25da60(0x1b8),_0x25da60(0x1a5)+_0x25da60(0x1ab)),await _0x379ec6[_0x25da60(0x1ee)][_0x25da60(0x1e9)](_0x5f20c7),_0x5f20c7[_0x25da60(0x1d7)]();}async[_0x18eea4(0x1cc)](_0x391995,_0x258e76){const _0x5910a7=_0x18eea4,{page:page=0x1,size:size=0x14,userId:_0x4b6c23,prompt:_0x184fd7}=_0x391995,_0x2e29f4={'type':balance_constant_1[_0x5910a7(0x1e4)][_0x5910a7(0x17e)],'prompt':(0x0,typeorm_2[_0x5910a7(0x193)])('')};_0x4b6c23&&Object[_0x5910a7(0x198)](_0x2e29f4,{'userId':_0x4b6c23}),_0x184fd7&&Object['assign'](_0x2e29f4,{'prompt':(0x0,typeorm_2[_0x5910a7(0x19d)])('%'+_0x184fd7+'%')});const [_0x1709e0,_0x2c7268]=await this['chatLogEntity'][_0x5910a7(0x1df)]({'order':{'id':_0x5910a7(0x1b7)},'skip':(page-0x1)*size,'take':size,'where':_0x2e29f4}),_0x682426=_0x1709e0[_0x5910a7(0x1ea)](_0xb5a783=>_0xb5a783[_0x5910a7(0x180)]),_0x1a6c28=await this[_0x5910a7(0x1b9)][_0x5910a7(0x1b1)]({'where':{'id':(0x0,typeorm_2['In'])(_0x682426)},'select':['id','username',_0x5910a7(0x1be)]});return _0x1709e0[_0x5910a7(0x1d5)](_0xb485ff=>{const _0x25cd0d=_0x5910a7,{username:_0x3a02a5,email:_0x5b11ac}=_0x1a6c28[_0x25cd0d(0x1b1)](_0x35ae19=>_0x35ae19['id']===_0xb485ff[_0x25cd0d(0x180)])||{};_0xb485ff['username']=_0x3a02a5,_0xb485ff[_0x25cd0d(0x1be)]=_0x5b11ac;}),_0x258e76[_0x5910a7(0x1c5)][_0x5910a7(0x182)]!==_0x5910a7(0x1d8)&&_0x1709e0[_0x5910a7(0x1d5)](_0x3b2ac3=>_0x3b2ac3[_0x5910a7(0x1be)]=(0x0,utils_1[_0x5910a7(0x19b)])(_0x3b2ac3['email'])),_0x1709e0[_0x5910a7(0x1d5)](_0x474e52=>{const _0x5ed3e7=_0x5910a7;!_0x474e52[_0x5ed3e7(0x1be)]&&(_0x474e52['email']=(_0x474e52===null||_0x474e52===void 0x0?void 0x0:_0x474e52[_0x5ed3e7(0x180)])+_0x5ed3e7(0x1d6)),!_0x474e52[_0x5ed3e7(0x1dd)]&&(_0x474e52['username']='游客'+(_0x474e52===null||_0x474e52===void 0x0?void 0x0:_0x474e52[_0x5ed3e7(0x180)]));}),{'rows':_0x1709e0,'count':_0x2c7268};}async[_0x18eea4(0x196)](_0x54b5ce,_0x363ac5){const _0x4c5e75=_0x18eea4,{id:_0x45e55f}=_0x54b5ce[_0x4c5e75(0x1c5)],{groupId:_0x39479e}=_0x363ac5,_0x43b400={'userId':_0x45e55f,'isDelete':![]};_0x39479e&&Object['assign'](_0x43b400,{'groupId':_0x39479e});if(_0x39479e){const _0x591d91=await this[_0x4c5e75(0x1ad)]['count']({'where':{'isDelete':![]}});if(_0x591d91===0x0)return[];}const _0x56b7e8=await this[_0x4c5e75(0x1a1)][_0x4c5e75(0x1b1)]({'where':_0x43b400});return _0x56b7e8[_0x4c5e75(0x1ea)](_0x35ef0a=>{const _0x30c7d7=_0x4c5e75,{prompt:_0x581603,role:_0x2ad74a,answer:_0x3d64ea,createdAt:_0x424547,model:_0x2543ba,conversationOptions:_0x571e81,requestOptions:_0x9b18d1,id:_0x10c3d9,imageUrl:_0x499a41}=_0x35ef0a;let _0x5f5018=null,_0x2e48ab=null;try{_0x5f5018=JSON['parse'](_0x571e81),_0x2e48ab=JSON[_0x30c7d7(0x197)](_0x9b18d1);}catch(_0x1a7c8f){}return{'chatId':_0x10c3d9,'dateTime':(0x0,utils_1[_0x30c7d7(0x1de)])(_0x424547),'text':_0x2ad74a===_0x30c7d7(0x1c5)?_0x581603:_0x3d64ea,'inversion':_0x2ad74a===_0x30c7d7(0x1c5),'error':![],'conversationOptions':_0x5f5018,'requestOptions':_0x2e48ab,'imageUrl':_0x499a41,'model':_0x2543ba};});}async['deleteChatLog'](_0x2962c2,_0x28d9ea){const _0x59aa17=_0x18eea4,{id:_0xc31f5d}=_0x2962c2[_0x59aa17(0x1c5)],{id:_0x23d30d}=_0x28d9ea,_0x5cdd1d=await this['chatLogEntity']['findOne']({'where':{'id':_0x23d30d,'userId':_0xc31f5d}});if(!_0x5cdd1d)throw new common_1[(_0x59aa17(0x188))](_0x59aa17(0x1e2),common_1[_0x59aa17(0x1ac)]['BAD_REQUEST']);const _0x4388e1=await this[_0x59aa17(0x1a1)][_0x59aa17(0x18f)]({'id':_0x23d30d},{'isDelete':!![]});if(_0x4388e1[_0x59aa17(0x1a6)]>0x0)return _0x59aa17(0x1cd);else throw new common_1[(_0x59aa17(0x188))](_0x59aa17(0x1e2),common_1['HttpStatus'][_0x59aa17(0x1e7)]);}async[_0x18eea4(0x17d)](_0x16c71e,_0x122717){const _0x30b066=_0x18eea4,{groupId:_0x45524c}=_0x122717,{id:_0xd12ed0}=_0x16c71e[_0x30b066(0x1c5)],_0x753f7d=await this[_0x30b066(0x1ad)][_0x30b066(0x1a0)]({'where':{'id':_0x45524c,'userId':_0xd12ed0}});if(!_0x753f7d)throw new common_1[(_0x30b066(0x188))](_0x30b066(0x1e2),common_1[_0x30b066(0x1ac)][_0x30b066(0x1e7)]);const _0x5973a3=await this[_0x30b066(0x1a1)][_0x30b066(0x18f)]({'groupId':_0x45524c},{'isDelete':!![]});if(_0x5973a3[_0x30b066(0x1a6)]>0x0)return'删除对话记录成功！';if(_0x5973a3[_0x30b066(0x1a6)]===0x0)throw new common_1[(_0x30b066(0x188))](_0x30b066(0x195),common_1[_0x30b066(0x1ac)][_0x30b066(0x1e7)]);}async[_0x18eea4(0x194)](_0x462849,_0x44b289){const _0x16c7a3=_0x18eea4,{id:_0x3b4f82}=_0x462849[_0x16c7a3(0x1c5)],{appId:_0x3d1755,page:page=0x1,size:size=0xa}=_0x44b289,[_0x205dd0,_0x566c69]=await this[_0x16c7a3(0x1a1)][_0x16c7a3(0x1df)]({'where':{'userId':_0x3b4f82,'appId':_0x3d1755,'role':_0x16c7a3(0x1db)},'order':{'id':_0x16c7a3(0x1b7)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x205dd0,'count':_0x566c69};}};ChatLogService=__decorate([(0x0,common_1[_0x18eea4(0x1c9)])(),__param(0x0,(0x0,typeorm_1[_0x18eea4(0x1ef)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x18eea4(0x1ef)])(user_entity_1[_0x18eea4(0x1aa)])),__param(0x2,(0x0,typeorm_1[_0x18eea4(0x1ef)])(chatGroup_entity_1[_0x18eea4(0x190)])),__metadata(_0x18eea4(0x192),[typeorm_2[_0x18eea4(0x1c3)],typeorm_2[_0x18eea4(0x1c3)],typeorm_2[_0x18eea4(0x1c3)]])],ChatLogService),exports[_0x18eea4(0x1ca)]=ChatLogService;