'use strict';function _0x5ad0(){const _0x2b4e5e=['HttpStatus','Logger','24080430YmSrBy','用户不存在','find','getDate','HttpException','andWhere','RechargeType','save','signInDate','saveRecordRechargeLog','push','length','3JZJmqQ','../globalConfig/globalConfig.service','defineProperty','endOf','SigninEntity','3156573JIwhFq','format','YYYY-MM-DD','__esModule','YYYY-MM-DD\x20HH:mm:ss','createQueryBuilder','1803486QDdDFY','getSignatureGiftConfig','__decorate','design:paramtypes','findOne','Sign\x20in\x20successful.','../../common/utils/date','decorate','403095WaqEdH','UserBalanceService','update','getRawMany','signinEntity','object','GlobalConfigService','addBalanceToUser','9955pxdWIs','../../common/constants/balance.constant','userBalanceService','function','../user/user.entity','976tZIGgl','userEntity','昨天没签到、今天重置天数！','今日已签到、改天再来吧!.','SIGN_IN','InjectRepository','@nestjs/typeorm','globalConfigService','99KXeqcN','day','select','isSigned','metadata','SigninService','signin.signInTime\x20>=\x20:firstDay','BAD_REQUEST','signin.userId\x20=\x20:userId','@nestjs/common','416152FeXTUK','user','8297712ybFhuI','debug','typeorm','昨天签到了、今天是连续签到！','default','getOwnPropertyDescriptor'];_0x5ad0=function(){return _0x2b4e5e;};return _0x5ad0();}const _0x301958=_0x4d2e;(function(_0x23ea40,_0x34e547){const _0x5dd124=_0x4d2e,_0x34903d=_0x23ea40();while(!![]){try{const _0x341b72=-parseInt(_0x5dd124(0x1b9))/0x1+parseInt(_0x5dd124(0x1b1))/0x2*(parseInt(_0x5dd124(0x1a6))/0x3)+-parseInt(_0x5dd124(0x1c6))/0x4*(-parseInt(_0x5dd124(0x1c1))/0x5)+parseInt(_0x5dd124(0x192))/0x6+parseInt(_0x5dd124(0x1ab))/0x7+-parseInt(_0x5dd124(0x1d8))/0x8*(-parseInt(_0x5dd124(0x1ce))/0x9)+-parseInt(_0x5dd124(0x19a))/0xa;if(_0x341b72===_0x34e547)break;else _0x34903d['push'](_0x34903d['shift']());}catch(_0xef8a8f){_0x34903d['push'](_0x34903d['shift']());}}}(_0x5ad0,0xefded));var __decorate=this&&this[_0x301958(0x1b3)]||function(_0x2c1a26,_0x4db35f,_0xc8339a,_0x49d01e){const _0x520a74=_0x301958;var _0x477547=arguments[_0x520a74(0x1a5)],_0x3e492b=_0x477547<0x3?_0x4db35f:_0x49d01e===null?_0x49d01e=Object[_0x520a74(0x197)](_0x4db35f,_0xc8339a):_0x49d01e,_0x52216e;if(typeof Reflect===_0x520a74(0x1be)&&typeof Reflect['decorate']===_0x520a74(0x1c4))_0x3e492b=Reflect[_0x520a74(0x1b8)](_0x2c1a26,_0x4db35f,_0xc8339a,_0x49d01e);else{for(var _0x56016f=_0x2c1a26[_0x520a74(0x1a5)]-0x1;_0x56016f>=0x0;_0x56016f--)if(_0x52216e=_0x2c1a26[_0x56016f])_0x3e492b=(_0x477547<0x3?_0x52216e(_0x3e492b):_0x477547>0x3?_0x52216e(_0x4db35f,_0xc8339a,_0x3e492b):_0x52216e(_0x4db35f,_0xc8339a))||_0x3e492b;}return _0x477547>0x3&&_0x3e492b&&Object[_0x520a74(0x1a8)](_0x4db35f,_0xc8339a,_0x3e492b),_0x3e492b;},__metadata=this&&this['__metadata']||function(_0x41d68f,_0x187cdb){const _0x18bac1=_0x301958;if(typeof Reflect===_0x18bac1(0x1be)&&typeof Reflect[_0x18bac1(0x1d2)]===_0x18bac1(0x1c4))return Reflect[_0x18bac1(0x1d2)](_0x41d68f,_0x187cdb);},__param=this&&this['__param']||function(_0x274999,_0x2e1630){return function(_0xb57509,_0x31578e){_0x2e1630(_0xb57509,_0x31578e,_0x274999);};};Object[_0x301958(0x1a8)](exports,_0x301958(0x1ae),{'value':!![]}),exports['SigninService']=void 0x0;const globalConfig_service_1=require(_0x301958(0x1a7)),userBalance_service_1=require('../userBalance/userBalance.service'),common_1=require(_0x301958(0x1d7)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x301958(0x1cc)),typeorm_2=require(_0x301958(0x194)),date_1=require(_0x301958(0x1b7)),user_entity_1=require(_0x301958(0x1c5)),balance_constant_1=require(_0x301958(0x1c2));let SigninService=class SigninService{constructor(_0x26b2ec,_0x5297d0,_0x50f364,_0x35eccc){const _0x8b0830=_0x301958;this[_0x8b0830(0x1bd)]=_0x26b2ec,this['userEntity']=_0x5297d0,this[_0x8b0830(0x1c3)]=_0x50f364,this['globalConfigService']=_0x35eccc;}async['sign'](_0x346896){const _0x593c62=_0x301958,{id:_0x54ec19}=_0x346896['user'],_0x1776a0=(0x0,date_1[_0x593c62(0x196)])(new Date())[_0x593c62(0x1ac)](_0x593c62(0x1ad)),_0xc8a58f=await this[_0x593c62(0x1bd)][_0x593c62(0x1b5)]({'where':{'userId':_0x54ec19,'signInDate':_0x1776a0}});if(_0xc8a58f)throw new common_1['HttpException'](_0x593c62(0x1c9),common_1[_0x593c62(0x198)][_0x593c62(0x1d5)]);const {model3Count:_0x202a78,model4Count:_0x4ed962,drawMjCount:_0x2c7538}=await this[_0x593c62(0x1cd)][_0x593c62(0x1b2)]();await this['signinEntity'][_0x593c62(0x1a1)]({'userId':_0x54ec19,'signInTime':new Date(),'signInDate':_0x1776a0,'isSigned':!![]}),await this[_0x593c62(0x1c3)][_0x593c62(0x1c0)](_0x54ec19,{'model3Count':_0x202a78,'model4Count':_0x4ed962,'drawMjCount':_0x2c7538}),await this[_0x593c62(0x1c3)][_0x593c62(0x1a3)]({'userId':_0x54ec19,'rechargeType':balance_constant_1[_0x593c62(0x1a0)][_0x593c62(0x1ca)],'model3Count':_0x202a78,'model4Count':_0x4ed962,'drawMjCount':_0x2c7538});const _0xd4866c=(0x0,date_1[_0x593c62(0x196)])(new Date())['subtract'](0x1,_0x593c62(0x1cf))[_0x593c62(0x1ac)](_0x593c62(0x1ad)),_0x472600=await this[_0x593c62(0x1bd)][_0x593c62(0x1b5)]({'where':{'userId':_0x54ec19,'signInDate':_0xd4866c}});if(_0x472600){common_1[_0x593c62(0x199)][_0x593c62(0x193)]('用户'+_0x54ec19+_0x593c62(0x195),_0x593c62(0x1d3));const _0x1aa033=await this['userEntity'][_0x593c62(0x1b5)]({'where':{'id':_0x54ec19}});if(!_0x1aa033)throw new common_1[(_0x593c62(0x19e))](_0x593c62(0x19b),common_1[_0x593c62(0x198)][_0x593c62(0x1d5)]);const {consecutiveDays:consecutiveDays=0x0}=_0x1aa033;await this[_0x593c62(0x1c7)][_0x593c62(0x1bb)]({'id':_0x54ec19},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x593c62(0x199)][_0x593c62(0x193)]('用户'+_0x54ec19+_0x593c62(0x1c8),'SigninService'),await this[_0x593c62(0x1c7)]['update']({'id':_0x54ec19},{'consecutiveDays':0x1});return _0x593c62(0x1b6);}async['getSigninLog'](_0x56d2ac){const _0x416661=_0x301958;try{const {id:_0x3d4039}=_0x56d2ac[_0x416661(0x1d9)],_0x33e0ce=(0x0,date_1[_0x416661(0x196)])()['startOf']('month')[_0x416661(0x1ac)](_0x416661(0x1af)),_0x151236=(0x0,date_1[_0x416661(0x196)])()[_0x416661(0x1a9)]('month')[_0x416661(0x1ac)](_0x416661(0x1af)),_0x2e520e=this[_0x416661(0x1bd)][_0x416661(0x1b0)]('signin'),_0x44c252=await _0x2e520e[_0x416661(0x1d0)]('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')[_0x416661(0x19f)](_0x416661(0x1d6),{'userId':_0x56d2ac['user']['id']})[_0x416661(0x19f)](_0x416661(0x1d4),{'firstDay':_0x33e0ce})[_0x416661(0x19f)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x151236})[_0x416661(0x1bc)](),_0x3c5b1e=new Date(_0x33e0ce),_0x2834ab=new Date(_0x151236),_0x58d2b2=[],_0x179b37=new Date(_0x3c5b1e);while(_0x179b37<=_0x2834ab){_0x58d2b2[_0x416661(0x1a4)]((0x0,date_1[_0x416661(0x196)])(new Date(_0x179b37))[_0x416661(0x1ac)](_0x416661(0x1ad))),_0x179b37['setDate'](_0x179b37[_0x416661(0x19d)]()+0x1);}const _0x5e7676=[];for(const _0x4fea01 of _0x58d2b2){const _0x250e6b=_0x44c252[_0x416661(0x19c)](_0x291ec1=>_0x291ec1[_0x416661(0x1a2)]===_0x4fea01);!_0x250e6b?_0x5e7676[_0x416661(0x1a4)]({'signInDate':_0x4fea01,'isSigned':![]}):(_0x250e6b[_0x416661(0x1d1)]=!![],_0x5e7676['push'](_0x250e6b));}return _0x5e7676;}catch(_0x4b5f3f){console['log']('error:\x20',_0x4b5f3f);throw new common_1[(_0x416661(0x19e))]('获取签到数据失败！',common_1['HttpStatus'][_0x416661(0x1d5)]);}}};function _0x4d2e(_0x22e0d6,_0x48b76e){const _0x5ad0b0=_0x5ad0();return _0x4d2e=function(_0x4d2e42,_0x4b94ef){_0x4d2e42=_0x4d2e42-0x192;let _0x7728eb=_0x5ad0b0[_0x4d2e42];return _0x7728eb;},_0x4d2e(_0x22e0d6,_0x48b76e);}SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x301958(0x1cb)])(signIn_entity_1[_0x301958(0x1aa)])),__param(0x1,(0x0,typeorm_1[_0x301958(0x1cb)])(user_entity_1['UserEntity'])),__metadata(_0x301958(0x1b4),[typeorm_2['Repository'],typeorm_2['Repository'],userBalance_service_1[_0x301958(0x1ba)],globalConfig_service_1[_0x301958(0x1bf)]])],SigninService),exports[_0x301958(0x1d3)]=SigninService;