'use strict';const _0x5705a8=_0x4848;(function(_0x365c76,_0x5acc88){const _0x1fb9f4=_0x4848,_0x53f8cc=_0x365c76();while(!![]){try{const _0x58a0d7=-parseInt(_0x1fb9f4(0xf8))/0x1*(-parseInt(_0x1fb9f4(0xd1))/0x2)+parseInt(_0x1fb9f4(0xd4))/0x3*(parseInt(_0x1fb9f4(0xf0))/0x4)+-parseInt(_0x1fb9f4(0xe2))/0x5*(parseInt(_0x1fb9f4(0x103))/0x6)+-parseInt(_0x1fb9f4(0xf6))/0x7+parseInt(_0x1fb9f4(0xc5))/0x8+parseInt(_0x1fb9f4(0xd8))/0x9+-parseInt(_0x1fb9f4(0xe8))/0xa;if(_0x58a0d7===_0x5acc88)break;else _0x53f8cc['push'](_0x53f8cc['shift']());}catch(_0x421404){_0x53f8cc['push'](_0x53f8cc['shift']());}}}(_0x9898,0xc0587));var __decorate=this&&this['__decorate']||function(_0x262d27,_0x2840fd,_0x16eb24,_0x4c118a){const _0x52d398=_0x4848;var _0xce9e23=arguments[_0x52d398(0xff)],_0x32cf61=_0xce9e23<0x3?_0x2840fd:_0x4c118a===null?_0x4c118a=Object[_0x52d398(0xdd)](_0x2840fd,_0x16eb24):_0x4c118a,_0xb6a664;if(typeof Reflect===_0x52d398(0xd0)&&typeof Reflect[_0x52d398(0xcf)]===_0x52d398(0xda))_0x32cf61=Reflect[_0x52d398(0xcf)](_0x262d27,_0x2840fd,_0x16eb24,_0x4c118a);else{for(var _0x2cfc7a=_0x262d27[_0x52d398(0xff)]-0x1;_0x2cfc7a>=0x0;_0x2cfc7a--)if(_0xb6a664=_0x262d27[_0x2cfc7a])_0x32cf61=(_0xce9e23<0x3?_0xb6a664(_0x32cf61):_0xce9e23>0x3?_0xb6a664(_0x2840fd,_0x16eb24,_0x32cf61):_0xb6a664(_0x2840fd,_0x16eb24))||_0x32cf61;}return _0xce9e23>0x3&&_0x32cf61&&Object[_0x52d398(0xc2)](_0x2840fd,_0x16eb24,_0x32cf61),_0x32cf61;},__metadata=this&&this[_0x5705a8(0xc7)]||function(_0x401571,_0x586998){const _0x22e88b=_0x5705a8;if(typeof Reflect===_0x22e88b(0xd0)&&typeof Reflect[_0x22e88b(0xeb)]==='function')return Reflect[_0x22e88b(0xeb)](_0x401571,_0x586998);},__param=this&&this[_0x5705a8(0xcd)]||function(_0x478624,_0x12fa5e){return function(_0x5359e0,_0x227670){_0x12fa5e(_0x5359e0,_0x227670,_0x478624);};};function _0x4848(_0x1fba16,_0x1ea519){const _0x9898c2=_0x9898();return _0x4848=function(_0x484884,_0x174f59){_0x484884=_0x484884-0xc0;let _0x393f68=_0x9898c2[_0x484884];return _0x393f68;},_0x4848(_0x1fba16,_0x1ea519);}Object[_0x5705a8(0xc2)](exports,'__esModule',{'value':!![]}),exports[_0x5705a8(0xf5)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),userBalance_service_1=require('../userBalance/userBalance.service'),common_1=require(_0x5705a8(0xed)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5705a8(0xc4)),date_1=require(_0x5705a8(0xdb)),user_entity_1=require('../user/user.entity'),balance_constant_1=require('../../common/constants/balance.constant');function _0x9898(){const _0x3bbe33=['default','362795DSBksl','InjectRepository','getSigninLog','createQueryBuilder','userBalanceService','获取签到数据失败！','19231830qXsiWL','error:\x20','signin.signInTime\x20<=\x20:lastDay','metadata','format','@nestjs/common','globalConfigService','昨天没签到、今天重置天数！','5305076uKPshz','push','YYYY-MM-DD\x20HH:mm:ss','day','HttpStatus','SigninService','5164411bpemph','design:paramtypes','1GvhImr','signin','BAD_REQUEST','signinEntity','saveRecordRechargeLog','UserBalanceService','month','length','signin.signInTime\x20>=\x20:firstDay','sign','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','48CnNHVD','SigninEntity','昨天签到了、今天是连续签到！','startOf','Injectable','Repository','YYYY-MM-DD','SIGN_IN','defineProperty','user','typeorm','6707880wdjRaL','Logger','__metadata','今日已签到、改天再来吧!.','save','debug','signin.userId\x20=\x20:userId','userEntity','__param','update','decorate','object','2660578zfraMf','find','andWhere','3WtYMZJ','用户不存在','addBalanceToUser','findOne','4808088UwJUEl','HttpException','function','../../common/utils/date','isSigned','getOwnPropertyDescriptor','UserEntity','getDate','select'];_0x9898=function(){return _0x3bbe33;};return _0x9898();}let SigninService=class SigninService{constructor(_0x283804,_0xf2254e,_0x4a3a04,_0x307fa0){const _0x14801b=_0x5705a8;this['signinEntity']=_0x283804,this[_0x14801b(0xcc)]=_0xf2254e,this['userBalanceService']=_0x4a3a04,this[_0x14801b(0xee)]=_0x307fa0;}async[_0x5705a8(0x101)](_0x4109e9){const _0x40f16c=_0x5705a8,{id:_0xcbb896}=_0x4109e9['user'],_0x919116=(0x0,date_1[_0x40f16c(0xe1)])(new Date())[_0x40f16c(0xec)](_0x40f16c(0xc0)),_0x2d4e90=await this[_0x40f16c(0xfb)][_0x40f16c(0xd7)]({'where':{'userId':_0xcbb896,'signInDate':_0x919116}});if(_0x2d4e90)throw new common_1[(_0x40f16c(0xd9))](_0x40f16c(0xc8),common_1[_0x40f16c(0xf4)]['BAD_REQUEST']);const {model3Count:_0x32e81e,model4Count:_0x35ed88,drawMjCount:_0x490526}=await this[_0x40f16c(0xee)]['getSignatureGiftConfig']();await this['signinEntity'][_0x40f16c(0xc9)]({'userId':_0xcbb896,'signInTime':new Date(),'signInDate':_0x919116,'isSigned':!![]}),await this[_0x40f16c(0xe6)][_0x40f16c(0xd6)](_0xcbb896,{'model3Count':_0x32e81e,'model4Count':_0x35ed88,'drawMjCount':_0x490526}),await this[_0x40f16c(0xe6)][_0x40f16c(0xfc)]({'userId':_0xcbb896,'rechargeType':balance_constant_1['RechargeType'][_0x40f16c(0xc1)],'model3Count':_0x32e81e,'model4Count':_0x35ed88,'drawMjCount':_0x490526});const _0x57432=(0x0,date_1[_0x40f16c(0xe1)])(new Date())['subtract'](0x1,_0x40f16c(0xf3))[_0x40f16c(0xec)](_0x40f16c(0xc0)),_0x3af581=await this[_0x40f16c(0xfb)][_0x40f16c(0xd7)]({'where':{'userId':_0xcbb896,'signInDate':_0x57432}});if(_0x3af581){common_1[_0x40f16c(0xc6)][_0x40f16c(0xca)]('用户'+_0xcbb896+_0x40f16c(0x105),_0x40f16c(0xf5));const _0x13a039=await this[_0x40f16c(0xcc)]['findOne']({'where':{'id':_0xcbb896}});if(!_0x13a039)throw new common_1[(_0x40f16c(0xd9))](_0x40f16c(0xd5),common_1[_0x40f16c(0xf4)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x13a039;await this[_0x40f16c(0xcc)]['update']({'id':_0xcbb896},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x40f16c(0xc6)]['debug']('用户'+_0xcbb896+_0x40f16c(0xef),_0x40f16c(0xf5)),await this[_0x40f16c(0xcc)][_0x40f16c(0xce)]({'id':_0xcbb896},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x5705a8(0xe4)](_0x5c37f1){const _0x5b8634=_0x5705a8;try{const {id:_0x59a57f}=_0x5c37f1[_0x5b8634(0xc3)],_0x5818c9=(0x0,date_1[_0x5b8634(0xe1)])()[_0x5b8634(0x106)]('month')['format'](_0x5b8634(0xf2)),_0x258b30=(0x0,date_1['default'])()['endOf'](_0x5b8634(0xfe))[_0x5b8634(0xec)]('YYYY-MM-DD\x20HH:mm:ss'),_0xdc17a7=this[_0x5b8634(0xfb)][_0x5b8634(0xe5)](_0x5b8634(0xf9)),_0x8d960d=await _0xdc17a7[_0x5b8634(0xe0)](_0x5b8634(0x102))[_0x5b8634(0xd3)](_0x5b8634(0xcb),{'userId':_0x5c37f1['user']['id']})['andWhere'](_0x5b8634(0x100),{'firstDay':_0x5818c9})['andWhere'](_0x5b8634(0xea),{'lastDay':_0x258b30})['getRawMany'](),_0x20bdfa=new Date(_0x5818c9),_0x3f46cd=new Date(_0x258b30),_0x3e7936=[],_0x10194e=new Date(_0x20bdfa);while(_0x10194e<=_0x3f46cd){_0x3e7936[_0x5b8634(0xf1)]((0x0,date_1[_0x5b8634(0xe1)])(new Date(_0x10194e))[_0x5b8634(0xec)]('YYYY-MM-DD')),_0x10194e['setDate'](_0x10194e[_0x5b8634(0xdf)]()+0x1);}const _0x246d20=[];for(const _0x4ae92f of _0x3e7936){const _0x25f36b=_0x8d960d[_0x5b8634(0xd2)](_0x24881d=>_0x24881d['signInDate']===_0x4ae92f);!_0x25f36b?_0x246d20['push']({'signInDate':_0x4ae92f,'isSigned':![]}):(_0x25f36b[_0x5b8634(0xdc)]=!![],_0x246d20[_0x5b8634(0xf1)](_0x25f36b));}return _0x246d20;}catch(_0x44ef1a){console['log'](_0x5b8634(0xe9),_0x44ef1a);throw new common_1[(_0x5b8634(0xd9))](_0x5b8634(0xe7),common_1[_0x5b8634(0xf4)][_0x5b8634(0xfa)]);}}};SigninService=__decorate([(0x0,common_1[_0x5705a8(0x107)])(),__param(0x0,(0x0,typeorm_1[_0x5705a8(0xe3)])(signIn_entity_1[_0x5705a8(0x104)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x5705a8(0xde)])),__metadata(_0x5705a8(0xf7),[typeorm_2[_0x5705a8(0x108)],typeorm_2[_0x5705a8(0x108)],userBalance_service_1[_0x5705a8(0xfd)],globalConfig_service_1['GlobalConfigService']])],SigninService),exports[_0x5705a8(0xf5)]=SigninService;