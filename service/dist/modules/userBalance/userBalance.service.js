'use strict';const _0x18a008=_0x513d;(function(_0x126698,_0x1a01c9){const _0x4ab9b7=_0x513d,_0x4bfd2e=_0x126698();while(!![]){try{const _0x4c9158=-parseInt(_0x4ab9b7(0x18e))/0x1+-parseInt(_0x4ab9b7(0x1aa))/0x2*(parseInt(_0x4ab9b7(0x12a))/0x3)+parseInt(_0x4ab9b7(0x1c2))/0x4*(-parseInt(_0x4ab9b7(0x16b))/0x5)+parseInt(_0x4ab9b7(0x1c4))/0x6*(-parseInt(_0x4ab9b7(0x19a))/0x7)+parseInt(_0x4ab9b7(0x113))/0x8+parseInt(_0x4ab9b7(0x114))/0x9+parseInt(_0x4ab9b7(0x158))/0xa;if(_0x4c9158===_0x1a01c9)break;else _0x4bfd2e['push'](_0x4bfd2e['shift']());}catch(_0x203c2e){_0x4bfd2e['push'](_0x4bfd2e['shift']());}}}(_0x5f11,0x6143a));var __decorate=this&&this['__decorate']||function(_0x56f6b4,_0x4e6172,_0x3f536a,_0x42b6c0){const _0xbadc73=_0x513d;var _0x296628=arguments['length'],_0x5309af=_0x296628<0x3?_0x4e6172:_0x42b6c0===null?_0x42b6c0=Object[_0xbadc73(0x136)](_0x4e6172,_0x3f536a):_0x42b6c0,_0x3a8bc7;if(typeof Reflect===_0xbadc73(0x18d)&&typeof Reflect[_0xbadc73(0x163)]===_0xbadc73(0x11b))_0x5309af=Reflect[_0xbadc73(0x163)](_0x56f6b4,_0x4e6172,_0x3f536a,_0x42b6c0);else{for(var _0x3dd3ef=_0x56f6b4[_0xbadc73(0x192)]-0x1;_0x3dd3ef>=0x0;_0x3dd3ef--)if(_0x3a8bc7=_0x56f6b4[_0x3dd3ef])_0x5309af=(_0x296628<0x3?_0x3a8bc7(_0x5309af):_0x296628>0x3?_0x3a8bc7(_0x4e6172,_0x3f536a,_0x5309af):_0x3a8bc7(_0x4e6172,_0x3f536a))||_0x5309af;}return _0x296628>0x3&&_0x5309af&&Object[_0xbadc73(0x18a)](_0x4e6172,_0x3f536a,_0x5309af),_0x5309af;},__metadata=this&&this[_0x18a008(0x120)]||function(_0x1efd4c,_0x4e47a1){const _0x2f85dd=_0x18a008;if(typeof Reflect===_0x2f85dd(0x18d)&&typeof Reflect[_0x2f85dd(0x134)]===_0x2f85dd(0x11b))return Reflect['metadata'](_0x1efd4c,_0x4e47a1);},__param=this&&this['__param']||function(_0x161a7f,_0xbb86d8){return function(_0x1267eb,_0x4d0758){_0xbb86d8(_0x1267eb,_0x4d0758,_0x161a7f);};};function _0x5f11(){const _0x385d77=['drawMjCount','../crami/cramiPackage.entity','invitedGuestSendModel4Count','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','查询当前用户余额失败！','metadata','model4','getOwnPropertyDescriptor','fingerprintLogEntity','../sales/salesUsers.entity','ConfigEntity','firstRegisterSendRank','BalanceService','model4Count','vxNumber','validateBalance','memberModel3Count','消费余额失败！','configEntity','registerSendDrawMjCount','mjDraw','isUpdatedToday','setConfig','旧账户信息迁移成功','BAD_REQUEST','odel3','avatar','registerSendModel3Count','getRechargeLog','LessThan','WhiteListEntity','validateVisitorBalance','accountLogEntity','odel4','upgradeStatus','invitedGuestSendDrawMjCount','chatLogEntity','ChatGroupEntity','PAYMENT_REQUIRED','查询用户账户信息失败！','globalConfigService','7704910BrfbmJ','ChatLogEntity','expirationTime','GlobalConfigService','inviteGiveSendModel4Count','total','phone','BalanceEntity','username','memberDrawMjCount','REG_GIFT','decorate','RechargeType','AccountLogEntity','count','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','userId','UserBalanceEntity','visitorModel3Num','412105UnqqYn','email','../../common/utils','refundMjBalance','findAndCount','user','createRandomUid','registerSendStatus','SalesUsersEntity','../chatgpt/whiteList.entity','deductFromBalance','rechargeType','upgradeBalance','addBalanceToUser','useDrawMjToken','旧账户信息迁移失败','./balance.entity','typeorm','affected','add','MidjourneyEntity','YYYY-MM-DD','useModel4Count','../chatLog/chatLog.entity','saveCommissionAmount','writeOldBalanceToNewTable','useModel3Token','super','../globalConfig/globalConfig.service','debug','../../common/utils/date','defineProperty','queryUserBalanceByIds','../../common/constants/balance.constant','object','491258UGlGaO','formatDate','updatedAt','chatGroupEntity','length','账户信息已经存在、迁移无效','UserBalanceService','then','model3','DESC','visitorModel4Num','salesUsersEntity','560NWWWUL','log','缺失当前套餐ID、充值失败！','update','save','days','headers','whiteListEntity','saveRecordRechargeLog','缺失当前用户账户记录！','非法操作、当前充值套餐暂不存在！','__esModule','inviteSendStatus','您已经升级过了、请勿重复操作！','status','commissionAmount','9094rnzgea','inviteGiveSendModel3Count','HttpException','UserEntity','catch','firstRegisterSendStatus','./userBalance.entity','../chatGroup/chatGroup.entity','CramiPackageEntity','firstRregisterSendModel4Count','Repository','充值的工单信息:','>\x20或购买专属套餐\x20！','memberModel4Count','configKey','./accountLog.entity','firstRregisterSendDrawMjCount','registerSendModel4Count','REFER_GIFT','queryUserBalance','useModel4Token','addBalanceToNewUser','sumDrawMjCount','Injectable','8FyIkzO','day','13278VoeqBK','userBalanceEntity','find','getConfigs','includes','../globalConfig/config.entity','YYYY-MM-DD\x20HH:mm:ss','cramiPackageEntity','inheritVisitorData','createBaseUserBalance','充值失败','SCAN_PAY','Logger','userEntity','InjectRepository','toFixed','inviteGiveSendDrawMjCount','default','@nestjs/common','model3Count','useModel3Count','midjourneyEntity','getVisitorCount','2112424trFEDi','5865210Wjnulr','weight','充值失败！','../midjourney/midjourney.entity','forEach','sumModel3Count','balanceEntity','function','visitorMJNum','FingerprintLogEntity','hideString','findOne','__metadata','SalesService','invitedGuestSendModel3Count','packageId','getAccountLog','salesService','formatCreateOrUpdateDate','design:paramtypes','HttpStatus','configVal','300XuuCsK','goodsId','getFullYear','error:\x20','@nestjs/typeorm'];_0x5f11=function(){return _0x385d77;};return _0x5f11();}Object[_0x18a008(0x18a)](exports,_0x18a008(0x1a5),{'value':!![]}),exports[_0x18a008(0x194)]=void 0x0;function _0x513d(_0x1c8455,_0x1cfb7d){const _0x5f11ea=_0x5f11();return _0x513d=function(_0x513d9d,_0x2c407a){_0x513d9d=_0x513d9d-0x112;let _0x576c24=_0x5f11ea[_0x513d9d];return _0x576c24;},_0x513d(_0x1c8455,_0x1cfb7d);}const globalConfig_service_1=require(_0x18a008(0x187)),typeorm_1=require(_0x18a008(0x12e)),balance_entity_1=require(_0x18a008(0x17b)),common_1=require(_0x18a008(0x1d6)),typeorm_2=require(_0x18a008(0x17c)),balance_constant_1=require(_0x18a008(0x18c)),accountLog_entity_1=require(_0x18a008(0x1b9)),utils_1=require(_0x18a008(0x16d)),config_entity_1=require(_0x18a008(0x1c9)),cramiPackage_entity_1=require(_0x18a008(0x130)),userBalance_entity_1=require(_0x18a008(0x1b0)),date_1=require(_0x18a008(0x189)),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x18a008(0x138)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x18a008(0x174)),fingerprint_entity_1=require('./fingerprint.entity'),chatLog_entity_1=require(_0x18a008(0x182)),chatGroup_entity_1=require(_0x18a008(0x1b1)),midjourney_entity_1=require(_0x18a008(0x117));let UserBalanceService=class UserBalanceService{constructor(_0x5f2c7,_0x4edf2c,_0x477837,_0x322f9a,_0x114782,_0x25ba6a,_0xacb257,_0x5238c5,_0x61b93,_0x4f496a,_0x10fea5,_0x5caa87,_0x2d6866,_0x18e220){const _0x416b04=_0x18a008;this[_0x416b04(0x11a)]=_0x5f2c7,this[_0x416b04(0x1c5)]=_0x4edf2c,this[_0x416b04(0x14f)]=_0x477837,this[_0x416b04(0x1cb)]=_0x322f9a,this[_0x416b04(0x141)]=_0x114782,this[_0x416b04(0x1d1)]=_0x25ba6a,this[_0x416b04(0x199)]=_0xacb257,this[_0x416b04(0x1a1)]=_0x5238c5,this[_0x416b04(0x137)]=_0x61b93,this['chatGroupEntity']=_0x4f496a,this[_0x416b04(0x153)]=_0x10fea5,this[_0x416b04(0x1d9)]=_0x5caa87,this['salesService']=_0x2d6866,this['globalConfigService']=_0x18e220;}async[_0x18a008(0x1bf)](_0x27013e,_0x5923ad){const _0x793a9a=_0x18a008;try{const _0x4c90e7=await this['configEntity'][_0x793a9a(0x1c6)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x793a9a(0x172),_0x793a9a(0x14a),_0x793a9a(0x1bb),_0x793a9a(0x142),_0x793a9a(0x1af),_0x793a9a(0x13a),'firstRregisterSendModel3Count','firstRregisterSendModel4Count','firstRregisterSendDrawMjCount',_0x793a9a(0x1a6),_0x793a9a(0x1ab),_0x793a9a(0x15c),_0x793a9a(0x1d4),_0x793a9a(0x122),_0x793a9a(0x152),'invitedGuestSendModel4Count'])}}),_0x35a89b=_0x4c90e7['reduce']((_0xc90429,_0x3135a3)=>{const _0x21c1ca=_0x793a9a,_0x456194=Number(_0x3135a3[_0x21c1ca(0x129)]),_0x233a72=Number['isInteger'](_0x456194)&&_0x456194>0x0?_0x456194:0x0;return _0xc90429[_0x3135a3[_0x21c1ca(0x1b8)]]=_0x233a72,_0xc90429;},{});let _0x2e3b7b=0x0,_0x1c9e7f=0x0,_0x53a31d=0x0;_0x35a89b['registerSendStatus']===0x1&&(_0x2e3b7b=_0x2e3b7b+_0x35a89b[_0x793a9a(0x14a)],_0x1c9e7f=_0x1c9e7f+_0x35a89b[_0x793a9a(0x1bb)],_0x53a31d=_0x53a31d+_0x35a89b[_0x793a9a(0x142)]),_0x35a89b[_0x793a9a(0x172)]===0x1&&_0x35a89b[_0x793a9a(0x1af)]===0x1&&_0x27013e<=_0x35a89b['firstRegisterSendRank']&&(_0x2e3b7b=_0x2e3b7b+_0x35a89b['firstRregisterSendModel3Count'],_0x1c9e7f=_0x1c9e7f+_0x35a89b[_0x793a9a(0x1b3)],_0x53a31d=_0x53a31d+_0x35a89b[_0x793a9a(0x1ba)]),await this[_0x793a9a(0x1a2)]({'userId':_0x27013e,'rechargeType':balance_constant_1[_0x793a9a(0x164)][_0x793a9a(0x162)],'model3Count':_0x2e3b7b,'drawMjCount':_0x53a31d,'model4Count':_0x1c9e7f}),_0x5923ad&&(Number(_0x35a89b[_0x793a9a(0x1a6)])===0x1&&(_0x2e3b7b=_0x2e3b7b+Number(_0x35a89b['invitedGuestSendModel3Count']),_0x1c9e7f=_0x1c9e7f+Number(_0x35a89b['invitedGuestSendModel4Count']),_0x53a31d=_0x53a31d+Number(_0x35a89b[_0x793a9a(0x152)]),await this[_0x793a9a(0x1a2)]({'userId':_0x27013e,'rechargeType':balance_constant_1['RechargeType']['INVITE_GIFT'],'model3Count':_0x35a89b[_0x793a9a(0x122)],'model4Count':_0x35a89b[_0x793a9a(0x131)],'drawMjCount':_0x35a89b[_0x793a9a(0x152)]}),await this[_0x793a9a(0x178)](_0x5923ad,{'model3Count':_0x35a89b[_0x793a9a(0x1ab)],'model4Count':_0x35a89b[_0x793a9a(0x15c)],'drawMjCount':_0x35a89b[_0x793a9a(0x1d4)]}),await this[_0x793a9a(0x1a2)]({'userId':_0x5923ad,'rechargeType':balance_constant_1[_0x793a9a(0x164)][_0x793a9a(0x1bc)],'model3Count':_0x35a89b[_0x793a9a(0x1ab)],'model4Count':_0x35a89b[_0x793a9a(0x15c)],'drawMjCount':_0x35a89b[_0x793a9a(0x1d4)]}))),await this[_0x793a9a(0x1c5)]['save']({'userId':_0x27013e,'model3Count':_0x2e3b7b,'model4Count':_0x1c9e7f,'drawMjCount':_0x53a31d,'useTokens':0x0});}catch(_0x760303){console[_0x793a9a(0x19b)](_0x793a9a(0x12d),_0x760303);throw new common_1[(_0x793a9a(0x1ac))]('注册赠送失败,请联系管理员！',common_1[_0x793a9a(0x128)][_0x793a9a(0x147)]);}}async[_0x18a008(0x13e)](_0x441857,_0x4029a7,_0x53cfb1){const _0x5589cf=_0x18a008,{id:_0x4e73cb,role:_0xd4c369}=_0x441857[_0x5589cf(0x170)];let _0x26f7c3=await this[_0x5589cf(0x1c5)]['findOne']({'where':{'userId':_0x4e73cb}});!_0x26f7c3&&(_0x26f7c3=await this[_0x5589cf(0x1cd)](_0x4e73cb));if(_0xd4c369==='visitor')return this[_0x5589cf(0x14e)](_0x441857,_0x4029a7,_0x53cfb1);const _0xb37ee=await this[_0x5589cf(0x141)]['findOne']({'where':{'configKey':_0x5589cf(0x13d)}}),_0x2db29d=_0xb37ee?_0xb37ee['configVal']:'---',_0xcb1e1d=_0x4029a7==='model3'?'memberModel3Count':_0x4029a7===_0x5589cf(0x135)?_0x5589cf(0x1b7):_0x4029a7==='mjDraw'?'memberDrawMjCount':null,_0x57dfd8=_0x4029a7===_0x5589cf(0x196)?'model3Count':_0x4029a7==='model4'?_0x5589cf(0x13c):_0x4029a7==='mjDraw'?_0x5589cf(0x12f):null;if(_0x26f7c3[_0x5589cf(0x123)]&&_0x26f7c3[_0xcb1e1d]<_0x53cfb1){if(_0x26f7c3[_0x57dfd8]<_0x53cfb1)throw new common_1[(_0x5589cf(0x1ac))](_0x5589cf(0x167)+_0x2db29d+_0x5589cf(0x1b6),common_1[_0x5589cf(0x128)]['PAYMENT_REQUIRED']);}if(!_0x26f7c3[_0x5589cf(0x123)]&&_0x26f7c3[_0x57dfd8]<_0x53cfb1)throw new common_1[(_0x5589cf(0x1ac))](_0x5589cf(0x167)+_0x2db29d+_0x5589cf(0x1b6),common_1['HttpStatus'][_0x5589cf(0x155)]);return _0x26f7c3;}async[_0x18a008(0x14e)](_0xa93060,_0x135929,_0xffeb00){const _0x2855d3=_0x18a008,{id:_0x544445}=_0xa93060['user'],_0x2eee8a=_0x135929===_0x2855d3(0x196)?'model3Count':_0x135929===_0x2855d3(0x135)?'model4Count':_0x135929==='mjDraw'?_0x2855d3(0x12f):null,_0x8b8c27=new Date(),_0x5641a8=await this[_0x2855d3(0x137)]['findOne']({'where':{'fingerprint':_0x544445}}),{visitorModel3Num:_0x311d1f,visitorModel4Num:_0x1997de,visitorMJNum:_0x481a1e}=await this[_0x2855d3(0x157)][_0x2855d3(0x1c7)]([_0x2855d3(0x16a),_0x2855d3(0x198),_0x2855d3(0x11c)]),_0x350aae={'model3Count':_0x311d1f?Number(_0x311d1f):0x0,'model4Count':_0x1997de?Number(_0x1997de):0x0,'drawMjCount':_0x481a1e?Number(_0x481a1e):0x0};if(!_0x5641a8){const _0xd828b3={'fingerprint':_0x544445,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0xd828b3[_0x2eee8a]=_0xd828b3[_0x2eee8a]+_0xffeb00;if(_0xd828b3[_0x2eee8a]>_0x350aae[_0x2eee8a])throw new common_1['HttpException']('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x2855d3(0x128)][_0x2855d3(0x155)]);else return await this[_0x2855d3(0x137)][_0x2855d3(0x19e)](_0xd828b3),!![];}else{const {model3Count:_0x53acce,model4Count:_0x1bd19a,drawMjCount:_0x3e6d2a}=_0x5641a8;let _0x3815d9={'model3Count':_0x53acce,'model4Count':_0x1bd19a,'drawMjCount':_0x3e6d2a};const _0x3809ac=Number(new Date(_0x5641a8[_0x2855d3(0x190)])),_0x222810=this['isUpdatedToday'](_0x3809ac);_0x222810?_0x3815d9[_0x2eee8a]=_0x3815d9[_0x2eee8a]+_0xffeb00:(_0x3815d9={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x3815d9[_0x2eee8a]=_0x3815d9[_0x2eee8a]+_0xffeb00);if(_0x3815d9[_0x2eee8a]>_0x350aae[_0x2eee8a])throw new common_1[(_0x2855d3(0x1ac))](_0x2855d3(0x132),common_1[_0x2855d3(0x128)][_0x2855d3(0x155)]);else return await this[_0x2855d3(0x137)][_0x2855d3(0x19d)]({'fingerprint':_0x544445},_0x3815d9),!![];}}[_0x18a008(0x144)](_0x30713d){const _0x291de0=_0x18a008,_0x1cc6f2=new Date(),_0x4c65db=new Date(_0x1cc6f2[_0x291de0(0x12c)](),_0x1cc6f2['getMonth'](),_0x1cc6f2['getDate']());return _0x30713d>=_0x4c65db;}async[_0x18a008(0x175)](_0xe8d7af,_0x56e696,_0x4b1e10,_0xe24859=0x0){const _0x4e989a=_0x18a008,_0x10cf87=await this[_0x4e989a(0x1c5)][_0x4e989a(0x11f)]({'where':{'userId':_0xe8d7af}});if(!_0x10cf87)throw new common_1['HttpException'](_0x4e989a(0x1a3),common_1[_0x4e989a(0x128)][_0x4e989a(0x147)]);const _0x4a0f3a=_0x56e696===_0x4e989a(0x196)?_0x4e989a(0x13f):_0x56e696===_0x4e989a(0x135)?'memberModel4Count':_0x56e696==='mjDraw'?_0x4e989a(0x161):null,_0x1d66c3=_0x56e696===_0x4e989a(0x196)?_0x4e989a(0x1d7):_0x56e696===_0x4e989a(0x135)?'model4Count':_0x56e696===_0x4e989a(0x143)?_0x4e989a(0x12f):null,_0x3d5ca5=_0x10cf87[_0x4e989a(0x123)]&&_0x10cf87[_0x4a0f3a]<_0x4b1e10?_0x1d66c3:_0x10cf87[_0x4e989a(0x123)]?_0x4a0f3a:_0x1d66c3;let _0x3f2a02=null;_0x3d5ca5[_0x4e989a(0x1c8)](_0x4e989a(0x148))&&(_0x3f2a02='useModel3Token');_0x3d5ca5['includes'](_0x4e989a(0x150))&&(_0x3f2a02=_0x4e989a(0x1be));_0x3d5ca5[_0x4e989a(0x1c8)]('MjCount')&&(_0x3f2a02='useDrawMjToken');const _0x5f4e75={[_0x3d5ca5]:_0x10cf87[_0x3d5ca5]-_0x4b1e10<0x0?0x0:_0x10cf87[_0x3d5ca5]-_0x4b1e10,[_0x3f2a02]:_0x10cf87[_0x3f2a02]+_0xe24859};_0x3f2a02==='useModel3Token'&&(_0x5f4e75[_0x4e989a(0x1d8)]=_0x10cf87['useModel3Count']+_0x4b1e10),_0x3f2a02===_0x4e989a(0x1be)&&(_0x5f4e75[_0x4e989a(0x181)]=_0x10cf87[_0x4e989a(0x181)]+_0x4b1e10);const _0x3599d8=await this[_0x4e989a(0x1c5)]['update']({'userId':_0xe8d7af},_0x5f4e75);if(_0x3599d8[_0x4e989a(0x17d)]===0x0)throw new common_1[(_0x4e989a(0x1ac))](_0x4e989a(0x140),common_1[_0x4e989a(0x128)][_0x4e989a(0x147)]);}async['queryUserBalance'](_0xe08a6b){const _0x56270d=_0x18a008;try{const _0x23c9f0=await this[_0x56270d(0x1c5)][_0x56270d(0x11f)]({'where':{'userId':_0xe08a6b},'select':[_0x56270d(0x123),_0x56270d(0x1d7),'model4Count',_0x56270d(0x12f),_0x56270d(0x13f),_0x56270d(0x1b7),_0x56270d(0x161),_0x56270d(0x1d8),_0x56270d(0x181),_0x56270d(0x185),_0x56270d(0x1be),_0x56270d(0x179),'expirationTime']});if(!_0x23c9f0){const _0x342293=await this[_0x56270d(0x1cd)](_0xe08a6b);if(_0x342293)return await this[_0x56270d(0x1bd)](_0xe08a6b);else throw new common_1[(_0x56270d(0x1ac))](_0x56270d(0x133),common_1[_0x56270d(0x128)]['BAD_REQUEST']);}return _0x23c9f0[_0x56270d(0x119)]=_0x23c9f0[_0x56270d(0x123)]?_0x23c9f0[_0x56270d(0x1d7)]+_0x23c9f0[_0x56270d(0x13f)]:_0x23c9f0[_0x56270d(0x1d7)],_0x23c9f0['sumModel4Count']=_0x23c9f0[_0x56270d(0x123)]?_0x23c9f0[_0x56270d(0x13c)]+_0x23c9f0[_0x56270d(0x1b7)]:_0x23c9f0['model4Count'],_0x23c9f0[_0x56270d(0x1c0)]=_0x23c9f0[_0x56270d(0x123)]?_0x23c9f0[_0x56270d(0x12f)]+_0x23c9f0[_0x56270d(0x161)]:_0x23c9f0[_0x56270d(0x12f)],_0x23c9f0[_0x56270d(0x15a)]=_0x23c9f0['expirationTime']?(0x0,date_1[_0x56270d(0x18f)])(_0x23c9f0[_0x56270d(0x15a)],_0x56270d(0x180)):null,_0x23c9f0;}catch(_0x987907){console['log'](_0x56270d(0x12d),_0x987907);}}async['saveRecordRechargeLog'](_0x3ae49e){const _0x564e5b=_0x18a008,{userId:_0x41a277,rechargeType:_0x4cda8f,model3Count:_0x1c35bc,model4Count:_0x1ec784,drawMjCount:_0xe49130,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3ae49e;if(!_0x41a277)throw new common_1['HttpException']('当前用户不存在,记录充值日志异常',common_1[_0x564e5b(0x128)][_0x564e5b(0x147)]);const _0x41d47f=(0x0,utils_1[_0x564e5b(0x171)])();return await this[_0x564e5b(0x14f)][_0x564e5b(0x19e)]({'userId':_0x41a277,'rechargeType':_0x4cda8f,'model3Count':_0x1c35bc,'model4Count':_0x1ec784,'drawMjCount':_0xe49130,'days':days,'extent':extent,'uid':_0x41d47f,'pkgName':pkgName});}async['createBaseUserBalance'](_0x46ed84,_0x486e3c={}){const _0x401635=_0x18a008,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x486e3c,_0x39c363=await this[_0x401635(0x1c5)][_0x401635(0x11f)]({'where':{'userId':_0x46ed84}});if(_0x39c363)throw new common_1[(_0x401635(0x1ac))]('当前用户无需创建账户信息！',common_1[_0x401635(0x128)][_0x401635(0x147)]);return await this[_0x401635(0x1c5)][_0x401635(0x19e)]({'userId':_0x46ed84,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x18a008(0x178)](_0x284c74,_0x530e1f,_0x527bc5=-0x1){const _0x3c43bc=_0x18a008;try{const _0x43cd51=await this[_0x3c43bc(0x1c5)][_0x3c43bc(0x11f)]({'where':{'userId':_0x284c74}})||await this[_0x3c43bc(0x1cd)](_0x284c74);if(!_0x43cd51)throw new common_1[(_0x3c43bc(0x1ac))](_0x3c43bc(0x156),common_1['HttpStatus'][_0x3c43bc(0x147)]);const {model3Count:_0x37682c,model4Count:_0x3b055e,drawMjCount:_0x1f6ca5,memberModel3Count:_0x5f0360,memberModel4Count:_0x3a9be2,memberDrawMjCount:_0x1fa43d}=_0x43cd51;let _0x51aa83={};if(_0x527bc5>0x0){const {packageId:_0x51384d}=_0x530e1f;if(!_0x51384d)throw new common_1[(_0x3c43bc(0x1ac))](_0x3c43bc(0x19c),common_1[_0x3c43bc(0x128)]['BAD_REQUEST']);const _0x2486a0=await this[_0x3c43bc(0x1cb)][_0x3c43bc(0x11f)]({'where':{'id':_0x51384d}});if(!_0x2486a0)throw new common_1[(_0x3c43bc(0x1ac))]('当前套餐不存在！',common_1[_0x3c43bc(0x128)]['BAD_REQUEST']);const {weight:_0x4b3977}=_0x2486a0;if(!_0x43cd51[_0x3c43bc(0x123)])_0x51aa83={'memberModel3Count':_0x37682c+_0x530e1f[_0x3c43bc(0x1d7)],'memberModel4Count':_0x3b055e+_0x530e1f['model4Count'],'memberDrawMjCount':_0x1f6ca5+_0x530e1f['drawMjCount'],'expirationTime':(0x0,date_1[_0x3c43bc(0x1d5)])()[_0x3c43bc(0x17e)](_0x527bc5>0x0?_0x527bc5:0x0,_0x3c43bc(0x1c3))['format'](_0x3c43bc(0x1ca)),'packageId':_0x51384d};else{const _0x2367c6=await this[_0x3c43bc(0x1cb)][_0x3c43bc(0x11f)]({'where':{'id':_0x43cd51[_0x3c43bc(0x123)]}});_0x4b3977>=_0x2367c6[_0x3c43bc(0x115)]&&(_0x51aa83={'memberModel3Count':_0x5f0360+_0x530e1f[_0x3c43bc(0x1d7)],'memberModel4Count':_0x3a9be2+_0x530e1f[_0x3c43bc(0x13c)],'memberDrawMjCount':_0x1fa43d+_0x530e1f[_0x3c43bc(0x12f)],'expirationTime':(0x0,date_1['default'])(_0x43cd51['expirationTime'])[_0x3c43bc(0x17e)](_0x527bc5>0x0?_0x527bc5:0x0,'day')['format'](_0x3c43bc(0x1ca)),'packageId':_0x51384d}),_0x4b3977<_0x2367c6[_0x3c43bc(0x115)]&&(_0x51aa83={'memberModel3Count':_0x5f0360+_0x530e1f['model3Count'],'memberModel4Count':_0x3a9be2+_0x530e1f[_0x3c43bc(0x13c)],'memberDrawMjCount':_0x1fa43d+_0x530e1f[_0x3c43bc(0x12f)]});}}_0x527bc5<=0x0&&(_0x51aa83={'model3Count':_0x37682c+_0x530e1f[_0x3c43bc(0x1d7)],'model4Count':_0x3b055e+_0x530e1f['model4Count'],'drawMjCount':_0x1f6ca5+_0x530e1f['drawMjCount']});const _0x3e2e57=await this[_0x3c43bc(0x1c5)][_0x3c43bc(0x19d)]({'userId':_0x284c74},_0x51aa83);if(_0x3e2e57['affected']===0x0)throw new common_1[(_0x3c43bc(0x1ac))](_0x284c74+_0x3c43bc(0x1ce),common_1[_0x3c43bc(0x128)][_0x3c43bc(0x147)]);}catch(_0x142103){console['log']('error:\x20',_0x142103);throw new common_1[(_0x3c43bc(0x1ac))]('用户充值失败！',common_1[_0x3c43bc(0x128)][_0x3c43bc(0x147)]);}}async['addBalanceToOrder'](_0x351e18){const _0x35dae8=_0x18a008;console[_0x35dae8(0x19b)](_0x35dae8(0x1b5),_0x351e18);try{const {userId:_0x2843ad,goodsId:_0x47089f}=_0x351e18,_0x39dd58=await this[_0x35dae8(0x1cb)][_0x35dae8(0x11f)]({'where':{'id':_0x351e18[_0x35dae8(0x12b)],'status':0x1}});if(!_0x39dd58)throw new common_1[(_0x35dae8(0x1ac))](_0x35dae8(0x1a4),common_1[_0x35dae8(0x128)][_0x35dae8(0x147)]);const {model3Count:_0x4d3551,model4Count:_0x1f2a54,drawMjCount:_0x15437d,days:_0x254091,name:_0xb0de03}=_0x39dd58,_0x3a3e14={'model3Count':_0x4d3551,'model4Count':_0x1f2a54,'drawMjCount':_0x15437d,'days':_0x254091,'packageId':_0x351e18[_0x35dae8(0x12b)]};await this[_0x35dae8(0x178)](_0x2843ad,_0x3a3e14,_0x254091),await this[_0x35dae8(0x1a2)]({'userId':_0x2843ad,'rechargeType':balance_constant_1[_0x35dae8(0x164)][_0x35dae8(0x1cf)],'model3Count':_0x4d3551,'model4Count':_0x1f2a54,'drawMjCount':_0x15437d,'pkgName':_0xb0de03,'days':_0x254091});const _0x5641fd=await this['userEntity'][_0x35dae8(0x11f)]({'where':{'id':_0x2843ad}}),{invitedBy:_0x51fa29}=_0x5641fd;if(_0x51fa29){const _0x60210=await this[_0x35dae8(0x1d1)][_0x35dae8(0x11f)]({'where':{'inviteCode':_0x51fa29}}),_0x27bc94=await this[_0x35dae8(0x199)][_0x35dae8(0x11f)]({'where':{'userId':_0x60210['id']}});if(!_0x60210)return;const {id:_0x4c3e21}=_0x60210,{performanceRatio:_0x1b1a2a}=_0x27bc94,_0x55f5c9={'inviterUserId':_0x4c3e21,'inviteeUserId':_0x2843ad,'orderId':_0x351e18['id'],'orderPrice':_0x351e18[_0x35dae8(0x15d)],'commissionPercentage':_0x1b1a2a,'commissionAmount':(_0x351e18['total']*_0x1b1a2a/0x64)[_0x35dae8(0x1d3)](0x2)};await this[_0x35dae8(0x125)]['createSalesRecords'](_0x55f5c9),await this[_0x35dae8(0x125)][_0x35dae8(0x183)](_0x4c3e21,_0x55f5c9[_0x35dae8(0x1a9)]);}}catch(_0x3e2600){console['log'](_0x35dae8(0x12d),_0x3e2600);throw new common_1[(_0x35dae8(0x1ac))](_0x35dae8(0x116),common_1[_0x35dae8(0x128)][_0x35dae8(0x147)]);}}async[_0x18a008(0x14b)](_0x4e6c0c,_0x36a897){const _0x4886d7=_0x18a008,{page:page=0x1,size:size=0x14}=_0x36a897,{id:_0x272bff}=_0x4e6c0c[_0x4886d7(0x170)],[_0x39e181,_0x55d7fc]=await this[_0x4886d7(0x14f)][_0x4886d7(0x16f)]({'where':{'userId':_0x272bff},'order':{'id':_0x4886d7(0x197)},'skip':(page-0x1)*size,'take':size});return _0x39e181[_0x4886d7(0x118)](_0x31e5e4=>{const _0x213cc3=_0x4886d7;_0x31e5e4['expireDateCn']=_0x31e5e4['days']>0x0?_0x31e5e4[_0x213cc3(0x19f)]+'天':'永久';}),{'rows':(0x0,date_1[_0x4886d7(0x126)])(_0x39e181),'count':_0x55d7fc};}async[_0x18a008(0x124)](_0x3c68d1,_0x4d8c34){const _0x4e1719=_0x18a008;try{const {page:page=0x1,size:size=0xa,userId:_0x39f109,rechargeType:_0x8bc8c2,packageId:_0x517de5}=_0x4d8c34,{role:_0x121944}=_0x3c68d1['user'],_0x352395={};_0x8bc8c2&&(_0x352395[_0x4e1719(0x176)]=_0x8bc8c2),_0x352395['userId']=_0x39f109||(0x0,typeorm_2[_0x4e1719(0x14c)])(0x186a0),_0x517de5&&(_0x352395[_0x4e1719(0x123)]={'$like':'%'+_0x517de5+'%'});const [_0x1e2fe0,_0x3ecfb7]=await this['accountLogEntity'][_0x4e1719(0x16f)]({'where':_0x352395,'order':{'id':_0x4e1719(0x197)},'skip':(page-0x1)*size,'take':size}),_0x38d835=_0x1e2fe0['map'](_0x4e464d=>_0x4e464d[_0x4e1719(0x168)]),_0x6cd775=await this[_0x4e1719(0x1d1)][_0x4e1719(0x1c6)]({'where':{'id':(0x0,typeorm_2['In'])(_0x38d835)}});return _0x1e2fe0[_0x4e1719(0x118)](_0x3be79f=>{const _0x372dd5=_0x4e1719,_0x32d1e6=_0x6cd775['find'](_0x1e3f5e=>_0x1e3f5e['id']===_0x3be79f[_0x372dd5(0x168)]);_0x3be79f[_0x372dd5(0x160)]=_0x32d1e6===null||_0x32d1e6===void 0x0?void 0x0:_0x32d1e6[_0x372dd5(0x160)],_0x3be79f[_0x372dd5(0x16c)]=_0x32d1e6===null||_0x32d1e6===void 0x0?void 0x0:_0x32d1e6[_0x372dd5(0x16c)],_0x3be79f[_0x372dd5(0x15e)]=_0x32d1e6===null||_0x32d1e6===void 0x0?void 0x0:_0x32d1e6[_0x372dd5(0x15e)],_0x3be79f[_0x372dd5(0x1a8)]=_0x32d1e6===null||_0x32d1e6===void 0x0?void 0x0:_0x32d1e6[_0x372dd5(0x1a8)],_0x3be79f[_0x372dd5(0x149)]=_0x32d1e6===null||_0x32d1e6===void 0x0?void 0x0:_0x32d1e6['avatar'];}),_0x121944!==_0x4e1719(0x186)&&_0x1e2fe0['forEach'](_0x58848b=>{const _0x186820=_0x4e1719;_0x58848b[_0x186820(0x16c)]=_0x58848b[_0x186820(0x16c)]?(0x0,utils_1[_0x186820(0x11e)])(_0x58848b[_0x186820(0x16c)]):'',_0x58848b[_0x186820(0x15e)]=_0x58848b[_0x186820(0x15e)]?(0x0,utils_1[_0x186820(0x11e)])(_0x58848b[_0x186820(0x15e)]):'';}),{'rows':_0x1e2fe0,'count':_0x3ecfb7};}catch(_0x299a1b){console[_0x4e1719(0x19b)](_0x4e1719(0x12d),_0x299a1b);throw new common_1[(_0x4e1719(0x1ac))]('查询用户账户失败！',common_1['HttpStatus'][_0x4e1719(0x147)]);}}async[_0x18a008(0x18b)](_0x3f6a8c){const _0x48172b=_0x18a008;return await this[_0x48172b(0x1c5)][_0x48172b(0x1c6)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x3f6a8c)}});}async[_0x18a008(0x16e)](_0x51db88,_0x51333c){const _0x36f8d0=_0x18a008;return await this[_0x36f8d0(0x175)](_0x51db88,_0x36f8d0(0x143),-_0x51333c);}async[_0x18a008(0x177)](){const _0x197d35=_0x18a008,_0x1e0214=await this[_0x197d35(0x1d1)]['find']();if(!_0x1e0214[_0x197d35(0x192)])return;const _0x32f910=await this['globalConfigService']['getConfigs']([_0x197d35(0x151)]);if(!_0x32f910)await this[_0x197d35(0x157)][_0x197d35(0x145)]({'settings':[{'configKey':_0x197d35(0x151),'configVal':'1'}]});else throw new common_1[(_0x197d35(0x1ac))](_0x197d35(0x1a7),common_1[_0x197d35(0x128)][_0x197d35(0x147)]);_0x1e0214[_0x197d35(0x118)](_0x18a2a9=>{const _0x444562=_0x197d35,{id:_0x22b3e8}=_0x18a2a9;this['balanceEntity'][_0x444562(0x11f)]({'where':{'userId':_0x22b3e8}})[_0x444562(0x195)](_0x4b94fe=>{const _0x536f5d=_0x444562;if(!_0x4b94fe)return;this[_0x536f5d(0x184)](_0x22b3e8,_0x4b94fe);});});}async[_0x18a008(0x184)](_0x14c075,_0x4946ad){const _0x4e4e47=_0x18a008,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x4946ad,_0x135e6b=await this[_0x4e4e47(0x1a1)][_0x4e4e47(0x11f)]({'where':{'userId':_0x14c075}}),_0x329ca5={'userId':_0x14c075,'model3Count':Number(usesLeft),'model4Count':(_0x135e6b===null||_0x135e6b===void 0x0?void 0x0:_0x135e6b['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x135e6b===null||_0x135e6b===void 0x0?void 0x0:_0x135e6b['useCount'])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x24bc49=await this[_0x4e4e47(0x1c5)]['findOne']({'where':{'userId':_0x14c075}});_0x24bc49?common_1[_0x4e4e47(0x1d0)][_0x4e4e47(0x188)]('用户'+_0x14c075+_0x4e4e47(0x193),_0x4e4e47(0x13b)):this[_0x4e4e47(0x1c5)]['save'](_0x329ca5)[_0x4e4e47(0x195)](_0x5b6adb=>{const _0x4a01bc=_0x4e4e47;common_1[_0x4a01bc(0x1d0)][_0x4a01bc(0x188)]('用户'+_0x14c075+_0x4a01bc(0x146),_0x4a01bc(0x13b));})[_0x4e4e47(0x1ae)](_0xef811d=>{const _0x183072=_0x4e4e47;console[_0x183072(0x19b)](_0x183072(0x12d),_0xef811d),common_1[_0x183072(0x1d0)][_0x183072(0x188)]('用户'+_0x14c075+_0x183072(0x17a),'BalanceService');});}async[_0x18a008(0x1cc)](_0x9124b3){const _0x3a29e6=_0x18a008,{fingerprint:_0x12b50c}=_0x9124b3[_0x3a29e6(0x1a0)],{id:_0x30759d}=_0x9124b3[_0x3a29e6(0x170)];return await this[_0x3a29e6(0x153)][_0x3a29e6(0x19d)]({'userId':Number(_0x12b50c)},{'userId':_0x30759d}),await this[_0x3a29e6(0x191)][_0x3a29e6(0x19d)]({'userId':Number(_0x12b50c)},{'userId':_0x30759d}),await this[_0x3a29e6(0x1d9)][_0x3a29e6(0x19d)]({'userId':Number(_0x12b50c)},{'userId':_0x30759d}),0x1;}async[_0x18a008(0x112)](_0x4cffde){const _0x294fdb=_0x18a008,{fingerprint:_0xb2445a}=_0x4cffde[_0x294fdb(0x1a0)],_0x555f40=await this['chatLogEntity'][_0x294fdb(0x166)]({'where':{'userId':_0xb2445a}}),_0x1e0ed7=await this[_0x294fdb(0x191)][_0x294fdb(0x166)]({'where':{'userId':_0xb2445a}}),_0x4ace90=await this['midjourneyEntity'][_0x294fdb(0x166)]({'where':{'userId':_0xb2445a}});return _0x555f40||_0x1e0ed7||_0x4ace90||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x18a008(0x1c1)])(),__param(0x0,(0x0,typeorm_1[_0x18a008(0x1d2)])(balance_entity_1[_0x18a008(0x15f)])),__param(0x1,(0x0,typeorm_1[_0x18a008(0x1d2)])(userBalance_entity_1[_0x18a008(0x169)])),__param(0x2,(0x0,typeorm_1[_0x18a008(0x1d2)])(accountLog_entity_1[_0x18a008(0x165)])),__param(0x3,(0x0,typeorm_1[_0x18a008(0x1d2)])(cramiPackage_entity_1[_0x18a008(0x1b2)])),__param(0x4,(0x0,typeorm_1[_0x18a008(0x1d2)])(config_entity_1[_0x18a008(0x139)])),__param(0x5,(0x0,typeorm_1[_0x18a008(0x1d2)])(user_entity_1[_0x18a008(0x1ad)])),__param(0x6,(0x0,typeorm_1[_0x18a008(0x1d2)])(salesUsers_entity_1[_0x18a008(0x173)])),__param(0x7,(0x0,typeorm_1[_0x18a008(0x1d2)])(whiteList_entity_1[_0x18a008(0x14d)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x18a008(0x11d)])),__param(0x9,(0x0,typeorm_1[_0x18a008(0x1d2)])(chatGroup_entity_1[_0x18a008(0x154)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x18a008(0x159)])),__param(0xb,(0x0,typeorm_1[_0x18a008(0x1d2)])(midjourney_entity_1[_0x18a008(0x17f)])),__metadata(_0x18a008(0x127),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],typeorm_2[_0x18a008(0x1b4)],sales_service_1[_0x18a008(0x121)],globalConfig_service_1[_0x18a008(0x15b)]])],UserBalanceService),exports[_0x18a008(0x194)]=UserBalanceService;