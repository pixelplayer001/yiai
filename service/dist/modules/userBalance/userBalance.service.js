'use strict';function _0x1e01(){const _0x218a50=['UserBalanceEntity','saveCommissionAmount','getOwnPropertyDescriptor','GlobalConfigService','30TxIgeg','./fingerprint.entity','user','status','registerSendModel3Count','充值失败！','69684ZDqVZK','odel4','查询用户账户信息失败！','__esModule','drawMjCount','../midjourney/midjourney.entity','Repository','registerSendStatus','userBalanceEntity','HttpException','visitorModel4Num','AccountLogEntity','weight','expirationTime','function','10eYhBXM','isUpdatedToday','UserBalanceService','217HIfeml','createBaseUserBalance','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','getAccountLog','9778599qeFIHu','ChatGroupEntity','缺失当前用户账户记录！','FingerprintLogEntity','saveRecordRechargeLog','whiteListEntity','days','useModel3Token','866891wbqlly','getMonth','findOne','sumDrawMjCount','avatar','YYYY-MM-DD\x20HH:mm:ss','configVal','473262ykNlsa','useModel4Token','then','>\x20或购买专属套餐\x20！','chatGroupEntity','globalConfigService','@nestjs/typeorm','includes','accountLogEntity','../globalConfig/globalConfig.service','旧账户信息迁移失败','充值的工单信息:','firstRegisterSendStatus','updatedAt','../../common/utils','invitedGuestSendModel4Count','当前套餐不存在！','useDrawMjToken','fingerprintLogEntity','BalanceService','注册赠送失败,请联系管理员！','visitorMJNum','length','createSalesRecords','HttpStatus','248624BViIJO','configKey','midjourneyEntity','add','非法操作、当前充值套餐暂不存在！','salesUsersEntity','expireDateCn','addBalanceToNewUser','queryUserBalanceByIds','forEach','当前用户无需创建账户信息！','cramiPackageEntity','username','firstRregisterSendModel3Count','visitor','当前用户不存在,记录充值日志异常','BAD_REQUEST','3927AroHug','model3','object','memberModel3Count','useCount','update','./accountLog.entity','firstRregisterSendDrawMjCount','registerSendDrawMjCount','inviteGiveSendDrawMjCount','deductFromBalance','invitedGuestSendDrawMjCount','memberModel4Count','---','../../common/utils/date','YYYY-MM-DD','rechargeType','sumModel3Count','RechargeType','userEntity','@nestjs/common','DESC','PAYMENT_REQUIRED','odel3','total','count','isInteger','951QcoGSk','affected','Logger','addBalanceToOrder','queryUserBalance','mjDraw','2636kwGLbD','inviteGiveSendModel4Count','goodsId','inviteGiveSendModel3Count','../chatGroup/chatGroup.entity','save','salesService','../chatLog/chatLog.entity','inheritVisitorData','__param','useModel4Count','writeOldBalanceToNewTable','debug','catch','REFER_GIFT','super','vxNumber','setConfig','error:\x20','default','../../common/constants/balance.constant','email','inviteSendStatus','./userBalance.entity','decorate','Injectable','sumModel4Count','firstRegisterSendRank','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','../sales/salesUsers.entity','find','账户信息已经存在、迁移无效','headers','SalesUsersEntity','configEntity','invitedGuestSendModel3Count','metadata','design:paramtypes','model4','addBalanceToUser','InjectRepository','hideString','useModel3Count','packageId','balanceEntity','visitorModel3Num','SalesService','getFullYear','day','log','../chatgpt/whiteList.entity','userId','查询用户账户失败！','chatLogEntity','../globalConfig/config.entity','MidjourneyEntity','memberDrawMjCount','getDate','getVisitorCount','phone','registerSendModel4Count','getRechargeLog','__metadata','model4Count','defineProperty','findAndCount','format','1672956yBygpa','formatDate','model3Count','UserEntity','LessThan','消费余额失败！','CramiPackageEntity','refundMjBalance'];_0x1e01=function(){return _0x218a50;};return _0x1e01();}const _0x36b845=_0x35f8;function _0x35f8(_0x43beef,_0x2f6bf4){const _0x1e019e=_0x1e01();return _0x35f8=function(_0x35f838,_0x29947f){_0x35f838=_0x35f838-0x162;let _0x124883=_0x1e019e[_0x35f838];return _0x124883;},_0x35f8(_0x43beef,_0x2f6bf4);}(function(_0x1333e1,_0x5afc62){const _0x358a10=_0x35f8,_0x2e39bf=_0x1333e1();while(!![]){try{const _0x1742c9=-parseInt(_0x358a10(0x1bc))/0x1+parseInt(_0x358a10(0x20e))/0x2*(parseInt(_0x358a10(0x208))/0x3)+-parseInt(_0x358a10(0x18c))/0x4+-parseInt(_0x358a10(0x198))/0x5*(parseInt(_0x358a10(0x1c3))/0x6)+-parseInt(_0x358a10(0x1b0))/0x7*(-parseInt(_0x358a10(0x1dc))/0x8)+parseInt(_0x358a10(0x1b4))/0x9*(-parseInt(_0x358a10(0x1ad))/0xa)+-parseInt(_0x358a10(0x1ed))/0xb*(-parseInt(_0x358a10(0x19e))/0xc);if(_0x1742c9===_0x5afc62)break;else _0x2e39bf['push'](_0x2e39bf['shift']());}catch(_0x231205){_0x2e39bf['push'](_0x2e39bf['shift']());}}}(_0x1e01,0x94c8c));var __decorate=this&&this['__decorate']||function(_0x2e1195,_0x4f1e07,_0x573e53,_0x5dc0cd){const _0x20fdd1=_0x35f8;var _0x13a0c9=arguments[_0x20fdd1(0x1d9)],_0x10348c=_0x13a0c9<0x3?_0x4f1e07:_0x5dc0cd===null?_0x5dc0cd=Object[_0x20fdd1(0x196)](_0x4f1e07,_0x573e53):_0x5dc0cd,_0x4b6318;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x20fdd1(0x1ac))_0x10348c=Reflect[_0x20fdd1(0x226)](_0x2e1195,_0x4f1e07,_0x573e53,_0x5dc0cd);else{for(var _0x4cfbf0=_0x2e1195[_0x20fdd1(0x1d9)]-0x1;_0x4cfbf0>=0x0;_0x4cfbf0--)if(_0x4b6318=_0x2e1195[_0x4cfbf0])_0x10348c=(_0x13a0c9<0x3?_0x4b6318(_0x10348c):_0x13a0c9>0x3?_0x4b6318(_0x4f1e07,_0x573e53,_0x10348c):_0x4b6318(_0x4f1e07,_0x573e53))||_0x10348c;}return _0x13a0c9>0x3&&_0x10348c&&Object['defineProperty'](_0x4f1e07,_0x573e53,_0x10348c),_0x10348c;},__metadata=this&&this[_0x36b845(0x187)]||function(_0x36caef,_0x224b41){const _0x51f5c8=_0x36b845;if(typeof Reflect===_0x51f5c8(0x1ef)&&typeof Reflect[_0x51f5c8(0x16d)]===_0x51f5c8(0x1ac))return Reflect[_0x51f5c8(0x16d)](_0x36caef,_0x224b41);},__param=this&&this[_0x36b845(0x217)]||function(_0x56678d,_0x52900a){return function(_0x41a890,_0x4a459b){_0x52900a(_0x41a890,_0x4a459b,_0x56678d);};};Object[_0x36b845(0x189)](exports,_0x36b845(0x1a1),{'value':!![]}),exports[_0x36b845(0x1af)]=void 0x0;const globalConfig_service_1=require(_0x36b845(0x1cc)),typeorm_1=require(_0x36b845(0x1c9)),balance_entity_1=require('./balance.entity'),common_1=require(_0x36b845(0x201)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x36b845(0x222)),accountLog_entity_1=require(_0x36b845(0x1f3)),utils_1=require(_0x36b845(0x1d1)),config_entity_1=require(_0x36b845(0x17f)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_entity_1=require(_0x36b845(0x225)),date_1=require(_0x36b845(0x1fb)),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x36b845(0x166)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x36b845(0x17b)),fingerprint_entity_1=require(_0x36b845(0x199)),chatLog_entity_1=require(_0x36b845(0x215)),chatGroup_entity_1=require(_0x36b845(0x212)),midjourney_entity_1=require(_0x36b845(0x1a3));let UserBalanceService=class UserBalanceService{constructor(_0x560dae,_0x2f9b0d,_0x46cf44,_0x15a242,_0x2e6902,_0x39989a,_0x275a31,_0x4f9add,_0x7564c9,_0x3fab0a,_0x1bbf1d,_0x4a4355,_0x3e84c7,_0x14f100){const _0xab3a5c=_0x36b845;this[_0xab3a5c(0x175)]=_0x560dae,this[_0xab3a5c(0x1a6)]=_0x2f9b0d,this[_0xab3a5c(0x1cb)]=_0x46cf44,this[_0xab3a5c(0x1e7)]=_0x15a242,this[_0xab3a5c(0x16b)]=_0x2e6902,this['userEntity']=_0x39989a,this[_0xab3a5c(0x1e1)]=_0x275a31,this[_0xab3a5c(0x1b9)]=_0x4f9add,this[_0xab3a5c(0x1d5)]=_0x7564c9,this[_0xab3a5c(0x1c7)]=_0x3fab0a,this[_0xab3a5c(0x17e)]=_0x1bbf1d,this[_0xab3a5c(0x1de)]=_0x4a4355,this['salesService']=_0x3e84c7,this[_0xab3a5c(0x1c8)]=_0x14f100;}async[_0x36b845(0x1e3)](_0x1c3d61,_0x1b89da){const _0xb74456=_0x36b845;try{const _0x8bdb0c=await this[_0xb74456(0x16b)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0xb74456(0x1a5),_0xb74456(0x19c),_0xb74456(0x185),_0xb74456(0x1f5),_0xb74456(0x1cf),_0xb74456(0x164),_0xb74456(0x1e9),'firstRregisterSendModel4Count',_0xb74456(0x1f4),_0xb74456(0x224),'inviteGiveSendModel3Count',_0xb74456(0x20f),'inviteGiveSendDrawMjCount',_0xb74456(0x16c),'invitedGuestSendDrawMjCount',_0xb74456(0x1d2)])}}),_0x521e89=_0x8bdb0c['reduce']((_0x3932ef,_0x563103)=>{const _0x3851be=_0xb74456,_0x192d87=Number(_0x563103[_0x3851be(0x1c2)]),_0x5f49fc=Number[_0x3851be(0x207)](_0x192d87)&&_0x192d87>0x0?_0x192d87:0x0;return _0x3932ef[_0x563103[_0x3851be(0x1dd)]]=_0x5f49fc,_0x3932ef;},{});let _0xdc09b9=0x0,_0x42c08e=0x0,_0x3d93bc=0x0;_0x521e89[_0xb74456(0x1a5)]===0x1&&(_0xdc09b9=_0xdc09b9+_0x521e89[_0xb74456(0x19c)],_0x42c08e=_0x42c08e+_0x521e89[_0xb74456(0x185)],_0x3d93bc=_0x3d93bc+_0x521e89[_0xb74456(0x1f5)]),_0x521e89[_0xb74456(0x1a5)]===0x1&&_0x521e89[_0xb74456(0x1cf)]===0x1&&_0x1c3d61<=_0x521e89[_0xb74456(0x164)]&&(_0xdc09b9=_0xdc09b9+_0x521e89[_0xb74456(0x1e9)],_0x42c08e=_0x42c08e+_0x521e89['firstRregisterSendModel4Count'],_0x3d93bc=_0x3d93bc+_0x521e89[_0xb74456(0x1f4)]),await this[_0xb74456(0x1b8)]({'userId':_0x1c3d61,'rechargeType':balance_constant_1['RechargeType']['REG_GIFT'],'model3Count':_0xdc09b9,'drawMjCount':_0x3d93bc,'model4Count':_0x42c08e}),_0x1b89da&&(Number(_0x521e89[_0xb74456(0x224)])===0x1&&(_0xdc09b9=_0xdc09b9+Number(_0x521e89[_0xb74456(0x16c)]),_0x42c08e=_0x42c08e+Number(_0x521e89[_0xb74456(0x1d2)]),_0x3d93bc=_0x3d93bc+Number(_0x521e89[_0xb74456(0x1f8)]),await this[_0xb74456(0x1b8)]({'userId':_0x1c3d61,'rechargeType':balance_constant_1[_0xb74456(0x1ff)]['INVITE_GIFT'],'model3Count':_0x521e89[_0xb74456(0x16c)],'model4Count':_0x521e89[_0xb74456(0x1d2)],'drawMjCount':_0x521e89[_0xb74456(0x1f8)]}),await this[_0xb74456(0x170)](_0x1b89da,{'model3Count':_0x521e89['inviteGiveSendModel3Count'],'model4Count':_0x521e89['inviteGiveSendModel4Count'],'drawMjCount':_0x521e89['inviteGiveSendDrawMjCount']}),await this['saveRecordRechargeLog']({'userId':_0x1b89da,'rechargeType':balance_constant_1[_0xb74456(0x1ff)][_0xb74456(0x21c)],'model3Count':_0x521e89[_0xb74456(0x211)],'model4Count':_0x521e89[_0xb74456(0x20f)],'drawMjCount':_0x521e89[_0xb74456(0x1f6)]}))),await this['userBalanceEntity'][_0xb74456(0x213)]({'userId':_0x1c3d61,'model3Count':_0xdc09b9,'model4Count':_0x42c08e,'drawMjCount':_0x3d93bc,'useTokens':0x0});}catch(_0x491f1f){console['log'](_0xb74456(0x220),_0x491f1f);throw new common_1[(_0xb74456(0x1a7))](_0xb74456(0x1d7),common_1[_0xb74456(0x1db)][_0xb74456(0x1ec)]);}}async['validateBalance'](_0x47e02c,_0xb7a1ac,_0x3f0d08){const _0x176e4a=_0x36b845,{id:_0x132fd7,role:_0x3b7409}=_0x47e02c[_0x176e4a(0x19a)];let _0x10d4b9=await this[_0x176e4a(0x1a6)][_0x176e4a(0x1be)]({'where':{'userId':_0x132fd7}});!_0x10d4b9&&(_0x10d4b9=await this[_0x176e4a(0x1b1)](_0x132fd7));if(_0x3b7409===_0x176e4a(0x1ea))return this['validateVisitorBalance'](_0x47e02c,_0xb7a1ac,_0x3f0d08);const _0x2a2e48=await this[_0x176e4a(0x16b)][_0x176e4a(0x1be)]({'where':{'configKey':_0x176e4a(0x21e)}}),_0x5f1402=_0x2a2e48?_0x2a2e48[_0x176e4a(0x1c2)]:_0x176e4a(0x1fa),_0x591969=_0xb7a1ac==='model3'?_0x176e4a(0x1f0):_0xb7a1ac===_0x176e4a(0x16f)?_0x176e4a(0x1f9):_0xb7a1ac==='mjDraw'?'memberDrawMjCount':null,_0x3fbffc=_0xb7a1ac==='model3'?'model3Count':_0xb7a1ac===_0x176e4a(0x16f)?_0x176e4a(0x188):_0xb7a1ac===_0x176e4a(0x20d)?'drawMjCount':null;if(_0x10d4b9[_0x176e4a(0x174)]&&_0x10d4b9[_0x591969]<_0x3f0d08){if(_0x10d4b9[_0x3fbffc]<_0x3f0d08)throw new common_1[(_0x176e4a(0x1a7))](_0x176e4a(0x1b2)+_0x5f1402+_0x176e4a(0x1c6),common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x10d4b9[_0x176e4a(0x174)]&&_0x10d4b9[_0x3fbffc]<_0x3f0d08)throw new common_1[(_0x176e4a(0x1a7))](_0x176e4a(0x1b2)+_0x5f1402+_0x176e4a(0x1c6),common_1[_0x176e4a(0x1db)][_0x176e4a(0x203)]);return _0x10d4b9;}async['validateVisitorBalance'](_0x4441bf,_0x577038,_0x156bd7){const _0x1f9132=_0x36b845,{id:_0x19fc08}=_0x4441bf[_0x1f9132(0x19a)],_0x12d480=_0x577038===_0x1f9132(0x1ee)?_0x1f9132(0x18e):_0x577038===_0x1f9132(0x16f)?_0x1f9132(0x188):_0x577038===_0x1f9132(0x20d)?'drawMjCount':null,_0xe031c6=new Date(),_0x4116bb=await this[_0x1f9132(0x1d5)]['findOne']({'where':{'fingerprint':_0x19fc08}}),{visitorModel3Num:_0x452908,visitorModel4Num:_0x3fc676,visitorMJNum:_0x304c5d}=await this[_0x1f9132(0x1c8)]['getConfigs']([_0x1f9132(0x176),_0x1f9132(0x1a8),_0x1f9132(0x1d8)]),_0x5de1cb={'model3Count':_0x452908?Number(_0x452908):0x0,'model4Count':_0x3fc676?Number(_0x3fc676):0x0,'drawMjCount':_0x304c5d?Number(_0x304c5d):0x0};if(!_0x4116bb){const _0x140347={'fingerprint':_0x19fc08,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x140347[_0x12d480]=_0x140347[_0x12d480]+_0x156bd7;if(_0x140347[_0x12d480]>_0x5de1cb[_0x12d480])throw new common_1['HttpException'](_0x1f9132(0x165),common_1[_0x1f9132(0x1db)]['PAYMENT_REQUIRED']);else return await this['fingerprintLogEntity'][_0x1f9132(0x213)](_0x140347),!![];}else{const {model3Count:_0x2978e9,model4Count:_0x1d7393,drawMjCount:_0x365167}=_0x4116bb;let _0x4c480d={'model3Count':_0x2978e9,'model4Count':_0x1d7393,'drawMjCount':_0x365167};const _0x14f59e=Number(new Date(_0x4116bb[_0x1f9132(0x1d0)])),_0x4cc6a3=this['isUpdatedToday'](_0x14f59e);_0x4cc6a3?_0x4c480d[_0x12d480]=_0x4c480d[_0x12d480]+_0x156bd7:(_0x4c480d={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x4c480d[_0x12d480]=_0x4c480d[_0x12d480]+_0x156bd7);if(_0x4c480d[_0x12d480]>_0x5de1cb[_0x12d480])throw new common_1[(_0x1f9132(0x1a7))](_0x1f9132(0x165),common_1[_0x1f9132(0x1db)][_0x1f9132(0x203)]);else return await this[_0x1f9132(0x1d5)][_0x1f9132(0x1f2)]({'fingerprint':_0x19fc08},_0x4c480d),!![];}}[_0x36b845(0x1ae)](_0x1e33cd){const _0x41ebfb=_0x36b845,_0x589396=new Date(),_0x165601=new Date(_0x589396[_0x41ebfb(0x178)](),_0x589396[_0x41ebfb(0x1bd)](),_0x589396[_0x41ebfb(0x182)]());return _0x1e33cd>=_0x165601;}async[_0x36b845(0x1f7)](_0xc0862b,_0x337644,_0x1239cb,_0xb87a8c=0x0){const _0x532c15=_0x36b845,_0x72ef7f=await this[_0x532c15(0x1a6)][_0x532c15(0x1be)]({'where':{'userId':_0xc0862b}});if(!_0x72ef7f)throw new common_1[(_0x532c15(0x1a7))](_0x532c15(0x1b6),common_1[_0x532c15(0x1db)][_0x532c15(0x1ec)]);const _0x4fb9b7=_0x337644===_0x532c15(0x1ee)?_0x532c15(0x1f0):_0x337644==='model4'?_0x532c15(0x1f9):_0x337644===_0x532c15(0x20d)?'memberDrawMjCount':null,_0x45edcd=_0x337644===_0x532c15(0x1ee)?'model3Count':_0x337644==='model4'?_0x532c15(0x188):_0x337644===_0x532c15(0x20d)?'drawMjCount':null,_0x3b6dfa=_0x72ef7f[_0x532c15(0x174)]&&_0x72ef7f[_0x4fb9b7]<_0x1239cb?_0x45edcd:_0x72ef7f[_0x532c15(0x174)]?_0x4fb9b7:_0x45edcd;let _0x3a5ef5=null;_0x3b6dfa[_0x532c15(0x1ca)](_0x532c15(0x204))&&(_0x3a5ef5=_0x532c15(0x1bb));_0x3b6dfa[_0x532c15(0x1ca)](_0x532c15(0x19f))&&(_0x3a5ef5='useModel4Token');_0x3b6dfa['includes']('MjCount')&&(_0x3a5ef5=_0x532c15(0x1d4));const _0x387f91={[_0x3b6dfa]:_0x72ef7f[_0x3b6dfa]-_0x1239cb<0x0?0x0:_0x72ef7f[_0x3b6dfa]-_0x1239cb,[_0x3a5ef5]:_0x72ef7f[_0x3a5ef5]+_0xb87a8c};_0x3a5ef5===_0x532c15(0x1bb)&&(_0x387f91['useModel3Count']=_0x72ef7f[_0x532c15(0x173)]+_0x1239cb),_0x3a5ef5===_0x532c15(0x1c4)&&(_0x387f91[_0x532c15(0x218)]=_0x72ef7f['useModel4Count']+_0x1239cb);const _0x20e0e3=await this[_0x532c15(0x1a6)][_0x532c15(0x1f2)]({'userId':_0xc0862b},_0x387f91);if(_0x20e0e3['affected']===0x0)throw new common_1[(_0x532c15(0x1a7))](_0x532c15(0x191),common_1['HttpStatus'][_0x532c15(0x1ec)]);}async[_0x36b845(0x20c)](_0x52d680){const _0x58599a=_0x36b845;try{const _0x1d0660=await this[_0x58599a(0x1a6)]['findOne']({'where':{'userId':_0x52d680},'select':['packageId',_0x58599a(0x18e),'model4Count',_0x58599a(0x1a2),'memberModel3Count',_0x58599a(0x1f9),_0x58599a(0x181),_0x58599a(0x173),_0x58599a(0x218),'useModel3Token',_0x58599a(0x1c4),_0x58599a(0x1d4),_0x58599a(0x1ab)]});if(!_0x1d0660){const _0x73e976=await this[_0x58599a(0x1b1)](_0x52d680);if(_0x73e976)return await this['queryUserBalance'](_0x52d680);else throw new common_1[(_0x58599a(0x1a7))]('查询当前用户余额失败！',common_1[_0x58599a(0x1db)]['BAD_REQUEST']);}return _0x1d0660[_0x58599a(0x1fe)]=_0x1d0660[_0x58599a(0x174)]?_0x1d0660[_0x58599a(0x18e)]+_0x1d0660['memberModel3Count']:_0x1d0660[_0x58599a(0x18e)],_0x1d0660[_0x58599a(0x163)]=_0x1d0660[_0x58599a(0x174)]?_0x1d0660[_0x58599a(0x188)]+_0x1d0660[_0x58599a(0x1f9)]:_0x1d0660[_0x58599a(0x188)],_0x1d0660[_0x58599a(0x1bf)]=_0x1d0660[_0x58599a(0x174)]?_0x1d0660[_0x58599a(0x1a2)]+_0x1d0660['memberDrawMjCount']:_0x1d0660[_0x58599a(0x1a2)],_0x1d0660[_0x58599a(0x1ab)]=_0x1d0660[_0x58599a(0x1ab)]?(0x0,date_1[_0x58599a(0x18d)])(_0x1d0660['expirationTime'],_0x58599a(0x1fc)):null,_0x1d0660;}catch(_0x45fd92){console[_0x58599a(0x17a)](_0x58599a(0x220),_0x45fd92);}}async[_0x36b845(0x1b8)](_0x46d821){const _0x5cd7af=_0x36b845,{userId:_0x5cf3a4,rechargeType:_0x251521,model3Count:_0x29a4b2,model4Count:_0x3e8c92,drawMjCount:_0x22aa14,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x46d821;if(!_0x5cf3a4)throw new common_1[(_0x5cd7af(0x1a7))](_0x5cd7af(0x1eb),common_1[_0x5cd7af(0x1db)][_0x5cd7af(0x1ec)]);const _0xd261d1=(0x0,utils_1['createRandomUid'])();return await this[_0x5cd7af(0x1cb)][_0x5cd7af(0x213)]({'userId':_0x5cf3a4,'rechargeType':_0x251521,'model3Count':_0x29a4b2,'model4Count':_0x3e8c92,'drawMjCount':_0x22aa14,'days':days,'extent':extent,'uid':_0xd261d1,'pkgName':pkgName});}async[_0x36b845(0x1b1)](_0x272fa2,_0x4fc60c={}){const _0x2643d8=_0x36b845,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4fc60c,_0x8dde77=await this[_0x2643d8(0x1a6)][_0x2643d8(0x1be)]({'where':{'userId':_0x272fa2}});if(_0x8dde77)throw new common_1[(_0x2643d8(0x1a7))](_0x2643d8(0x1e6),common_1[_0x2643d8(0x1db)][_0x2643d8(0x1ec)]);return await this[_0x2643d8(0x1a6)][_0x2643d8(0x213)]({'userId':_0x272fa2,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x36b845(0x170)](_0x28129f,_0x44a1e4,_0x5c5132=-0x1){const _0x572e1a=_0x36b845;try{const _0x2bf48a=await this[_0x572e1a(0x1a6)][_0x572e1a(0x1be)]({'where':{'userId':_0x28129f}})||await this['createBaseUserBalance'](_0x28129f);if(!_0x2bf48a)throw new common_1[(_0x572e1a(0x1a7))](_0x572e1a(0x1a0),common_1[_0x572e1a(0x1db)][_0x572e1a(0x1ec)]);const {model3Count:_0x21d165,model4Count:_0x550f31,drawMjCount:_0x152e86,memberModel3Count:_0x4a5816,memberModel4Count:_0x2b5fbe,memberDrawMjCount:_0x5187e8}=_0x2bf48a;let _0x48560c={};if(_0x5c5132>0x0){const {packageId:_0x147dde}=_0x44a1e4;if(!_0x147dde)throw new common_1[(_0x572e1a(0x1a7))]('缺失当前套餐ID、充值失败！',common_1[_0x572e1a(0x1db)][_0x572e1a(0x1ec)]);const _0xeb17e2=await this[_0x572e1a(0x1e7)][_0x572e1a(0x1be)]({'where':{'id':_0x147dde}});if(!_0xeb17e2)throw new common_1[(_0x572e1a(0x1a7))](_0x572e1a(0x1d3),common_1[_0x572e1a(0x1db)][_0x572e1a(0x1ec)]);const {weight:_0x4bd16d}=_0xeb17e2;if(!_0x2bf48a['packageId'])_0x48560c={'memberModel3Count':_0x21d165+_0x44a1e4[_0x572e1a(0x18e)],'memberModel4Count':_0x550f31+_0x44a1e4[_0x572e1a(0x188)],'memberDrawMjCount':_0x152e86+_0x44a1e4['drawMjCount'],'expirationTime':(0x0,date_1[_0x572e1a(0x221)])()[_0x572e1a(0x1df)](_0x5c5132>0x0?_0x5c5132:0x0,_0x572e1a(0x179))['format'](_0x572e1a(0x1c1)),'packageId':_0x147dde};else{const _0x5afca7=await this[_0x572e1a(0x1e7)][_0x572e1a(0x1be)]({'where':{'id':_0x2bf48a[_0x572e1a(0x174)]}});_0x4bd16d>=_0x5afca7['weight']&&(_0x48560c={'memberModel3Count':_0x4a5816+_0x44a1e4[_0x572e1a(0x18e)],'memberModel4Count':_0x2b5fbe+_0x44a1e4[_0x572e1a(0x188)],'memberDrawMjCount':_0x5187e8+_0x44a1e4[_0x572e1a(0x1a2)],'expirationTime':(0x0,date_1[_0x572e1a(0x221)])(_0x2bf48a['expirationTime'])[_0x572e1a(0x1df)](_0x5c5132>0x0?_0x5c5132:0x0,'day')[_0x572e1a(0x18b)](_0x572e1a(0x1c1)),'packageId':_0x147dde}),_0x4bd16d<_0x5afca7[_0x572e1a(0x1aa)]&&(_0x48560c={'memberModel3Count':_0x4a5816+_0x44a1e4[_0x572e1a(0x18e)],'memberModel4Count':_0x2b5fbe+_0x44a1e4[_0x572e1a(0x188)],'memberDrawMjCount':_0x5187e8+_0x44a1e4['drawMjCount']});}}_0x5c5132<=0x0&&(_0x48560c={'model3Count':_0x21d165+_0x44a1e4[_0x572e1a(0x18e)],'model4Count':_0x550f31+_0x44a1e4['model4Count'],'drawMjCount':_0x152e86+_0x44a1e4[_0x572e1a(0x1a2)]});const _0x22b06a=await this[_0x572e1a(0x1a6)][_0x572e1a(0x1f2)]({'userId':_0x28129f},_0x48560c);if(_0x22b06a[_0x572e1a(0x209)]===0x0)throw new common_1[(_0x572e1a(0x1a7))](_0x28129f+'充值失败',common_1[_0x572e1a(0x1db)]['BAD_REQUEST']);}catch(_0x367c13){console[_0x572e1a(0x17a)](_0x572e1a(0x220),_0x367c13);throw new common_1[(_0x572e1a(0x1a7))]('用户充值失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x36b845(0x20b)](_0x1dc4ea){const _0x410f91=_0x36b845;console[_0x410f91(0x17a)](_0x410f91(0x1ce),_0x1dc4ea);try{const {userId:_0x2b6731,goodsId:_0x441a52}=_0x1dc4ea,_0x212950=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x1dc4ea[_0x410f91(0x210)],'status':0x1}});if(!_0x212950)throw new common_1[(_0x410f91(0x1a7))](_0x410f91(0x1e0),common_1[_0x410f91(0x1db)][_0x410f91(0x1ec)]);const {model3Count:_0x31999c,model4Count:_0x3b0234,drawMjCount:_0x2532eb,days:_0x460b57,name:_0xfe2138}=_0x212950,_0x1b696f={'model3Count':_0x31999c,'model4Count':_0x3b0234,'drawMjCount':_0x2532eb,'days':_0x460b57,'packageId':_0x1dc4ea[_0x410f91(0x210)]};await this[_0x410f91(0x170)](_0x2b6731,_0x1b696f,_0x460b57),await this[_0x410f91(0x1b8)]({'userId':_0x2b6731,'rechargeType':balance_constant_1[_0x410f91(0x1ff)]['SCAN_PAY'],'model3Count':_0x31999c,'model4Count':_0x3b0234,'drawMjCount':_0x2532eb,'pkgName':_0xfe2138,'days':_0x460b57});const _0x37568f=await this[_0x410f91(0x200)][_0x410f91(0x1be)]({'where':{'id':_0x2b6731}}),{invitedBy:_0x113ff9}=_0x37568f;if(_0x113ff9){const _0x5501cd=await this[_0x410f91(0x200)][_0x410f91(0x1be)]({'where':{'inviteCode':_0x113ff9}}),_0x461beb=await this[_0x410f91(0x1e1)][_0x410f91(0x1be)]({'where':{'userId':_0x5501cd['id']}});if(!_0x5501cd)return;const {id:_0x17dc61}=_0x5501cd,{performanceRatio:_0x4b868a}=_0x461beb,_0x4cc8e8={'inviterUserId':_0x17dc61,'inviteeUserId':_0x2b6731,'orderId':_0x1dc4ea['id'],'orderPrice':_0x1dc4ea[_0x410f91(0x205)],'commissionPercentage':_0x4b868a,'commissionAmount':(_0x1dc4ea[_0x410f91(0x205)]*_0x4b868a/0x64)['toFixed'](0x2)};await this[_0x410f91(0x214)][_0x410f91(0x1da)](_0x4cc8e8),await this[_0x410f91(0x214)][_0x410f91(0x195)](_0x17dc61,_0x4cc8e8['commissionAmount']);}}catch(_0x4f228a){console[_0x410f91(0x17a)](_0x410f91(0x220),_0x4f228a);throw new common_1[(_0x410f91(0x1a7))](_0x410f91(0x19d),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x36b845(0x186)](_0x4598fa,_0x17189c){const _0x32131f=_0x36b845,{page:page=0x1,size:size=0x14}=_0x17189c,{id:_0x18c5a8}=_0x4598fa[_0x32131f(0x19a)],[_0x4dad43,_0x5b9193]=await this[_0x32131f(0x1cb)][_0x32131f(0x18a)]({'where':{'userId':_0x18c5a8},'order':{'id':_0x32131f(0x202)},'skip':(page-0x1)*size,'take':size});return _0x4dad43[_0x32131f(0x1e5)](_0x1cedf6=>{const _0x446fe6=_0x32131f;_0x1cedf6[_0x446fe6(0x1e2)]=_0x1cedf6[_0x446fe6(0x1ba)]>0x0?_0x1cedf6[_0x446fe6(0x1ba)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x4dad43),'count':_0x5b9193};}async[_0x36b845(0x1b3)](_0x5574fa,_0x3de587){const _0x5827fb=_0x36b845;try{const {page:page=0x1,size:size=0xa,userId:_0x508ca7,rechargeType:_0x208ae8,packageId:_0x1bf6ab}=_0x3de587,{role:_0x418e1d}=_0x5574fa[_0x5827fb(0x19a)],_0x4f4ab9={};_0x208ae8&&(_0x4f4ab9[_0x5827fb(0x1fd)]=_0x208ae8),_0x4f4ab9['userId']=_0x508ca7||(0x0,typeorm_2[_0x5827fb(0x190)])(0x186a0),_0x1bf6ab&&(_0x4f4ab9[_0x5827fb(0x174)]={'$like':'%'+_0x1bf6ab+'%'});const [_0x516a77,_0x44f612]=await this[_0x5827fb(0x1cb)]['findAndCount']({'where':_0x4f4ab9,'order':{'id':_0x5827fb(0x202)},'skip':(page-0x1)*size,'take':size}),_0x37d92f=_0x516a77['map'](_0x31301e=>_0x31301e['userId']),_0x12f8b0=await this[_0x5827fb(0x200)][_0x5827fb(0x167)]({'where':{'id':(0x0,typeorm_2['In'])(_0x37d92f)}});return _0x516a77[_0x5827fb(0x1e5)](_0x4f45d6=>{const _0xf61da2=_0x5827fb,_0x50272c=_0x12f8b0['find'](_0x2d1322=>_0x2d1322['id']===_0x4f45d6[_0xf61da2(0x17c)]);_0x4f45d6[_0xf61da2(0x1e8)]=_0x50272c===null||_0x50272c===void 0x0?void 0x0:_0x50272c[_0xf61da2(0x1e8)],_0x4f45d6[_0xf61da2(0x223)]=_0x50272c===null||_0x50272c===void 0x0?void 0x0:_0x50272c[_0xf61da2(0x223)],_0x4f45d6['phone']=_0x50272c===null||_0x50272c===void 0x0?void 0x0:_0x50272c[_0xf61da2(0x184)],_0x4f45d6[_0xf61da2(0x19b)]=_0x50272c===null||_0x50272c===void 0x0?void 0x0:_0x50272c['status'],_0x4f45d6[_0xf61da2(0x1c0)]=_0x50272c===null||_0x50272c===void 0x0?void 0x0:_0x50272c[_0xf61da2(0x1c0)];}),_0x418e1d!==_0x5827fb(0x21d)&&_0x516a77['forEach'](_0x58cf42=>{const _0x30a157=_0x5827fb;_0x58cf42[_0x30a157(0x223)]=_0x58cf42['email']?(0x0,utils_1[_0x30a157(0x172)])(_0x58cf42[_0x30a157(0x223)]):'',_0x58cf42[_0x30a157(0x184)]=_0x58cf42['phone']?(0x0,utils_1[_0x30a157(0x172)])(_0x58cf42[_0x30a157(0x184)]):'';}),{'rows':_0x516a77,'count':_0x44f612};}catch(_0x53c4ef){console[_0x5827fb(0x17a)](_0x5827fb(0x220),_0x53c4ef);throw new common_1[(_0x5827fb(0x1a7))](_0x5827fb(0x17d),common_1['HttpStatus'][_0x5827fb(0x1ec)]);}}async[_0x36b845(0x1e4)](_0x158710){const _0x5c56b6=_0x36b845;return await this[_0x5c56b6(0x1a6)][_0x5c56b6(0x167)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x158710)}});}async[_0x36b845(0x193)](_0xdffd43,_0x4a674e){const _0x52d1bc=_0x36b845;return await this[_0x52d1bc(0x1f7)](_0xdffd43,_0x52d1bc(0x20d),-_0x4a674e);}async['upgradeBalance'](){const _0x3d5475=_0x36b845,_0x48dffe=await this[_0x3d5475(0x200)][_0x3d5475(0x167)]();if(!_0x48dffe[_0x3d5475(0x1d9)])return;const _0x8823f4=await this[_0x3d5475(0x1c8)]['getConfigs'](['upgradeStatus']);if(!_0x8823f4)await this[_0x3d5475(0x1c8)][_0x3d5475(0x21f)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x3d5475(0x1a7))]('您已经升级过了、请勿重复操作！',common_1[_0x3d5475(0x1db)][_0x3d5475(0x1ec)]);_0x48dffe[_0x3d5475(0x1e5)](_0x40e2a5=>{const _0xcc3f10=_0x3d5475,{id:_0x3ba560}=_0x40e2a5;this['balanceEntity']['findOne']({'where':{'userId':_0x3ba560}})[_0xcc3f10(0x1c5)](_0x46dddc=>{const _0x18cd4c=_0xcc3f10;if(!_0x46dddc)return;this[_0x18cd4c(0x219)](_0x3ba560,_0x46dddc);});});}async[_0x36b845(0x219)](_0x56e40d,_0x217689){const _0x2b426c=_0x36b845,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x217689,_0x2014c7=await this[_0x2b426c(0x1b9)]['findOne']({'where':{'userId':_0x56e40d}}),_0x33b0cb={'userId':_0x56e40d,'model3Count':Number(usesLeft),'model4Count':(_0x2014c7===null||_0x2014c7===void 0x0?void 0x0:_0x2014c7[_0x2b426c(0x206)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x2014c7===null||_0x2014c7===void 0x0?void 0x0:_0x2014c7[_0x2b426c(0x1f1)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x145e82=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x56e40d}});_0x145e82?common_1['Logger'][_0x2b426c(0x21a)]('用户'+_0x56e40d+_0x2b426c(0x168),_0x2b426c(0x1d6)):this[_0x2b426c(0x1a6)]['save'](_0x33b0cb)['then'](_0x863be=>{const _0x59a1ca=_0x2b426c;common_1[_0x59a1ca(0x20a)][_0x59a1ca(0x21a)]('用户'+_0x56e40d+'旧账户信息迁移成功',_0x59a1ca(0x1d6));})[_0x2b426c(0x21b)](_0x3a0347=>{const _0x3ab573=_0x2b426c;console[_0x3ab573(0x17a)](_0x3ab573(0x220),_0x3a0347),common_1[_0x3ab573(0x20a)][_0x3ab573(0x21a)]('用户'+_0x56e40d+_0x3ab573(0x1cd),_0x3ab573(0x1d6));});}async[_0x36b845(0x216)](_0x3cd52e){const _0x4cfa61=_0x36b845,{fingerprint:_0x3a3db3}=_0x3cd52e[_0x4cfa61(0x169)],{id:_0x475145}=_0x3cd52e[_0x4cfa61(0x19a)];return await this['chatLogEntity']['update']({'userId':Number(_0x3a3db3)},{'userId':_0x475145}),await this[_0x4cfa61(0x1c7)][_0x4cfa61(0x1f2)]({'userId':Number(_0x3a3db3)},{'userId':_0x475145}),await this[_0x4cfa61(0x1de)]['update']({'userId':Number(_0x3a3db3)},{'userId':_0x475145}),0x1;}async[_0x36b845(0x183)](_0xc37aef){const _0x39e4a1=_0x36b845,{fingerprint:_0x10a0f0}=_0xc37aef[_0x39e4a1(0x169)],_0x4f885c=await this['chatLogEntity'][_0x39e4a1(0x206)]({'where':{'userId':_0x10a0f0}}),_0xe9d945=await this[_0x39e4a1(0x1c7)][_0x39e4a1(0x206)]({'where':{'userId':_0x10a0f0}}),_0x510dee=await this[_0x39e4a1(0x1de)][_0x39e4a1(0x206)]({'where':{'userId':_0x10a0f0}});return _0x4f885c||_0xe9d945||_0x510dee||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x36b845(0x162)])(),__param(0x0,(0x0,typeorm_1[_0x36b845(0x171)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x36b845(0x171)])(userBalance_entity_1[_0x36b845(0x194)])),__param(0x2,(0x0,typeorm_1[_0x36b845(0x171)])(accountLog_entity_1[_0x36b845(0x1a9)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x36b845(0x192)])),__param(0x4,(0x0,typeorm_1[_0x36b845(0x171)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x36b845(0x18f)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x36b845(0x16a)])),__param(0x7,(0x0,typeorm_1[_0x36b845(0x171)])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x36b845(0x171)])(fingerprint_entity_1[_0x36b845(0x1b7)])),__param(0x9,(0x0,typeorm_1[_0x36b845(0x171)])(chatGroup_entity_1[_0x36b845(0x1b5)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0xb,(0x0,typeorm_1[_0x36b845(0x171)])(midjourney_entity_1[_0x36b845(0x180)])),__metadata(_0x36b845(0x16e),[typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2['Repository'],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],typeorm_2[_0x36b845(0x1a4)],sales_service_1[_0x36b845(0x177)],globalConfig_service_1[_0x36b845(0x197)]])],UserBalanceService),exports[_0x36b845(0x1af)]=UserBalanceService;