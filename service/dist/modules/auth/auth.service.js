'use strict';const _0x5c6639=_0x13b3;(function(_0x5dbb17,_0x51a096){const _0x358b8c=_0x13b3,_0x30bca6=_0x5dbb17();while(!![]){try{const _0x523509=parseInt(_0x358b8c(0x16b))/0x1*(parseInt(_0x358b8c(0x168))/0x2)+-parseInt(_0x358b8c(0x14b))/0x3*(-parseInt(_0x358b8c(0x15b))/0x4)+parseInt(_0x358b8c(0x170))/0x5*(parseInt(_0x358b8c(0x127))/0x6)+-parseInt(_0x358b8c(0x15d))/0x7+parseInt(_0x358b8c(0x16a))/0x8+-parseInt(_0x358b8c(0x11b))/0x9*(-parseInt(_0x358b8c(0x13f))/0xa)+-parseInt(_0x358b8c(0x11d))/0xb;if(_0x523509===_0x51a096)break;else _0x30bca6['push'](_0x30bca6['shift']());}catch(_0x475060){_0x30bca6['push'](_0x30bca6['shift']());}}}(_0x437f,0x5c5d0));var __decorate=this&&this[_0x5c6639(0x123)]||function(_0x4b9d94,_0x51e612,_0x364384,_0x3a07b6){const _0x1d7283=_0x5c6639;var _0x4f0c67=arguments['length'],_0x4a02f9=_0x4f0c67<0x3?_0x51e612:_0x3a07b6===null?_0x3a07b6=Object[_0x1d7283(0xfa)](_0x51e612,_0x364384):_0x3a07b6,_0x1a083b;if(typeof Reflect===_0x1d7283(0x102)&&typeof Reflect['decorate']===_0x1d7283(0x179))_0x4a02f9=Reflect[_0x1d7283(0xfd)](_0x4b9d94,_0x51e612,_0x364384,_0x3a07b6);else{for(var _0x1069eb=_0x4b9d94[_0x1d7283(0x129)]-0x1;_0x1069eb>=0x0;_0x1069eb--)if(_0x1a083b=_0x4b9d94[_0x1069eb])_0x4a02f9=(_0x4f0c67<0x3?_0x1a083b(_0x4a02f9):_0x4f0c67>0x3?_0x1a083b(_0x51e612,_0x364384,_0x4a02f9):_0x1a083b(_0x51e612,_0x364384))||_0x4a02f9;}return _0x4f0c67>0x3&&_0x4a02f9&&Object['defineProperty'](_0x51e612,_0x364384,_0x4a02f9),_0x4a02f9;},__metadata=this&&this[_0x5c6639(0x154)]||function(_0x8a71e1,_0x3ecdb6){const _0x4bf787=_0x5c6639;if(typeof Reflect==='object'&&typeof Reflect[_0x4bf787(0x13b)]===_0x4bf787(0x179))return Reflect['metadata'](_0x8a71e1,_0x3ecdb6);},__param=this&&this[_0x5c6639(0x126)]||function(_0x54650d,_0x47c4d2){return function(_0x4b1113,_0x366eb3){_0x47c4d2(_0x4b1113,_0x366eb3,_0x54650d);};};function _0x437f(){const _0x4c77a0=['../user/user.service','updatePassByOther','ipAddress','updateUserPassword','JwtService','redirect','GlobalConfigService','非法操作、请联系管理员！','createRandomCode','__esModule','AuthService','密码修改成功','createTokenFromFingerprint','&registerFailEmailTitle=','&registerSuccessEmailTitle=','验证码填写错误、请重新输入！','&registerFailEmailTeamName=','ConfigEntity','../../common/utils','2876040EfvROT','验证码发送成功、请填写验证码完成注册！','13771120ICLgmu','registerSuccessEmailTeamName','@nine.com','createRandomUid','data','../globalConfig/config.entity','__decorate','UserStatusErrMsg','onModuleInit','__param','1273254alQwUg','&registerSuccessEmaileAppend=','length','sendPhoneCode','forEach','秒内不得重复发送短信！','registerFailEmailTitle','text','error:\x20','../verification/verification.service','register','Registration','createUser','getNamespace','HttpException','user','验证码类型错误','registerSuccessEmaileAppend','@nestjs/common','createUserAndVerifycation','metadata','userService','padStart',':PHONECODE:','20RfEFGj','registerSuccessEmailTitle','userId','ACTIVE','login','address','../userBalance/userBalance.service','registerFailEmailTeamName','getIp','family','UserStatusEnum','MailerService','6177WqpZRm','verifyCode','addBalanceToNewUser','networkInterfaces','../../common/constants/user.constant','hashSync','@nestjs/typeorm','updatePassword','IPv4','__metadata','log','internal','configEntity','savaLoginIp','BAD_REQUEST','verificationService','4rThCfO','qureyUserInfoByInviteCode','1090285CLRnOd','password','updateUserStatus','loginByOpenId','VerificationService','验证码已过期、请重新发送！','captcha','无权此操作！','127.0.0.1','&email=','../../common/constants/verification.constant','1154622sKWVZM','#fff','2842368RAHzDv','1IlEifV','verifyCaptcha','getUserInfo','avatar','Injectable','5YVfXwp','@nestjs/jwt','registerByPhone','redisCacheService','bcryptjs','UserService',':CAPTCHA:','keys','/api/auth/registerError?message=','function','getClientIp','defineProperty','saveToken','HttpStatus','userBalanceService','configVal','globalConfigService','set','mailerService','&username=','admin','getConfigs','reduce','../mailer/mailer.service','getInfo','getOwnPropertyDescriptor','verifyUserRegisterByPhone','InjectRepository','decorate','client','jwtService','toString','svg-captcha','object','typeorm','verifyUserCredentials','sign','verifyUserPassword','../globalConfig/globalConfig.service'];_0x437f=function(){return _0x4c77a0;};return _0x437f();}Object[_0x5c6639(0x17b)](exports,_0x5c6639(0x111),{'value':!![]}),exports['AuthService']=void 0x0;const globalConfig_service_1=require(_0x5c6639(0x107)),verification_constant_1=require(_0x5c6639(0x167)),verification_service_1=require(_0x5c6639(0x130)),common_1=require(_0x5c6639(0x139)),jwt_1=require(_0x5c6639(0x171)),user_service_1=require(_0x5c6639(0x108)),mailer_service_1=require(_0x5c6639(0x187)),user_constant_1=require(_0x5c6639(0x14f)),userBalance_service_1=require(_0x5c6639(0x145)),config_entity_1=require(_0x5c6639(0x122)),typeorm_1=require(_0x5c6639(0x103)),typeorm_2=require(_0x5c6639(0x151)),utils_1=require(_0x5c6639(0x11a)),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x5c6639(0x101)),bcrypt=require(_0x5c6639(0x174));function _0x13b3(_0x4806a4,_0x3c35d){const _0x437f7d=_0x437f();return _0x13b3=function(_0x13b3ec,_0x1d8f5b){_0x13b3ec=_0x13b3ec-0xf9;let _0x1bfcbc=_0x437f7d[_0x13b3ec];return _0x1bfcbc;},_0x13b3(_0x4806a4,_0x3c35d);}let AuthService=class AuthService{constructor(_0x2f1b2e,_0x37ce64,_0x35a53d,_0x25a636,_0x4eb458,_0x8e562f,_0x59d103,_0x4f1fbc){const _0x4d7f10=_0x5c6639;this[_0x4d7f10(0x157)]=_0x2f1b2e,this[_0x4d7f10(0x13c)]=_0x37ce64,this[_0x4d7f10(0xff)]=_0x35a53d,this[_0x4d7f10(0x182)]=_0x25a636,this[_0x4d7f10(0x15a)]=_0x4eb458,this[_0x4d7f10(0x17e)]=_0x8e562f,this['redisCacheService']=_0x59d103,this[_0x4d7f10(0x180)]=_0x4f1fbc;}async[_0x5c6639(0x125)](){this['getIp']();}async[_0x5c6639(0x131)](_0x127786,_0x388d38){const _0x3601c6=_0x5c6639;await this[_0x3601c6(0x15a)][_0x3601c6(0x16c)](_0x127786);const _0x5d0c0f=await this[_0x3601c6(0x13c)][_0x3601c6(0x13a)](_0x127786,_0x388d38),{username:_0x44840d,email:_0x450514,client:_0x257d65,id:_0x38b272}=_0x5d0c0f,_0x35c920={'username':_0x44840d,'email':_0x450514,'id':_0x38b272};return _0x257d65&&(_0x35c920[_0x3601c6(0xfe)]=_0x257d65),_0x35c920;}async[_0x5c6639(0x172)](_0x71516,_0xa0b37b){const _0x2ff8d0=_0x5c6639,{username:_0x4c12cc,password:_0x68d4fa,phone:_0x3038b3,phoneCode:_0x36b4f4,invitedBy:_0xdd3730}=_0x71516;await this['userService'][_0x2ff8d0(0xfb)](_0x71516);const _0x54ebb4=await this['globalConfigService']['getNamespace'](),_0x12d997=_0x54ebb4+_0x2ff8d0(0x13e)+_0x3038b3,_0x179112=await this['redisCacheService']['get']({'key':_0x12d997});if(!_0x179112)throw new common_1[(_0x2ff8d0(0x135))](_0x2ff8d0(0x162),common_1[_0x2ff8d0(0x17d)][_0x2ff8d0(0x159)]);if(_0x36b4f4!==_0x179112)throw new common_1['HttpException'](_0x2ff8d0(0x117),common_1[_0x2ff8d0(0x17d)][_0x2ff8d0(0x159)]);const _0x217d93=(0x0,utils_1[_0x2ff8d0(0x120)])()+'@nine.com',_0x48a784={'username':_0x4c12cc,'password':_0x68d4fa,'phone':_0x3038b3,'invitedBy':_0xdd3730,'email':_0x217d93,'status':user_constant_1[_0x2ff8d0(0x149)][_0x2ff8d0(0x142)]},_0x1444b8=await this[_0x2ff8d0(0x180)][_0x2ff8d0(0x185)](['userDefautlAvatar']);_0x48a784[_0x2ff8d0(0x16e)]=_0x1444b8;const _0x3126e3=bcrypt[_0x2ff8d0(0x150)](_0x68d4fa,0xa);_0x48a784['password']=_0x3126e3;const _0x32832f=await this[_0x2ff8d0(0x13c)][_0x2ff8d0(0x133)](_0x48a784);let _0x4f5311;_0xdd3730&&(_0x4f5311=await this[_0x2ff8d0(0x13c)][_0x2ff8d0(0x15c)](_0xdd3730));await this['userBalanceService'][_0x2ff8d0(0x14d)](_0x32832f['id'],_0x4f5311===null||_0x4f5311===void 0x0?void 0x0:_0x4f5311['id']);return;}async[_0x5c6639(0x143)](_0x9c3555,_0x1ac765){const _0x56e45a=_0x5c6639,_0x39e88b=await this[_0x56e45a(0x13c)][_0x56e45a(0x104)](_0x9c3555),{username:_0xc026ac,id:_0x1018c4,email:_0x434182,role:_0xfd0774,openId:_0x1e9a53,client:_0x1e11f0}=_0x39e88b,_0x1e1e24=(0x0,utils_1['getClientIp'])(_0x1ac765);await this['userService'][_0x56e45a(0x158)](_0x1018c4,_0x1e1e24);const _0x378d30=await this[_0x56e45a(0xff)]['sign']({'username':_0xc026ac,'id':_0x1018c4,'email':_0x434182,'role':_0xfd0774,'openId':_0x1e9a53,'client':_0x1e11f0});return await this['redisCacheService']['saveToken'](_0x1018c4,_0x378d30),_0x378d30;}async['loginByPhone'](_0x40a9c8,_0x1ca3ad){const _0x5eba75=_0x5c6639,_0x3171dd=await this[_0x5eba75(0x13c)][_0x5eba75(0x104)](_0x40a9c8),{username:_0x4641dc,id:_0x404bd2,email:_0x261e01,role:_0x115d3d,openId:_0x33f266,client:_0x423d2c}=_0x3171dd,_0x204c2c=(0x0,utils_1[_0x5eba75(0x17a)])(_0x1ca3ad);await this['userService'][_0x5eba75(0x158)](_0x404bd2,_0x204c2c);const {phone:_0x4fdfe9}=_0x40a9c8,_0x1f7f64=await this['jwtService'][_0x5eba75(0x105)]({'username':_0x4641dc,'id':_0x404bd2,'email':_0x261e01,'role':_0x115d3d,'openId':_0x33f266,'client':_0x423d2c,'phone':_0x4fdfe9});return await this[_0x5eba75(0x173)][_0x5eba75(0x17c)](_0x404bd2,_0x1f7f64),_0x1f7f64;}async[_0x5c6639(0x160)](_0x2dfd21,_0x1aefeb){const _0x415b61=_0x5c6639,{status:_0x207fda}=_0x2dfd21;if(_0x207fda!==user_constant_1['UserStatusEnum'][_0x415b61(0x142)])throw new common_1[(_0x415b61(0x135))](user_constant_1[_0x415b61(0x124)][_0x207fda],common_1[_0x415b61(0x17d)]['BAD_REQUEST']);const {username:_0x4755ac,id:_0x238ac6,email:_0x11e4b8,role:_0x5b8af5,openId:_0x560374,client:_0x2c4524}=_0x2dfd21,_0x519f02=(0x0,utils_1[_0x415b61(0x17a)])(_0x1aefeb);await this[_0x415b61(0x13c)]['savaLoginIp'](_0x238ac6,_0x519f02);const _0x427728=await this['jwtService']['sign']({'username':_0x4755ac,'id':_0x238ac6,'email':_0x11e4b8,'role':_0x5b8af5,'openId':_0x560374,'client':_0x2c4524});return await this[_0x415b61(0x173)][_0x415b61(0x17c)](_0x238ac6,_0x427728),_0x427728;}async[_0x5c6639(0xf9)](_0x1f2f37){const _0x2734bc=_0x5c6639,{id:_0x139771}=_0x1f2f37[_0x2734bc(0x136)];return await this[_0x2734bc(0x13c)][_0x2734bc(0x16d)](_0x139771);}async['activateAccount'](_0x141275,_0x680fac){const _0x3c7002=_0x5c6639,_0x2049ce=await this[_0x3c7002(0x157)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0x3c7002(0x11e),_0x3c7002(0x138),_0x3c7002(0x12d),_0x3c7002(0x146)])}}),_0x443c72=_0x2049ce[_0x3c7002(0x186)]((_0x3dc24b,_0x1f9881)=>{const _0x2eaf86=_0x3c7002;return _0x3dc24b[_0x1f9881['configKey']]=_0x1f9881[_0x2eaf86(0x17f)],_0x3dc24b;},{});try{const _0x4c0d25=await this[_0x3c7002(0x15a)][_0x3c7002(0x14c)](_0x141275,verification_constant_1['VerificationEnum']['Registration']),{type:_0x5e0df3,userId:_0x5e378a}=_0x4c0d25;if(_0x5e0df3!==verification_constant_1['VerificationEnum'][_0x3c7002(0x132)])throw new common_1[(_0x3c7002(0x135))](_0x3c7002(0x137),common_1[_0x3c7002(0x17d)][_0x3c7002(0x159)]);const _0x2b8ddf=await this[_0x3c7002(0x13c)]['getUserStatus'](_0x5e378a);if(_0x2b8ddf===user_constant_1['UserStatusEnum'][_0x3c7002(0x142)])throw new common_1['HttpException']('账户已被激活过',common_1[_0x3c7002(0x17d)]['BAD_REQUEST']);await this['userService'][_0x3c7002(0x15f)](_0x4c0d25[_0x3c7002(0x141)],user_constant_1[_0x3c7002(0x149)][_0x3c7002(0x142)]);const _0x21e197=await this[_0x3c7002(0x13c)]['queryUserInfoById'](_0x4c0d25[_0x3c7002(0x141)]),{username:_0x362239,email:_0x3df29c,id:_0x4b0541,invitedBy:_0x2f9203}=_0x21e197;let _0x19a88e;_0x2f9203&&(_0x19a88e=await this[_0x3c7002(0x13c)]['qureyUserInfoByInviteCode'](_0x2f9203)),await this['userBalanceService'][_0x3c7002(0x14d)](_0x4b0541,_0x19a88e===null||_0x19a88e===void 0x0?void 0x0:_0x19a88e['id']),_0x680fac[_0x3c7002(0x10d)]('/api/auth/registerSuccess?id='+_0x4b0541[_0x3c7002(0x100)]()[_0x3c7002(0x13d)](0x4,'0')+_0x3c7002(0x183)+_0x362239+_0x3c7002(0x166)+_0x3df29c+_0x3c7002(0x116)+_0x443c72[_0x3c7002(0x140)]+'&registerSuccessEmailTeamName='+_0x443c72['registerSuccessEmailTeamName']+_0x3c7002(0x128)+_0x443c72['registerSuccessEmaileAppend']);}catch(_0x38d513){console[_0x3c7002(0x155)](_0x3c7002(0x12f),_0x38d513);const _0x4ea80b=_0x38d513['response'];_0x680fac['redirect'](_0x3c7002(0x178)+_0x4ea80b+_0x3c7002(0x115)+_0x443c72['registerFailEmailTitle']+_0x3c7002(0x118)+_0x443c72[_0x3c7002(0x146)]);}}async[_0x5c6639(0x152)](_0x33f913,_0x564c73){const _0x50f69a=_0x5c6639,{id:_0x273037,client:_0x55c2f9,role:_0x1e8e68}=_0x33f913[_0x50f69a(0x136)];if(_0x55c2f9&&Number(_0x55c2f9)>0x0)throw new common_1[(_0x50f69a(0x135))]('无权此操作、请联系管理员！',common_1['HttpStatus'][_0x50f69a(0x159)]);if(_0x1e8e68===_0x50f69a(0x184))throw new common_1['HttpException'](_0x50f69a(0x10f),common_1[_0x50f69a(0x17d)][_0x50f69a(0x159)]);const _0x13607f=await this['userService'][_0x50f69a(0x106)](_0x273037,_0x564c73['oldPassword']);if(!_0x13607f)throw new common_1[(_0x50f69a(0x135))]('旧密码错误、请检查提交',common_1[_0x50f69a(0x17d)][_0x50f69a(0x159)]);return this[_0x50f69a(0x13c)][_0x50f69a(0x10b)](_0x273037,_0x564c73[_0x50f69a(0x15e)]),'密码修改成功';}async[_0x5c6639(0x109)](_0x143098,_0x416846){const _0x160635=_0x5c6639,{id:_0x31d595,client:_0xac1125}=_0x143098[_0x160635(0x136)];if(!_0xac1125)throw new common_1['HttpException'](_0x160635(0x164),common_1['HttpStatus'][_0x160635(0x159)]);return this['userService']['updateUserPassword'](_0x31d595,_0x416846[_0x160635(0x15e)]),_0x160635(0x113);}[_0x5c6639(0x147)](){const _0x1145a5=_0x5c6639;let _0x496940;const _0xd805e3=os[_0x1145a5(0x14e)]();Object[_0x1145a5(0x177)](_0xd805e3)[_0x1145a5(0x12b)](_0xe62554=>{const _0x4c8978=_0x1145a5,_0x45fb22=_0xd805e3[_0xe62554];for(let _0x3bda4a=0x0;_0x3bda4a<_0x45fb22[_0x4c8978(0x129)];_0x3bda4a++){const _0x3c019a=_0x45fb22[_0x3bda4a];if(_0x3c019a[_0x4c8978(0x148)]===_0x4c8978(0x153)&&_0x3c019a[_0x4c8978(0x144)]!==_0x4c8978(0x165)&&!_0x3c019a[_0x4c8978(0x156)]){_0x496940=_0x3c019a[_0x4c8978(0x144)];break;}}}),this[_0x1145a5(0x10a)]=_0x496940;}async[_0x5c6639(0x163)](_0x543698){const _0x41d2a4=_0x5c6639,_0x2974f2=await this['globalConfigService'][_0x41d2a4(0x134)](),{color:color=_0x41d2a4(0x169)}=_0x543698,_0x518069=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x567f2d=_0x518069[_0x41d2a4(0x12e)],_0x559bb7=(0x0,utils_1[_0x41d2a4(0x120)])(),_0x2f1ca8=_0x2974f2+_0x41d2a4(0x176)+_0x559bb7;return await this[_0x41d2a4(0x173)]['set']({'key':_0x2f1ca8,'val':_0x518069[_0x41d2a4(0x12e)]},0x5*0x3c),{'svgCode':_0x518069[_0x41d2a4(0x121)],'code':_0x559bb7};}async[_0x5c6639(0x12a)](_0x2b58ec){const _0x4923e7=_0x5c6639;await this[_0x4923e7(0x15a)][_0x4923e7(0x16c)](_0x2b58ec);const {phone:_0x133daa}=_0x2b58ec,_0xfb2d8=await this['globalConfigService']['getNamespace'](),_0x48c07d=_0xfb2d8+_0x4923e7(0x13e)+_0x133daa,_0x462af2=await this[_0x4923e7(0x173)]['ttl'](_0x48c07d);if(_0x462af2&&_0x462af2>0x0)throw new common_1[(_0x4923e7(0x135))](_0x462af2+_0x4923e7(0x12c),common_1['HttpStatus'][_0x4923e7(0x159)]);const _0x3775fe=(0x0,utils_1[_0x4923e7(0x110)])(),_0x1317a7={'phone':_0x133daa,'code':_0x3775fe};return await this[_0x4923e7(0x15a)][_0x4923e7(0x12a)](_0x1317a7),await this[_0x4923e7(0x173)][_0x4923e7(0x181)]({'key':_0x48c07d,'val':_0x3775fe},0x1*0x3c),_0x4923e7(0x11c);}[_0x5c6639(0x114)](_0x4bc23){const _0x5d1c31=_0x5c6639,_0x9e116=this[_0x5d1c31(0xff)][_0x5d1c31(0x105)]({'username':'游客'+_0x4bc23,'id':_0x4bc23,'email':_0x4bc23+_0x5d1c31(0x11f),'role':'visitor','openId':null,'client':null});return _0x9e116;}};AuthService=__decorate([(0x0,common_1[_0x5c6639(0x16f)])(),__param(0x0,(0x0,typeorm_2[_0x5c6639(0xfc)])(config_entity_1[_0x5c6639(0x119)])),__metadata('design:paramtypes',[typeorm_1['Repository'],user_service_1[_0x5c6639(0x175)],jwt_1[_0x5c6639(0x10c)],mailer_service_1[_0x5c6639(0x14a)],verification_service_1[_0x5c6639(0x161)],userBalance_service_1['UserBalanceService'],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x5c6639(0x10e)]])],AuthService),exports[_0x5c6639(0x112)]=AuthService;