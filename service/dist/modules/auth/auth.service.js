'use strict';const _0xcb06a2=_0x2fc2;(function(_0x2969d9,_0x4fb7e8){const _0x40024b=_0x2fc2,_0x3a14d3=_0x2969d9();while(!![]){try{const _0xb35d72=-parseInt(_0x40024b(0x1a8))/0x1*(parseInt(_0x40024b(0x14d))/0x2)+parseInt(_0x40024b(0x18c))/0x3+-parseInt(_0x40024b(0x156))/0x4+parseInt(_0x40024b(0x164))/0x5*(parseInt(_0x40024b(0x186))/0x6)+parseInt(_0x40024b(0x1b8))/0x7+parseInt(_0x40024b(0x19b))/0x8*(-parseInt(_0x40024b(0x1a0))/0x9)+parseInt(_0x40024b(0x158))/0xa;if(_0xb35d72===_0x4fb7e8)break;else _0x3a14d3['push'](_0x3a14d3['shift']());}catch(_0x389614){_0x3a14d3['push'](_0x3a14d3['shift']());}}}(_0x35f7,0x48555));function _0x2fc2(_0x308382,_0x358748){const _0x35f782=_0x35f7();return _0x2fc2=function(_0x2fc28e,_0x40b760){_0x2fc28e=_0x2fc28e-0x12e;let _0x406bf9=_0x35f782[_0x2fc28e];return _0x406bf9;},_0x2fc2(_0x308382,_0x358748);}var __decorate=this&&this['__decorate']||function(_0x7f616a,_0x4a55ab,_0x3dfa42,_0x47315c){const _0x24bf87=_0x2fc2;var _0x4cda27=arguments[_0x24bf87(0x1b4)],_0x11b34c=_0x4cda27<0x3?_0x4a55ab:_0x47315c===null?_0x47315c=Object[_0x24bf87(0x13a)](_0x4a55ab,_0x3dfa42):_0x47315c,_0x3cf40f;if(typeof Reflect===_0x24bf87(0x15b)&&typeof Reflect[_0x24bf87(0x1ab)]==='function')_0x11b34c=Reflect[_0x24bf87(0x1ab)](_0x7f616a,_0x4a55ab,_0x3dfa42,_0x47315c);else{for(var _0x3b2202=_0x7f616a[_0x24bf87(0x1b4)]-0x1;_0x3b2202>=0x0;_0x3b2202--)if(_0x3cf40f=_0x7f616a[_0x3b2202])_0x11b34c=(_0x4cda27<0x3?_0x3cf40f(_0x11b34c):_0x4cda27>0x3?_0x3cf40f(_0x4a55ab,_0x3dfa42,_0x11b34c):_0x3cf40f(_0x4a55ab,_0x3dfa42))||_0x11b34c;}return _0x4cda27>0x3&&_0x11b34c&&Object[_0x24bf87(0x1a5)](_0x4a55ab,_0x3dfa42,_0x11b34c),_0x11b34c;},__metadata=this&&this[_0xcb06a2(0x180)]||function(_0x16591a,_0x70a917){const _0x1d7e90=_0xcb06a2;if(typeof Reflect===_0x1d7e90(0x15b)&&typeof Reflect[_0x1d7e90(0x178)]===_0x1d7e90(0x1aa))return Reflect[_0x1d7e90(0x178)](_0x16591a,_0x70a917);},__param=this&&this[_0xcb06a2(0x150)]||function(_0x267b24,_0x389d81){return function(_0x266e9d,_0xa2d133){_0x389d81(_0x266e9d,_0xa2d133,_0x267b24);};};Object[_0xcb06a2(0x1a5)](exports,_0xcb06a2(0x18a),{'value':!![]}),exports[_0xcb06a2(0x13f)]=void 0x0;const globalConfig_service_1=require(_0xcb06a2(0x13d)),verification_constant_1=require(_0xcb06a2(0x131)),verification_service_1=require(_0xcb06a2(0x14c)),common_1=require(_0xcb06a2(0x168)),jwt_1=require(_0xcb06a2(0x182)),user_service_1=require(_0xcb06a2(0x19e)),mailer_service_1=require(_0xcb06a2(0x19f)),user_constant_1=require(_0xcb06a2(0x193)),userBalance_service_1=require(_0xcb06a2(0x15a)),config_entity_1=require(_0xcb06a2(0x15d)),typeorm_1=require(_0xcb06a2(0x136)),typeorm_2=require(_0xcb06a2(0x15c)),utils_1=require(_0xcb06a2(0x142)),os=require('os'),redisCache_service_1=require(_0xcb06a2(0x163)),svgCaptcha=require(_0xcb06a2(0x196)),bcrypt=require(_0xcb06a2(0x16d));let AuthService=class AuthService{constructor(_0x2b83d1,_0x4e2733,_0x9d58b0,_0x208fe6,_0x2f15f9,_0x5a7ecf,_0x261980,_0x4245a5){const _0x78036e=_0xcb06a2;this[_0x78036e(0x17d)]=_0x2b83d1,this[_0x78036e(0x172)]=_0x4e2733,this[_0x78036e(0x159)]=_0x9d58b0,this[_0x78036e(0x18b)]=_0x208fe6,this[_0x78036e(0x188)]=_0x2f15f9,this[_0x78036e(0x141)]=_0x5a7ecf,this[_0x78036e(0x15f)]=_0x261980,this[_0x78036e(0x139)]=_0x4245a5;}async[_0xcb06a2(0x1b2)](){const _0x3c0899=_0xcb06a2;this[_0x3c0899(0x1b3)]();}async['register'](_0x248ff3,_0x10d1b4){const _0x426524=_0xcb06a2;await this[_0x426524(0x188)]['verifyCaptcha'](_0x248ff3);const _0x4c65ee=await this['userService'][_0x426524(0x13e)](_0x248ff3,_0x10d1b4),{username:_0x3b417a,email:_0x2727cd,client:_0x4821a2,id:_0x1a151a}=_0x4c65ee,_0x4fbd56={'username':_0x3b417a,'email':_0x2727cd,'id':_0x1a151a};return _0x4821a2&&(_0x4fbd56[_0x426524(0x16a)]=_0x4821a2),_0x4fbd56;}async[_0xcb06a2(0x1b1)](_0x21c47e,_0x5ef10b){const _0x35ba15=_0xcb06a2,{username:_0x46357e,password:_0x3a0062,phone:_0x3a9dbb,phoneCode:_0xe7e314,invitedBy:_0xb5c612}=_0x21c47e;await this[_0x35ba15(0x172)][_0x35ba15(0x177)](_0x21c47e);const _0x4af4e3=await this[_0x35ba15(0x139)][_0x35ba15(0x1ae)](),_0x59fd80=_0x4af4e3+':PHONECODE:'+_0x3a9dbb,_0x180a95=await this[_0x35ba15(0x15f)][_0x35ba15(0x146)]({'key':_0x59fd80});if(!_0x180a95)throw new common_1[(_0x35ba15(0x195))](_0x35ba15(0x135),common_1[_0x35ba15(0x187)][_0x35ba15(0x16c)]);if(_0xe7e314!==_0x180a95)throw new common_1[(_0x35ba15(0x195))]('验证码填写错误、请重新输入！',common_1[_0x35ba15(0x187)][_0x35ba15(0x16c)]);const _0x53e48e=(0x0,utils_1[_0x35ba15(0x1b0)])()+_0x35ba15(0x19d),_0x5cbce0={'username':_0x46357e,'password':_0x3a0062,'phone':_0x3a9dbb,'invitedBy':_0xb5c612,'email':_0x53e48e,'status':user_constant_1[_0x35ba15(0x14b)][_0x35ba15(0x18f)]},_0x3775e4=await this['globalConfigService'][_0x35ba15(0x165)]([_0x35ba15(0x1a6)]);_0x5cbce0[_0x35ba15(0x19c)]=_0x3775e4;const _0x395f82=bcrypt[_0x35ba15(0x16e)](_0x3a0062,0xa);_0x5cbce0[_0x35ba15(0x171)]=_0x395f82;const _0x187b53=await this['userService']['createUser'](_0x5cbce0);let _0x5079dd;_0xb5c612&&(_0x5079dd=await this[_0x35ba15(0x172)][_0x35ba15(0x18d)](_0xb5c612));await this[_0x35ba15(0x141)][_0x35ba15(0x16f)](_0x187b53['id'],_0x5079dd===null||_0x5079dd===void 0x0?void 0x0:_0x5079dd['id']);return;}async[_0xcb06a2(0x176)](_0x27bb94,_0x1cc387){const _0x5bda88=_0xcb06a2,_0x4e3846=await this['userService']['verifyUserCredentials'](_0x27bb94),{username:_0x28cfb0,id:_0x46f276,email:_0x52b03c,role:_0x434ca5,openId:_0x41334b,client:_0x43cc05}=_0x4e3846,_0x30f3dd=(0x0,utils_1[_0x5bda88(0x185)])(_0x1cc387);await this['userService'][_0x5bda88(0x183)](_0x46f276,_0x30f3dd);const _0x295004=await this[_0x5bda88(0x159)][_0x5bda88(0x15e)]({'username':_0x28cfb0,'id':_0x46f276,'email':_0x52b03c,'role':_0x434ca5,'openId':_0x41334b,'client':_0x43cc05});return await this['redisCacheService'][_0x5bda88(0x199)](_0x46f276,_0x295004),_0x295004;}async[_0xcb06a2(0x1a9)](_0x20f3ef,_0x4a51ad){const _0x2811d9=_0xcb06a2,_0x3e9b2e=await this['userService'][_0x2811d9(0x1a2)](_0x20f3ef),{username:_0x146171,id:_0x42bec0,email:_0x38bd6d,role:_0x4ab399,openId:_0x3831b2,client:_0x4e3de9}=_0x3e9b2e,_0xe83243=(0x0,utils_1['getClientIp'])(_0x4a51ad);await this['userService'][_0x2811d9(0x183)](_0x42bec0,_0xe83243);const {phone:_0x244686}=_0x20f3ef,_0x237006=await this[_0x2811d9(0x159)]['sign']({'username':_0x146171,'id':_0x42bec0,'email':_0x38bd6d,'role':_0x4ab399,'openId':_0x3831b2,'client':_0x4e3de9,'phone':_0x244686});return await this['redisCacheService'][_0x2811d9(0x199)](_0x42bec0,_0x237006),_0x237006;}async[_0xcb06a2(0x173)](_0x4c40fa,_0x13c9e8){const _0x36c667=_0xcb06a2,{status:_0x1f6bd4}=_0x4c40fa;if(_0x1f6bd4!==user_constant_1[_0x36c667(0x14b)][_0x36c667(0x18f)])throw new common_1['HttpException'](user_constant_1[_0x36c667(0x197)][_0x1f6bd4],common_1[_0x36c667(0x187)]['BAD_REQUEST']);const {username:_0xd31415,id:_0x322886,email:_0x3ea5ef,role:_0x404539,openId:_0x37c1f6,client:_0x47a1d6}=_0x4c40fa,_0x2bf88a=(0x0,utils_1[_0x36c667(0x185)])(_0x13c9e8);await this[_0x36c667(0x172)][_0x36c667(0x183)](_0x322886,_0x2bf88a);const _0x2c6b03=await this[_0x36c667(0x159)][_0x36c667(0x15e)]({'username':_0xd31415,'id':_0x322886,'email':_0x3ea5ef,'role':_0x404539,'openId':_0x37c1f6,'client':_0x47a1d6});return await this['redisCacheService'][_0x36c667(0x199)](_0x322886,_0x2c6b03),_0x2c6b03;}async['getInfo'](_0x510edd){const _0x295fba=_0xcb06a2,{id:_0x4e54c9}=_0x510edd[_0x295fba(0x166)];return await this[_0x295fba(0x172)][_0x295fba(0x14a)](_0x4e54c9);}async['activateAccount'](_0x553cda,_0x3751b3){const _0x23d61c=_0xcb06a2,_0x16b63f=await this['configEntity'][_0x23d61c(0x175)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x23d61c(0x153),_0x23d61c(0x138),'registerSuccessEmaileAppend',_0x23d61c(0x198),'registerFailEmailTeamName'])}}),_0x5382c7=_0x16b63f['reduce']((_0x1c6a17,_0x7e65eb)=>{const _0x2d948c=_0x23d61c;return _0x1c6a17[_0x7e65eb[_0x2d948c(0x1a3)]]=_0x7e65eb[_0x2d948c(0x181)],_0x1c6a17;},{});try{const _0x40ef51=await this['verificationService'][_0x23d61c(0x147)](_0x553cda,verification_constant_1['VerificationEnum'][_0x23d61c(0x1a4)]),{type:_0x12999a,userId:_0x256f29}=_0x40ef51;if(_0x12999a!==verification_constant_1['VerificationEnum'][_0x23d61c(0x1a4)])throw new common_1['HttpException']('验证码类型错误',common_1[_0x23d61c(0x187)][_0x23d61c(0x16c)]);const _0x1bc2c3=await this[_0x23d61c(0x172)]['getUserStatus'](_0x256f29);if(_0x1bc2c3===user_constant_1['UserStatusEnum'][_0x23d61c(0x18f)])throw new common_1[(_0x23d61c(0x195))]('账户已被激活过',common_1[_0x23d61c(0x187)][_0x23d61c(0x16c)]);await this[_0x23d61c(0x172)][_0x23d61c(0x12e)](_0x40ef51[_0x23d61c(0x17b)],user_constant_1[_0x23d61c(0x14b)][_0x23d61c(0x18f)]);const _0x40ab0a=await this['userService'][_0x23d61c(0x1a7)](_0x40ef51[_0x23d61c(0x17b)]),{username:_0x2714d4,email:_0x4db01d,id:_0x580823,invitedBy:_0x26d450}=_0x40ab0a;let _0x616cf6;_0x26d450&&(_0x616cf6=await this[_0x23d61c(0x172)][_0x23d61c(0x18d)](_0x26d450)),await this[_0x23d61c(0x141)]['addBalanceToNewUser'](_0x580823,_0x616cf6===null||_0x616cf6===void 0x0?void 0x0:_0x616cf6['id']),_0x3751b3['redirect'](_0x23d61c(0x149)+_0x580823[_0x23d61c(0x134)]()['padStart'](0x4,'0')+'&username='+_0x2714d4+_0x23d61c(0x194)+_0x4db01d+_0x23d61c(0x1ad)+_0x5382c7['registerSuccessEmailTitle']+_0x23d61c(0x16b)+_0x5382c7[_0x23d61c(0x138)]+_0x23d61c(0x161)+_0x5382c7['registerSuccessEmaileAppend']);}catch(_0x17e413){console[_0x23d61c(0x17f)](_0x23d61c(0x1af),_0x17e413);const _0x570cdb=_0x17e413[_0x23d61c(0x18e)];_0x3751b3[_0x23d61c(0x179)](_0x23d61c(0x148)+_0x570cdb+_0x23d61c(0x137)+_0x5382c7[_0x23d61c(0x198)]+_0x23d61c(0x1ac)+_0x5382c7['registerFailEmailTeamName']);}}async[_0xcb06a2(0x1b9)](_0x2c228f,_0x1c4a11){const _0x28a860=_0xcb06a2,{id:_0xbe9e25,client:_0x30c845,role:_0x2f822d}=_0x2c228f[_0x28a860(0x166)];if(_0x30c845&&Number(_0x30c845)>0x0)throw new common_1[(_0x28a860(0x195))]('无权此操作、请联系管理员！',common_1['HttpStatus'][_0x28a860(0x16c)]);if(_0x2f822d===_0x28a860(0x133))throw new common_1[(_0x28a860(0x195))](_0x28a860(0x169),common_1[_0x28a860(0x187)][_0x28a860(0x16c)]);const _0x88bbdb=await this[_0x28a860(0x172)][_0x28a860(0x152)](_0xbe9e25,_0x1c4a11[_0x28a860(0x1b5)]);if(!_0x88bbdb)throw new common_1[(_0x28a860(0x195))](_0x28a860(0x19a),common_1['HttpStatus'][_0x28a860(0x16c)]);return this[_0x28a860(0x172)][_0x28a860(0x154)](_0xbe9e25,_0x1c4a11[_0x28a860(0x171)]),'密码修改成功';}async['updatePassByOther'](_0x5d93e6,_0x379158){const _0x4bc130=_0xcb06a2,{id:_0x39c252,client:_0x16758e}=_0x5d93e6[_0x4bc130(0x166)];if(!_0x16758e)throw new common_1['HttpException'](_0x4bc130(0x190),common_1[_0x4bc130(0x187)][_0x4bc130(0x16c)]);return this[_0x4bc130(0x172)][_0x4bc130(0x154)](_0x39c252,_0x379158[_0x4bc130(0x171)]),'密码修改成功';}[_0xcb06a2(0x1b3)](){const _0x1541bd=_0xcb06a2;let _0x377aa0;const _0x3685f4=os[_0x1541bd(0x143)]();Object[_0x1541bd(0x184)](_0x3685f4)[_0x1541bd(0x174)](_0x52bfc4=>{const _0x331aa4=_0x1541bd,_0x11d0fa=_0x3685f4[_0x52bfc4];for(let _0x1e667f=0x0;_0x1e667f<_0x11d0fa['length'];_0x1e667f++){const _0x30cb05=_0x11d0fa[_0x1e667f];if(_0x30cb05[_0x331aa4(0x144)]==='IPv4'&&_0x30cb05[_0x331aa4(0x155)]!==_0x331aa4(0x151)&&!_0x30cb05[_0x331aa4(0x167)]){_0x377aa0=_0x30cb05['address'];break;}}}),this[_0x1541bd(0x13b)]=_0x377aa0;}async['captcha'](_0x31fa27){const _0x2b4934=_0xcb06a2,_0x2c3136=await this[_0x2b4934(0x139)][_0x2b4934(0x1ae)](),{color:color='#fff'}=_0x31fa27,_0x5a6949=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x42eca6=_0x5a6949[_0x2b4934(0x1b6)],_0xb46e33=(0x0,utils_1[_0x2b4934(0x1b0)])(),_0x169c5e=_0x2c3136+_0x2b4934(0x17e)+_0xb46e33;return await this['redisCacheService']['set']({'key':_0x169c5e,'val':_0x5a6949['text']},0x5*0x3c),{'svgCode':_0x5a6949[_0x2b4934(0x162)],'code':_0xb46e33};}async[_0xcb06a2(0x12f)](_0x16b984){const _0x34d92a=_0xcb06a2;await this[_0x34d92a(0x188)][_0x34d92a(0x17c)](_0x16b984);const {phone:_0x496645}=_0x16b984,_0xd566f9=await this[_0x34d92a(0x139)][_0x34d92a(0x1ae)](),_0x6e5583=_0xd566f9+_0x34d92a(0x130)+_0x496645,_0x2d2ec9=await this[_0x34d92a(0x15f)][_0x34d92a(0x14f)](_0x6e5583);if(_0x2d2ec9&&_0x2d2ec9>0x0)throw new common_1['HttpException'](_0x2d2ec9+_0x34d92a(0x157),common_1['HttpStatus'][_0x34d92a(0x16c)]);const _0x275541=(0x0,utils_1[_0x34d92a(0x17a)])(),_0x3cf19c={'phone':_0x496645,'code':_0x275541};return await this['verificationService'][_0x34d92a(0x12f)](_0x3cf19c),await this[_0x34d92a(0x15f)][_0x34d92a(0x170)]({'key':_0x6e5583,'val':_0x275541},0x1*0x3c),_0x34d92a(0x1b7);}[_0xcb06a2(0x14e)](_0xd62663){const _0x2daa40=_0xcb06a2,_0x452325=this[_0x2daa40(0x159)][_0x2daa40(0x15e)]({'username':'游客'+_0xd62663,'id':_0xd62663,'email':_0xd62663+_0x2daa40(0x19d),'role':_0x2daa40(0x192),'openId':null,'client':null});return _0x452325;}};function _0x35f7(){const _0x314296=['get','verifyCode','/api/auth/registerError?message=','/api/auth/registerSuccess?id=','getUserInfo','UserStatusEnum','../verification/verification.service','323260AwUodK','createTokenFromFingerprint','ttl','__param','127.0.0.1','verifyUserPassword','registerSuccessEmailTitle','updateUserPassword','address','622360iHPxei','秒内不得重复发送短信！','2161620RGcVpw','jwtService','../userBalance/userBalance.service','object','@nestjs/typeorm','../globalConfig/config.entity','sign','redisCacheService','GlobalConfigService','&registerSuccessEmaileAppend=','data','../redisCache/redisCache.service','22615xWlcSo','getConfigs','user','internal','@nestjs/common','非法操作、请联系管理员！','client','&registerSuccessEmailTeamName=','BAD_REQUEST','bcryptjs','hashSync','addBalanceToNewUser','set','password','userService','loginByOpenId','forEach','find','login','verifyUserRegisterByPhone','metadata','redirect','createRandomCode','userId','verifyCaptcha','configEntity',':CAPTCHA:','log','__metadata','configVal','@nestjs/jwt','savaLoginIp','keys','getClientIp','60Ihrbkw','HttpStatus','verificationService','InjectRepository','__esModule','mailerService','583122yDotEI','qureyUserInfoByInviteCode','response','ACTIVE','无权此操作！','MailerService','visitor','../../common/constants/user.constant','&email=','HttpException','svg-captcha','UserStatusErrMsg','registerFailEmailTitle','saveToken','旧密码错误、请检查提交','8ovFqKH','avatar','@nine.com','../user/user.service','../mailer/mailer.service','3182508pBjIDR','UserService','verifyUserCredentials','configKey','Registration','defineProperty','userDefautlAvatar','queryUserInfoById','1DfcWVL','loginByPhone','function','decorate','&registerFailEmailTeamName=','&registerSuccessEmailTitle=','getNamespace','error:\x20','createRandomUid','registerByPhone','onModuleInit','getIp','length','oldPassword','text','验证码发送成功、请填写验证码完成注册！','3579401boRPRT','updatePassword','updateUserStatus','sendPhoneCode',':PHONECODE:','../../common/constants/verification.constant','Repository','admin','toString','验证码已过期、请重新发送！','typeorm','&registerFailEmailTitle=','registerSuccessEmailTeamName','globalConfigService','getOwnPropertyDescriptor','ipAddress','design:paramtypes','../globalConfig/globalConfig.service','createUserAndVerifycation','AuthService','UserBalanceService','userBalanceService','../../common/utils','networkInterfaces','family','JwtService'];_0x35f7=function(){return _0x314296;};return _0x35f7();}AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0xcb06a2(0x189)])(config_entity_1['ConfigEntity'])),__metadata(_0xcb06a2(0x13c),[typeorm_1[_0xcb06a2(0x132)],user_service_1[_0xcb06a2(0x1a1)],jwt_1[_0xcb06a2(0x145)],mailer_service_1[_0xcb06a2(0x191)],verification_service_1['VerificationService'],userBalance_service_1[_0xcb06a2(0x140)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0xcb06a2(0x160)]])],AuthService),exports[_0xcb06a2(0x13f)]=AuthService;