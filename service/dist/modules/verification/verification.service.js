'use strict';const _0x328ac5=_0x4a02;function _0x4a02(_0x4c8222,_0xb09cef){const _0x538e24=_0x538e();return _0x4a02=function(_0x4a026f,_0x5d2c69){_0x4a026f=_0x4a026f-0xeb;let _0x33e79e=_0x538e24[_0x4a026f];return _0x33e79e;},_0x4a02(_0x4c8222,_0xb09cef);}(function(_0x167104,_0x59e9ac){const _0x5aaf7f=_0x4a02,_0x493d58=_0x167104();while(!![]){try{const _0xe792c4=-parseInt(_0x5aaf7f(0x129))/0x1*(-parseInt(_0x5aaf7f(0x11b))/0x2)+-parseInt(_0x5aaf7f(0x120))/0x3+-parseInt(_0x5aaf7f(0xee))/0x4*(parseInt(_0x5aaf7f(0xf6))/0x5)+parseInt(_0x5aaf7f(0x105))/0x6+parseInt(_0x5aaf7f(0xf3))/0x7+-parseInt(_0x5aaf7f(0xed))/0x8+parseInt(_0x5aaf7f(0xf5))/0x9;if(_0xe792c4===_0x59e9ac)break;else _0x493d58['push'](_0x493d58['shift']());}catch(_0x49b021){_0x493d58['push'](_0x493d58['shift']());}}}(_0x538e,0x9b385));function _0x538e(){const _0x4a9e6c=['getNamespace','getOwnPropertyDescriptor',':CAPTCHA:','验证码不存在','globalConfigService','request','verifyCaptcha','__metadata','expiresAt','update','metadata','decorate','VerificationUseStatusEnum','Message','verifycationEntity','@alicloud/pop-core','defineProperty','867922SJsyAx','Injectable','RedisCacheService','verifyCode','https://dysmsapi.aliyuncs.com','3512400WZftRd','code','@nestjs/common','SendSms','./verifycation.entity','sendPhoneCode','redisCacheService','HttpException','findOne','1SSNCTg','图形验证码已过期、请重新输入!','createdAt','USED','getTime','object','../../common/constants/status.constant','BAD_REQUEST','used','2222096bxJvSe','585688SCYLZv','length','验证码发送失败！','__esModule','function','2098467jfbuFC','typeorm','12086568CLoGum','35nGZUDq','createRandomCode','Repository','确实必要参数错误！','验证码已过期','VerificationService','S内不得重新发送','__decorate','get','now','data','design:paramtypes','POST','__param','getPhoneVerifyConfig','6195618ENyOTq','HttpStatus','stringify','../globalConfig/globalConfig.service','VerifycationEntity'];_0x538e=function(){return _0x4a9e6c;};return _0x538e();}var __decorate=this&&this[_0x328ac5(0xfd)]||function(_0xb17d31,_0x43b42f,_0x2f65dd,_0x3845d5){const _0x56f082=_0x328ac5;var _0x4450d5=arguments[_0x56f082(0xef)],_0x20ef78=_0x4450d5<0x3?_0x43b42f:_0x3845d5===null?_0x3845d5=Object[_0x56f082(0x10b)](_0x43b42f,_0x2f65dd):_0x3845d5,_0x99af37;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x20ef78=Reflect[_0x56f082(0x115)](_0xb17d31,_0x43b42f,_0x2f65dd,_0x3845d5);else{for(var _0x1919cd=_0xb17d31[_0x56f082(0xef)]-0x1;_0x1919cd>=0x0;_0x1919cd--)if(_0x99af37=_0xb17d31[_0x1919cd])_0x20ef78=(_0x4450d5<0x3?_0x99af37(_0x20ef78):_0x4450d5>0x3?_0x99af37(_0x43b42f,_0x2f65dd,_0x20ef78):_0x99af37(_0x43b42f,_0x2f65dd))||_0x20ef78;}return _0x4450d5>0x3&&_0x20ef78&&Object[_0x56f082(0x11a)](_0x43b42f,_0x2f65dd,_0x20ef78),_0x20ef78;},__metadata=this&&this[_0x328ac5(0x111)]||function(_0xb0e579,_0x472726){const _0x437890=_0x328ac5;if(typeof Reflect===_0x437890(0x12e)&&typeof Reflect['metadata']===_0x437890(0xf2))return Reflect[_0x437890(0x114)](_0xb0e579,_0x472726);},__param=this&&this[_0x328ac5(0x103)]||function(_0x42b395,_0x32cf2f){return function(_0x4d7f46,_0x582d0e){_0x32cf2f(_0x4d7f46,_0x582d0e,_0x42b395);};};Object[_0x328ac5(0x11a)](exports,_0x328ac5(0xf1),{'value':!![]}),exports[_0x328ac5(0xfb)]=void 0x0;const globalConfig_service_1=require(_0x328ac5(0x108)),status_constant_1=require(_0x328ac5(0x12f)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x328ac5(0xf4)),verifycation_entity_1=require(_0x328ac5(0x124)),common_1=require(_0x328ac5(0x122)),utils_1=require('../../common/utils'),redisCache_service_1=require('../redisCache/redisCache.service'),Core=require(_0x328ac5(0x119));let VerificationService=class VerificationService{constructor(_0x2af0dc,_0xc9b5c9,_0x69b145){const _0x1d7b9a=_0x328ac5;this[_0x1d7b9a(0x118)]=_0x2af0dc,this['globalConfigService']=_0xc9b5c9,this['redisCacheService']=_0x69b145;}async['createVerification'](_0x2fbe0b,_0x526e84,_0x35303c=0x1e*0x3c){const _0x53c02b=_0x328ac5,_0x147d74=await this[_0x53c02b(0x118)][_0x53c02b(0x128)]({'where':{'userId':_0x2fbe0b['id'],'type':_0x526e84},'order':{'createdAt':'DESC'}});if(_0x147d74&&_0x147d74[_0x53c02b(0x12b)][_0x53c02b(0x12d)]()+0x1*0x3c*0x3e8>Date[_0x53c02b(0xff)]()){const _0x2e2225=Math['ceil']((_0x147d74[_0x53c02b(0x12b)][_0x53c02b(0x12d)]()+0x1*0x3c*0x3e8-Date[_0x53c02b(0xff)]())/0x3e8);throw new common_1[(_0x53c02b(0x127))](_0x2e2225+_0x53c02b(0xfc),common_1['HttpStatus'][_0x53c02b(0xeb)]);}const _0x1c33da=(0x0,utils_1[_0x53c02b(0xf7)])(),_0x536e44=new Date(Date[_0x53c02b(0xff)]()+_0x35303c*0x3e8),{id:_0x448f79,email:_0x2767be}=_0x2fbe0b,_0x2ee5ea={'userId':_0x448f79,'type':_0x526e84,'code':_0x1c33da,'expiresAt':_0x536e44,'email':_0x2767be};return await this[_0x53c02b(0x118)]['save'](_0x2ee5ea);}async[_0x328ac5(0x11e)]({code:_0x49680d,id:_0x54d391},_0x420ad1){const _0x54e23d=_0x328ac5,_0x563038=await this[_0x54e23d(0x118)][_0x54e23d(0x128)]({'where':{'id':_0x54d391,'type':_0x420ad1},'order':{'createdAt':'DESC'}});if(!_0x563038)throw new common_1[(_0x54e23d(0x127))](_0x54e23d(0x10d),common_1[_0x54e23d(0x106)][_0x54e23d(0xeb)]);if(_0x563038['used']===status_constant_1['VerificationUseStatusEnum'][_0x54e23d(0x12c)])throw new common_1['HttpException']('当前验证码已被使用！',common_1['HttpStatus'][_0x54e23d(0xeb)]);else _0x563038[_0x54e23d(0xec)]=status_constant_1[_0x54e23d(0x116)][_0x54e23d(0x12c)],await this[_0x54e23d(0x118)][_0x54e23d(0x113)]({'id':_0x54d391},_0x563038);if(Number(_0x563038[_0x54e23d(0x121)])!==Number(_0x49680d))throw new common_1[(_0x54e23d(0x127))]('验证码错误',common_1[_0x54e23d(0x106)][_0x54e23d(0xeb)]);if(_0x563038[_0x54e23d(0x112)]<new Date())throw new common_1[(_0x54e23d(0x127))](_0x54e23d(0xfa),common_1[_0x54e23d(0x106)][_0x54e23d(0xeb)]);return _0x563038;}async[_0x328ac5(0x110)](_0x865494){const _0xb64749=_0x328ac5,{captchaId:_0x4fa92f,captchaCode:_0x3ebafb}=_0x865494,_0x51e228=await this[_0xb64749(0x10e)][_0xb64749(0x10a)](),_0x582551=_0x51e228+_0xb64749(0x10c)+_0x4fa92f,_0x47c74d=await this[_0xb64749(0x126)][_0xb64749(0xfe)]({'key':_0x582551});await this[_0xb64749(0x126)]['del']({'key':_0x582551});if(!_0x47c74d)throw new common_1[(_0xb64749(0x127))](_0xb64749(0x12a),common_1[_0xb64749(0x106)][_0xb64749(0xeb)]);if(!_0x47c74d||_0x47c74d!==_0x3ebafb)throw new common_1[(_0xb64749(0x127))]('图形验证码错误、请检查填写!',common_1[_0xb64749(0x106)][_0xb64749(0xeb)]);}async[_0x328ac5(0x125)](_0x347c6a){const _0x10fe2d=_0x328ac5;var _0x374e25;const {accessKeyId:_0x237ce2,accessKeySecret:_0x56337d,SignName:_0x2130ba,TemplateCode:_0x32372b}=await this[_0x10fe2d(0x10e)][_0x10fe2d(0x104)](),{phone:_0x2b91fa,code:_0x38a8d4}=_0x347c6a;if(!_0x2b91fa||!_0x38a8d4)throw new common_1[(_0x10fe2d(0x127))](_0x10fe2d(0xf9),common_1['HttpStatus']['BAD_REQUEST']);const _0x48ff74=new Core({'accessKeyId':_0x237ce2,'accessKeySecret':_0x56337d,'endpoint':_0x10fe2d(0x11f),'apiVersion':'2017-05-25'}),_0x11880a={'PhoneNumbers':_0x2b91fa,'SignName':_0x2130ba,'TemplateCode':_0x32372b,'TemplateParam':JSON[_0x10fe2d(0x107)]({'code':_0x38a8d4})},_0x26acaa={'method':_0x10fe2d(0x102),'formatParams':![]};try{const _0x43d1de=await _0x48ff74[_0x10fe2d(0x10f)](_0x10fe2d(0x123),_0x11880a,_0x26acaa);if(_0x43d1de['Code']==='OK')return!![];else throw new common_1[(_0x10fe2d(0x127))](_0x43d1de[_0x10fe2d(0x117)]||'验证码发送失败！',common_1[_0x10fe2d(0x106)][_0x10fe2d(0xeb)]);}catch(_0x21aaa7){throw new common_1[(_0x10fe2d(0x127))](((_0x374e25=_0x21aaa7===null||_0x21aaa7===void 0x0?void 0x0:_0x21aaa7[_0x10fe2d(0x100)])===null||_0x374e25===void 0x0?void 0x0:_0x374e25[_0x10fe2d(0x117)])||_0x10fe2d(0xf0),common_1['HttpStatus'][_0x10fe2d(0xeb)]);}}};VerificationService=__decorate([(0x0,common_1[_0x328ac5(0x11c)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x328ac5(0x109)])),__metadata(_0x328ac5(0x101),[typeorm_2[_0x328ac5(0xf8)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x328ac5(0x11d)]])],VerificationService),exports[_0x328ac5(0xfb)]=VerificationService;