'use strict';const _0x3faa9d=_0x3fe1;(function(_0x3eb70d,_0x1aaee8){const _0x38649c=_0x3fe1,_0x5a4f21=_0x3eb70d();while(!![]){try{const _0x1f0990=parseInt(_0x38649c(0x150))/0x1+-parseInt(_0x38649c(0x172))/0x2*(-parseInt(_0x38649c(0x171))/0x3)+parseInt(_0x38649c(0x175))/0x4*(-parseInt(_0x38649c(0x17e))/0x5)+-parseInt(_0x38649c(0x17a))/0x6*(-parseInt(_0x38649c(0x187))/0x7)+-parseInt(_0x38649c(0x188))/0x8+-parseInt(_0x38649c(0x170))/0x9*(-parseInt(_0x38649c(0x18b))/0xa)+parseInt(_0x38649c(0x176))/0xb*(-parseInt(_0x38649c(0x196))/0xc);if(_0x1f0990===_0x1aaee8)break;else _0x5a4f21['push'](_0x5a4f21['shift']());}catch(_0x4d6013){_0x5a4f21['push'](_0x5a4f21['shift']());}}}(_0x5632,0x3b653));var __decorate=this&&this['__decorate']||function(_0x45fda6,_0x19c4aa,_0x50f9bd,_0x52b0e4){const _0x5b06d9=_0x3fe1;var _0x252397=arguments[_0x5b06d9(0x159)],_0x25cbde=_0x252397<0x3?_0x19c4aa:_0x52b0e4===null?_0x52b0e4=Object['getOwnPropertyDescriptor'](_0x19c4aa,_0x50f9bd):_0x52b0e4,_0x5382a7;if(typeof Reflect==='object'&&typeof Reflect[_0x5b06d9(0x16d)]===_0x5b06d9(0x168))_0x25cbde=Reflect['decorate'](_0x45fda6,_0x19c4aa,_0x50f9bd,_0x52b0e4);else{for(var _0x1c829a=_0x45fda6[_0x5b06d9(0x159)]-0x1;_0x1c829a>=0x0;_0x1c829a--)if(_0x5382a7=_0x45fda6[_0x1c829a])_0x25cbde=(_0x252397<0x3?_0x5382a7(_0x25cbde):_0x252397>0x3?_0x5382a7(_0x19c4aa,_0x50f9bd,_0x25cbde):_0x5382a7(_0x19c4aa,_0x50f9bd))||_0x25cbde;}return _0x252397>0x3&&_0x25cbde&&Object[_0x5b06d9(0x184)](_0x19c4aa,_0x50f9bd,_0x25cbde),_0x25cbde;},__metadata=this&&this['__metadata']||function(_0x27990e,_0x413d52){const _0x3ba51d=_0x3fe1;if(typeof Reflect==='object'&&typeof Reflect[_0x3ba51d(0x166)]==='function')return Reflect[_0x3ba51d(0x166)](_0x27990e,_0x413d52);},__param=this&&this[_0x3faa9d(0x15e)]||function(_0x5870c3,_0x412f6c){return function(_0x260073,_0x400c77){_0x412f6c(_0x260073,_0x400c77,_0x5870c3);};};function _0x3fe1(_0x4db596,_0x2b1602){const _0x56321a=_0x5632();return _0x3fe1=function(_0x3fe16d,_0x1a8429){_0x3fe16d=_0x3fe16d-0x150;let _0x27e972=_0x56321a[_0x3fe16d];return _0x27e972;},_0x3fe1(_0x4db596,_0x2b1602);}function _0x5632(){const _0x4eea50=['update','VerificationService','SendSms','../../common/constants/status.constant','Message','data','metadata','USED','function','stringify','Injectable','VerifycationEntity','Code','decorate','get','BAD_REQUEST','690561EOMwJq','9YRUUxz','275928ytMEMJ','del','RedisCacheService','443308mURLRP','253wOUYuF','HttpStatus','redisCacheService','verifyCaptcha','6oSdzes','verifyCode','验证码已过期','used','5DEkcbr','图形验证码已过期、请重新输入!','HttpException','验证码不存在','../../common/utils','InjectRepository','defineProperty','Repository','getNamespace','2342893dIeQLL','1223848gxpRCF','createVerification','expiresAt','60GUxkUT','图形验证码错误、请检查填写!','globalConfigService','code','now','./verifycation.entity','createRandomCode','getTime','ceil','验证码发送失败！',':CAPTCHA:','449196EFbIop','159085NwGRgH','typeorm','确实必要参数错误！','getPhoneVerifyConfig','createdAt','findOne','save','https://dysmsapi.aliyuncs.com','VerificationUseStatusEnum','length','../redisCache/redisCache.service','../globalConfig/globalConfig.service','DESC','当前验证码已被使用！','__param','verifycationEntity'];_0x5632=function(){return _0x4eea50;};return _0x5632();}Object[_0x3faa9d(0x184)](exports,'__esModule',{'value':!![]}),exports[_0x3faa9d(0x161)]=void 0x0;const globalConfig_service_1=require(_0x3faa9d(0x15b)),status_constant_1=require(_0x3faa9d(0x163)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x3faa9d(0x151)),verifycation_entity_1=require(_0x3faa9d(0x190)),common_1=require('@nestjs/common'),utils_1=require(_0x3faa9d(0x182)),redisCache_service_1=require(_0x3faa9d(0x15a)),Core=require('@alicloud/pop-core');let VerificationService=class VerificationService{constructor(_0x47b0d3,_0x3884f8,_0x266a01){const _0x65b3c8=_0x3faa9d;this['verifycationEntity']=_0x47b0d3,this[_0x65b3c8(0x18d)]=_0x3884f8,this['redisCacheService']=_0x266a01;}async[_0x3faa9d(0x189)](_0x2d125e,_0x2aec8e,_0x550c98=0x1e*0x3c){const _0x58cd5b=_0x3faa9d,_0x39e099=await this[_0x58cd5b(0x15f)][_0x58cd5b(0x155)]({'where':{'userId':_0x2d125e['id'],'type':_0x2aec8e},'order':{'createdAt':_0x58cd5b(0x15c)}});if(_0x39e099&&_0x39e099[_0x58cd5b(0x154)][_0x58cd5b(0x192)]()+0x1*0x3c*0x3e8>Date[_0x58cd5b(0x18f)]()){const _0x9962f5=Math[_0x58cd5b(0x193)]((_0x39e099['createdAt'][_0x58cd5b(0x192)]()+0x1*0x3c*0x3e8-Date[_0x58cd5b(0x18f)]())/0x3e8);throw new common_1[(_0x58cd5b(0x180))](_0x9962f5+'S内不得重新发送',common_1[_0x58cd5b(0x177)]['BAD_REQUEST']);}const _0x4c7556=(0x0,utils_1[_0x58cd5b(0x191)])(),_0x187679=new Date(Date[_0x58cd5b(0x18f)]()+_0x550c98*0x3e8),{id:_0x1e22db,email:_0x15ca43}=_0x2d125e,_0x31ac47={'userId':_0x1e22db,'type':_0x2aec8e,'code':_0x4c7556,'expiresAt':_0x187679,'email':_0x15ca43};return await this['verifycationEntity'][_0x58cd5b(0x156)](_0x31ac47);}async[_0x3faa9d(0x17b)]({code:_0xff7e73,id:_0x738073},_0x2cb6e3){const _0x564547=_0x3faa9d,_0x44300c=await this['verifycationEntity'][_0x564547(0x155)]({'where':{'id':_0x738073,'type':_0x2cb6e3},'order':{'createdAt':'DESC'}});if(!_0x44300c)throw new common_1['HttpException'](_0x564547(0x181),common_1[_0x564547(0x177)]['BAD_REQUEST']);if(_0x44300c['used']===status_constant_1[_0x564547(0x158)][_0x564547(0x167)])throw new common_1[(_0x564547(0x180))](_0x564547(0x15d),common_1['HttpStatus']['BAD_REQUEST']);else _0x44300c[_0x564547(0x17d)]=status_constant_1[_0x564547(0x158)][_0x564547(0x167)],await this[_0x564547(0x15f)][_0x564547(0x160)]({'id':_0x738073},_0x44300c);if(Number(_0x44300c[_0x564547(0x18e)])!==Number(_0xff7e73))throw new common_1['HttpException']('验证码错误',common_1[_0x564547(0x177)][_0x564547(0x16f)]);if(_0x44300c[_0x564547(0x18a)]<new Date())throw new common_1['HttpException'](_0x564547(0x17c),common_1[_0x564547(0x177)][_0x564547(0x16f)]);return _0x44300c;}async[_0x3faa9d(0x179)](_0x429ce5){const _0x164c85=_0x3faa9d,{captchaId:_0x3a6ccb,captchaCode:_0xda7da7}=_0x429ce5,_0x538c33=await this[_0x164c85(0x18d)][_0x164c85(0x186)](),_0x250e31=_0x538c33+_0x164c85(0x195)+_0x3a6ccb,_0x172ace=await this[_0x164c85(0x178)][_0x164c85(0x16e)]({'key':_0x250e31});await this[_0x164c85(0x178)][_0x164c85(0x173)]({'key':_0x250e31});if(!_0x172ace)throw new common_1[(_0x164c85(0x180))](_0x164c85(0x17f),common_1[_0x164c85(0x177)][_0x164c85(0x16f)]);if(!_0x172ace||_0x172ace!==_0xda7da7)throw new common_1[(_0x164c85(0x180))](_0x164c85(0x18c),common_1[_0x164c85(0x177)][_0x164c85(0x16f)]);}async['sendPhoneCode'](_0x28f737){const _0x4af300=_0x3faa9d;var _0x5a67f3;const {accessKeyId:_0x333e54,accessKeySecret:_0x201cec,SignName:_0x148701,TemplateCode:_0x4e6597}=await this['globalConfigService'][_0x4af300(0x153)](),{phone:_0x3644a3,code:_0x390057}=_0x28f737;if(!_0x3644a3||!_0x390057)throw new common_1[(_0x4af300(0x180))](_0x4af300(0x152),common_1[_0x4af300(0x177)][_0x4af300(0x16f)]);const _0x4d0427=new Core({'accessKeyId':_0x333e54,'accessKeySecret':_0x201cec,'endpoint':_0x4af300(0x157),'apiVersion':'2017-05-25'}),_0x5d0494={'PhoneNumbers':_0x3644a3,'SignName':_0x148701,'TemplateCode':_0x4e6597,'TemplateParam':JSON[_0x4af300(0x169)]({'code':_0x390057})},_0x27babb={'method':'POST','formatParams':![]};try{const _0x3454e8=await _0x4d0427['request'](_0x4af300(0x162),_0x5d0494,_0x27babb);if(_0x3454e8[_0x4af300(0x16c)]==='OK')return!![];else throw new common_1[(_0x4af300(0x180))](_0x3454e8[_0x4af300(0x164)]||_0x4af300(0x194),common_1['HttpStatus'][_0x4af300(0x16f)]);}catch(_0x39c9c5){throw new common_1[(_0x4af300(0x180))](((_0x5a67f3=_0x39c9c5===null||_0x39c9c5===void 0x0?void 0x0:_0x39c9c5[_0x4af300(0x165)])===null||_0x5a67f3===void 0x0?void 0x0:_0x5a67f3[_0x4af300(0x164)])||_0x4af300(0x194),common_1['HttpStatus']['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1[_0x3faa9d(0x16a)])(),__param(0x0,(0x0,typeorm_1[_0x3faa9d(0x183)])(verifycation_entity_1[_0x3faa9d(0x16b)])),__metadata('design:paramtypes',[typeorm_2[_0x3faa9d(0x185)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x3faa9d(0x174)]])],VerificationService),exports[_0x3faa9d(0x161)]=VerificationService;