'use strict';function _0x5fe3(_0x49f523,_0x3b25d6){const _0x5e3cca=_0x5e3c();return _0x5fe3=function(_0x5fe388,_0x48bef6){_0x5fe388=_0x5fe388-0x1da;let _0x14bd73=_0x5e3cca[_0x5fe388];return _0x14bd73;},_0x5fe3(_0x49f523,_0x3b25d6);}const _0x347fe6=_0x5fe3;function _0x5e3c(){const _0x366bd5=['getQRSceneStrByBind','now','HttpException','onModuleInit',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','race','post','wechatAccessToken','../auth/auth.service','jsapi_ticket=','2487180qRiQxS','officialAutoReplyText','str:\x20','&redirect_uri=','680QfiRvP','非法参数','../../common/utils','digest','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','update','sha1','2237712bAYAvJ','checkAutoReply','getUserFromOpenId','get','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','&code=','autoreplyService','getQRCodeTicket','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','authService','9fdIuOW','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','回跳跳转地址:\x20','2290zqeBzE','verify','object','scanedSceneStrMap','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','17143xAxqzx','wechatOfficialToken','user','getWechatAccessToken','appId:\x20','来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整','globalConfigService','axios','请求超时','scan','../chatgpt/chatgpt.service','metadata','wechatJsapiTicket','getUserById','90zXBgGk','defineProperty','BAD_REQUEST','1489902ycsAmN','getRedirectUrl','createHash','AutoreplyService','407618huupDJ','fromusername','wechatOfficialAppId','wechatOfficialAppSecret','bindWxBySceneStr','aotoPlay','&secret=','605305UlFVUN','../globalConfig/globalConfig.service','toFixed','ChatgptService','Injectable','sceneStrMap','OfficialService','chatSyncFree','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','function','join','length','log','HttpStatus','fetchQRCodeTicket','tousername','getJsapiTicket','userService','genXmlMsg','jiangly','bindWx','AuthService','__esModule','chatgptService','decorate','&grant_type=authorization_code','loginByOpenId','loginByCode','getOwnPropertyDescriptor','来自公众号的询问问题\x20=======>\x20','jsapiTicket:\x20','&timestamp=','getConfigs','getTime','../autoreply/autoreply.service','split','default','genXmlMsgByConfig','QR_STR_SCENE','getQRSceneStr','createRandomNonceStr'];_0x5e3c=function(){return _0x366bd5;};return _0x5e3c();}(function(_0x4cb106,_0x342a54){const _0x5cc9c5=_0x5fe3,_0x281bc2=_0x4cb106();while(!![]){try{const _0x2f1d3c=-parseInt(_0x5cc9c5(0x21d))/0x1+parseInt(_0x5cc9c5(0x203))/0x2*(-parseInt(_0x5cc9c5(0x216))/0x3)+parseInt(_0x5cc9c5(0x1f6))/0x4+-parseInt(_0x5cc9c5(0x224))/0x5+parseInt(_0x5cc9c5(0x219))/0x6+parseInt(_0x5cc9c5(0x208))/0x7*(-parseInt(_0x5cc9c5(0x1ef))/0x8)+parseInt(_0x5cc9c5(0x200))/0x9*(parseInt(_0x5cc9c5(0x1eb))/0xa);if(_0x2f1d3c===_0x342a54)break;else _0x281bc2['push'](_0x281bc2['shift']());}catch(_0x2657ae){_0x281bc2['push'](_0x281bc2['shift']());}}}(_0x5e3c,0x45a55));var __decorate=this&&this['__decorate']||function(_0x436dd3,_0x55ca68,_0x574da5,_0x1be4f9){const _0x1249af=_0x5fe3;var _0x266f93=arguments[_0x1249af(0x22f)],_0x272d43=_0x266f93<0x3?_0x55ca68:_0x1be4f9===null?_0x1be4f9=Object[_0x1249af(0x240)](_0x55ca68,_0x574da5):_0x1be4f9,_0x2295aa;if(typeof Reflect===_0x1249af(0x205)&&typeof Reflect[_0x1249af(0x23c)]===_0x1249af(0x22d))_0x272d43=Reflect[_0x1249af(0x23c)](_0x436dd3,_0x55ca68,_0x574da5,_0x1be4f9);else{for(var _0x2ddac0=_0x436dd3[_0x1249af(0x22f)]-0x1;_0x2ddac0>=0x0;_0x2ddac0--)if(_0x2295aa=_0x436dd3[_0x2ddac0])_0x272d43=(_0x266f93<0x3?_0x2295aa(_0x272d43):_0x266f93>0x3?_0x2295aa(_0x55ca68,_0x574da5,_0x272d43):_0x2295aa(_0x55ca68,_0x574da5))||_0x272d43;}return _0x266f93>0x3&&_0x272d43&&Object[_0x1249af(0x217)](_0x55ca68,_0x574da5,_0x272d43),_0x272d43;},__metadata=this&&this['__metadata']||function(_0x1d0a67,_0x13da7e){const _0x55f088=_0x5fe3;if(typeof Reflect===_0x55f088(0x205)&&typeof Reflect[_0x55f088(0x213)]===_0x55f088(0x22d))return Reflect[_0x55f088(0x213)](_0x1d0a67,_0x13da7e);};Object[_0x347fe6(0x217)](exports,_0x347fe6(0x23a),{'value':!![]}),exports[_0x347fe6(0x22a)]=void 0x0;const chatgpt_service_1=require(_0x347fe6(0x212)),globalConfig_service_1=require(_0x347fe6(0x225)),auth_service_1=require(_0x347fe6(0x1e9)),user_service_1=require('../user/user.service'),autoreply_service_1=require(_0x347fe6(0x1da)),common_1=require('@nestjs/common'),crypto=require('crypto'),axios_1=require(_0x347fe6(0x20f)),utils_1=require(_0x347fe6(0x1f1));let OfficialService=class OfficialService{constructor(_0x1bcecd,_0x359628,_0x5f0937,_0x2929aa,_0x5463af){const _0x25b2ae=_0x347fe6;this[_0x25b2ae(0x1fc)]=_0x1bcecd,this[_0x25b2ae(0x235)]=_0x359628,this[_0x25b2ae(0x1ff)]=_0x5f0937,this[_0x25b2ae(0x20e)]=_0x2929aa,this[_0x25b2ae(0x23b)]=_0x5463af,this[_0x25b2ae(0x229)]={},this[_0x25b2ae(0x206)]={};}async[_0x347fe6(0x1e4)](){const _0xf90dda=_0x347fe6;await this[_0xf90dda(0x20e)][_0xf90dda(0x20b)](!![]);}async[_0x347fe6(0x1df)](_0x36b252){const _0xd55e41=_0x347fe6,{invitedBy:_0x5d5343}=_0x36b252;let _0x2eae78=(0x0,utils_1[_0xd55e41(0x1e0)])(0x20);return _0x5d5343&&(_0x2eae78+=':'+_0x5d5343),this['sceneStrMap'][_0x2eae78]=!![],_0x2eae78;}async[_0x347fe6(0x1e1)](_0x1aae0e){const _0x158186=_0x347fe6,{id:_0x51f5b2}=_0x1aae0e[_0x158186(0x20a)],_0x810027=(0x0,utils_1[_0x158186(0x1e0)])(0x20)+'/'+_0x51f5b2;return this[_0x158186(0x229)][_0x810027]=!![],_0x810027;}async[_0x347fe6(0x1fd)](_0x44ab69){return this['fetchQRCodeTicket'](_0x44ab69);}async[_0x347fe6(0x21a)](_0x449619){const _0x4643fa=_0x347fe6,_0x49fcf7=await this[_0x4643fa(0x20e)][_0x4643fa(0x244)]([_0x4643fa(0x21f)]),_0x4be47f=_0x4643fa(0x22c)+_0x49fcf7+_0x4643fa(0x1ee)+encodeURIComponent(_0x449619)+_0x4643fa(0x201);return console[_0x4643fa(0x230)](_0x4643fa(0x202),_0x4be47f),_0x4be47f;}async[_0x347fe6(0x234)](_0x53ea51){const _0xe08ad2=_0x347fe6,_0x100684=(0x0,utils_1[_0xe08ad2(0x1e0)])(0x20),_0x2f2c23=(Date[_0xe08ad2(0x1e2)]()/0x3e8)[_0xe08ad2(0x226)](0x0),_0x3a4575=await this[_0xe08ad2(0x20e)][_0xe08ad2(0x244)]([_0xe08ad2(0x214)]);console[_0xe08ad2(0x230)](_0xe08ad2(0x242),_0x3a4575);const _0x2108d9=await this[_0xe08ad2(0x20e)]['getConfigs']([_0xe08ad2(0x21f)]);console['log'](_0xe08ad2(0x20c),_0x2108d9);const _0x3d676f=_0xe08ad2(0x1ea)+_0x3a4575+'&noncestr='+_0x100684+_0xe08ad2(0x243)+_0x2f2c23+'&url='+_0x53ea51;console[_0xe08ad2(0x230)](_0xe08ad2(0x1ed),_0x3d676f);const _0xb4848=this['sha1'](_0x3d676f);return{'appId':_0x2108d9,'nonceStr':_0x100684,'timestamp':_0x2f2c23,'signature':_0xb4848};}async[_0x347fe6(0x232)](_0x55c941){const _0x2c038b=_0x347fe6,_0x58139a=await this[_0x2c038b(0x20e)][_0x2c038b(0x244)]([_0x2c038b(0x1e8)]),_0x1a20b7={'action_name':_0x2c038b(0x1de),'action_info':{'scene':{'scene_str':_0x55c941}}},_0x4ed961=await axios_1[_0x2c038b(0x1dc)][_0x2c038b(0x1e7)](_0x2c038b(0x1fe)+_0x58139a,_0x1a20b7),{data:{errmsg:_0x584f63,ticket:_0x5341fa}}=_0x4ed961;if(_0x584f63)throw new common_1[(_0x2c038b(0x1e3))](_0x584f63,common_1[_0x2c038b(0x231)]['BAD_REQUEST']);return _0x5341fa;}async[_0x347fe6(0x23f)](_0x23972f,_0x29d05e){const _0x4d1923=_0x347fe6,_0x716e62=await this['globalConfigService'][_0x4d1923(0x244)]([_0x4d1923(0x21f)]),_0xdd3a0e=await this[_0x4d1923(0x20e)]['getConfigs']([_0x4d1923(0x220)]),_0x1f7c30=await axios_1[_0x4d1923(0x1dc)][_0x4d1923(0x1f9)](_0x4d1923(0x1fa)+_0x716e62+_0x4d1923(0x223)+_0xdd3a0e+_0x4d1923(0x1fb)+_0x29d05e+_0x4d1923(0x23d)),{data:{errmsg:_0x3d5e9a,openid:_0x4fb49d}}=_0x1f7c30;if(_0x3d5e9a)throw new common_1[(_0x4d1923(0x1e3))](_0x3d5e9a,common_1[_0x4d1923(0x231)]['BAD_REQUEST']);let _0x51bbde;return _0x51bbde=await this['userService']['getUserOpenId'](_0x4fb49d),!_0x51bbde&&(_0x51bbde=await this[_0x4d1923(0x235)][_0x4d1923(0x1f8)](_0x4fb49d)),this[_0x4d1923(0x1ff)][_0x4d1923(0x23e)](_0x51bbde,_0x23972f);}async[_0x347fe6(0x211)](_0x117205,_0x105913){const _0x5a3c64=_0x347fe6;if(!this['sceneStrMap'][_0x105913])throw new common_1[(_0x5a3c64(0x1e3))]('非法参数',common_1[_0x5a3c64(0x231)][_0x5a3c64(0x218)]);const _0x7fcdd6=await this['userService'][_0x5a3c64(0x1f8)](_0x117205,_0x105913);this['scanedSceneStrMap'][_0x105913]=_0x7fcdd6['id'];}async['loginBySceneStr'](_0x5b1ba9,_0x57fef6){const _0x1950c3=_0x347fe6;if(!this[_0x1950c3(0x229)][_0x57fef6])return;const _0xe8f8b6=this[_0x1950c3(0x206)][_0x57fef6];if(!_0xe8f8b6)return'';const _0x5d0e07=await this['userService'][_0x1950c3(0x215)](_0xe8f8b6);return delete this['scanedSceneStrMap'][_0x57fef6],this[_0x1950c3(0x1ff)][_0x1950c3(0x23e)](_0x5d0e07,_0x5b1ba9);}async['scanBindWx'](_0x40bb91,_0xf4ede6){const _0x5c9b7d=_0x347fe6;if(!this[_0x5c9b7d(0x229)][_0xf4ede6])throw new common_1[(_0x5c9b7d(0x1e3))](_0x5c9b7d(0x1f0),common_1[_0x5c9b7d(0x231)][_0x5c9b7d(0x218)]);const _0x2d503b=_0xf4ede6[_0x5c9b7d(0x1db)]('/')[0x1],_0x14d3f8=await this[_0x5c9b7d(0x235)][_0x5c9b7d(0x238)](_0x40bb91,_0x2d503b);this[_0x5c9b7d(0x206)][_0xf4ede6]=_0x14d3f8;}async[_0x347fe6(0x221)](_0x2d2b7e,_0x309702){const _0x4efd5c=_0x347fe6;if(!this[_0x4efd5c(0x229)][_0x309702])throw new common_1[(_0x4efd5c(0x1e3))](_0x4efd5c(0x1f0),common_1['HttpStatus']['BAD_REQUEST']);const {id:_0x3f0f83}=_0x2d2b7e[_0x4efd5c(0x20a)],_0x16d197=this['scanedSceneStrMap'][_0x309702];if(!_0x16d197)return'';return delete this[_0x4efd5c(0x206)][_0x309702],_0x16d197;}async[_0x347fe6(0x204)](_0xb7c469,_0x5dc6fa,_0x5f4a34){const _0x5631c8=_0x347fe6,_0x360996=await this[_0x5631c8(0x20e)][_0x5631c8(0x244)]([_0x5631c8(0x209)])||_0x5631c8(0x237);return await this['sha1']([_0x360996,_0x5dc6fa,_0x5f4a34]['sort']()[_0x5631c8(0x22e)](''))==_0xb7c469;}[_0x347fe6(0x1f5)](_0x43c717){const _0x55127c=_0x347fe6;return crypto[_0x55127c(0x21b)]('sha1')[_0x55127c(0x1f4)](_0x43c717)[_0x55127c(0x1f2)]('hex');}async[_0x347fe6(0x1dd)](_0xbe8d9e,_0x4b3790){const _0x572354=_0x347fe6,_0x55b795=await this['globalConfigService'][_0x572354(0x244)]([_0x4b3790]);return this[_0x572354(0x236)](_0xbe8d9e,_0x55b795);}async['genXmlMsg'](_0x259a1c,_0x158634){const _0x86f057=_0x347fe6;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x259a1c[_0x86f057(0x21e)][0x0]+_0x86f057(0x1e5)+_0x259a1c[_0x86f057(0x233)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+new Date()[_0x86f057(0x245)]()+_0x86f057(0x1f3)+_0x158634+']]></Content>\x0a\x20\x20\x20\x20</xml>';}async[_0x347fe6(0x222)](_0x1bf863){const _0x3a8f3a=_0x347fe6,_0xb3a111=new Promise((_0x27a4ea,_0x36e77c)=>{setTimeout(()=>{const _0x435020=_0x5fe3;_0x36e77c(new Error(_0x435020(0x210)));},0x12c0);});let _0x274a4c='';try{console[_0x3a8f3a(0x230)](_0x3a8f3a(0x241),_0x1bf863);const _0x3ae48a=await Promise[_0x3a8f3a(0x1e6)]([this[_0x3a8f3a(0x23b)][_0x3a8f3a(0x22b)](_0x1bf863),_0xb3a111]);_0x274a4c=_0x3ae48a||await this[_0x3a8f3a(0x1fc)][_0x3a8f3a(0x1f7)](_0x1bf863);}catch(_0xb9bbaf){console[_0x3a8f3a(0x230)](_0x3a8f3a(0x20d)),_0x274a4c=await this[_0x3a8f3a(0x20e)][_0x3a8f3a(0x244)]([_0x3a8f3a(0x1ec)])||_0x3a8f3a(0x207);}return _0x274a4c;}};OfficialService=__decorate([(0x0,common_1[_0x347fe6(0x228)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x347fe6(0x21c)],user_service_1['UserService'],auth_service_1[_0x347fe6(0x239)],globalConfig_service_1['GlobalConfigService'],chatgpt_service_1[_0x347fe6(0x227)]])],OfficialService),exports[_0x347fe6(0x22a)]=OfficialService;