'use strict';const _0x410759=_0x2c89;function _0x2d15(){const _0xd8dc8d=['ConfigEntity','log','queryAll','UNAUTHORIZED','getOpenIdByUserId','configKey','createUserFromOpenId','phone','formatCreateOrUpdateDate','UserService','update','checkUserStatus','HttpException','不可将用户置为未激活状态！','cloneDeep','Not','getConfigs','当前密码错误！','该微信已绑定其他账号！','maskIpAddress','8ybVpfF','没有变更，无需更改！','Like','9660260ZrHPRT','generateRandomString','queryUserInfoById','inviteCode','forEach','当前用户信息失效、请重新登录！','未激活用户不可手动变更状态！','bindWx','startsWith','PENDING','verifyUserRegisterByPhone','../globalConfig/config.entity','user','consecutiveDays','getUserInfo','----,','findOne','isBindWx','2983158jsuCyH','email','$2b$','当前手机号已注册、请勿重复注册！','object','UserBalanceService','$2a$','error:\x20','verificationService','openId','mailerService','修改密码失败、请重新试试吧。','crypto','超级管理员不可被操作！','4779691yatDaZ','createUserAndVerifycation','生成邀请码失败，请重新试一次吧！','getSuper','../../common/constants/balance.constant','__esModule','registerBaseUrl','ACTIVE','find','email\x20response\x20\x20->\x20:\x20','Registration','configVal','decorate','362JPlXkk','绑定微信失败、请联系管理员！','../verification/verification.service','globalConfigService','$2y$','role','BLACKLISTED','../userBalance/userBalance.service','registerIp','的账号激活','InjectRepository','configMap:\x20','registerVerifyExpir','affected','getUserOpenId','RechargeType','修改用户信息成功！','getOwnPropertyDescriptor','UserEntity','VerificationService','reduce','WhiteListEntity','createHash','password','用户不存在！','69175ITzySm','addBalanceToNewUser','用户名已存在！','typeorm','MailerService','split','恭喜您绑定成功、后续可直接扫码登录了！','userEntity','createVerification','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','./user.entity','saveRecordRechargeLog','lastLoginIp','@nestjs/typeorm','Injectable','../chatgpt/whiteList.entity','findAndCount','当前绑定用户不存在！','verifyUserPassword','__param','queryOne','maskEmail','assign','Repository','createRandomUid','savaLoginIp','BAD_REQUEST','当前用户不存在！','已生成过邀请码、请勿重复生成','sendMail','status','getUserStatus','../../common/constants/verification.constant','avatar','isVerifyEmail','getUserFromOpenId','configEntity','genInviteCode','super','hex','createUser','修改用户状态失败！','function','@nestjs/common','修改用户信息失败！','addBalanceToUser','register','digest','用户名或者邮箱已被注册！','visitor','sign','LOCKED','inviteLink','UserStatusEnum','updateUserStatus','compareSync','defineProperty','getInviteRecord','__metadata','GlobalConfigService','connection','__decorate','userBalanceService','UserStatusErrMsg','createdAt','md5','当前账户不存在！','username','123456','VerificationEnum','save','balanceInfo','1172nkXRnz','map','length','qureyUserInfoByInviteCode','verifyUserCredentials','HttpStatus','metadata','修改用户状态成功！','hashSync','getClientIp','Connection','2295669poonef','1012000UAtPvO','78JFefAy','whiteListEntity','lodash'];_0x2d15=function(){return _0xd8dc8d;};return _0x2d15();}(function(_0x14d6c6,_0x502a0d){const _0x1d2247=_0x2c89,_0x2574a8=_0x14d6c6();while(!![]){try{const _0x1cacfd=parseInt(_0x1d2247(0x14f))/0x1*(-parseInt(_0x1d2247(0x1b0))/0x2)+parseInt(_0x1d2247(0x1bb))/0x3+-parseInt(_0x1d2247(0x1bc))/0x4+parseInt(_0x1d2247(0x168))/0x5*(parseInt(_0x1d2247(0x1bd))/0x6)+-parseInt(_0x1d2247(0x142))/0x7*(parseInt(_0x1d2247(0x1d4))/0x8)+-parseInt(_0x1d2247(0x134))/0x9+parseInt(_0x1d2247(0x1d7))/0xa;if(_0x1cacfd===_0x502a0d)break;else _0x2574a8['push'](_0x2574a8['shift']());}catch(_0xc450a8){_0x2574a8['push'](_0x2574a8['shift']());}}}(_0x2d15,0x69651));var __decorate=this&&this[_0x410759(0x1a5)]||function(_0x3d29da,_0x4030d9,_0x186375,_0x608382){const _0xdc181f=_0x410759;var _0x55cc2a=arguments[_0xdc181f(0x1b2)],_0x16ebe4=_0x55cc2a<0x3?_0x4030d9:_0x608382===null?_0x608382=Object[_0xdc181f(0x160)](_0x4030d9,_0x186375):_0x608382,_0xcc0f61;if(typeof Reflect==='object'&&typeof Reflect[_0xdc181f(0x14e)]===_0xdc181f(0x192))_0x16ebe4=Reflect[_0xdc181f(0x14e)](_0x3d29da,_0x4030d9,_0x186375,_0x608382);else{for(var _0xeb4e6d=_0x3d29da['length']-0x1;_0xeb4e6d>=0x0;_0xeb4e6d--)if(_0xcc0f61=_0x3d29da[_0xeb4e6d])_0x16ebe4=(_0x55cc2a<0x3?_0xcc0f61(_0x16ebe4):_0x55cc2a>0x3?_0xcc0f61(_0x4030d9,_0x186375,_0x16ebe4):_0xcc0f61(_0x4030d9,_0x186375))||_0x16ebe4;}return _0x55cc2a>0x3&&_0x16ebe4&&Object[_0xdc181f(0x1a0)](_0x4030d9,_0x186375,_0x16ebe4),_0x16ebe4;},__metadata=this&&this[_0x410759(0x1a2)]||function(_0x97813b,_0x4e876e){const _0x12558c=_0x410759;if(typeof Reflect===_0x12558c(0x138)&&typeof Reflect['metadata']==='function')return Reflect[_0x12558c(0x1b6)](_0x97813b,_0x4e876e);},__param=this&&this[_0x410759(0x17b)]||function(_0x556b30,_0x408dbc){return function(_0x54a40f,_0x4233ba){_0x408dbc(_0x54a40f,_0x4233ba,_0x556b30);};};Object[_0x410759(0x1a0)](exports,_0x410759(0x147),{'value':!![]}),exports[_0x410759(0x1c9)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require('@nestjs-modules/mailer'),verification_service_1=require(_0x410759(0x151)),common_1=require(_0x410759(0x193)),typeorm_1=require(_0x410759(0x175)),typeorm_2=require(_0x410759(0x16b)),user_entity_1=require(_0x410759(0x172)),bcrypt=require('bcryptjs'),crypto=require(_0x410759(0x140)),_=require(_0x410759(0x1bf)),verification_constant_1=require(_0x410759(0x188)),userBalance_service_1=require(_0x410759(0x156)),utils_1=require('../../common/utils'),balance_constant_1=require(_0x410759(0x146)),config_entity_1=require(_0x410759(0x12d)),whiteList_entity_1=require(_0x410759(0x177));let UserService=class UserService{constructor(_0x4613c0,_0x4a21a7,_0x214469,_0x572146,_0x44c714,_0x39cb2b,_0x1abff0,_0x4a12e1){const _0xb22fe1=_0x410759;this[_0xb22fe1(0x16f)]=_0x4613c0,this[_0xb22fe1(0x1be)]=_0x4a21a7,this[_0xb22fe1(0x1a4)]=_0x214469,this[_0xb22fe1(0x13c)]=_0x572146,this[_0xb22fe1(0x13e)]=_0x44c714,this[_0xb22fe1(0x1a6)]=_0x39cb2b,this['globalConfigService']=_0x1abff0,this[_0xb22fe1(0x18c)]=_0x4a12e1;}async[_0x410759(0x143)](_0x910a2c,_0x5e7878){const _0x2840a6=_0x410759,{username:_0x4de632,email:_0x339df8,password:_0x3eb58b,invitedBy:_0x304e14,client:client=0x0}=_0x910a2c;if(_0x304e14){const _0x561b6b=await this[_0x2840a6(0x16f)][_0x2840a6(0x132)]({'where':{'inviteCode':_0x304e14}});if(!_0x561b6b)throw new common_1[(_0x2840a6(0x1cc))]('无效的邀请码！',common_1[_0x2840a6(0x1b5)]['BAD_REQUEST']);}const _0x551597=[{'username':_0x4de632},{'email':_0x339df8}],_0x46d550=await this['userEntity'][_0x2840a6(0x132)]({'where':_0x551597});if(_0x46d550&&_0x46d550[_0x2840a6(0x186)]!==user_constant_1[_0x2840a6(0x19d)][_0x2840a6(0x12b)])throw new common_1[(_0x2840a6(0x1cc))](_0x2840a6(0x198),common_1['HttpStatus'][_0x2840a6(0x182)]);try{const _0x1ac0f6=_[_0x2840a6(0x1ce)](_0x910a2c),_0xe7ee60=bcrypt[_0x2840a6(0x1b8)](_0x3eb58b,0xa),_0x2211c7=(0x0,utils_1[_0x2840a6(0x1b9)])(_0x5e7878);_0x1ac0f6[_0x2840a6(0x166)]=_0xe7ee60,_0x1ac0f6[_0x2840a6(0x157)]=_0x2211c7,_0x1ac0f6['client']=client;let _0x5a6c3f;if(!_0x46d550){const _0x324887=await this[_0x2840a6(0x152)][_0x2840a6(0x1d0)](['userDefautlAvatar']);_0x1ac0f6[_0x2840a6(0x189)]=_0x324887,_0x5a6c3f=await this[_0x2840a6(0x16f)]['save'](_0x1ac0f6);}else _0x5a6c3f=_0x46d550;const _0xcaa43d=await this[_0x2840a6(0x18c)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x2840a6(0x18a),_0x2840a6(0x148),'registerVerifyEmailTitle','registerVerifyEmailDesc','registerVerifyEmailFrom','registerVerifyExpir'])}}),_0x482724=_0xcaa43d[_0x2840a6(0x163)]((_0xf8399b,_0x212316)=>{const _0x5f086f=_0x2840a6;return _0xf8399b[_0x212316[_0x5f086f(0x1c5)]]=_0x212316[_0x5f086f(0x14d)],_0xf8399b;},{}),_0x2b3aa1=_0x482724[_0x2840a6(0x18a)]?Number(_0x482724[_0x2840a6(0x18a)]):0x1;if(_0x2b3aa1){const _0x502ac7=_0x482724['registerVerifyExpir']?Number(_0x482724[_0x2840a6(0x15b)]):0x1e*0x3c,_0x24e40e=await this['verificationService'][_0x2840a6(0x170)](_0x5a6c3f,verification_constant_1[_0x2840a6(0x1ad)][_0x2840a6(0x14c)],_0x502ac7),{code:_0x3da4ca,email:_0x5f08fb,id:_0x2db6fa}=_0x24e40e,{registerVerifyEmailFrom:_0x437a97}=_0x482724;console['log'](_0x2840a6(0x15a),_0x482724);const _0x11a922=await this[_0x2840a6(0x13e)][_0x2840a6(0x185)]({'to':_0x5f08fb,'subject':'来自'+_0x437a97+_0x2840a6(0x158),'template':_0x2840a6(0x196),'context':Object[_0x2840a6(0x17e)]({'baseUrl':_0x482724['registerBaseUrl'],'code':_0x3da4ca,'id':_0x2db6fa},_0x482724)});console[_0x2840a6(0x1c1)](_0x2840a6(0x14b),_0x11a922);}else{const {username:_0x3299e8,email:_0x20347a,id:_0x264893,invitedBy:_0x5805d6}=_0x5a6c3f;await this[_0x2840a6(0x19e)](_0x264893,user_constant_1['UserStatusEnum'][_0x2840a6(0x149)]);let _0x3a86d8;_0x5805d6&&(_0x3a86d8=await this['qureyUserInfoByInviteCode'](_0x5805d6)),await this['userBalanceService'][_0x2840a6(0x169)](_0x264893,_0x3a86d8===null||_0x3a86d8===void 0x0?void 0x0:_0x3a86d8['id']);}return _0x5a6c3f;}catch(_0x20778e){console[_0x2840a6(0x1c1)](_0x2840a6(0x13b),_0x20778e);throw _0x20778e;}}async[_0x410759(0x145)](){const _0x434935=_0x410759,_0x150070=await this[_0x434935(0x16f)][_0x434935(0x132)]({'where':{'role':_0x434935(0x18e)}});return _0x150070;}async[_0x410759(0x1b4)](_0x1764fb){const _0x29beae=_0x410759,{username:_0x428fee,password:_0x28c2d8,uid:uid=0x0,phone:_0x197c66}=_0x1764fb;let _0x4a3d88=null;if(uid>0x0){_0x4a3d88=await this[_0x29beae(0x16f)]['findOne']({'where':{'id':uid}});if(!_0x4a3d88)throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1aa),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);if(_0x4a3d88['password']['startsWith'](_0x29beae(0x13a))||_0x4a3d88[_0x29beae(0x166)][_0x29beae(0x12a)](_0x29beae(0x136))||_0x4a3d88['password'][_0x29beae(0x12a)](_0x29beae(0x153))){if(!bcrypt[_0x29beae(0x19f)](_0x28c2d8,_0x4a3d88[_0x29beae(0x166)]))throw new common_1['HttpException'](_0x29beae(0x1d1),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);}else{console[_0x29beae(0x1c1)](_0x29beae(0x131));const _0x59561c=crypto[_0x29beae(0x165)](_0x29beae(0x1a9))[_0x29beae(0x1ca)](_0x28c2d8)['digest'](_0x29beae(0x18f));console['log'](_0x29beae(0x131),_0x59561c);if(_0x59561c!==_0x4a3d88[_0x29beae(0x166)])throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1d1),common_1[_0x29beae(0x1b5)]['BAD_REQUEST']);}}if(_0x428fee&&_0x28c2d8){const _0x347d88=[{'username':_0x428fee},{'email':_0x428fee}];_0x4a3d88=await this[_0x29beae(0x16f)][_0x29beae(0x132)]({'where':_0x347d88});if(!_0x4a3d88)throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1aa),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);if(_0x4a3d88[_0x29beae(0x166)]['startsWith']('$2a$')||_0x4a3d88[_0x29beae(0x166)]['startsWith'](_0x29beae(0x136))||_0x4a3d88[_0x29beae(0x166)][_0x29beae(0x12a)](_0x29beae(0x153))){if(!bcrypt[_0x29beae(0x19f)](_0x28c2d8,_0x4a3d88['password']))throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1d1),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);}else{console[_0x29beae(0x1c1)]('----,');const _0x14e602=crypto[_0x29beae(0x165)](_0x29beae(0x1a9))[_0x29beae(0x1ca)](_0x28c2d8)['digest'](_0x29beae(0x18f));console[_0x29beae(0x1c1)](_0x29beae(0x131),_0x14e602);if(_0x14e602!==_0x4a3d88['password'])throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1d1),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);}}if(_0x197c66&&_0x28c2d8){const _0x44f5b3=[{'phone':_0x197c66}];_0x4a3d88=await this[_0x29beae(0x16f)][_0x29beae(0x132)]({'where':_0x44f5b3});if(!_0x4a3d88)throw new common_1['HttpException'](_0x29beae(0x1aa),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);if(_0x4a3d88[_0x29beae(0x166)]['startsWith'](_0x29beae(0x13a))||_0x4a3d88[_0x29beae(0x166)]['startsWith'](_0x29beae(0x136))||_0x4a3d88[_0x29beae(0x166)][_0x29beae(0x12a)](_0x29beae(0x153))){if(!bcrypt[_0x29beae(0x19f)](_0x28c2d8,_0x4a3d88[_0x29beae(0x166)]))throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1d1),common_1['HttpStatus'][_0x29beae(0x182)]);}else{console[_0x29beae(0x1c1)](_0x29beae(0x131));const _0x4916f9=crypto['createHash'](_0x29beae(0x1a9))[_0x29beae(0x1ca)](_0x28c2d8)[_0x29beae(0x197)](_0x29beae(0x18f));console[_0x29beae(0x1c1)](_0x29beae(0x131),_0x4916f9);if(_0x4916f9!==_0x4a3d88[_0x29beae(0x166)])throw new common_1[(_0x29beae(0x1cc))](_0x29beae(0x1d1),common_1[_0x29beae(0x1b5)][_0x29beae(0x182)]);}}if(!_0x4a3d88)throw new common_1['HttpException']('当前账户不存在！',common_1['HttpStatus'][_0x29beae(0x182)]);if(_0x4a3d88['status']!==user_constant_1[_0x29beae(0x19d)]['ACTIVE'])throw new common_1[(_0x29beae(0x1cc))](user_constant_1[_0x29beae(0x1a7)][_0x4a3d88[_0x29beae(0x186)]],common_1['HttpStatus'][_0x29beae(0x182)]);return _0x4a3d88;}async[_0x410759(0x17a)](_0x4ee080,_0x39c4d7){const _0x311e99=_0x410759,_0x208e54=await this[_0x311e99(0x16f)][_0x311e99(0x132)]({'where':{'id':_0x4ee080}});if(_0x208e54['password']['startsWith'](_0x311e99(0x13a))||_0x208e54[_0x311e99(0x166)]['startsWith'](_0x311e99(0x136))||_0x208e54['password'][_0x311e99(0x12a)](_0x311e99(0x153)))return bcrypt[_0x311e99(0x19f)](_0x39c4d7,_0x208e54[_0x311e99(0x166)]);else{const _0x4aeab1=crypto[_0x311e99(0x165)](_0x311e99(0x1a9))['update'](_0x39c4d7)['digest'](_0x311e99(0x18f));return console[_0x311e99(0x1c1)]('----,',_0x4aeab1),_0x4aeab1===_0x208e54[_0x311e99(0x166)];}}async[_0x410759(0x19e)](_0x30482b,_0xfd6a48){const _0x526bcb=_0x410759,_0x44c007=await this[_0x526bcb(0x16f)][_0x526bcb(0x1ca)]({'id':_0x30482b},{'status':_0xfd6a48});return _0x44c007['affected']>0x0;}async[_0x410759(0x187)](_0x35894c){const _0xc6ccf1=_0x410759,_0x65de89=await this[_0xc6ccf1(0x16f)][_0xc6ccf1(0x132)]({'where':{'id':_0x35894c}});return _0x65de89[_0xc6ccf1(0x186)];}async[_0x410759(0x1d9)](_0x3d84e7){const _0x4b2969=_0x410759;return await this[_0x4b2969(0x16f)][_0x4b2969(0x132)]({'where':{'id':_0x3d84e7}});}async['queryOneUserInfo'](_0x1622c2){const _0x140b64=_0x410759;return await this['userEntity'][_0x140b64(0x132)]({'where':{'id':_0x1622c2}});}async[_0x410759(0x1cb)](_0x33f5cd){const _0xb3c092=_0x410759,{id:_0x5eddd1,role:_0x483fd5}=_0x33f5cd;if(_0x483fd5===_0xb3c092(0x199))return!![];const _0x510eab=await this['userEntity'][_0xb3c092(0x132)]({'where':{'id':_0x5eddd1}});if(!_0x510eab)throw new common_1[(_0xb3c092(0x1cc))](_0xb3c092(0x127),common_1[_0xb3c092(0x1b5)][_0xb3c092(0x1c3)]);if(_0x510eab['status']===user_constant_1[_0xb3c092(0x19d)][_0xb3c092(0x155)])throw new common_1[(_0xb3c092(0x1cc))](_0xb3c092(0x171),common_1['HttpStatus'][_0xb3c092(0x182)]);if(_0x510eab[_0xb3c092(0x186)]===user_constant_1[_0xb3c092(0x19d)][_0xb3c092(0x19b)])throw new common_1[(_0xb3c092(0x1cc))]('您的账户已被封禁、如有疑问、请联系管理员！',common_1[_0xb3c092(0x1b5)]['BAD_REQUEST']);}async[_0x410759(0x130)](_0x2e62c7){const _0x221f56=_0x410759,_0x3fe659=await this[_0x221f56(0x16f)]['findOne']({'where':{'id':_0x2e62c7},'select':[_0x221f56(0x1ab),_0x221f56(0x189),_0x221f56(0x154),'email',_0x221f56(0x19a),_0x221f56(0x1da),_0x221f56(0x13d),_0x221f56(0x12f)]});if(!_0x3fe659)throw new common_1['HttpException'](_0x221f56(0x127),common_1[_0x221f56(0x1b5)]['UNAUTHORIZED']);_0x3fe659[_0x221f56(0x133)]=!!(_0x3fe659===null||_0x3fe659===void 0x0?void 0x0:_0x3fe659[_0x221f56(0x13d)]),delete _0x3fe659[_0x221f56(0x13d)];const _0x2d958b=await this['userBalanceService']['queryUserBalance'](_0x2e62c7);return{'userInfo':_0x3fe659,'userBalance':Object['assign']({},_0x2d958b)};}async['getUserById'](_0x28227b){const _0x1175fa=_0x410759;return await this[_0x1175fa(0x16f)][_0x1175fa(0x132)]({'where':{'id':_0x28227b}});}async[_0x410759(0x15d)](_0x36f949){const _0x2212f3=_0x410759;return await this[_0x2212f3(0x16f)][_0x2212f3(0x132)]({'where':{'openId':_0x36f949}});}async['updateInfo'](_0x1b9efb,_0x2140a3){const _0x19acd4=_0x410759,{id:_0x493683}=_0x2140a3[_0x19acd4(0x12e)],_0x3319ff=await this[_0x19acd4(0x16f)][_0x19acd4(0x132)]({'where':{'id':_0x493683}});if(!_0x3319ff)throw new common_1[(_0x19acd4(0x1cc))](_0x19acd4(0x183),common_1[_0x19acd4(0x1b5)]['BAD_REQUEST']);if(_0x1b9efb['username']&&_0x3319ff[_0x19acd4(0x1ab)]===_0x1b9efb[_0x19acd4(0x1ab)])throw new common_1[(_0x19acd4(0x1cc))](_0x19acd4(0x1d5),common_1[_0x19acd4(0x1b5)][_0x19acd4(0x182)]);if(_0x1b9efb['username']){const _0x5aadec=await this[_0x19acd4(0x16f)][_0x19acd4(0x132)]({'where':{'username':_0x1b9efb[_0x19acd4(0x1ab)],'id':(0x0,typeorm_2[_0x19acd4(0x1cf)])(_0x493683)}});if(_0x5aadec)throw new common_1[(_0x19acd4(0x1cc))](_0x19acd4(0x16a),common_1[_0x19acd4(0x1b5)][_0x19acd4(0x182)]);}const _0x270179=await this[_0x19acd4(0x16f)][_0x19acd4(0x1ca)]({'id':_0x493683},_0x1b9efb);if(_0x270179[_0x19acd4(0x15c)]<=0x0)throw new common_1[(_0x19acd4(0x1cc))](_0x19acd4(0x194),common_1[_0x19acd4(0x1b5)][_0x19acd4(0x182)]);return _0x19acd4(0x15f);}async['updateUserPassword'](_0x4cf422,_0x149950){const _0x2b7616=_0x410759,_0x2fb195=bcrypt[_0x2b7616(0x1b8)](_0x149950,0xa),_0x47414e=await this[_0x2b7616(0x16f)][_0x2b7616(0x1ca)]({'id':_0x4cf422},{'password':_0x2fb195});if(_0x47414e[_0x2b7616(0x15c)]<=0x0)throw new common_1[(_0x2b7616(0x1cc))](_0x2b7616(0x13f),common_1['HttpStatus'][_0x2b7616(0x182)]);}async[_0x410759(0x18d)](_0x424439){const _0x4736b1=_0x410759,{id:_0x37756c}=_0x424439[_0x4736b1(0x12e)],_0x789e59=await this['userEntity']['findOne']({'where':{'id':_0x37756c}});if(!_0x789e59||_0x789e59['inviteCode'])throw new common_1[(_0x4736b1(0x1cc))](_0x4736b1(0x184),common_1[_0x4736b1(0x1b5)][_0x4736b1(0x182)]);const _0x396636=(0x0,utils_1[_0x4736b1(0x1d8)])(),_0x8ab8ae=await this[_0x4736b1(0x16f)][_0x4736b1(0x132)]({'where':{'inviteCode':_0x396636}});if(_0x8ab8ae)throw new common_1['HttpException']('生成邀请码失败，请重新试一次吧！',common_1['HttpStatus']['BAD_REQUEST']);const _0xd40e4d=await this[_0x4736b1(0x16f)][_0x4736b1(0x1ca)]({'id':_0x37756c},{'inviteCode':_0x396636});if(_0xd40e4d[_0x4736b1(0x15c)]<=0x0)throw new common_1['HttpException'](_0x4736b1(0x144),common_1[_0x4736b1(0x1b5)][_0x4736b1(0x182)]);return _0x396636;}async[_0x410759(0x1a1)](_0x1ff044,_0x1b403c){const _0x567939=_0x410759;try{const {id:_0x192851}=_0x1ff044[_0x567939(0x12e)],{page:page=0x1,size:size=0xa}=_0x1b403c,_0x50f8a6=await this[_0x567939(0x16f)]['findOne']({'where':{'id':_0x192851}}),{inviteCode:_0x26fb16}=_0x50f8a6;if(!_0x26fb16)return[];const [_0x30a988,_0xfcd4fc]=await this[_0x567939(0x16f)][_0x567939(0x178)]({'where':{'inviteCode':_0x26fb16},'order':{'id':'DESC'},'select':['username',_0x567939(0x135),'createdAt','status',_0x567939(0x189)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x567939(0x1c8)])(_0x30a988)[_0x567939(0x1b1)](_0x35cbe2=>{const _0x4e010c=_0x567939;return _0x35cbe2[_0x4e010c(0x135)]=(0x0,utils_1[_0x4e010c(0x17d)])(_0x35cbe2[_0x4e010c(0x135)]),_0x35cbe2;}),{'rows':_0x30a988,'count':_0xfcd4fc};}catch(_0x385e7d){console[_0x567939(0x1c1)](_0x567939(0x13b),_0x385e7d);throw new common_1['HttpException']('获取邀请记录失败！',common_1[_0x567939(0x1b5)][_0x567939(0x182)]);}}async[_0x410759(0x19c)](_0x2fbfd7){const _0x296b0f=_0x410759,_0x4236ba=await this[_0x296b0f(0x16f)]['findOne']({'where':{'inviteCode':_0x2fbfd7}});if(!_0x4236ba)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x4236ba,_0x1e3c16=await this['userEntity']['update']({'inviteCode':_0x2fbfd7},{'inviteLinkCount':inviteLinkCount+0x1});return _0x1e3c16[_0x296b0f(0x15c)]?0x1:0x0;}async[_0x410759(0x1b3)](_0x55eba8){return await this['userEntity']['findOne']({'where':{'inviteCode':_0x55eba8}});}async['userRecharge'](_0x209d82){const _0x4d635d=_0x410759,{userId:_0x527c29,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x209d82;await this[_0x4d635d(0x1a6)][_0x4d635d(0x195)](_0x527c29,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x254e56=await this[_0x4d635d(0x1a6)][_0x4d635d(0x173)]({'userId':_0x527c29,'rechargeType':balance_constant_1[_0x4d635d(0x15e)]['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x254e56;}async[_0x410759(0x1c2)](_0x48eed3,_0x13592a){const _0x24b5d1=_0x410759,{page:page=0x1,size:size=0xa,username:_0x2c7d43,email:_0x18243c,status:_0x28a69b,keyword:_0x23dde3,phone:_0x3e7386}=_0x48eed3;let _0x18d4f6={};_0x2c7d43&&Object[_0x24b5d1(0x17e)](_0x18d4f6,{'username':(0x0,typeorm_2[_0x24b5d1(0x1d6)])('%'+_0x2c7d43+'%')}),_0x18243c&&Object[_0x24b5d1(0x17e)](_0x18d4f6,{'email':(0x0,typeorm_2[_0x24b5d1(0x1d6)])('%'+_0x18243c+'%')}),_0x3e7386&&Object[_0x24b5d1(0x17e)](_0x18d4f6,{'phone':(0x0,typeorm_2[_0x24b5d1(0x1d6)])('%'+_0x3e7386+'%')}),_0x28a69b&&Object['assign'](_0x18d4f6,{'status':_0x28a69b});_0x23dde3&&(_0x18d4f6=[{'username':(0x0,typeorm_2['Like'])('%'+_0x23dde3+'%')},{'email':(0x0,typeorm_2[_0x24b5d1(0x1d6)])('%'+_0x23dde3+'%')},{'phone':(0x0,typeorm_2[_0x24b5d1(0x1d6)])('%'+_0x23dde3+'%')}]);const [_0x3dcfb2,_0x9a1891]=await this[_0x24b5d1(0x16f)][_0x24b5d1(0x178)]({'skip':(page-0x1)*size,'where':_0x18d4f6,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':['username',_0x24b5d1(0x189),_0x24b5d1(0x1da),'role',_0x24b5d1(0x19a),'status','id','email',_0x24b5d1(0x1a8),_0x24b5d1(0x174),_0x24b5d1(0x1c7)]}),_0x460b1d=_0x3dcfb2['map'](_0x4294f1=>_0x4294f1['id']),_0x1579b3=await this[_0x24b5d1(0x1a6)]['queryUserBalanceByIds'](_0x460b1d);return _0x3dcfb2[_0x24b5d1(0x126)](_0x3e7227=>_0x3e7227[_0x24b5d1(0x1af)]=_0x1579b3[_0x24b5d1(0x14a)](_0x25378a=>_0x25378a['userId']===_0x3e7227['id'])),_0x13592a['user'][_0x24b5d1(0x154)]!==_0x24b5d1(0x18e)&&_0x3dcfb2[_0x24b5d1(0x126)](_0x400f0f=>_0x400f0f[_0x24b5d1(0x135)]=(0x0,utils_1[_0x24b5d1(0x17d)])(_0x400f0f['email'])),_0x13592a['user']['role']!==_0x24b5d1(0x18e)&&_0x3dcfb2['forEach'](_0x2f695e=>_0x2f695e[_0x24b5d1(0x174)]=(0x0,utils_1[_0x24b5d1(0x1d3)])(_0x2f695e[_0x24b5d1(0x174)])),_0x13592a[_0x24b5d1(0x12e)][_0x24b5d1(0x154)]!==_0x24b5d1(0x18e)&&_0x3dcfb2['forEach'](_0x17dce3=>_0x17dce3[_0x24b5d1(0x1c7)]=(0x0,utils_1[_0x24b5d1(0x1d3)])(_0x17dce3[_0x24b5d1(0x1c7)])),{'rows':_0x3dcfb2,'count':_0x9a1891};}async[_0x410759(0x17c)]({id:_0x55b0a0}){const _0x4e89b0=_0x410759;return await this[_0x4e89b0(0x16f)][_0x4e89b0(0x132)]({'where':{'id':_0x55b0a0},'select':['username',_0x4e89b0(0x189),'inviteCode',_0x4e89b0(0x154),_0x4e89b0(0x19a),'status']});}async['updateStatus'](_0x2607f2){const _0x4f766f=_0x410759,{id:_0x3ffbbd,status:_0x1b8408}=_0x2607f2,_0x159763=await this['userEntity'][_0x4f766f(0x132)]({'where':{'id':_0x3ffbbd}});if(!_0x159763)throw new common_1[(_0x4f766f(0x1cc))](_0x4f766f(0x167),common_1['HttpStatus'][_0x4f766f(0x182)]);if(_0x159763[_0x4f766f(0x154)]===_0x4f766f(0x18e))throw new common_1[(_0x4f766f(0x1cc))](_0x4f766f(0x141),common_1[_0x4f766f(0x1b5)][_0x4f766f(0x182)]);if(_0x159763['status']===user_constant_1[_0x4f766f(0x19d)][_0x4f766f(0x12b)])throw new common_1[(_0x4f766f(0x1cc))](_0x4f766f(0x128),common_1[_0x4f766f(0x1b5)]['BAD_REQUEST']);if(_0x159763['role']==='super')throw new common_1[(_0x4f766f(0x1cc))]('超级管理员不可被操作！',common_1[_0x4f766f(0x1b5)]['BAD_REQUEST']);if(_0x1b8408===user_constant_1[_0x4f766f(0x19d)][_0x4f766f(0x12b)])throw new common_1[(_0x4f766f(0x1cc))](_0x4f766f(0x1cd),common_1[_0x4f766f(0x1b5)][_0x4f766f(0x182)]);const _0x1c4409=await this['userEntity'][_0x4f766f(0x1ca)]({'id':_0x3ffbbd},{'status':_0x1b8408});if(_0x1c4409[_0x4f766f(0x15c)]<=0x0)throw new common_1[(_0x4f766f(0x1cc))](_0x4f766f(0x191),common_1['HttpStatus'][_0x4f766f(0x182)]);return _0x4f766f(0x1b7);}async['resetUserPass'](_0x3e9cb4){const _0x3ff6e0=_0x410759,{id:_0x530dee}=_0x3e9cb4,_0x37ef12=await this['userEntity']['findOne']({'where':{'id':_0x530dee}});if(!_0x37ef12)throw new common_1[(_0x3ff6e0(0x1cc))]('用户不存在！',common_1[_0x3ff6e0(0x1b5)]['BAD_REQUEST']);const _0xe40d07=_0x3ff6e0(0x1ac),_0x2caa22=bcrypt[_0x3ff6e0(0x1b8)](_0xe40d07,0xa),_0x4f1558=await this[_0x3ff6e0(0x16f)][_0x3ff6e0(0x1ca)]({'id':_0x530dee},{'password':_0x2caa22});if(_0x4f1558[_0x3ff6e0(0x15c)]<=0x0)throw new common_1[(_0x3ff6e0(0x1cc))]('重置密码失败！',common_1[_0x3ff6e0(0x1b5)][_0x3ff6e0(0x182)]);return'密码重置为['+_0xe40d07+']成功!';}async[_0x410759(0x181)](_0x20840f,_0x5b7a19){const _0x2cb85c=_0x410759;return await this['userEntity'][_0x2cb85c(0x1ca)]({'id':_0x20840f},{'lastLoginIp':_0x5b7a19});}async[_0x410759(0x18b)](_0x581105,_0x32b6ae){const _0x2cd300=_0x410759,_0x52ec27=await this['userEntity'][_0x2cd300(0x132)]({'where':{'openId':_0x581105}});if(!_0x52ec27){const _0x35f829=_0x32b6ae?_0x32b6ae[_0x2cd300(0x16d)](':')[0x1]:'',_0x381327=await this[_0x2cd300(0x1b3)](_0x35f829),_0x1a7d21=await this[_0x2cd300(0x1c6)](_0x581105,_0x35f829);return await this[_0x2cd300(0x1a6)][_0x2cd300(0x169)](_0x1a7d21['id'],_0x35f829?_0x381327===null||_0x381327===void 0x0?void 0x0:_0x381327['id']:null),_0x1a7d21;}return _0x52ec27;}async[_0x410759(0x1c6)](_0x4f97c2,_0x565c0c){const _0x45f982=_0x410759,_0x559258=await this['globalConfigService']['getConfigs'](['userDefautlAvatar']),_0x308180={'avatar':_0x559258,'username':'用户'+(0x0,utils_1[_0x45f982(0x180)])(),'status':user_constant_1[_0x45f982(0x19d)][_0x45f982(0x149)],'sex':0x0,'email':(0x0,utils_1[_0x45f982(0x180)])()+'@default.com','invitedBy':_0x565c0c,'openId':_0x4f97c2},_0x59a058=await this[_0x45f982(0x16f)][_0x45f982(0x1ae)](_0x308180);return _0x59a058;}async[_0x410759(0x129)](_0x1fdbaf,_0x4a9a6b){const _0xc84233=_0x410759;try{const _0x323203=await this[_0xc84233(0x16f)][_0xc84233(0x132)]({'where':{'id':_0x4a9a6b}});if(!_0x323203)return{'status':![],'msg':_0xc84233(0x179)};const _0x3cc3be=await this[_0xc84233(0x16f)][_0xc84233(0x132)]({'where':{'openId':_0x1fdbaf}});if(_0x3cc3be)return{'status':![],'msg':_0xc84233(0x1d2)};const _0xa0d2f1=await this[_0xc84233(0x16f)]['update']({'id':_0x4a9a6b},{'openId':_0x1fdbaf});if(_0xa0d2f1[_0xc84233(0x15c)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0xc84233(0x16e)};}catch(_0x589b4f){return{'status':![],'msg':_0xc84233(0x150)};}}async[_0x410759(0x1c4)](_0x5d14b8){const _0x245516=_0x410759,_0x3d424d=await this[_0x245516(0x16f)][_0x245516(0x132)]({'where':{'id':_0x5d14b8}});return _0x3d424d===null||_0x3d424d===void 0x0?void 0x0:_0x3d424d['openId'];}async[_0x410759(0x12c)](_0x34b3b1){const _0x3c8d98=_0x410759,{username:_0x337eb1,password:_0x6ef209,phone:_0x12abdc,phoneCode:_0x3d064a}=_0x34b3b1,_0x34f19f=await this[_0x3c8d98(0x16f)][_0x3c8d98(0x132)]({'where':[{'username':_0x337eb1},{'phone':_0x12abdc}]});if(_0x34f19f&&_0x34f19f[_0x3c8d98(0x1ab)]===_0x337eb1)throw new common_1[(_0x3c8d98(0x1cc))]('用户名已存在、请更换用户名！',common_1[_0x3c8d98(0x1b5)]['BAD_REQUEST']);if(_0x34f19f&&_0x34f19f[_0x3c8d98(0x1c7)]===_0x12abdc)throw new common_1[(_0x3c8d98(0x1cc))](_0x3c8d98(0x137),common_1[_0x3c8d98(0x1b5)]['BAD_REQUEST']);}async[_0x410759(0x190)](_0x2757d4){const _0x4db077=_0x410759;return await this['userEntity'][_0x4db077(0x1ae)](_0x2757d4);}};function _0x2c89(_0x2f787b,_0x14dd14){const _0x2d1580=_0x2d15();return _0x2c89=function(_0x2c89b9,_0x3f4935){_0x2c89b9=_0x2c89b9-0x126;let _0x57be6a=_0x2d1580[_0x2c89b9];return _0x57be6a;},_0x2c89(_0x2f787b,_0x14dd14);}UserService=__decorate([(0x0,common_1[_0x410759(0x176)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x410759(0x161)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x410759(0x164)])),__param(0x7,(0x0,typeorm_1[_0x410759(0x159)])(config_entity_1[_0x410759(0x1c0)])),__metadata('design:paramtypes',[typeorm_2[_0x410759(0x17f)],typeorm_2[_0x410759(0x17f)],typeorm_2[_0x410759(0x1ba)],verification_service_1[_0x410759(0x162)],mailer_1[_0x410759(0x16c)],userBalance_service_1[_0x410759(0x139)],globalConfig_service_1[_0x410759(0x1a3)],typeorm_2[_0x410759(0x17f)]])],UserService),exports[_0x410759(0x1c9)]=UserService;