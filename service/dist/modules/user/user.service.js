'use strict';const _0x509beb=_0x1652;(function(_0x3c1e05,_0x588119){const _0x213767=_0x1652,_0x5d6d9d=_0x3c1e05();while(!![]){try{const _0x2869f0=parseInt(_0x213767(0xd7))/0x1*(-parseInt(_0x213767(0x102))/0x2)+-parseInt(_0x213767(0xe3))/0x3+parseInt(_0x213767(0xd1))/0x4*(-parseInt(_0x213767(0xef))/0x5)+-parseInt(_0x213767(0x97))/0x6+parseInt(_0x213767(0xdc))/0x7+-parseInt(_0x213767(0xf6))/0x8*(parseInt(_0x213767(0xfd))/0x9)+parseInt(_0x213767(0xdb))/0xa*(parseInt(_0x213767(0x115))/0xb);if(_0x2869f0===_0x588119)break;else _0x5d6d9d['push'](_0x5d6d9d['shift']());}catch(_0x2016c5){_0x5d6d9d['push'](_0x5d6d9d['shift']());}}}(_0x261e,0xc34b0));function _0x261e(){const _0x4f3758=['用户不存在！','getConfigs','当前手机号已注册、请勿重复注册！','createUserFromOpenId','configMap:\x20','inviteLink','userDefautlAvatar','updateUserPassword','../globalConfig/config.entity','md5','isVerifyEmail','用户名或者邮箱已被注册！','WhiteListEntity','length','用户名已存在！','PENDING','registerVerifyEmailTitle','createVerification','../globalConfig/globalConfig.service','../../common/constants/user.constant','globalConfigService','ADMIN_GIFT','sign','super','createRandomUid','@nestjs/typeorm','124vckBeX','reduce','lodash','checkUserStatus','registerIp','Like','3zxVvHp','connection','绑定微信失败、请联系管理员！','addBalanceToNewUser','95020YnfdPI','2742278CGPwMo','configVal','__decorate','@nestjs-modules/mailer','$2b$','ConfigEntity','__esModule','1894491utVqER','LOCKED','maskIpAddress','avatar','UNAUTHORIZED','saveRecordRechargeLog','恭喜您绑定成功、后续可直接扫码登录了！','error:\x20','registerVerifyEmailFrom','未激活用户不可手动变更状态！','getUserStatus','openId','160175mrQnly','log','无效的邀请码！','digest','__param','hashSync','map','6563896OARfDe','defineProperty','UserStatusEnum','queryUserInfoById','affected','createdAt','typeorm','9xxQzAj','assign','client','password','没有变更，无需更改！','104362FMRHsl','@nestjs/common','startsWith','isBindWx','visitor','修改用户信息失败！','genInviteCode','----,','当前账户不存在！','$2a$','@default.com','getUserById','forEach','role','email\x20response\x20\x20->\x20:\x20','configEntity','该微信已绑定其他账号！','userBalanceService','getInviteRecord','5269xJQbtt','phone','用户名已存在、请更换用户名！','当前密码错误！','generateRandomString','inviteCode','split','verifyUserCredentials','修改用户信息成功！','user','Injectable','status','queryAll','save','email','当前用户不存在！','whiteListEntity','configKey','sendMail','$2y$','UserService','./user.entity','update','maskEmail','getUserInfo','VerificationEnum','当前用户信息失效、请重新登录！','object','userId','registerVerifyExpir','createHash','123456','Registration','balanceInfo','InjectRepository','getOpenIdByUserId','修改用户状态失败！','HttpStatus','savaLoginIp','Repository','UserEntity','RechargeType','username','DESC','findAndCount','decorate','updateStatus','bindWx','您的账户已被封禁、如有疑问、请联系管理员！','qureyUserInfoByInviteCode','verificationService','9250080ydygEX','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','重置密码失败！','metadata','MailerService',']成功!','getUserFromOpenId','Connection','获取邀请记录失败！','compareSync','../../common/constants/balance.constant','../../common/utils','hex','lastLoginIp','修改密码失败、请重新试试吧。','BAD_REQUEST','queryOneUserInfo','crypto','updateUserStatus','register','HttpException','生成邀请码失败，请重新试一次吧！','registerVerifyEmailDesc','addBalanceToUser','function','registerBaseUrl','userEntity','verifyUserPassword','resetUserPass','find','UserStatusErrMsg','findOne'];_0x261e=function(){return _0x4f3758;};return _0x261e();}var __decorate=this&&this[_0x509beb(0xde)]||function(_0xe4f2f7,_0x4446d9,_0x55ddc4,_0x27dc80){const _0x365675=_0x509beb;var _0x404c2b=arguments[_0x365675(0xc4)],_0x277c59=_0x404c2b<0x3?_0x4446d9:_0x27dc80===null?_0x27dc80=Object['getOwnPropertyDescriptor'](_0x4446d9,_0x55ddc4):_0x27dc80,_0x5a5a2a;if(typeof Reflect===_0x365675(0x130)&&typeof Reflect[_0x365675(0x91)]===_0x365675(0xaf))_0x277c59=Reflect[_0x365675(0x91)](_0xe4f2f7,_0x4446d9,_0x55ddc4,_0x27dc80);else{for(var _0x176ad4=_0xe4f2f7[_0x365675(0xc4)]-0x1;_0x176ad4>=0x0;_0x176ad4--)if(_0x5a5a2a=_0xe4f2f7[_0x176ad4])_0x277c59=(_0x404c2b<0x3?_0x5a5a2a(_0x277c59):_0x404c2b>0x3?_0x5a5a2a(_0x4446d9,_0x55ddc4,_0x277c59):_0x5a5a2a(_0x4446d9,_0x55ddc4))||_0x277c59;}return _0x404c2b>0x3&&_0x277c59&&Object[_0x365675(0xf7)](_0x4446d9,_0x55ddc4,_0x277c59),_0x277c59;},__metadata=this&&this['__metadata']||function(_0x2b1490,_0x201458){const _0x50689c=_0x509beb;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x50689c(0xaf))return Reflect[_0x50689c(0x9a)](_0x2b1490,_0x201458);},__param=this&&this[_0x509beb(0xf3)]||function(_0x2675b0,_0x584356){return function(_0x3424b7,_0x58e204){_0x584356(_0x3424b7,_0x58e204,_0x2675b0);};};Object[_0x509beb(0xf7)](exports,_0x509beb(0xe2),{'value':!![]}),exports[_0x509beb(0x129)]=void 0x0;const globalConfig_service_1=require(_0x509beb(0xc9)),user_constant_1=require(_0x509beb(0xca)),mailer_1=require(_0x509beb(0xdf)),verification_service_1=require('../verification/verification.service'),common_1=require(_0x509beb(0x103)),typeorm_1=require(_0x509beb(0xd0)),typeorm_2=require(_0x509beb(0xfc)),user_entity_1=require(_0x509beb(0x12a)),bcrypt=require('bcryptjs'),crypto=require(_0x509beb(0xa8)),_=require(_0x509beb(0xd3)),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x509beb(0xa2)),balance_constant_1=require(_0x509beb(0xa1)),config_entity_1=require(_0x509beb(0xbf)),whiteList_entity_1=require('../chatgpt/whiteList.entity');let UserService=class UserService{constructor(_0x53764c,_0x5603c9,_0x383a4a,_0x2ef314,_0x3cf215,_0x8f3ca6,_0x305dd7,_0x3bf1ae){const _0x1328c1=_0x509beb;this[_0x1328c1(0xb1)]=_0x53764c,this[_0x1328c1(0x125)]=_0x5603c9,this[_0x1328c1(0xd8)]=_0x383a4a,this[_0x1328c1(0x96)]=_0x2ef314,this['mailerService']=_0x3cf215,this[_0x1328c1(0x113)]=_0x8f3ca6,this[_0x1328c1(0xcb)]=_0x305dd7,this[_0x1328c1(0x111)]=_0x3bf1ae;}async['createUserAndVerifycation'](_0x9f9023,_0x3d157d){const _0x1d2a8d=_0x509beb,{username:_0x40e78e,email:_0x203395,password:_0x5020fe,invitedBy:_0x352a71,client:client=0x0}=_0x9f9023;if(_0x352a71){const _0x3c5057=await this['userEntity']['findOne']({'where':{'inviteCode':_0x352a71}});if(!_0x3c5057)throw new common_1[(_0x1d2a8d(0xab))](_0x1d2a8d(0xf1),common_1[_0x1d2a8d(0x13a)][_0x1d2a8d(0xa6)]);}const _0x388529=[{'username':_0x40e78e},{'email':_0x203395}],_0x2f7272=await this[_0x1d2a8d(0xb1)][_0x1d2a8d(0xb6)]({'where':_0x388529});if(_0x2f7272&&_0x2f7272[_0x1d2a8d(0x120)]!==user_constant_1[_0x1d2a8d(0xf8)][_0x1d2a8d(0xc6)])throw new common_1['HttpException'](_0x1d2a8d(0xc2),common_1['HttpStatus'][_0x1d2a8d(0xa6)]);try{const _0x4ee6d5=_['cloneDeep'](_0x9f9023),_0x41fb98=bcrypt['hashSync'](_0x5020fe,0xa),_0x267968=(0x0,utils_1['getClientIp'])(_0x3d157d);_0x4ee6d5['password']=_0x41fb98,_0x4ee6d5[_0x1d2a8d(0xd5)]=_0x267968,_0x4ee6d5[_0x1d2a8d(0xff)]=client;let _0x39e561;if(!_0x2f7272){const _0x2d3c67=await this[_0x1d2a8d(0xcb)][_0x1d2a8d(0xb8)](['userDefautlAvatar']);_0x4ee6d5[_0x1d2a8d(0xe6)]=_0x2d3c67,_0x39e561=await this['userEntity']['save'](_0x4ee6d5);}else _0x39e561=_0x2f7272;const _0x1dfa2c=await this['configEntity'][_0x1d2a8d(0xb4)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1d2a8d(0xc1),_0x1d2a8d(0xb0),_0x1d2a8d(0xc7),_0x1d2a8d(0xad),_0x1d2a8d(0xeb),_0x1d2a8d(0x132)])}}),_0xf594b5=_0x1dfa2c[_0x1d2a8d(0xd2)]((_0x24d06b,_0x1054f0)=>{const _0x5bfefb=_0x1d2a8d;return _0x24d06b[_0x1054f0[_0x5bfefb(0x126)]]=_0x1054f0[_0x5bfefb(0xdd)],_0x24d06b;},{}),_0x32a746=_0xf594b5[_0x1d2a8d(0xc1)]?Number(_0xf594b5[_0x1d2a8d(0xc1)]):0x1;if(_0x32a746){const _0x2888d3=_0xf594b5[_0x1d2a8d(0x132)]?Number(_0xf594b5[_0x1d2a8d(0x132)]):0x1e*0x3c,_0x6adc68=await this['verificationService'][_0x1d2a8d(0xc8)](_0x39e561,verification_constant_1[_0x1d2a8d(0x12e)][_0x1d2a8d(0x135)],_0x2888d3),{code:_0x14d4a1,email:_0x239a54,id:_0xf0f337}=_0x6adc68,{registerVerifyEmailFrom:_0x3f84f4}=_0xf594b5;console[_0x1d2a8d(0xf0)](_0x1d2a8d(0xbb),_0xf594b5);const _0x264c80=await this['mailerService'][_0x1d2a8d(0x127)]({'to':_0x239a54,'subject':'来自'+_0x3f84f4+'的账号激活','template':_0x1d2a8d(0xaa),'context':Object['assign']({'baseUrl':_0xf594b5[_0x1d2a8d(0xb0)],'code':_0x14d4a1,'id':_0xf0f337},_0xf594b5)});console[_0x1d2a8d(0xf0)](_0x1d2a8d(0x110),_0x264c80);}else{const {username:_0x3997c8,email:_0x39c72c,id:_0x5a2ffb,invitedBy:_0x36b498}=_0x39e561;await this[_0x1d2a8d(0xa9)](_0x5a2ffb,user_constant_1[_0x1d2a8d(0xf8)]['ACTIVE']);let _0xd75017;_0x36b498&&(_0xd75017=await this[_0x1d2a8d(0x95)](_0x36b498)),await this['userBalanceService'][_0x1d2a8d(0xda)](_0x5a2ffb,_0xd75017===null||_0xd75017===void 0x0?void 0x0:_0xd75017['id']);}return _0x39e561;}catch(_0x5d5b88){console['log'](_0x1d2a8d(0xea),_0x5d5b88);throw _0x5d5b88;}}async['getSuper'](){const _0x3d461f=_0x509beb,_0x244666=await this[_0x3d461f(0xb1)][_0x3d461f(0xb6)]({'where':{'role':_0x3d461f(0xce)}});return _0x244666;}async[_0x509beb(0x11c)](_0xd101a4){const _0x28bed6=_0x509beb,{username:_0x506b61,password:_0x10327d,uid:uid=0x0,phone:_0x42149f}=_0xd101a4;let _0x3fab30=null;if(uid>0x0){_0x3fab30=await this['userEntity'][_0x28bed6(0xb6)]({'where':{'id':uid}});if(!_0x3fab30)throw new common_1[(_0x28bed6(0xab))]('当前账户不存在！',common_1[_0x28bed6(0x13a)]['BAD_REQUEST']);if(_0x3fab30[_0x28bed6(0x100)][_0x28bed6(0x104)](_0x28bed6(0x10b))||_0x3fab30[_0x28bed6(0x100)]['startsWith']('$2b$')||_0x3fab30[_0x28bed6(0x100)]['startsWith'](_0x28bed6(0x128))){if(!bcrypt['compareSync'](_0x10327d,_0x3fab30[_0x28bed6(0x100)]))throw new common_1['HttpException'](_0x28bed6(0x118),common_1[_0x28bed6(0x13a)][_0x28bed6(0xa6)]);}else{console[_0x28bed6(0xf0)]('----,');const _0x2dce83=crypto[_0x28bed6(0x133)]('md5')['update'](_0x10327d)['digest'](_0x28bed6(0xa3));console[_0x28bed6(0xf0)](_0x28bed6(0x109),_0x2dce83);if(_0x2dce83!==_0x3fab30['password'])throw new common_1[(_0x28bed6(0xab))](_0x28bed6(0x118),common_1[_0x28bed6(0x13a)][_0x28bed6(0xa6)]);}}if(_0x506b61&&_0x10327d){const _0x4c2d90=[{'username':_0x506b61},{'email':_0x506b61}];_0x3fab30=await this[_0x28bed6(0xb1)][_0x28bed6(0xb6)]({'where':_0x4c2d90});if(!_0x3fab30)throw new common_1[(_0x28bed6(0xab))](_0x28bed6(0x10a),common_1[_0x28bed6(0x13a)][_0x28bed6(0xa6)]);if(_0x3fab30[_0x28bed6(0x100)][_0x28bed6(0x104)](_0x28bed6(0x10b))||_0x3fab30[_0x28bed6(0x100)][_0x28bed6(0x104)](_0x28bed6(0xe0))||_0x3fab30['password'][_0x28bed6(0x104)](_0x28bed6(0x128))){if(!bcrypt[_0x28bed6(0xa0)](_0x10327d,_0x3fab30[_0x28bed6(0x100)]))throw new common_1[(_0x28bed6(0xab))](_0x28bed6(0x118),common_1[_0x28bed6(0x13a)][_0x28bed6(0xa6)]);}else{console['log'](_0x28bed6(0x109));const _0x4a97cc=crypto['createHash']('md5')[_0x28bed6(0x12b)](_0x10327d)[_0x28bed6(0xf2)]('hex');console[_0x28bed6(0xf0)](_0x28bed6(0x109),_0x4a97cc);if(_0x4a97cc!==_0x3fab30[_0x28bed6(0x100)])throw new common_1[(_0x28bed6(0xab))]('当前密码错误！',common_1[_0x28bed6(0x13a)]['BAD_REQUEST']);}}if(_0x42149f&&_0x10327d){const _0x3ed5cc=[{'phone':_0x42149f}];_0x3fab30=await this[_0x28bed6(0xb1)][_0x28bed6(0xb6)]({'where':_0x3ed5cc});if(!_0x3fab30)throw new common_1[(_0x28bed6(0xab))](_0x28bed6(0x10a),common_1[_0x28bed6(0x13a)]['BAD_REQUEST']);if(_0x3fab30[_0x28bed6(0x100)]['startsWith'](_0x28bed6(0x10b))||_0x3fab30[_0x28bed6(0x100)][_0x28bed6(0x104)](_0x28bed6(0xe0))||_0x3fab30[_0x28bed6(0x100)]['startsWith']('$2y$')){if(!bcrypt['compareSync'](_0x10327d,_0x3fab30[_0x28bed6(0x100)]))throw new common_1[(_0x28bed6(0xab))](_0x28bed6(0x118),common_1[_0x28bed6(0x13a)][_0x28bed6(0xa6)]);}else{console[_0x28bed6(0xf0)](_0x28bed6(0x109));const _0xf9bf60=crypto[_0x28bed6(0x133)]('md5')[_0x28bed6(0x12b)](_0x10327d)[_0x28bed6(0xf2)](_0x28bed6(0xa3));console[_0x28bed6(0xf0)](_0x28bed6(0x109),_0xf9bf60);if(_0xf9bf60!==_0x3fab30[_0x28bed6(0x100)])throw new common_1[(_0x28bed6(0xab))](_0x28bed6(0x118),common_1['HttpStatus']['BAD_REQUEST']);}}if(!_0x3fab30)throw new common_1[(_0x28bed6(0xab))]('当前账户不存在！',common_1['HttpStatus'][_0x28bed6(0xa6)]);if(_0x3fab30[_0x28bed6(0x120)]!==user_constant_1[_0x28bed6(0xf8)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x28bed6(0xb5)][_0x3fab30[_0x28bed6(0x120)]],common_1[_0x28bed6(0x13a)][_0x28bed6(0xa6)]);return _0x3fab30;}async[_0x509beb(0xb2)](_0x1696f3,_0x332d78){const _0x5c9a66=_0x509beb,_0x3e3b60=await this[_0x5c9a66(0xb1)]['findOne']({'where':{'id':_0x1696f3}});if(_0x3e3b60[_0x5c9a66(0x100)][_0x5c9a66(0x104)]('$2a$')||_0x3e3b60[_0x5c9a66(0x100)][_0x5c9a66(0x104)](_0x5c9a66(0xe0))||_0x3e3b60[_0x5c9a66(0x100)][_0x5c9a66(0x104)](_0x5c9a66(0x128)))return bcrypt[_0x5c9a66(0xa0)](_0x332d78,_0x3e3b60['password']);else{const _0x2f5026=crypto[_0x5c9a66(0x133)](_0x5c9a66(0xc0))[_0x5c9a66(0x12b)](_0x332d78)[_0x5c9a66(0xf2)](_0x5c9a66(0xa3));return console[_0x5c9a66(0xf0)](_0x5c9a66(0x109),_0x2f5026),_0x2f5026===_0x3e3b60[_0x5c9a66(0x100)];}}async[_0x509beb(0xa9)](_0x4966a7,_0x405f16){const _0x5bebf4=_0x509beb,_0x5dbd11=await this[_0x5bebf4(0xb1)]['update']({'id':_0x4966a7},{'status':_0x405f16});return _0x5dbd11[_0x5bebf4(0xfa)]>0x0;}async[_0x509beb(0xed)](_0x2d1522){const _0x582cb1=_0x509beb,_0x178479=await this[_0x582cb1(0xb1)][_0x582cb1(0xb6)]({'where':{'id':_0x2d1522}});return _0x178479[_0x582cb1(0x120)];}async[_0x509beb(0xf9)](_0x335ed3){const _0x4bbfa0=_0x509beb;return await this[_0x4bbfa0(0xb1)][_0x4bbfa0(0xb6)]({'where':{'id':_0x335ed3}});}async[_0x509beb(0xa7)](_0x9eeb30){const _0x168d73=_0x509beb;return await this[_0x168d73(0xb1)][_0x168d73(0xb6)]({'where':{'id':_0x9eeb30}});}async[_0x509beb(0xd4)](_0x32d18a){const _0x38e4e7=_0x509beb,{id:_0x4e9068,role:_0x1ae066}=_0x32d18a;if(_0x1ae066===_0x38e4e7(0x106))return!![];const _0x3f4124=await this[_0x38e4e7(0xb1)][_0x38e4e7(0xb6)]({'where':{'id':_0x4e9068}});if(!_0x3f4124)throw new common_1['HttpException'](_0x38e4e7(0x12f),common_1[_0x38e4e7(0x13a)][_0x38e4e7(0xe7)]);if(_0x3f4124['status']===user_constant_1[_0x38e4e7(0xf8)]['BLACKLISTED'])throw new common_1[(_0x38e4e7(0xab))](_0x38e4e7(0x98),common_1['HttpStatus']['BAD_REQUEST']);if(_0x3f4124['status']===user_constant_1[_0x38e4e7(0xf8)][_0x38e4e7(0xe4)])throw new common_1[(_0x38e4e7(0xab))](_0x38e4e7(0x94),common_1[_0x38e4e7(0x13a)][_0x38e4e7(0xa6)]);}async[_0x509beb(0x12d)](_0x4c7a20){const _0x3181be=_0x509beb,_0x1d9d86=await this['userEntity'][_0x3181be(0xb6)]({'where':{'id':_0x4c7a20},'select':[_0x3181be(0x8e),_0x3181be(0xe6),'role','email','sign','inviteCode',_0x3181be(0xee),'consecutiveDays']});if(!_0x1d9d86)throw new common_1[(_0x3181be(0xab))](_0x3181be(0x12f),common_1['HttpStatus'][_0x3181be(0xe7)]);_0x1d9d86[_0x3181be(0x105)]=!!(_0x1d9d86===null||_0x1d9d86===void 0x0?void 0x0:_0x1d9d86[_0x3181be(0xee)]),delete _0x1d9d86[_0x3181be(0xee)];const _0x3acb95=await this[_0x3181be(0x113)]['queryUserBalance'](_0x4c7a20);return{'userInfo':_0x1d9d86,'userBalance':Object[_0x3181be(0xfe)]({},_0x3acb95)};}async[_0x509beb(0x10d)](_0x3556e5){const _0x5056db=_0x509beb;return await this[_0x5056db(0xb1)][_0x5056db(0xb6)]({'where':{'id':_0x3556e5}});}async['getUserOpenId'](_0x2858c7){const _0x1f4f5d=_0x509beb;return await this[_0x1f4f5d(0xb1)][_0x1f4f5d(0xb6)]({'where':{'openId':_0x2858c7}});}async['updateInfo'](_0x31bf34,_0x2a9fa4){const _0x355aae=_0x509beb,{id:_0x226d0a}=_0x2a9fa4[_0x355aae(0x11e)],_0x4a7c6e=await this['userEntity']['findOne']({'where':{'id':_0x226d0a}});if(!_0x4a7c6e)throw new common_1[(_0x355aae(0xab))](_0x355aae(0x124),common_1[_0x355aae(0x13a)]['BAD_REQUEST']);if(_0x31bf34[_0x355aae(0x8e)]&&_0x4a7c6e[_0x355aae(0x8e)]===_0x31bf34[_0x355aae(0x8e)])throw new common_1['HttpException'](_0x355aae(0x101),common_1[_0x355aae(0x13a)]['BAD_REQUEST']);if(_0x31bf34[_0x355aae(0x8e)]){const _0x16a044=await this[_0x355aae(0xb1)][_0x355aae(0xb6)]({'where':{'username':_0x31bf34['username'],'id':(0x0,typeorm_2['Not'])(_0x226d0a)}});if(_0x16a044)throw new common_1['HttpException'](_0x355aae(0xc5),common_1[_0x355aae(0x13a)][_0x355aae(0xa6)]);}const _0x2f0188=await this[_0x355aae(0xb1)][_0x355aae(0x12b)]({'id':_0x226d0a},_0x31bf34);if(_0x2f0188['affected']<=0x0)throw new common_1[(_0x355aae(0xab))](_0x355aae(0x107),common_1[_0x355aae(0x13a)][_0x355aae(0xa6)]);return _0x355aae(0x11d);}async[_0x509beb(0xbe)](_0x4ae8c8,_0x45a8af){const _0x20ed0c=_0x509beb,_0x2f3e2e=bcrypt[_0x20ed0c(0xf4)](_0x45a8af,0xa),_0x49f6bb=await this[_0x20ed0c(0xb1)][_0x20ed0c(0x12b)]({'id':_0x4ae8c8},{'password':_0x2f3e2e});if(_0x49f6bb[_0x20ed0c(0xfa)]<=0x0)throw new common_1[(_0x20ed0c(0xab))](_0x20ed0c(0xa5),common_1[_0x20ed0c(0x13a)][_0x20ed0c(0xa6)]);}async[_0x509beb(0x108)](_0x3e68e2){const _0x334292=_0x509beb,{id:_0x37ab42}=_0x3e68e2[_0x334292(0x11e)],_0x2514f5=await this[_0x334292(0xb1)][_0x334292(0xb6)]({'where':{'id':_0x37ab42}});if(!_0x2514f5||_0x2514f5[_0x334292(0x11a)])throw new common_1[(_0x334292(0xab))]('已生成过邀请码、请勿重复生成',common_1['HttpStatus'][_0x334292(0xa6)]);const _0x39b401=(0x0,utils_1[_0x334292(0x119)])(),_0x4766f9=await this[_0x334292(0xb1)][_0x334292(0xb6)]({'where':{'inviteCode':_0x39b401}});if(_0x4766f9)throw new common_1[(_0x334292(0xab))]('生成邀请码失败，请重新试一次吧！',common_1[_0x334292(0x13a)][_0x334292(0xa6)]);const _0x3b7cfd=await this['userEntity'][_0x334292(0x12b)]({'id':_0x37ab42},{'inviteCode':_0x39b401});if(_0x3b7cfd[_0x334292(0xfa)]<=0x0)throw new common_1[(_0x334292(0xab))](_0x334292(0xac),common_1[_0x334292(0x13a)]['BAD_REQUEST']);return _0x39b401;}async[_0x509beb(0x114)](_0x24905d,_0x3a883e){const _0xf65a7e=_0x509beb;try{const {id:_0x5c1916}=_0x24905d[_0xf65a7e(0x11e)],{page:page=0x1,size:size=0xa}=_0x3a883e,_0x4230d0=await this[_0xf65a7e(0xb1)][_0xf65a7e(0xb6)]({'where':{'id':_0x5c1916}}),{inviteCode:_0x534539}=_0x4230d0;if(!_0x534539)return[];const [_0x5ac0ed,_0x174531]=await this[_0xf65a7e(0xb1)]['findAndCount']({'where':{'inviteCode':_0x534539},'order':{'id':_0xf65a7e(0x8f)},'select':[_0xf65a7e(0x8e),_0xf65a7e(0x123),_0xf65a7e(0xfb),_0xf65a7e(0x120),'avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1['formatCreateOrUpdateDate'])(_0x5ac0ed)[_0xf65a7e(0xf5)](_0x3908c7=>{const _0x821c73=_0xf65a7e;return _0x3908c7[_0x821c73(0x123)]=(0x0,utils_1[_0x821c73(0x12c)])(_0x3908c7[_0x821c73(0x123)]),_0x3908c7;}),{'rows':_0x5ac0ed,'count':_0x174531};}catch(_0x681479){console['log']('error:\x20',_0x681479);throw new common_1[(_0xf65a7e(0xab))](_0xf65a7e(0x9f),common_1[_0xf65a7e(0x13a)][_0xf65a7e(0xa6)]);}}async[_0x509beb(0xbc)](_0x3e27bc){const _0x11c681=_0x509beb,_0x138a64=await this[_0x11c681(0xb1)][_0x11c681(0xb6)]({'where':{'inviteCode':_0x3e27bc}});if(!_0x138a64)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x138a64,_0x58446b=await this[_0x11c681(0xb1)]['update']({'inviteCode':_0x3e27bc},{'inviteLinkCount':inviteLinkCount+0x1});return _0x58446b[_0x11c681(0xfa)]?0x1:0x0;}async[_0x509beb(0x95)](_0x30b52a){const _0x5e6873=_0x509beb;return await this[_0x5e6873(0xb1)][_0x5e6873(0xb6)]({'where':{'inviteCode':_0x30b52a}});}async['userRecharge'](_0x2eb7e3){const _0x35a873=_0x509beb,{userId:_0x249aa5,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2eb7e3;await this['userBalanceService'][_0x35a873(0xae)](_0x249aa5,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x3fa365=await this[_0x35a873(0x113)][_0x35a873(0xe8)]({'userId':_0x249aa5,'rechargeType':balance_constant_1[_0x35a873(0x13e)][_0x35a873(0xcc)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x3fa365;}async[_0x509beb(0x121)](_0x4e2422,_0x5e8f8f){const _0x105d6f=_0x509beb,{page:page=0x1,size:size=0xa,username:_0x1cb73d,email:_0x5b410a,status:_0x53bab9,keyword:_0xaeb36b,phone:_0x1c15ec}=_0x4e2422;let _0x243577={};_0x1cb73d&&Object[_0x105d6f(0xfe)](_0x243577,{'username':(0x0,typeorm_2[_0x105d6f(0xd6)])('%'+_0x1cb73d+'%')}),_0x5b410a&&Object[_0x105d6f(0xfe)](_0x243577,{'email':(0x0,typeorm_2['Like'])('%'+_0x5b410a+'%')}),_0x1c15ec&&Object[_0x105d6f(0xfe)](_0x243577,{'phone':(0x0,typeorm_2[_0x105d6f(0xd6)])('%'+_0x1c15ec+'%')}),_0x53bab9&&Object['assign'](_0x243577,{'status':_0x53bab9});_0xaeb36b&&(_0x243577=[{'username':(0x0,typeorm_2['Like'])('%'+_0xaeb36b+'%')},{'email':(0x0,typeorm_2[_0x105d6f(0xd6)])('%'+_0xaeb36b+'%')},{'phone':(0x0,typeorm_2[_0x105d6f(0xd6)])('%'+_0xaeb36b+'%')}]);const [_0x6708b2,_0x201b93]=await this['userEntity'][_0x105d6f(0x90)]({'skip':(page-0x1)*size,'where':_0x243577,'take':size,'order':{'createdAt':_0x105d6f(0x8f)},'cache':!![],'select':['username','avatar',_0x105d6f(0x11a),_0x105d6f(0x10f),_0x105d6f(0xcd),'status','id','email',_0x105d6f(0xfb),_0x105d6f(0xa4),_0x105d6f(0x116)]}),_0x35de11=_0x6708b2[_0x105d6f(0xf5)](_0xf793c7=>_0xf793c7['id']),_0x4a9ef7=await this[_0x105d6f(0x113)]['queryUserBalanceByIds'](_0x35de11);return _0x6708b2[_0x105d6f(0x10e)](_0x2a0ea6=>_0x2a0ea6[_0x105d6f(0x136)]=_0x4a9ef7['find'](_0x1fe79d=>_0x1fe79d[_0x105d6f(0x131)]===_0x2a0ea6['id'])),_0x5e8f8f[_0x105d6f(0x11e)][_0x105d6f(0x10f)]!==_0x105d6f(0xce)&&_0x6708b2[_0x105d6f(0x10e)](_0x4cf416=>_0x4cf416['email']=(0x0,utils_1['maskEmail'])(_0x4cf416[_0x105d6f(0x123)])),_0x5e8f8f['user'][_0x105d6f(0x10f)]!==_0x105d6f(0xce)&&_0x6708b2[_0x105d6f(0x10e)](_0xca2aa7=>_0xca2aa7[_0x105d6f(0xa4)]=(0x0,utils_1[_0x105d6f(0xe5)])(_0xca2aa7[_0x105d6f(0xa4)])),_0x5e8f8f[_0x105d6f(0x11e)][_0x105d6f(0x10f)]!==_0x105d6f(0xce)&&_0x6708b2[_0x105d6f(0x10e)](_0x14ca9f=>_0x14ca9f[_0x105d6f(0x116)]=(0x0,utils_1[_0x105d6f(0xe5)])(_0x14ca9f[_0x105d6f(0x116)])),{'rows':_0x6708b2,'count':_0x201b93};}async['queryOne']({id:_0x2f6ae5}){const _0x5d20de=_0x509beb;return await this['userEntity'][_0x5d20de(0xb6)]({'where':{'id':_0x2f6ae5},'select':['username',_0x5d20de(0xe6),_0x5d20de(0x11a),_0x5d20de(0x10f),_0x5d20de(0xcd),_0x5d20de(0x120)]});}async[_0x509beb(0x92)](_0x36fd89){const _0x27a8b8=_0x509beb,{id:_0x5b94c5,status:_0xaaf7f8}=_0x36fd89,_0x166ba2=await this[_0x27a8b8(0xb1)][_0x27a8b8(0xb6)]({'where':{'id':_0x5b94c5}});if(!_0x166ba2)throw new common_1[(_0x27a8b8(0xab))](_0x27a8b8(0xb7),common_1['HttpStatus'][_0x27a8b8(0xa6)]);if(_0x166ba2[_0x27a8b8(0x10f)]===_0x27a8b8(0xce))throw new common_1[(_0x27a8b8(0xab))]('超级管理员不可被操作！',common_1[_0x27a8b8(0x13a)][_0x27a8b8(0xa6)]);if(_0x166ba2[_0x27a8b8(0x120)]===user_constant_1[_0x27a8b8(0xf8)]['PENDING'])throw new common_1[(_0x27a8b8(0xab))](_0x27a8b8(0xec),common_1['HttpStatus']['BAD_REQUEST']);if(_0x166ba2[_0x27a8b8(0x10f)]===_0x27a8b8(0xce))throw new common_1['HttpException']('超级管理员不可被操作！',common_1[_0x27a8b8(0x13a)][_0x27a8b8(0xa6)]);if(_0xaaf7f8===user_constant_1['UserStatusEnum'][_0x27a8b8(0xc6)])throw new common_1[(_0x27a8b8(0xab))]('不可将用户置为未激活状态！',common_1[_0x27a8b8(0x13a)][_0x27a8b8(0xa6)]);const _0x3814eb=await this[_0x27a8b8(0xb1)][_0x27a8b8(0x12b)]({'id':_0x5b94c5},{'status':_0xaaf7f8});if(_0x3814eb['affected']<=0x0)throw new common_1[(_0x27a8b8(0xab))](_0x27a8b8(0x139),common_1[_0x27a8b8(0x13a)][_0x27a8b8(0xa6)]);return'修改用户状态成功！';}async[_0x509beb(0xb3)](_0x32443b){const _0x285a0f=_0x509beb,{id:_0x3da0ef}=_0x32443b,_0x3e3ef9=await this[_0x285a0f(0xb1)][_0x285a0f(0xb6)]({'where':{'id':_0x3da0ef}});if(!_0x3e3ef9)throw new common_1[(_0x285a0f(0xab))](_0x285a0f(0xb7),common_1['HttpStatus'][_0x285a0f(0xa6)]);const _0x527a9a=_0x285a0f(0x134),_0x352970=bcrypt[_0x285a0f(0xf4)](_0x527a9a,0xa),_0x1d5912=await this[_0x285a0f(0xb1)][_0x285a0f(0x12b)]({'id':_0x3da0ef},{'password':_0x352970});if(_0x1d5912[_0x285a0f(0xfa)]<=0x0)throw new common_1[(_0x285a0f(0xab))](_0x285a0f(0x99),common_1['HttpStatus']['BAD_REQUEST']);return'密码重置为['+_0x527a9a+_0x285a0f(0x9c);}async[_0x509beb(0x13b)](_0x46cfd3,_0x155944){const _0x13f3c9=_0x509beb;return await this[_0x13f3c9(0xb1)][_0x13f3c9(0x12b)]({'id':_0x46cfd3},{'lastLoginIp':_0x155944});}async[_0x509beb(0x9d)](_0x48655f,_0x12689d){const _0x17c148=_0x509beb,_0x1b16bf=await this[_0x17c148(0xb1)][_0x17c148(0xb6)]({'where':{'openId':_0x48655f}});if(!_0x1b16bf){const _0x39d497=_0x12689d?_0x12689d[_0x17c148(0x11b)](':')[0x1]:'',_0x2f91fc=await this[_0x17c148(0x95)](_0x39d497),_0x44e01d=await this[_0x17c148(0xba)](_0x48655f,_0x39d497);return await this[_0x17c148(0x113)][_0x17c148(0xda)](_0x44e01d['id'],_0x39d497?_0x2f91fc===null||_0x2f91fc===void 0x0?void 0x0:_0x2f91fc['id']:null),_0x44e01d;}return _0x1b16bf;}async['createUserFromOpenId'](_0x1e7ee8,_0x4f7bee){const _0x5df1a3=_0x509beb,_0x3f565f=await this['globalConfigService']['getConfigs']([_0x5df1a3(0xbd)]),_0x4ec412={'avatar':_0x3f565f,'username':'用户'+(0x0,utils_1[_0x5df1a3(0xcf)])(),'status':user_constant_1[_0x5df1a3(0xf8)]['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x5df1a3(0xcf)])()+_0x5df1a3(0x10c),'invitedBy':_0x4f7bee,'openId':_0x1e7ee8},_0x3b30a0=await this[_0x5df1a3(0xb1)][_0x5df1a3(0x122)](_0x4ec412);return _0x3b30a0;}async[_0x509beb(0x93)](_0x4488fa,_0x10fef0){const _0x2f39d6=_0x509beb;try{const _0x90b99d=await this[_0x2f39d6(0xb1)][_0x2f39d6(0xb6)]({'where':{'id':_0x10fef0}});if(!_0x90b99d)return{'status':![],'msg':'当前绑定用户不存在！'};const _0xc799d2=await this[_0x2f39d6(0xb1)][_0x2f39d6(0xb6)]({'where':{'openId':_0x4488fa}});if(_0xc799d2)return{'status':![],'msg':_0x2f39d6(0x112)};const _0x1ec818=await this[_0x2f39d6(0xb1)][_0x2f39d6(0x12b)]({'id':_0x10fef0},{'openId':_0x4488fa});if(_0x1ec818[_0x2f39d6(0xfa)]<=0x0)return{'status':![],'msg':_0x2f39d6(0xd9)};return{'status':!![],'msg':_0x2f39d6(0xe9)};}catch(_0x39c406){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x509beb(0x138)](_0x46a809){const _0x3a3b12=_0x509beb,_0x4972c8=await this['userEntity'][_0x3a3b12(0xb6)]({'where':{'id':_0x46a809}});return _0x4972c8===null||_0x4972c8===void 0x0?void 0x0:_0x4972c8[_0x3a3b12(0xee)];}async['verifyUserRegisterByPhone'](_0x3d7157){const _0x2fba73=_0x509beb,{username:_0x4976b6,password:_0x2e2e91,phone:_0x3578d8,phoneCode:_0x1070fc}=_0x3d7157,_0x5d3a61=await this[_0x2fba73(0xb1)][_0x2fba73(0xb6)]({'where':[{'username':_0x4976b6},{'phone':_0x3578d8}]});if(_0x5d3a61&&_0x5d3a61['username']===_0x4976b6)throw new common_1[(_0x2fba73(0xab))](_0x2fba73(0x117),common_1[_0x2fba73(0x13a)][_0x2fba73(0xa6)]);if(_0x5d3a61&&_0x5d3a61[_0x2fba73(0x116)]===_0x3578d8)throw new common_1['HttpException'](_0x2fba73(0xb9),common_1[_0x2fba73(0x13a)][_0x2fba73(0xa6)]);}async['createUser'](_0x181e82){const _0x22a6be=_0x509beb;return await this[_0x22a6be(0xb1)][_0x22a6be(0x122)](_0x181e82);}};function _0x1652(_0x47c0b4,_0x3c464a){const _0x261e61=_0x261e();return _0x1652=function(_0x165209,_0x4a42df){_0x165209=_0x165209-0x8e;let _0x1c55f4=_0x261e61[_0x165209];return _0x1c55f4;},_0x1652(_0x47c0b4,_0x3c464a);}UserService=__decorate([(0x0,common_1[_0x509beb(0x11f)])(),__param(0x0,(0x0,typeorm_1[_0x509beb(0x137)])(user_entity_1[_0x509beb(0x13d)])),__param(0x1,(0x0,typeorm_1[_0x509beb(0x137)])(whiteList_entity_1[_0x509beb(0xc3)])),__param(0x7,(0x0,typeorm_1[_0x509beb(0x137)])(config_entity_1[_0x509beb(0xe1)])),__metadata('design:paramtypes',[typeorm_2[_0x509beb(0x13c)],typeorm_2[_0x509beb(0x13c)],typeorm_2[_0x509beb(0x9e)],verification_service_1['VerificationService'],mailer_1[_0x509beb(0x9b)],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x509beb(0x13c)]])],UserService),exports['UserService']=UserService;